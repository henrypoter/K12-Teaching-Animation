<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>法拉第电磁感应实验 - 交互式教学动画</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.92);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eaeaea;
        }
        
        h1 {
            color: #2c3e50;
            font-size: 2.4rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #3498db, #2c3e50);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 1.1rem;
            font-weight: normal;
        }
        
        .content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .animation-area {
            flex: 1;
            min-width: 500px;
            background-color: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }
        
        .controls {
            flex: 0 0 300px;
            background-color: #f8fafc;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }
        
        .canvas-container {
            position: relative;
            width: 100%;
            height: 500px;
            background-color: #f0f4f8;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #d1d9e6;
        }
        
        #experimentCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .section-title {
            color: #2c3e50;
            font-size: 1.4rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .control-group {
            margin-bottom: 25px;
        }
        
        .control-title {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 12px;
            font-size: 1.1rem;
        }
        
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        button {
            padding: 12px 18px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-secondary {
            background-color: #2ecc71;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #27ae60;
        }
        
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-outline {
            background-color: transparent;
            color: #4a5568;
            border: 2px solid #cbd5e0;
        }
        
        .btn-outline:hover {
            background-color: #edf2f7;
        }
        
        .toggle-group {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        
        .toggle-btn {
            flex: 1;
            padding: 12px;
        }
        
        .toggle-btn.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .info-panel {
            background-color: #edf2f7;
            border-radius: 8px;
            padding: 20px;
            margin-top: 25px;
            border-left: 4px solid #3498db;
        }
        
        .info-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .info-content {
            color: #4a5568;
            line-height: 1.7;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            margin-top: 15px;
            padding: 12px;
            background-color: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .status-label {
            font-weight: 600;
            color: #4a5568;
            margin-right: 10px;
            min-width: 120px;
        }
        
        .status-value {
            color: #2c3e50;
            font-weight: 600;
        }
        
        .current-direction {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-left: 10px;
            vertical-align: middle;
        }
        
        .current-positive {
            background-color: #f1c40f;
            box-shadow: 0 0 8px #f1c40f;
        }
        
        .current-negative {
            background-color: #9b59b6;
            box-shadow: 0 0 8px #9b59b6;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .legend-text {
            font-size: 0.9rem;
            color: #4a5568;
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eaeaea;
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        @media (max-width: 900px) {
            .content {
                flex-direction: column;
            }
            
            .animation-area, .controls {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>法拉第电磁感应实验</h1>
            <p class="subtitle">磁铁插入线圈瞬间的电流产生 - 交互式教学动画</p>
        </header>
        
        <div class="content">
            <div class="animation-area">
                <h2 class="section-title">实验装置</h2>
                <div class="canvas-container">
                    <canvas id="experimentCanvas"></canvas>
                </div>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e74c3c;"></div>
                        <span class="legend-text">磁铁N极</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #3498db;"></div>
                        <span class="legend-text">磁铁S极</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f1c40f;"></div>
                        <span class="legend-text">正向电流</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #9b59b6;"></div>
                        <span class="legend-text">反向电流</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #2ecc71;"></div>
                        <span class="legend-text">磁场线</span>
                    </div>
                </div>
            </div>
            
            <div class="controls">
                <h2 class="section-title">实验控制</h2>
                
                <div class="control-group">
                    <div class="control-title">磁铁运动控制</div>
                    <div class="btn-group">
                        <button id="insertBtn" class="btn-primary">
                            <span>插入线圈</span>
                        </button>
                        <button id="withdrawBtn" class="btn-primary">
                            <span>抽出线圈</span>
                        </button>
                        <button id="flipMagnetBtn" class="btn-outline">
                            <span>翻转磁极</span>
                        </button>
                    </div>
                    <div class="btn-group">
                        <button id="resetBtn" class="btn-danger">
                            <span>重置实验</span>
                        </button>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="control-title">可视化选项</div>
                    <div class="toggle-group">
                        <button id="toggleFieldBtn" class="toggle-btn btn-outline active">
                            <span>显示磁场</span>
                        </button>
                        <button id="toggleCurrentBtn" class="toggle-btn btn-outline active">
                            <span>显示电流</span>
                        </button>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="control-title">实验模式</div>
                    <div class="btn-group">
                        <button id="freeModeBtn" class="toggle-btn btn-outline active">
                            <span>自由模式</span>
                        </button>
                        <button id="autoModeBtn" class="toggle-btn btn-outline">
                            <span>自动演示</span>
                        </button>
                    </div>
                </div>
                
                <div class="info-panel">
                    <div class="info-title">实验状态</div>
                    <div class="info-content">
                        <p id="statusText">磁铁在线圈外部静止，电路中没有电流。</p>
                        
                        <div class="status-indicator">
                            <span class="status-label">磁铁位置:</span>
                            <span id="magnetPosition" class="status-value">外部</span>
                        </div>
                        
                        <div class="status-indicator">
                            <span class="status-label">磁通量变化:</span>
                            <span id="fluxChange" class="status-value">无变化</span>
                        </div>
                        
                        <div class="status-indicator">
                            <span class="status-label">感应电流:</span>
                            <span id="currentValue" class="status-value">0.00 A</span>
                            <span id="currentDirection" class="current-direction"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>交互式物理教学动画 | 法拉第电磁感应定律 | 磁通量变化产生感应电流</p>
        </footer>
    </div>

    <script>
        // 获取Canvas元素和上下文
        const canvas = document.getElementById('experimentCanvas');
        const ctx = canvas.getContext('2d');
        
        // 设置Canvas尺寸
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }
        
        // 初始调整Canvas大小
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // 实验状态变量
        let magnet = {
            x: 150,
            y: 250,
            width: 60,
            height: 120,
            nPoleColor: '#e74c3c',
            sPoleColor: '#3498db',
            isNFirst: true, // N极是否朝下
            isInside: false,
            isMoving: false,
            targetY: 250,
            speed: 2
        };
        
        let coil = {
            x: 400,
            y: 250,
            radius: 100,
            turns: 8,
            wireColor: '#8B4513',
            wireThickness: 3
        };
        
        let ammeter = {
            x: 650,
            y: 250,
            radius: 50,
            minAngle: -Math.PI/4,
            maxAngle: Math.PI/4,
            needleAngle: 0,
            maxCurrent: 1.0,
            current: 0
        };
        
        let fieldLines = [];
        let currentParticles = [];
        let showFieldLines = true;
        let showCurrent = true;
        let isAutoMode = false;
        let autoDemoStep = 0;
        let autoDemoTimer = null;
        
        // 初始化磁场线
        function initFieldLines() {
            fieldLines = [];
            // 创建从磁铁N极到S极的磁场线
            for (let i = 0; i < 15; i++) {
                const angle = (i / 14) * Math.PI * 2;
                fieldLines.push({
                    angle: angle,
                    particles: []
                });
                
                // 每条磁场线由多个粒子组成
                for (let j = 0; j < 20; j++) {
                    const t = j / 19;
                    fieldLines[i].particles.push({
                        t: t,
                        offset: Math.random() * 0.1
                    });
                }
            }
        }
        
        // 初始化电流粒子
        function initCurrentParticles() {
            currentParticles = [];
            // 创建沿线圈和导线流动的电流粒子
            for (let i = 0; i < 30; i++) {
                currentParticles.push({
                    position: i / 30, // 在路径上的位置 (0-1)
                    speed: 0.02 + Math.random() * 0.01,
                    size: 3 + Math.random() * 3,
                    color: ammeter.current >= 0 ? '#f1c40f' : '#9b59b6'
                });
            }
        }
        
        // 绘制磁铁
        function drawMagnet() {
            ctx.save();
            
            // 绘制磁铁主体
            ctx.fillStyle = '#2c3e50';
            ctx.fillRect(magnet.x - magnet.width/2, magnet.y - magnet.height/2, magnet.width, magnet.height);
            
            // 绘制N极和S极
            if (magnet.isNFirst) {
                // N极在下
                ctx.fillStyle = magnet.nPoleColor;
                ctx.fillRect(magnet.x - magnet.width/2, magnet.y + magnet.height/2 - 20, magnet.width, 20);
                
                ctx.fillStyle = magnet.sPoleColor;
                ctx.fillRect(magnet.x - magnet.width/2, magnet.y - magnet.height/2, magnet.width, 20);
                
                // 绘制N/S标签
                ctx.fillStyle = 'white';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('N', magnet.x, magnet.y + magnet.height/2 - 10);
                ctx.fillText('S', magnet.x, magnet.y - magnet.height/2 + 10);
            } else {
                // S极在下
                ctx.fillStyle = magnet.sPoleColor;
                ctx.fillRect(magnet.x - magnet.width/2, magnet.y + magnet.height/2 - 20, magnet.width, 20);
                
                ctx.fillStyle = magnet.nPoleColor;
                ctx.fillRect(magnet.x - magnet.width/2, magnet.y - magnet.height/2, magnet.width, 20);
                
                // 绘制N/S标签
                ctx.fillStyle = 'white';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('S', magnet.x, magnet.y + magnet.height/2 - 10);
                ctx.fillText('N', magnet.x, magnet.y - magnet.height/2 + 10);
            }
            
            // 绘制磁铁边框
            ctx.strokeStyle = '#34495e';
            ctx.lineWidth = 2;
            ctx.strokeRect(magnet.x - magnet.width/2, magnet.y - magnet.height/2, magnet.width, magnet.height);
            
            ctx.restore();
        }
        
        // 绘制线圈
        function drawCoil() {
            ctx.save();
            
            // 绘制线圈支架
            ctx.fillStyle = '#95a5a6';
            ctx.fillRect(coil.x - 120, coil.y - 130, 240, 20); // 上横梁
            ctx.fillRect(coil.x - 120, coil.y + 110, 240, 20); // 下横梁
            ctx.fillRect(coil.x - 120, coil.y - 110, 20, 220); // 左立柱
            ctx.fillRect(coil.x + 100, coil.y - 110, 20, 220); // 右立柱
            
            // 绘制线圈
            ctx.strokeStyle = coil.wireColor;
            ctx.lineWidth = coil.wireThickness;
            ctx.lineCap = 'round';
            
            const turnSpacing = 20;
            const startX = coil.x - coil.radius;
            
            ctx.beginPath();
            for (let i = 0; i < coil.turns; i++) {
                const x = startX + i * turnSpacing;
                const yTop = coil.y - coil.radius;
                const yBottom = coil.y + coil.radius;
                
                if (i === 0) {
                    ctx.moveTo(x, yTop);
                }
                
                // 绘制一圈
                ctx.lineTo(x, yBottom);
                ctx.lineTo(x + turnSpacing, yBottom);
                ctx.lineTo(x + turnSpacing, yTop);
                
                // 如果不是最后一圈，继续到下一圈的开始
                if (i < coil.turns - 1) {
                    ctx.lineTo(x + turnSpacing + turnSpacing, yTop);
                }
            }
            ctx.stroke();
            
            // 绘制线圈连接导线
            ctx.beginPath();
            ctx.moveTo(startX, coil.y - coil.radius);
            ctx.lineTo(startX - 50, coil.y - coil.radius);
            ctx.lineTo(startX - 50, ammeter.y);
            ctx.lineTo(ammeter.x - ammeter.radius, ammeter.y);
            
            ctx.moveTo(startX + coil.turns * turnSpacing, coil.y - coil.radius);
            ctx.lineTo(startX + coil.turns * turnSpacing + 50, coil.y - coil.radius);
            ctx.lineTo(startX + coil.turns * turnSpacing + 50, ammeter.y);
            ctx.lineTo(ammeter.x + ammeter.radius, ammeter.y);
            
            ctx.stroke();
            
            // 绘制线圈标签
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 18px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('线圈', coil.x, coil.y + coil.radius + 40);
            
            ctx.restore();
        }
        
        // 绘制电流表
        function drawAmmeter() {
            ctx.save();
            
            // 绘制表盘
            ctx.fillStyle = '#ecf0f1';
            ctx.beginPath();
            ctx.arc(ammeter.x, ammeter.y, ammeter.radius, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.strokeStyle = '#2c3e50';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            // 绘制刻度
            ctx.strokeStyle = '#7f8c8d';
            ctx.lineWidth = 1;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.font = '12px Arial';
            ctx.fillStyle = '#2c3e50';
            
            for (let i = -4; i <= 4; i++) {
                const angle = (i / 4) * (ammeter.maxAngle - ammeter.minAngle);
                const startRadius = ammeter.radius - 10;
                const endRadius = ammeter.radius - (i % 2 === 0 ? 20 : 15);
                
                const startX = ammeter.x + Math.cos(angle) * startRadius;
                const startY = ammeter.y + Math.sin(angle) * startRadius;
                const endX = ammeter.x + Math.cos(angle) * endRadius;
                const endY = ammeter.y + Math.sin(angle) * endRadius;
                
                ctx.beginPath();
                ctx.moveTo(startX, startY);
                ctx.lineTo(endX, endY);
                ctx.stroke();
                
                // 绘制刻度值
                if (i % 2 === 0) {
                    const labelRadius = ammeter.radius - 30;
                    const labelX = ammeter.x + Math.cos(angle) * labelRadius;
                    const labelY = ammeter.y + Math.sin(angle) * labelRadius;
                    
                    const currentValue = (i / 4) * ammeter.maxCurrent;
                    ctx.fillText(currentValue.toFixed(1), labelX, labelY);
                }
            }
            
            // 绘制指针
            ctx.save();
            ctx.translate(ammeter.x, ammeter.y);
            ctx.rotate(ammeter.needleAngle);
            
            // 指针主体
            ctx.fillStyle = '#e74c3c';
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(ammeter.radius - 15, 0);
            ctx.lineTo(ammeter.radius - 25, 5);
            ctx.lineTo(ammeter.radius - 25, -5);
            ctx.closePath();
            ctx.fill();
            
            // 指针中心
            ctx.fillStyle = '#2c3e50';
            ctx.beginPath();
            ctx.arc(0, 0, 5, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.restore();
            
            // 绘制电流表标签
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 18px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('电流表', ammeter.x, ammeter.y + ammeter.radius + 30);
            
            // 绘制正负标记
            ctx.font = '14px Arial';
            ctx.fillText('+', ammeter.x + ammeter.radius - 40, ammeter.y - 10);
            ctx.fillText('-', ammeter.x - ammeter.radius + 40, ammeter.y - 10);
            
            ctx.restore();
        }
        
        // 绘制磁场线
        function drawFieldLines() {
            if (!showFieldLines) return;
            
            ctx.save();
            ctx.strokeStyle = '#2ecc71';
            ctx.lineWidth = 1;
            ctx.globalAlpha = 0.7;
            
            // 计算磁铁中心位置
            const magnetCenterX = magnet.x;
            const magnetCenterY = magnet.y;
            
            // 计算磁铁是否在线圈内
            const dx = magnetCenterX - coil.x;
            const dy = magnetCenterY - coil.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const isMagnetInCoil = distance < coil.radius + 20;
            
            // 更新磁场线
            fieldLines.forEach((line, lineIndex) => {
                ctx.beginPath();
                
                // 磁场线从N极到S极
                const startAngle = line.angle;
                const endAngle = line.angle + Math.PI; // 相反方向
                
                // 计算磁场线路径（考虑磁铁位置）
                const startX = magnetCenterX + Math.cos(startAngle) * magnet.width/2;
                const startY = magnetCenterY + Math.sin(startAngle) * magnet.height/2;
                
                const endX = magnetCenterX + Math.cos(endAngle) * magnet.width/2;
                const endY = magnetCenterY + Math.sin(endAngle) * magnet.height/2;
                
                // 绘制磁场线粒子
                line.particles.forEach((particle, particleIndex) => {
                    const t = particle.t;
                    const offset = particle.offset;
                    
                    // 计算粒子位置（沿磁场线路径）
                    let particleX, particleY;
                    
                    if (t < 0.5) {
                        // 前半段：从起点到中点
                        const segmentT = t * 2;
                        particleX = startX + (magnetCenterX - startX) * segmentT;
                        particleY = startY + (magnetCenterY - startY) * segmentT;
                    } else {
                        // 后半段：从中点到终点
                        const segmentT = (t - 0.5) * 2;
                        particleX = magnetCenterX + (endX - magnetCenterX) * segmentT;
                        particleY = magnetCenterY + (endY - magnetCenterY) * segmentT;
                    }
                    
                    // 添加一些随机偏移，使磁场线看起来更自然
                    particleX += Math.cos(line.angle * 2 + offset) * 5;
                    particleY += Math.sin(line.angle * 2 + offset) * 5;
                    
                    // 绘制粒子
                    ctx.fillStyle = '#2ecc71';
                    ctx.beginPath();
                    ctx.arc(particleX, particleY, 2, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // 更新粒子位置（动画效果）
                    particle.t += 0.01;
                    if (particle.t > 1) {
                        particle.t = 0;
                    }
                });
            });
            
            // 如果磁铁在线圈内，高亮显示线圈内的磁场
            if (isMagnetInCoil) {
                ctx.fillStyle = 'rgba(46, 204, 113, 0.1)';
                ctx.beginPath();
                ctx.arc(coil.x, coil.y, coil.radius, 0, Math.PI * 2);
                ctx.fill();
                
                // 绘制线圈内的磁场线
                ctx.strokeStyle = 'rgba(46, 204, 113, 0.5)';
                ctx.lineWidth = 1;
                
                for (let i = 0; i < 8; i++) {
                    const angle = (i / 8) * Math.PI * 2;
                    const startX = coil.x + Math.cos(angle) * coil.radius;
                    const startY = coil.y + Math.sin(angle) * coil.radius;
                    
                    const endX = coil.x + Math.cos(angle + Math.PI) * coil.radius;
                    const endY = coil.y + Math.sin(angle + Math.PI) * coil.radius;
                    
                    ctx.beginPath();
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(endX, endY);
                    ctx.stroke();
                }
            }
            
            ctx.restore();
        }
        
        // 绘制电流粒子
        function drawCurrent() {
            if (!showCurrent || Math.abs(ammeter.current) < 0.01) return;
            
            ctx.save();
            
            // 更新电流粒子
            currentParticles.forEach(particle => {
                // 更新粒子位置
                particle.position += particle.speed * Math.sign(ammeter.current);
                if (particle.position > 1) particle.position = 0;
                if (particle.position < 0) particle.position = 1;
                
                // 设置粒子颜色
                particle.color = ammeter.current >= 0 ? '#f1c40f' : '#9b59b6';
                
                // 计算粒子在路径上的位置
                let particleX, particleY;
                const pathLength = 4; // 路径分为4段
                const segment = Math.floor(particle.position * pathLength) % pathLength;
                const segmentPos = (particle.position * pathLength) % 1;
                
                // 路径定义：从线圈左端开始，经过电流表，回到线圈右端
                switch (segment) {
                    case 0: // 从左导线到电流表左端
                        particleX = coil.x - coil.radius - 50 + segmentPos * 100;
                        particleY = coil.y - coil.radius;
                        break;
                    case 1: // 电流表下半部分
                        const angle = Math.PI * segmentPos;
                        particleX = ammeter.x + Math.cos(angle) * ammeter.radius;
                        particleY = ammeter.y + Math.sin(angle) * ammeter.radius;
                        break;
                    case 2: // 从电流表右端到右导线
                        particleX = coil.x + coil.radius + 50 - segmentPos * 100;
                        particleY = coil.y - coil.radius;
                        break;
                    case 3: // 线圈部分（简化）
                        particleX = coil.x - coil.radius + segmentPos * coil.radius * 2;
                        particleY = coil.y - coil.radius + Math.sin(segmentPos * Math.PI) * 20;
                        break;
                }
                
                // 绘制粒子
                ctx.fillStyle = particle.color;
                ctx.beginPath();
                ctx.arc(particleX, particleY, particle.size, 0, Math.PI * 2);
                ctx.fill();
                
                // 添加光晕效果
                ctx.fillStyle = particle.color;
                ctx.globalAlpha = 0.3;
                ctx.beginPath();
                ctx.arc(particleX, particleY, particle.size * 1.5, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            });
            
            ctx.restore();
        }
        
        // 更新实验状态
        function updateExperiment() {
            // 更新磁铁位置（如果正在移动）
            if (magnet.isMoving) {
                const dy = magnet.targetY - magnet.y;
                if (Math.abs(dy) < magnet.speed) {
                    magnet.y = magnet.targetY;
                    magnet.isMoving = false;
                    
                    // 如果到达目标位置，停止电流（除非在自动演示模式中保持）
                    if (!isAutoMode) {
                        ammeter.current = 0;
                        ammeter.needleAngle = 0;
                        updateStatusText();
                        initCurrentParticles();
                    }
                } else {
                    magnet.y += Math.sign(dy) * magnet.speed;
                    
                    // 计算磁通量变化和感应电流
                    const oldIsInside = magnet.isInside;
                    magnet.isInside = magnet.y > 150 && magnet.y < 350;
                    
                    // 如果磁铁进入或离开线圈，产生电流
                    if (oldIsInside !== magnet.isInside || magnet.isMoving) {
                        // 计算电流大小和方向
                        const direction = magnet.isNFirst ? 1 : -1;
                        const motionDirection = magnet.targetY > 250 ? 1 : -1;
                        const insideFactor = magnet.isInside ? 1.5 : 0.5;
                        
                        ammeter.current = direction * motionDirection * insideFactor * 0.8;
                        
                        // 限制电流在合理范围内
                        if (ammeter.current > ammeter.maxCurrent) ammeter.current = ammeter.maxCurrent;
                        if (ammeter.current < -ammeter.maxCurrent) ammeter.current = -ammeter.maxCurrent;
                        
                        // 更新电流表指针角度
                        ammeter.needleAngle = (ammeter.current / ammeter.maxCurrent) * ammeter.maxAngle;
                        
                        // 更新电流粒子
                        initCurrentParticles();
                        
                        // 更新状态文本
                        updateStatusText();
                    }
                }
            }
            
            // 更新自动演示模式
            if (isAutoMode && !magnet.isMoving) {
                autoDemoStep++;
                
                if (autoDemoStep === 1) {
                    // 第一步：N极插入
                    magnet.isNFirst = true;
                    magnet.targetY = 350;
                    magnet.isMoving = true;
                    updateStatusText("自动演示步骤 1/4: N极插入线圈");
                } else if (autoDemoStep === 2) {
                    // 第二步：N极抽出
                    magnet.targetY = 250;
                    magnet.isMoving = true;
                    updateStatusText("自动演示步骤 2/4: N极抽出线圈");
                } else if (autoDemoStep === 3) {
                    // 第三步：翻转磁极，S极插入
                    magnet.isNFirst = false;
                    magnet.targetY = 350;
                    magnet.isMoving = true;
                    updateStatusText("自动演示步骤 3/4: 翻转磁极，S极插入线圈");
                } else if (autoDemoStep === 4) {
                    // 第四步：S极抽出
                    magnet.targetY = 250;
                    magnet.isMoving = true;
                    updateStatusText("自动演示步骤 4/4: S极抽出线圈");
                } else if (autoDemoStep > 4) {
                    // 演示完成，重置
                    autoDemoStep = 0;
                    isAutoMode = false;
                    document.getElementById('freeModeBtn').click();
                    updateStatusText("自动演示完成。请尝试自由模式。");
                }
            }
        }
        
        // 更新状态文本
        function updateStatusText(customText = null) {
            const statusElement = document.getElementById('statusText');
            const positionElement = document.getElementById('magnetPosition');
            const fluxElement = document.getElementById('fluxChange');
            const currentElement = document.getElementById('currentValue');
            const directionElement = document.getElementById('currentDirection');
            
            if (customText) {
                statusElement.textContent = customText;
            } else {
                if (!magnet.isMoving && ammeter.current === 0) {
                    statusElement.textContent = magnet.isInside ? 
                        "磁铁在线圈内部静止，电路中没有电流。" : 
                        "磁铁在线圈外部静止，电路中没有电流。";
                } else if (magnet.isMoving) {
                    if (magnet.targetY > magnet.y) {
                        statusElement.textContent = magnet.isNFirst ? 
                            "N极正在插入线圈 → 磁通量增加 → 产生感应电流！" : 
                            "S极正在插入线圈 → 磁通量增加 → 产生感应电流！";
                    } else {
                        statusElement.textContent = magnet.isNFirst ? 
                            "N极正在抽出线圈 → 磁通量减少 → 产生反向感应电流！" : 
                            "S极正在抽出线圈 → 磁通量减少 → 产生反向感应电流！";
                    }
                } else {
                    statusElement.textContent = "磁铁已停止运动，电流逐渐减小为零。";
                }
            }
            
            // 更新磁铁位置
            positionElement.textContent = magnet.isInside ? "内部" :
<!--检测到代码截断，自动续写中...-->
"外部";
            
            // 更新磁通量变化
            if (magnet.isMoving) {
                if (magnet.targetY > magnet.y) {
                    fluxElement.textContent = magnet.isInside ? "快速增加" : "开始增加";
                } else {
                    fluxElement.textContent = magnet.isInside ? "快速减少" : "开始减少";
                }
            } else {
                fluxElement.textContent = "无变化";
            }
            
            // 更新电流值
            currentElement.textContent = ammeter.current.toFixed(2) + " A";
            
            // 更新电流方向指示器
            if (ammeter.current > 0.01) {
                directionElement.className = "current-direction current-positive";
                directionElement.title = "正向电流（顺时针）";
            } else if (ammeter.current < -0.01) {
                directionElement.className = "current-direction current-negative";
                directionElement.title = "反向电流（逆时针）";
            } else {
                directionElement.className = "current-direction";
                directionElement.title = "无电流";
            }
        }
        
        // 绘制所有元素
        function draw() {
            // 清除画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 绘制背景
            ctx.fillStyle = '#f0f4f8';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 绘制实验台
            ctx.fillStyle = '#d4b483';
            ctx.fillRect(50, 400, canvas.width - 100, 30);
            
            // 绘制线圈支架底座
            ctx.fillStyle = '#95a5a6';
            ctx.fillRect(coil.x - 130, 400, 260, 10);
            
            // 绘制电流表底座
            ctx.fillRect(ammeter.x - 60, 400, 120, 10);
            
            // 绘制所有实验组件
            drawCoil();
            drawAmmeter();
            drawMagnet();
            drawFieldLines();
            drawCurrent();
            
            // 绘制标题和说明
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('法拉第电磁感应实验', 50, 50);
            
            ctx.font = '16px Arial';
            ctx.fillStyle = '#7f8c8d';
            ctx.fillText('磁铁运动 → 磁通量变化 → 感应电流', 50, 80);
        }
        
        // 动画循环
        function animate() {
            updateExperiment();
            draw();
            requestAnimationFrame(animate);
        }
        
        // 初始化函数
        function init() {
            initFieldLines();
            initCurrentParticles();
            updateStatusText();
            
            // 开始动画循环
            animate();
            
            // 设置事件监听器
            setupEventListeners();
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 插入线圈按钮
            document.getElementById('insertBtn').addEventListener('click', () => {
                if (isAutoMode) return;
                magnet.targetY = 350;
                magnet.isMoving = true;
                updateStatusText();
            });
            
            // 抽出线圈按钮
            document.getElementById('withdrawBtn').addEventListener('click', () => {
                if (isAutoMode) return;
                magnet.targetY = 250;
                magnet.isMoving = true;
                updateStatusText();
            });
            
            // 翻转磁极按钮
            document.getElementById('flipMagnetBtn').addEventListener('click', () => {
                if (isAutoMode) return;
                magnet.isNFirst = !magnet.isNFirst;
                updateStatusText(magnet.isNFirst ? 
                    "磁极已翻转：N极朝下" : 
                    "磁极已翻转：S极朝下");
            });
            
            // 重置按钮
            document.getElementById('resetBtn').addEventListener('click', () => {
                magnet.x = 150;
                magnet.y = 250;
                magnet.isNFirst = true;
                magnet.isInside = false;
                magnet.isMoving = false;
                magnet.targetY = 250;
                
                ammeter.current = 0;
                ammeter.needleAngle = 0;
                
                isAutoMode = false;
                autoDemoStep = 0;
                
                if (autoDemoTimer) {
                    clearInterval(autoDemoTimer);
                    autoDemoTimer = null;
                }
                
                document.getElementById('freeModeBtn').classList.add('active');
                document.getElementById('autoModeBtn').classList.remove('active');
                
                updateStatusText();
                initCurrentParticles();
            });
            
            // 显示/隐藏磁场按钮
            document.getElementById('toggleFieldBtn').addEventListener('click', function() {
                showFieldLines = !showFieldLines;
                this.classList.toggle('active');
                this.innerHTML = showFieldLines ? '<span>显示磁场</span>' : '<span>隐藏磁场</span>';
            });
            
            // 显示/隐藏电流按钮
            document.getElementById('toggleCurrentBtn').addEventListener('click', function() {
                showCurrent = !showCurrent;
                this.classList.toggle('active');
                this.innerHTML = showCurrent ? '<span>显示电流</span>' : '<span>隐藏电流</span>';
            });
            
            // 自由模式按钮
            document.getElementById('freeModeBtn').addEventListener('click', function() {
                isAutoMode = false;
                autoDemoStep = 0;
                
                this.classList.add('active');
                document.getElementById('autoModeBtn').classList.remove('active');
                
                if (autoDemoTimer) {
                    clearInterval(autoDemoTimer);
                    autoDemoTimer = null;
                }
                
                updateStatusText("自由模式：使用控制按钮操作实验。");
            });
            
            // 自动演示按钮
            document.getElementById('autoModeBtn').addEventListener('click', function() {
                isAutoMode = true;
                autoDemoStep = 0;
                
                this.classList.add('active');
                document.getElementById('freeModeBtn').classList.remove('active');
                
                // 重置实验
                magnet.x = 150;
                magnet.y = 250;
                magnet.isNFirst = true;
                magnet.isInside = false;
                magnet.isMoving = false;
                magnet.targetY = 250;
                
                ammeter.current = 0;
                ammeter.needleAngle = 0;
                
                updateStatusText("自动演示模式开始。将依次演示四种情况。");
                
                // 开始自动演示
                setTimeout(() => {
                    autoDemoStep = 1;
                    magnet.targetY = 350;
                    magnet.isMoving = true;
                }, 1000);
            });
            
            // 添加键盘控制
            document.addEventListener('keydown', (e) => {
                if (isAutoMode) return;
                
                switch(e.key) {
                    case 'ArrowUp':
                    case 'w':
                    case 'W':
                        e.preventDefault();
                        magnet.targetY = Math.max(150, magnet.y - 50);
                        magnet.isMoving = true;
                        updateStatusText();
                        break;
                        
                    case 'ArrowDown':
                    case 's':
                    case 'S':
                        e.preventDefault();
                        magnet.targetY = Math.min(450, magnet.y + 50);
                        magnet.isMoving = true;
                        updateStatusText();
                        break;
                        
                    case 'f':
                    case 'F':
                        e.preventDefault();
                        document.getElementById('flipMagnetBtn').click();
                        break;
                        
                    case 'r':
                    case 'R':
                        e.preventDefault();
                        document.getElementById('resetBtn').click();
                        break;
                        
                    case ' ':
                        e.preventDefault();
                        if (magnet.isInside) {
                            document.getElementById('withdrawBtn').click();
                        } else {
                            document.getElementById('insertBtn').click();
                        }
                        break;
                }
            });
            
            // 添加画布点击拖拽功能
            let isDragging = false;
            
            canvas.addEventListener('mousedown', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // 检查是否点击了磁铁
                if (x >= magnet.x - magnet.width/2 && x <= magnet.x + magnet.width/2 &&
                    y >= magnet.y - magnet.height/2 && y <= magnet.y + magnet.height/2) {
                    isDragging = true;
                }
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (!isDragging || isAutoMode) return;
                
                const rect = canvas.getBoundingClientRect();
                const y = e.clientY - rect.top;
                
                // 限制磁铁在合理范围内移动
                const newY = Math.max(150, Math.min(450, y));
                magnet.targetY = newY;
                magnet.isMoving = true;
                
                updateStatusText();
            });
            
            canvas.addEventListener('mouseup', () => {
                isDragging = false;
            });
            
            canvas.addEventListener('mouseleave', () => {
                isDragging = false;
            });
        }
        
        // 页面加载完成后初始化
        window.addEventListener('load', init);
    </script>
</body>
</html>