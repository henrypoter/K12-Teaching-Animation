<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸¦ç”µç²’å­åœ¨å¤åˆåœºä¸­çš„è¿åŠ¨ä¸é€Ÿåº¦é€‰æ‹©å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        header {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        h1 {
            color: #4fc3f7;
            margin-bottom: 10px;
            font-size: 2.5rem;
            text-shadow: 0 0 10px rgba(79, 195, 247, 0.5);
        }
        
        .subtitle {
            color: #b0bec5;
            font-size: 1.2rem;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .simulation-area {
            flex: 1;
            min-width: 700px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .canvas-container {
            position: relative;
            width: 100%;
            height: 500px;
            background: #0d1525;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        #simulationCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .control-panel {
            flex: 0 0 400px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .panel-section {
            background: rgba(30, 40, 60, 0.7);
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #4fc3f7;
        }
        
        .section-title {
            color: #4fc3f7;
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            font-size: 1.2rem;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #b0bec5;
        }
        
        .value-display {
            color: #4fc3f7;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            background: #2c3e50;
            border-radius: 4px;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #4fc3f7;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(79, 195, 247, 0.8);
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        button {
            padding: 12px 20px;
            background: linear-gradient(to right, #1565c0, #2196f3);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 120px;
        }
        
        button:hover {
            background: linear-gradient(to right, #0d47a1, #1976d2);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button.reset {
            background: linear-gradient(to right, #c62828, #f44336);
        }
        
        button.reset:hover {
            background: linear-gradient(to right, #b71c1c, #d32f2f);
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
        }
        
        .toggle-switch {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #2c3e50;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #4fc3f7;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .info-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }
        
        .info-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        
        .info-label {
            color: #b0bec5;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .info-value {
            color: #4fc3f7;
            font-weight: bold;
            font-size: 1.2rem;
            font-family: 'Courier New', monospace;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .legend-text {
            font-size: 0.9rem;
            color: #b0bec5;
        }
        
        .scene-selector {
            display: flex;
            background: rgba(30, 40, 60, 0.7);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .scene-btn {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: transparent;
            border: none;
            color: #b0bec5;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        .scene-btn.active {
            background: #4fc3f7;
            color: white;
        }
        
        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .preset-btn {
            padding: 10px;
            background: rgba(30, 40, 60, 0.9);
            border: 1px solid rgba(79, 195, 247, 0.3);
            color: #b0bec5;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .preset-btn:hover {
            background: rgba(79, 195, 247, 0.2);
            color: white;
            border-color: #4fc3f7;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #78909c;
            font-size: 0.9rem;
            margin-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
            }
            
            .simulation-area, .control-panel {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>âš¡ å¸¦ç”µç²’å­åœ¨å¤åˆåœºä¸­çš„è¿åŠ¨</h1>
            <p class="subtitle">ç”µåœº + ç£åœº | åè½¬è½¨è¿¹ | é€Ÿåº¦é€‰æ‹©å™¨ | äº¤äº’å¼æ•™å­¦åŠ¨ç”»</p>
        </header>
        
        <div class="scene-selector">
            <button class="scene-btn active" id="scene1Btn">å¤åˆåœºåè½¬</button>
            <button class="scene-btn" id="scene2Btn">é€Ÿåº¦é€‰æ‹©å™¨</button>
        </div>
        
        <div class="main-content">
            <div class="simulation-area">
                <div class="canvas-container">
                    <canvas id="simulationCanvas"></canvas>
                </div>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #ff5252;"></div>
                        <div class="legend-text">ç”µåœºåŠ› (Fâ‚‘)</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #448aff;"></div>
                        <div class="legend-text">æ´›ä¼¦å…¹åŠ› (Fâ‚˜)</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #ffeb3b;"></div>
                        <div class="legend-text">åˆåŠ› (F)</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #69f0ae;"></div>
                        <div class="legend-text">é€Ÿåº¦ (v)</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #ff9800;"></div>
                        <div class="legend-text">æ­£ç”µè·ç²’å­</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e040fb;"></div>
                        <div class="legend-text">è´Ÿç”µè·ç²’å­</div>
                    </div>
                </div>
            </div>
            
            <div class="control-panel">
                <div class="panel-section">
                    <h3 class="section-title">ğŸ® æ¨¡æ‹Ÿæ§åˆ¶</h3>
                    <div class="button-group">
                        <button id="playBtn">â–¶ æ’­æ”¾</button>
                        <button id="pauseBtn">â¸ æš‚åœ</button>
                        <button id="stepBtn">â­ å•æ­¥</button>
                        <button id="resetBtn" class="reset">â†º é‡ç½®</button>
                    </div>
                    
                    <div class="toggle-switch">
                        <span>æ˜¾ç¤ºè½¨è¿¹</span>
                        <label class="switch">
                            <input type="checkbox" id="showTrajectory" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="toggle-switch">
                        <span>æ˜¾ç¤ºçŸ¢é‡</span>
                        <label class="switch">
                            <input type="checkbox" id="showVectors" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="panel-section">
                    <h3 class="section-title">âš™ï¸ ç‰©ç†å‚æ•°</h3>
                    
                    <div class="control-group">
                        <div class="control-label">
                            <span>ç”µåœºå¼ºåº¦ E (N/C):</span>
                            <span class="value-display" id="eValue">1000</span>
                        </div>
                        <input type="range" id="eSlider" min="0" max="5000" step="100" value="1000">
                    </div>
                    
                    <div class="control-group">
                        <div class="control-label">
                            <span>ç£æ„Ÿåº”å¼ºåº¦ B (T):</span>
                            <span class="value-display" id="bValue">0.5</span>
                        </div>
                        <input type="range" id="bSlider" min="0" max="2" step="0.05" value="0.5">
                    </div>
                    
                    <div class="control-group">
                        <div class="control-label">
                            <span>ç²’å­ç”µè· q (C):</span>
                            <span class="value-display" id="qValue">+1.6e-19</span>
                        </div>
                        <input type="range" id="qSlider" min="-1.6e-19" max="1.6e-19" step="3.2e-20" value="1.6e-19">
                    </div>
                    
                    <div class="control-group">
                        <div class="control-label">
                            <span>ç²’å­è´¨é‡ m (kg):</span>
                            <span class="value-display" id="mValue">9.1e-31</span>
                        </div>
                        <input type="range" id="mSlider" min="1e-31" max="5e-30" step="1e-31" value="9.1e-31">
                    </div>
                    
                    <div class="control-group">
                        <div class="control-label">
                            <span>åˆé€Ÿåº¦ vâ‚€ (m/s):</span>
                            <span class="value-display" id="vValue">1e6</span>
                        </div>
                        <input type="range" id="vSlider" min="1e5" max="5e6" step="1e5" value="1e6">
                    </div>
                </div>
                
                <div class="panel-section">
                    <h3 class="section-title">ğŸš€ é¢„è®¾æ¡ˆä¾‹</h3>
                    <div class="preset-buttons">
                        <button class="preset-btn" data-preset="electric">ä»…ç”µåœºåè½¬</button>
                        <button class="preset-btn" data-preset="magnetic">ä»…ç£åœºåè½¬</button>
                        <button class="preset-btn" data-preset="selector">é€Ÿåº¦é€‰æ‹©å™¨</button>
                        <button class="preset-btn" data-preset="fast">é€Ÿåº¦ > E/B</button>
                        <button class="preset-btn" data-preset="slow">é€Ÿåº¦ < E/B</button>
                        <button class="preset-btn" data-preset="negative">è´Ÿç”µè·ç²’å­</button>
                    </div>
                </div>
                
                <div class="panel-section">
                    <h3 class="section-title">ğŸ“Š å®æ—¶æ•°æ®</h3>
                    <div class="info-panel">
                        <div class="info-item">
                            <div class="info-label">ä½ç½® (x, y)</div>
                            <div class="info-value" id="posValue">(0, 0)</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">é€Ÿåº¦ (m/s)</div>
                            <div class="info-value" id="speedValue">1.00e6</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ç”µåœºåŠ› (N)</div>
                            <div class="info-value" id="feValue">1.60e-16</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">æ´›ä¼¦å…¹åŠ› (N)</div>
                            <div class="info-value" id="fbValue">8.00e-14</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">v = E/B</div>
                            <div class="info-value" id="ebValue">2.00e6</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">çŠ¶æ€</div>
                            <div class="info-value" id="stateValue">è¿åŠ¨</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>ç‰©ç†æ•™å­¦äº¤äº’åŠ¨ç”» | å¸¦ç”µç²’å­åœ¨å¤åˆåœºä¸­çš„è¿åŠ¨ | è®¾è®¡ï¼šæ•™è‚²æŠ€æœ¯ä¸“å®¶</p>
        </footer>
    </div>

    <script>
        // è·å–Canvaså’Œä¸Šä¸‹æ–‡
        const canvas = document.getElementById('simulationCanvas');
        const ctx = canvas.getContext('2d');
        
        // è®¾ç½®Canvaså°ºå¯¸
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }
        
        // åˆå§‹è°ƒæ•´å°ºå¯¸
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // ç‰©ç†å‚æ•°
        let params = {
            E: 1000,        // ç”µåœºå¼ºåº¦ (N/C)
            B: 0.5,         // ç£æ„Ÿåº”å¼ºåº¦ (T)
            q: 1.6e-19,     // ç”µè·é‡ (C)
            m: 9.1e-31,     // è´¨é‡ (kg)
            v0: 1e6,        // åˆé€Ÿåº¦ (m/s)
            angle: 0,       // åˆé€Ÿåº¦è§’åº¦ (å¼§åº¦)
            
            // ç”µåœºæ–¹å‘ï¼šå‘ä¸‹ä¸ºæ­£ï¼ˆyè½´æ­£æ–¹å‘ï¼‰
            E_direction: { x: 0, y: 1 },
            // ç£åœºæ–¹å‘ï¼šå‚ç›´çº¸é¢å‘å¤–ï¼ˆzè½´æ­£æ–¹å‘ï¼‰
            B_direction: { x: 0, y: 0, z: 1 }
        };
        
        // ç²’å­çŠ¶æ€
        let particle = {
            x: 0,
            y: 0,
            vx: 0,
            vy: 0,
            ax: 0,
            ay: 0,
            trail: [],
            maxTrailLength: 200
        };
        
        // æ¨¡æ‹ŸçŠ¶æ€
        let simulation = {
            running: false,
            time: 0,
            dt: 1e-10,      // æ—¶é—´æ­¥é•¿ (s)
            scene: 1,       // 1: å¤åˆåœºåè½¬, 2: é€Ÿåº¦é€‰æ‹©å™¨
            showTrajectory: true,
            showVectors: true
        };
        
        // åˆå§‹åŒ–ç²’å­
        function initParticle() {
            particle.x = -canvas.width * 0.4;
            particle.y = 0;
            particle.vx = params.v0 * Math.cos(params.angle);
            particle.vy = params.v0 * Math.sin(params.angle);
            particle.trail = [];
            simulation.time = 0;
            
            // æ·»åŠ åˆå§‹ä½ç½®åˆ°è½¨è¿¹
            particle.trail.push({ x: particle.x, y: particle.y });
        }
        
        // è®¡ç®—åŠ›
        function calculateForces() {
            // ç”µåœºåŠ›: F_e = q * E
            const Fe_x = params.q * params.E * params.E_direction.x;
            const Fe_y = params.q * params.E * params.E_direction.y;
            
            // æ´›ä¼¦å…¹åŠ›: F_b = q * (v Ã— B)
            // v Ã— B = (vy*Bz - vz*By, vz*Bx - vx*Bz, vx*By - vy*Bx)
            // å‡è®¾ç£åœºåªæœ‰zåˆ†é‡ï¼Œé€Ÿåº¦åªæœ‰x,yåˆ†é‡
            const Bz = params.B * params.B_direction.z;
            const Fb_x = params.q * (particle.vy * Bz);
            const Fb_y = params.q * (-particle.vx * Bz);
            
            // åˆåŠ›
            const Fx = Fe_x + Fb_x;
            const Fy = Fe_y + Fb_y;
            
            // åŠ é€Ÿåº¦: a = F / m
            particle.ax = Fx / params.m;
            particle.ay = Fy / params.m;
            
            return {
                Fe: { x: Fe_x, y: Fe_y, magnitude: Math.sqrt(Fe_x*Fe_x + Fe_y*Fe_y) },
                Fb: { x: Fb_x, y: Fb_y, magnitude: Math.sqrt(Fb_x*Fb_x + Fb_y*Fb_y) },
                F: { x: Fx, y: Fy, magnitude: Math.sqrt(Fx*Fx + Fy*Fy) }
            };
        }
        
        // æ›´æ–°ç²’å­çŠ¶æ€
        function updateParticle() {
            if (!simulation.running) return;
            
            // è®¡ç®—åŠ›
            const forces = calculateForces();
            
            // æ›´æ–°é€Ÿåº¦ (v = v0 + a*t)
            particle.vx += particle.ax * simulation.dt;
            particle.vy += particle.ay * simulation.dt;
            
            // æ›´æ–°ä½ç½® (x = x0 + v*t)
            particle.x += particle.vx * simulation.dt;
            particle.y += particle.vy * simulation.dt;
            
            // æ·»åŠ ä½ç½®åˆ°è½¨è¿¹
            particle.trail.push({ x: particle.x, y: particle.y });
            
            // é™åˆ¶è½¨è¿¹é•¿åº¦
            if (particle.trail.length > particle.maxTrailLength) {
                particle.trail.shift();
            }
            
            // æ›´æ–°æ—¶é—´
            simulation.time += simulation.dt;
            
            // å¦‚æœç²’å­é£å‡ºç”»å¸ƒï¼Œé‡ç½®
            if (Math.abs(particle.x) > canvas.width * 0.6 || Math.abs(particle.y) > canvas.height * 0.6) {
                initParticle();
            }
            
            // æ›´æ–°æ•°æ®æ˜¾ç¤º
            updateDisplay(forces);
        }
        
        // æ›´æ–°æ•°æ®æ˜¾ç¤º
        function updateDisplay(forces) {
            // æ›´æ–°å‚æ•°æ˜¾ç¤º
            document.getElementById('eValue').textContent = params.E.toFixed(0);
            document.getElementById('bValue').textContent = params.B.toFixed(2);
            document.getElementById('qValue').textContent = params.q.toExponential(2);
            document.getElementById('mValue').textContent = params.m.toExponential(2);
            document.getElementById('vValue').textContent = (params.v0 / 1e6).toFixed(2) + 'e6';
            
            // æ›´æ–°å®æ—¶æ•°æ®
            const speed = Math.sqrt(particle.vx*particle.vx + particle.vy*particle.vy);
            document.getElementById('posValue').textContent = 
                `(${(particle.x * 1e3).toFixed(2)}, ${(particle.y * 1e3).toFixed(2)}) mm`;
            document.getElementById('speedValue').textContent = (speed / 1e6).toFixed(2) + 'e6';
            document.getElementById('feValue').textContent = forces.Fe.magnitude.toExponential(2);
            document.getElementById('fbValue').textContent = forces.Fb.magnitude.toExponential(2);
            
            // è®¡ç®— v = E/B
            const v_EB = params.B !== 0 ? Math.abs(params.E / params.B) : Infinity;
            document.getElementById('ebValue').textContent = 
                params.B !== 0 ? (v_EB / 1e6).toFixed(2) + 'e6' : 'âˆ';
            
            // æ›´æ–°çŠ¶æ€
            if (simulation.scene === 2) {
                const diff = Math.abs(speed - v_EB) / v_EB;
                if (diff < 0.05) {
                    document.getElementById('stateValue').textContent = 'é€šè¿‡';
                    document.getElementById('stateValue').style.color = '#69f0ae';
                } else if (speed > v_EB) {
                    document.getElementById('stateValue').textContent = 'åè½¬';
                    document.getElementById('stateValue').style.color = '#ff5252';
                } else {
                    document.getElementById('stateValue').textContent = 'åè½¬';
                    document.getElementById('stateValue').style.color = '#448aff';
                }
            } else {
                document.getElementById('stateValue').textContent = 'è¿åŠ¨';
                document.getElementById('stateValue').style.color = '#ffeb3b';
            }
        }
        
        // ç»˜åˆ¶åœºæ™¯
        function drawScene() {
            // æ¸…é™¤ç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶ç½‘æ ¼èƒŒæ™¯
            drawGrid();
            
            // ç»˜åˆ¶åœºæŒ‡ç¤º
            drawFieldIndicators();
            
            // ç»˜åˆ¶é€Ÿåº¦é€‰æ‹©å™¨é€šé“ï¼ˆå¦‚æœåœºæ™¯2ï¼‰
            if (simulation.scene === 2) {
                drawVelocitySelector();
            }
            
            // ç»˜åˆ¶ç²’å­è½¨è¿¹
            if (simulation.showTrajectory && particle.trail.length > 1) {
                drawTrajectory();
            }
            
            // ç»˜åˆ¶ç²’å­
            drawParticle();
            
            // ç»˜åˆ¶åŠ›çŸ¢é‡
            if (simulation.showVectors) {
                drawForceVectors();
            }
            
            // ç»˜åˆ¶åæ ‡è½´
            drawAxes();
            
            // ç»˜åˆ¶åœºæ™¯æ ‡é¢˜
            drawSceneTitle();
        }
        
        // ç»˜åˆ¶ç½‘æ ¼
        function drawGrid() {
            const gridSize = 50;
            const offsetX = canvas.width / 2;
            const offsetY = canvas.height / 2;
            
            ctx.strokeStyle = 'rgba(100, 100, 150, 0.2)';
            ctx.lineWidth = 1;
            
            // å‚ç›´çº¿
            for (let x = -offsetX; x <= offsetX; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x + offsetX, 0);
                ctx.lineTo(x + offsetX, canvas.height);
                ctx.stroke();
            }
            
            // æ°´å¹³çº¿
            for (let y = -offsetY; y <= offsetY; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y + offsetY);
                ctx.lineTo(canvas.width, y + offsetY);
                ctx.stroke();
            }
        }
        
        // ç»˜åˆ¶åœºæŒ‡ç¤º
        function drawFieldIndicators() {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            // ç»˜åˆ¶ç”µåœºæŒ‡ç¤ºï¼ˆç®­å¤´å‘ä¸‹è¡¨ç¤ºç”µåœºæ–¹å‘ï¼‰
            if (params.E > 0) {
                ctx.fillStyle = 'rgba(255, 82, 82, 0.3)';
                ctx.strokeStyle = '#ff5252';
                ctx.lineWidth = 2;
                
                // ç”µåœºåŒºåŸŸ
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // ç”µåœºç®­å¤´
                const arrowCount = 10;
                const arrowSpacing = canvas.width / (arrowCount + 1);
                
                for (let i = 1; i <= arrowCount; i++) {
                    const x = i * arrowSpacing;
                    drawArrow(x, 30, x, 70, 10, '#ff5252');
                }
                
                // ç”µåœºæ ‡ç­¾
                ctx.fillStyle = '#ff5252';
                ctx.font = 'bold 16px Arial';
                ctx.fillText('E', canvas.width - 40, 50);
            }
            
            // ç»˜åˆ¶ç£åœºæŒ‡ç¤ºï¼ˆÃ—è¡¨ç¤ºå‚ç›´çº¸é¢å‘å¤–ï¼‰
            if (params.B > 0) {
                ctx.fillStyle = 'rgba(68, 138, 255, 0.1)';
                ctx.strokeStyle = '#448aff';
                ctx.lineWidth = 2;
                
                // ç£åœºç¬¦å·
                const symbolSize = 20;
                const symbolSpacing = 60;
                
                for (let x = symbolSpacing; x < canvas.width; x += symbolSpacing) {
                    for (let y = symbolSpacing; y < canvas.height; y += symbolSpacing) {
                        drawCircleWithDot(x, y, symbolSize / 2, '#448aff');
                    }
                }
                
                // ç£åœºæ ‡ç­¾
                ctx.fillStyle = '#448aff';
                ctx.font = 'bold 16px Arial';
                ctx.fillText('B âŠ™', canvas.width - 50, canvas.height - 30);
            }
        }
        
        // ç»˜åˆ¶é€Ÿåº¦é€‰æ‹©å™¨é€šé“
        function drawVelocitySelector() {
            const centerY = canvas.height / 2;
            const channelWidth = 80;
            
            // é€šé“èƒŒæ™¯
            ctx.fillStyle = 'rgba(100, 255, 100, 0.1)';
            ctx.fillRect(0, centerY - channelWidth/2, canvas.width, channelWidth);
            
            // é€šé“è¾¹ç•Œ
            ctx.strokeStyle = '#69f0ae';
            ctx.lineWidth = 3;
            ctx.setLineDash([10, 5]);
            ctx.beginPath();
            ctx.moveTo(0, centerY - channelWidth/2);
            ctx.lineTo(canvas.width, centerY - channelWidth/2);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(0, centerY + channelWidth/2);
            ctx.lineTo(canvas.width, centerY + channelWidth/2);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // é€šé“æ ‡ç­¾
            ctx.fillStyle = '#69f0ae';
            ctx.font = 'bold 18px Arial';
            ctx.fillText('é€Ÿåº¦é€‰æ‹©å™¨é€šé“', canvas.width / 2 - 70, centerY - channelWidth/2 - 10);
            
            // æ˜¾ç¤ºé€‰æ‹©æ¡ä»¶
            const v_EB = params.B !== 0 ? Math.abs(params.E / params.B) : Infinity;
            ctx.fillStyle = '#ffffff';
            ctx.font = '16px Arial';
            ctx.fillText(`é€‰æ‹©æ¡ä»¶: v = E/B = ${(v_EB/1e6).toFixed(2)}Ã—10â¶ m/s`, 
                        canvas.width / 2 - 120, centerY + channelWidth/2 + 25);
        }
        
        // ç»˜åˆ¶ç²’å­è½¨è¿¹
        function drawTrajectory() {
            if (particle.trail.length < 2) return;
            
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.7)';
            ctx.lineWidth = 2;
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            
            ctx.beginPath();
            ctx.moveTo(
                canvas.width / 2 + particle.trail[0].x,
                canvas.height / 2 + particle.trail[0].y
            );
            
            for (let i = 1; i < particle.trail.length; i++) {
                ctx.lineTo(
                    canvas.width / 2 + particle.trail[i].x,
                    canvas.height / 2 + particle.trail[i].y
                );
            }
            
            ctx.stroke();
        }
        
        // ç»˜åˆ¶ç²’å­
        function drawParticle() {
            const screenX = canvas.width / 2 + particle.x;
            const screenY = canvas.height / 2 + particle.y;
            
            // ç²’å­é¢œè‰²åŸºäºç”µè·
            const particleColor = params.q >= 0 ? '#ff9800' : '#e040fb';
            
            // ç»˜åˆ¶ç²’å­ï¼ˆå‘å…‰æ•ˆæœï¼‰
            const gradient = ctx.createRadialGradient(
                screenX, screenY, 0,
                screenX, screenY, 15
            );
            gradient.addColorStop(0, particleColor);
            gradient.addColorStop(0.7, particleColor + 'cc');
            gradient.addColorStop(1, particleColor + '00');
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(screenX, screenY, 10, 0, Math.PI * 2);
            ctx.fill();
            
            // ç²’å­è¾¹æ¡†
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(screenX, screenY, 10, 0, Math.PI * 2);
            ctx.stroke();
            
            // ç”µè·ç¬¦å·
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(params.q >= 0 ? '+' : '-', screenX, screenY);
        }
        
        // ç»˜åˆ¶åŠ›çŸ¢é‡
        function drawForceVectors() {
            const forces = calculateForces();
            const screenX = canvas.width / 2 + particle.x;
            const screenY = canvas.height / 2 + particle.y;
            
            // ç¼©æ”¾å› å­
            const forceScale = 1e15; // æ”¾å¤§æ˜¾ç¤º
            
            // ç»˜åˆ¶ç”µåœºåŠ›çŸ¢é‡ï¼ˆçº¢è‰²ï¼‰
            if (forces.Fe.magnitude > 0) {
                drawArrow(
                    screenX, screenY,
                    screenX + forces.Fe.x * forceScale,
                    screenY + forces.Fe.y * forceScale,
                    10, '#ff5252'
                );
            }
            
            // ç»˜åˆ¶æ´›ä¼¦å…¹åŠ›çŸ¢é‡ï¼ˆè“è‰²ï¼‰
            if (forces.Fb.magnitude > 0) {
                drawArrow(
                    screenX, screenY,
                    screenX + forces.Fb.x * forceScale,
                    screenY + forces.Fb.y * forceScale,
                    10, '#448aff'
                );
            }
            
            // ç»˜åˆ¶åˆåŠ›çŸ¢é‡ï¼ˆé»„è‰²ï¼‰
            if (forces.F.magnitude > 0) {
                drawArrow(
                    screenX, screenY,
                    screenX + forces.F.x * forceScale,
                    screenY + forces.F.y * forceScale,
                    12, '#ffeb3b'
                );
            }
            
            // ç»˜åˆ¶é€Ÿåº¦çŸ¢é‡ï¼ˆç»¿è‰²ï¼‰
            const speedScale = 1e-7; // ç¼©æ”¾é€Ÿåº¦çŸ¢é‡
            drawArrow(
                screenX, screenY,
                screenX + particle.vx * speedScale,
                screenY + particle.vy * speedScale,
                8, '#69f0ae'
            );
        }
        
        // ç»˜åˆ¶åæ ‡è½´
        function drawAxes() {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.lineWidth = 2;
            
            // xè½´
            ctx.beginPath();
            ctx.moveTo(0, centerY);
            ctx.lineTo(canvas.width, centerY);
            ctx.stroke();
            
            // yè½´
            ctx.beginPath();
            ctx.moveTo(centerX, 0);
            ctx.lineTo(centerX, canvas.height);
            ctx.stroke();
            
            // åæ ‡è½´æ ‡ç­¾
            ctx.fillStyle = '#ffffff';
            ctx.font = '14px Arial';
            ctx.fillText('x', canvas.width - 20, centerY - 10);
            ctx.fillText('
<!--æ£€æµ‹åˆ°ä»£ç æˆªæ–­ï¼Œè‡ªåŠ¨ç»­å†™ä¸­...-->
'y', centerX + 10, 20);
        }
        
        // ç»˜åˆ¶åœºæ™¯æ ‡é¢˜
        function drawSceneTitle() {
            ctx.fillStyle = '#4fc3f7';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            
            if (simulation.scene === 1) {
                ctx.fillText('å¤åˆåœºåè½¬', 20, 20);
                ctx.font = '16px Arial';
                ctx.fillStyle = '#b0bec5';
                ctx.fillText('ç”µåœºåŠ› + æ´›ä¼¦å…¹åŠ› = å¤æ‚è½¨è¿¹', 20, 50);
            } else {
                ctx.fillText('é€Ÿåº¦é€‰æ‹©å™¨', 20, 20);
                ctx.font = '16px Arial';
                ctx.fillStyle = '#b0bec5';
                ctx.fillText('å½“ v = E/B æ—¶ï¼Œç²’å­å—åŠ›å¹³è¡¡ï¼Œç›´çº¿é€šè¿‡', 20, 50);
            }
        }
        
        // ç»˜åˆ¶ç®­å¤´
        function drawArrow(fromX, fromY, toX, toY, headSize, color) {
            const angle = Math.atan2(toY - fromY, toX - fromX);
            const length = Math.sqrt((toX - fromX)**2 + (toY - fromY)**2);
            
            if (length < 5) return; // å¤ªçŸ­ä¸ç»˜åˆ¶
            
            ctx.strokeStyle = color;
            ctx.fillStyle = color;
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            
            // ç»˜åˆ¶ç®­å¤´çº¿
            ctx.beginPath();
            ctx.moveTo(fromX, fromY);
            ctx.lineTo(toX, toY);
            ctx.stroke();
            
            // ç»˜åˆ¶ç®­å¤´å¤´éƒ¨
            ctx.beginPath();
            ctx.moveTo(toX, toY);
            ctx.lineTo(
                toX - headSize * Math.cos(angle - Math.PI/6),
                toY - headSize * Math.sin(angle - Math.PI/6)
            );
            ctx.lineTo(
                toX - headSize * Math.cos(angle + Math.PI/6),
                toY - headSize * Math.sin(angle + Math.PI/6)
            );
            ctx.closePath();
            ctx.fill();
        }
        
        // ç»˜åˆ¶å¸¦ç‚¹çš„åœ†ï¼ˆè¡¨ç¤ºå‚ç›´çº¸é¢å‘å¤–çš„ç£åœºï¼‰
        function drawCircleWithDot(x, y, radius, color) {
            ctx.strokeStyle = color;
            ctx.fillStyle = color;
            ctx.lineWidth = 2;
            
            // ç»˜åˆ¶åœ†
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.stroke();
            
            // ç»˜åˆ¶ä¸­å¿ƒç‚¹
            ctx.beginPath();
            ctx.arc(x, y, radius/3, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // åŠ¨ç”»å¾ªç¯
        function animate() {
            updateParticle();
            drawScene();
            requestAnimationFrame(animate);
        }
        
        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initEventListeners() {
            // åœºæ™¯åˆ‡æ¢
            document.getElementById('scene1Btn').addEventListener('click', () => {
                document.getElementById('scene1Btn').classList.add('active');
                document.getElementById('scene2Btn').classList.remove('active');
                simulation.scene = 1;
                initParticle();
            });
            
            document.getElementById('scene2Btn').addEventListener('click', () => {
                document.getElementById('scene2Btn').classList.add('active');
                document.getElementById('scene1Btn').classList.remove('active');
                simulation.scene = 2;
                initParticle();
            });
            
            // æ¨¡æ‹Ÿæ§åˆ¶æŒ‰é’®
            document.getElementById('playBtn').addEventListener('click', () => {
                simulation.running = true;
            });
            
            document.getElementById('pauseBtn').addEventListener('click', () => {
                simulation.running = false;
            });
            
            document.getElementById('stepBtn').addEventListener('click', () => {
                simulation.running = false;
                updateParticle();
                drawScene();
            });
            
            document.getElementById('resetBtn').addEventListener('click', () => {
                initParticle();
                simulation.running = false;
            });
            
            // åˆ‡æ¢å¼€å…³
            document.getElementById('showTrajectory').addEventListener('change', (e) => {
                simulation.showTrajectory = e.target.checked;
            });
            
            document.getElementById('showVectors').addEventListener('change', (e) => {
                simulation.showVectors = e.target.checked;
            });
            
            // å‚æ•°æ»‘å—
            document.getElementById('eSlider').addEventListener('input', (e) => {
                params.E = parseFloat(e.target.value);
                initParticle();
            });
            
            document.getElementById('bSlider').addEventListener('input', (e) => {
                params.B = parseFloat(e.target.value);
                initParticle();
            });
            
            document.getElementById('qSlider').addEventListener('input', (e) => {
                params.q = parseFloat(e.target.value);
                initParticle();
            });
            
            document.getElementById('mSlider').addEventListener('input', (e) => {
                params.m = parseFloat(e.target.value);
                initParticle();
            });
            
            document.getElementById('vSlider').addEventListener('input', (e) => {
                params.v0 = parseFloat(e.target.value);
                initParticle();
            });
            
            // é¢„è®¾æ¡ˆä¾‹æŒ‰é’®
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const preset = btn.dataset.preset;
                    
                    switch(preset) {
                        case 'electric':
                            params.E = 2000;
                            params.B = 0;
                            params.q = 1.6e-19;
                            params.v0 = 1e6;
                            break;
                        case 'magnetic':
                            params.E = 0;
                            params.B = 0.8;
                            params.q = 1.6e-19;
                            params.v0 = 1e6;
                            break;
                        case 'selector':
                            params.E = 1000;
                            params.B = 0.5;
                            params.q = 1.6e-19;
                            params.v0 = params.E / params.B; // v = E/B
                            simulation.scene = 2;
                            document.getElementById('scene2Btn').classList.add('active');
                            document.getElementById('scene1Btn').classList.remove('active');
                            break;
                        case 'fast':
                            params.E = 1000;
                            params.B = 0.5;
                            params.q = 1.6e-19;
                            params.v0 = 3e6; // > E/B
                            simulation.scene = 2;
                            document.getElementById('scene2Btn').classList.add('active');
                            document.getElementById('scene1Btn').classList.remove('active');
                            break;
                        case 'slow':
                            params.E = 1000;
                            params.B = 0.5;
                            params.q = 1.6e-19;
                            params.v0 = 0.5e6; // < E/B
                            simulation.scene = 2;
                            document.getElementById('scene2Btn').classList.add('active');
                            document.getElementById('scene1Btn').classList.remove('active');
                            break;
                        case 'negative':
                            params.E = 1000;
                            params.B = 0.5;
                            params.q = -1.6e-19;
                            params.v0 = 1e6;
                            break;
                    }
                    
                    // æ›´æ–°æ»‘å—å€¼
                    document.getElementById('eSlider').value = params.E;
                    document.getElementById('bSlider').value = params.B;
                    document.getElementById('qSlider').value = params.q;
                    document.getElementById('vSlider').value = params.v0;
                    
                    initParticle();
                });
            });
        }
        
        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            initParticle();
            initEventListeners();
            animate();
            
            // åˆå§‹æ›´æ–°æ˜¾ç¤º
            updateDisplay(calculateForces());
        }
        
        // å¯åŠ¨åº”ç”¨
        window.addEventListener('load', initApp);
    </script>
</body>
</html>