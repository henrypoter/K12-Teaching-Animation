<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼¦ç´å‘ç°Xå°„çº¿ - äº¤äº’å¼æ•™å­¦åŠ¨ç”»</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0a0e17 0%, #1a1f2e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            max-width: 900px;
            width: 100%;
        }

        h1 {
            color: #4fc3f7;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(79, 195, 247, 0.3);
        }

        .subtitle {
            color: #b0bec5;
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 25px;
            max-width: 1100px;
            width: 100%;
        }

        .animation-area {
            background-color: rgba(25, 30, 45, 0.8);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(79, 195, 247, 0.1);
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        #animationCanvas {
            display: block;
            width: 100%;
            height: 500px;
            background-color: transparent;
        }

        .control-panel {
            background-color: rgba(30, 35, 55, 0.9);
            border-radius: 15px;
            padding: 25px;
            width: 100%;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .step-info {
            background-color: rgba(40, 45, 70, 0.7);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            border-left: 5px solid #4fc3f7;
            min-height: 100px;
            display: flex;
            align-items: center;
        }

        .step-text {
            font-size: 1.3rem;
            line-height: 1.6;
        }

        .highlight {
            color: #4fc3f7;
            font-weight: bold;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 25px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 140px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2196f3 0%, #0d47a1 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.5);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #455a64 0%, #263238 100%);
            color: white;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #546e7a 0%, #37474f 100%);
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .explore-panel {
            background-color: rgba(40, 45, 70, 0.7);
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            border-top: 2px dashed rgba(79, 195, 247, 0.3);
        }

        .explore-title {
            color: #ff9800;
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .slider-item {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .slider-label {
            min-width: 120px;
            font-weight: 600;
        }

        .slider-value {
            min-width: 50px;
            text-align: center;
            color: #4fc3f7;
            font-weight: bold;
        }

        input[type="range"] {
            flex-grow: 1;
            height: 8px;
            -webkit-appearance: none;
            background: linear-gradient(to right, #1565c0, #e91e63);
            border-radius: 4px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .target-selector {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        select {
            padding: 10px 15px;
            border-radius: 8px;
            background-color: #263238;
            color: white;
            border: 1px solid #546e7a;
            font-size: 1rem;
            cursor: pointer;
            flex-grow: 1;
        }

        .legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .legend-text {
            font-size: 0.9rem;
        }

        .footer {
            margin-top: 30px;
            text-align: center;
            color: #78909c;
            font-size: 0.9rem;
            max-width: 900px;
            width: 100%;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        @media (max-width: 768px) {
            .container {
                gap: 15px;
            }
            
            .animation-area {
                padding: 10px;
            }
            
            #animationCanvas {
                height: 400px;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }
            
            .slider-item {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ä¼¦ç´å‘ç°Xå°„çº¿</h1>
        <div class="subtitle">äº¤äº’å¼æ•™å­¦åŠ¨ç”»ï¼šé˜´æå°„çº¿æ’å‡»é˜³æäº§ç”ŸXå°„çº¿çš„è¿‡ç¨‹</div>
    </div>
    
    <div class="container">
        <div class="animation-area">
            <canvas id="animationCanvas"></canvas>
        </div>
        
        <div class="control-panel">
            <div class="step-info">
                <div class="step-text" id="stepText">ç‚¹å‡»"å¼€å§‹å®éªŒ"æŒ‰é’®ï¼Œé‡ç°ä¼¦ç´å‘ç°Xå°„çº¿çš„å†å²æ€§æ—¶åˆ»ã€‚</div>
            </div>
            
            <div class="controls">
                <button id="resetBtn" class="btn btn-secondary">
                    <span>ğŸ”</span> é‡ç½®
                </button>
                <button id="prevBtn" class="btn btn-secondary" disabled>
                    <span>â—€</span> ä¸Šä¸€æ­¥
                </button>
                <button id="nextBtn" class="btn btn-primary">
                    <span>â–¶</span> å¼€å§‹å®éªŒ
                </button>
                <button id="autoBtn" class="btn btn-primary">
                    <span>âµ</span> è‡ªåŠ¨æ’­æ”¾
                </button>
            </div>
            
            <div class="explore-panel">
                <div class="explore-title">
                    <span>âš™ï¸</span> æ¢ç´¢æ¨¡å¼ï¼šè°ƒèŠ‚å®éªŒå‚æ•°
                </div>
                
                <div class="slider-container">
                    <div class="slider-item">
                        <div class="slider-label">ç”µå‹ (kV):</div>
                        <input type="range" id="voltageSlider" min="20" max="100" value="50" step="10">
                        <div class="slider-value" id="voltageValue">50</div>
                    </div>
                </div>
                
                <div class="target-selector">
                    <div class="slider-label">é˜³æé¶æ:</div>
                    <select id="targetSelect">
                        <option value="tungsten">é’¨ (å†å²ä½¿ç”¨)</option>
                        <option value="copper">é“œ</option>
                        <option value="molybdenum">é’¼</option>
                    </select>
                </div>
            </div>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #4fc3f7;"></div>
                    <div class="legend-text">ç”µå­ / é˜´æå°„çº¿</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ff4081;"></div>
                    <div class="legend-text">Xå°„çº¿</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #cddc39;"></div>
                    <div class="legend-text">è§å…‰å±</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #b0bec5;"></div>
                    <div class="legend-text">é˜³æé¶æ</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <p>æ•™å­¦åŠ¨ç”»è®¾è®¡ï¼šæ¨¡æ‹Ÿ1895å¹´å¨å»‰Â·åº·æ‹‰å¾·Â·ä¼¦ç´å‘ç°Xå°„çº¿çš„å…³é”®å®éªŒ | äº¤äº’å¼ç§‘å­¦æ•™è‚²å·¥å…·</p>
    </div>

    <script>
        // è·å–Canvaså’Œä¸Šä¸‹æ–‡
        const canvas = document.getElementById('animationCanvas');
        const ctx = canvas.getContext('2d');
        
        // è®¾ç½®Canvaså°ºå¯¸
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }
        
        // åˆå§‹è°ƒæ•´å°ºå¯¸
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // å®éªŒçŠ¶æ€
        const experimentState = {
            currentStep: 0,
            totalSteps: 5,
            isAutoPlaying: false,
            voltage: 50, // kV
            targetMaterial: 'tungsten',
            animationTime: 0
        };
        
        // æ­¥éª¤æè¿°
        const stepDescriptions = [
            "å®éªŒå‡†å¤‡ï¼šè¿™æ˜¯ä¸€ä¸ªé«˜åº¦çœŸç©ºçš„ç»ç’ƒç®¡ã€‚å·¦ä¾§æ˜¯<span class='highlight'>é˜´æ</span>ï¼Œå³ä¾§æ˜¯<span class='highlight'>é˜³æï¼ˆé¶æï¼‰</span>ã€‚å‰æ–¹æ”¾ç½®äº†æ¶‚æœ‰æ°°äºšé“‚é…¸é’¡çš„<span class='highlight'>è§å…‰å±</span>ã€‚",
            "æ¥é€šé«˜å‹ç”µæºï¼šåœ¨é˜´æå’Œé˜³æä¹‹é—´æ–½åŠ é«˜ç”µå‹ï¼ˆ<span class='highlight'>" + experimentState.voltage + " kV</span>ï¼‰ï¼Œé˜´æè¢«åŠ çƒ­å¹¶å¼€å§‹å‘å°„ç”µå­ã€‚",
            "äº§ç”Ÿé˜´æå°„çº¿ï¼šç”µå­åœ¨ç”µåœºä¸­åŠ é€Ÿï¼Œå½¢æˆé«˜é€Ÿç”µå­æµâ€”â€”<span class='highlight'>é˜´æå°„çº¿</span>ã€‚é˜´æå°„çº¿æ’å‡»ç»ç’ƒç®¡å£ï¼Œäº§ç”Ÿå¾®å¼±è§å…‰ã€‚",
            "æ’å‡»é˜³æäº§ç”ŸXå°„çº¿ï¼šé«˜é€Ÿç”µå­æµæ’å‡»<span class='highlight'>" + (experimentState.targetMaterial === 'tungsten' ? 'é’¨' : experimentState.targetMaterial === 'copper' ? 'é“œ' : 'é’¼') + "</span>é˜³æé¶æï¼Œç”µå­çªç„¶å‡é€Ÿï¼Œéƒ¨åˆ†èƒ½é‡è½¬åŒ–ä¸ºä¸€ç§æ–°çš„è¾å°„â€”â€”<span class='highlight'>Xå°„çº¿</span>ï¼",
            "å‘ç°Xå°„çº¿ï¼šXå°„çº¿ç©¿é€ç»ç’ƒç®¡å£ï¼Œç…§å°„åˆ°å‰æ–¹çš„è§å…‰å±ä¸Šï¼Œä½¿å…¶å‘å‡ºæ˜äº®çš„<span class='highlight'>é»„ç»¿è‰²è§å…‰</span>ï¼è¿™å°±æ˜¯ä¼¦ç´åœ¨1895å¹´å‘ç°çš„æœªçŸ¥å°„çº¿ï¼ˆXå°„çº¿ï¼‰ã€‚"
        ];
        
        // æ›´æ–°æ­¥éª¤æ–‡æœ¬
        function updateStepText() {
            const stepTextElement = document.getElementById('stepText');
            stepTextElement.innerHTML = stepDescriptions[experimentState.currentStep];
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('prevBtn').disabled = experimentState.currentStep === 0;
            document.getElementById('nextBtn').disabled = experimentState.currentStep === experimentState.totalSteps - 1;
            
            // æ›´æ–°ä¸‹ä¸€æ­¥æŒ‰é’®æ–‡æœ¬
            if (experimentState.currentStep === 0) {
                document.getElementById('nextBtn').innerHTML = '<span>â–¶</span> å¼€å§‹å®éªŒ';
            } else if (experimentState.currentStep === experimentState.totalSteps - 1) {
                document.getElementById('nextBtn').innerHTML = '<span>âœ…</span> å®éªŒå®Œæˆ';
            } else {
                document.getElementById('nextBtn').innerHTML = '<span>â–¶</span> ä¸‹ä¸€æ­¥';
            }
        }
        
        // å®éªŒç»„ä»¶å‚æ•°
        const components = {
            // é˜´æå°„çº¿ç®¡
            tube: {
                x: 0,
                y: 0,
                width: 0,
                height: 0,
                glassColor: 'rgba(180, 200, 220, 0.15)',
                glassBorderColor: 'rgba(200, 220, 240, 0.3)'
            },
            
            // é˜´æ
            cathode: {
                x: 0,
                y: 0,
                width: 0,
                height: 0,
                color: '#1e88e5',
                isHeated: false,
                temperature: 0
            },
            
            // é˜³æï¼ˆé¶æï¼‰
            anode: {
                x: 0,
                y: 0,
                width: 0,
                height: 0,
                color: '#b0bec5',
                isHit: false,
                hitTime: 0
            },
            
            // è§å…‰å±
            screen: {
                x: 0,
                y: 0,
                width: 0,
                height: 0,
                color: 'rgba(205, 220, 57, 0.1)',
                isLit: false,
                brightness: 0
            },
            
            // ç”µå­
            electrons: [],
            
            // Xå°„çº¿å…‰å­
            xrayPhotons: []
        };
        
        // åˆå§‹åŒ–ç»„ä»¶å°ºå¯¸å’Œä½ç½®
        function initComponents() {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const tubeWidth = canvas.width * 0.7;
            const tubeHeight = canvas.height * 0.4;
            
            // å°„çº¿ç®¡
            components.tube.x = centerX - tubeWidth / 2;
            components.tube.y = centerY - tubeHeight / 2;
            components.tube.width = tubeWidth;
            components.tube.height = tubeHeight;
            
            // é˜´æï¼ˆå·¦ä¾§ï¼‰
            components.cathode.width = tubeWidth * 0.08;
            components.cathode.height = tubeHeight * 0.6;
            components.cathode.x = components.tube.x + tubeWidth * 0.15;
            components.cathode.y = centerY - components.cathode.height / 2;
            
            // é˜³æï¼ˆå³ä¾§é¶æï¼‰
            components.anode.width = tubeWidth * 0.1;
            components.anode.height = tubeHeight * 0.7;
            components.anode.x = components.tube.x + tubeWidth * 0.75;
            components.anode.y = centerY - components.anode.height / 2;
            
            // è§å…‰å±ï¼ˆå³ä¾§å¤–éƒ¨ï¼‰
            components.screen.width = tubeWidth * 0.25;
            components.screen.height = tubeHeight * 0.9;
            components.screen.x = components.tube.x + tubeWidth * 0.9;
            components.screen.y = centerY - components.screen.height / 2;
            
            // æ¸…ç©ºç”µå­å’Œå…‰å­
            components.electrons = [];
            components.xrayPhotons = [];
        }
        
        // åˆ›å»ºç”µå­
        function createElectron() {
            if (experimentState.currentStep < 2) return;
            
            const speedFactor = experimentState.voltage / 50; // åŸºäºç”µå‹çš„é€Ÿåº¦å› å­
            
            return {
                x: components.cathode.x + components.cathode.width,
                y: components.cathode.y + components.cathode.height / 2 + (Math.random() - 0.5) * components.cathode.height * 0.5,
                radius: 4,
                color: '#4fc3f7',
                speed: 3 + speedFactor * 2,
                trail: [],
                maxTrailLength: 15,
                isActive: true,
                hitAnode: false
            };
        }
        
        // åˆ›å»ºXå°„çº¿å…‰å­
        function createXRayPhoton(sourceX, sourceY, angle) {
            const intensityFactor = experimentState.voltage / 50; // åŸºäºç”µå‹çš„å¼ºåº¦å› å­
            
            return {
                x: sourceX,
                y: sourceY,
                radius: 3,
                color: '#ff4081',
                speed: 8 + intensityFactor * 2,
                angle: angle,
                life: 1.0, // ç”Ÿå‘½å‘¨æœŸ (0åˆ°1)
                decayRate: 0.02 + (1 - intensityFactor) * 0.01
            };
        }
        
        // ç»˜åˆ¶é˜´æå°„çº¿ç®¡
        function drawTube() {
            const t = components.tube;
            
            // ç»ç’ƒç®¡
            ctx.beginPath();
            ctx.roundRect(t.x, t.y, t.width, t.height, 20);
            ctx.fillStyle = t.glassColor;
            ctx.fill();
            ctx.strokeStyle = t.glassBorderColor;
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // çœŸç©ºæ ‡ç­¾
            ctx.fillStyle = 'rgba(200, 220, 240, 0.6)';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('é«˜åº¦çœŸç©º', t.x + t.width / 2, t.y + 25);
        }
        
        // ç»˜åˆ¶é˜´æ
        function drawCathode() {
            const c = components.cathode;
            
            // é˜´æä¸»ä½“
            ctx.beginPath();
            ctx.roundRect(c.x, c.y, c.width, c.height, 5);
            
            // åŠ çƒ­æ•ˆæœ
            if (c.isHeated && experimentState.currentStep >= 1) {
                const gradient = ctx.createLinearGradient(c.x, c.y, c.x + c.width, c.y);
                gradient.addColorStop(0, '#0d47a1');
                gradient.addColorStop(0.5, '#2196f3');
                gradient.addColorStop(1, '#64b5f6');
                ctx.fillStyle = gradient;
                
                // åŠ çƒ­å‘å…‰æ•ˆæœ
                if (experimentState.animationTime % 1 < 0.5) {
                    ctx.shadowColor = '#2196f3';
                    ctx.shadowBlur = 15;
                }
            } else {
                ctx.fillStyle = c.color;
            }
            
            ctx.fill();
            ctx.shadowBlur = 0;
            
            // é˜´ææ ‡ç­¾
            ctx.fillStyle = '#e3f2fd';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('é˜´æ', c.x + c.width / 2, c.y + c.height + 25);
            
            // åŠ çƒ­ä¸æ•ˆæœï¼ˆæ­¥éª¤1ï¼‰
            if (experimentState.currentStep >= 1) {
                c.isHeated = true;
                c.temperature = Math.min(1, c.temperature + 0.02);
                
                // ç»˜åˆ¶åŠ çƒ­ä¸
                ctx.beginPath();
                ctx.moveTo(c.x + c.width / 2, c.y + 10);
                for (let i = 0; i < 5; i++) {
                    const y = c.y + 10 + i * 8;
                    ctx.lineTo(c.x + c.width * 0.3, y);
                    ctx.lineTo(c.x + c.width * 0.7, y + 4);
                }
                ctx.strokeStyle = `rgba(255, ${200 - c.temperature * 100}, ${100 - c.temperature * 80}, ${0.5 + c.temperature * 0.5})`;
                ctx.lineWidth = 1.5;
                ctx.stroke();
            }
        }
        
        // ç»˜åˆ¶é˜³æ
        function drawAnode() {
            const a = components.anode;
            
            // é˜³æä¸»ä½“
            ctx.beginPath();
            ctx.roundRect(a.x, a.y, a.width, a.height, 5);
            
            // æ ¹æ®é¶ææ”¹å˜é¢œè‰²
            let anodeColor = a.color;
            if (experimentState.targetMaterial === 'copper') {
                anodeColor = '#d2691e';
            } else if (experimentState.targetMaterial === 'molybdenum') {
                anodeColor = '#9e9e9e';
            }
            
            ctx.fillStyle = anodeColor;
            ctx.fill();
            
            // è¢«æ’å‡»æ•ˆæœ
            if (a.isHit && experimentState.currentStep >= 3) {
                a.hitTime += 0.05;
                const pulse = Math.sin(a.hitTime * 10) * 0.5 + 0.5;
                
                // æ’å‡»ç‚¹å‘å…‰æ•ˆæœ
                const centerX = a.x;
                const centerY = a.y + a.height / 2;
                
                const gradient = ctx.createRadialGradient(
                    centerX, centerY, 5,
                    centerX, centerY, 30
                );
                gradient.addColorStop(0, `rgba(255, 64, 129, ${0.8 * pulse})`);
                gradient.addColorStop(1, 'rgba(255, 64, 129, 0)');
                
                ctx.beginPath();
                ctx.arc(centerX, centerY, 30, 0, Math.PI * 2);
                ctx.fillStyle = gradient;
                ctx.fill();
            }
            
            // é˜³ææ ‡ç­¾
            ctx.fillStyle = '#f5f5f5';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            
            let materialName = 'é’¨';
            if (experimentState.targetMaterial === 'copper') materialName = 'é“œ';
            if (experimentState.targetMaterial === 'molybdenum') materialName = 'é’¼';
            
            ctx.fillText('é˜³æ (' + materialName + ')', a.x + a.width / 2, a.y + a.height + 25);
        }
        
        // ç»˜åˆ¶è§å…‰å±
        function drawScreen() {
            const s = components.screen;
            
            // è§å…‰å±è¾¹æ¡†
            ctx.beginPath();
            ctx.roundRect(s.x, s.y, s.width, s.height, 5);
            ctx.strokeStyle = 'rgba(205, 220, 57, 0.5)';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // è§å…‰å±å†…éƒ¨
            if (s.isLit && experimentState.currentStep >= 4) {
                s.brightness = Math.min(1, s.brightness + 0.02);
                
                // è§å…‰æ•ˆæœ
                const gradient = ctx.createLinearGradient(s.x, s.y, s.x + s.width, s.y);
                gradient.addColorStop(0, `rgba(205, 220, 57, ${0.1 + s.brightness * 0.4})`);
                gradient.addColorStop(1, `rgba(205, 220, 57, ${0.05 + s.brightness * 0.3})`);
                
                ctx.fillStyle = gradient;
                ctx.fill();
                
                // å‘å…‰æ•ˆæœ
                ctx.shadowColor = '#cddc39';
                ctx.shadowBlur = 20 + s.brightness * 30;
                ctx.fill();
                ctx.shadowBlur = 0;
                
                // è§å…‰é—ªçƒæ•ˆæœ
                if (Math.sin(experimentState.animationTime * 10) > 0.7) {
                    ctx.beginPath();
                    ctx.arc(s.x + s.width / 2, s.y + s.height / 2, s.width * 0.4, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(205, 220, 57, ${0.3 * s.brightness})`;
                    ctx.fill();
                }
            } else {
                ctx.fillStyle = s.color;
                ctx.fill();
            }
            
            // è§å…‰å±æ ‡ç­¾
            ctx.fillStyle = '#f0f4c3';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('è§å…‰å±', s.x + s.width / 2, s.y - 15);
        }
        
        // ç»˜åˆ¶ç”µå­
        function drawElectrons() {
            if (experimentState.currentStep < 2) return;
            
            // åˆ›å»ºæ–°ç”µå­ï¼ˆåŸºäºç”µå‹æ§åˆ¶é¢‘ç‡ï¼‰
            const creationRate = Math.max(0.1, experimentState.voltage / 100);
            if (Math.random() < creationRate && components.electrons.length < 30) {
                components.electrons.push(createElectron());
            }
            
            // æ›´æ–°å’Œç»˜åˆ¶ç”µå­
            for (let i = components.electrons.length - 1; i >= 0; i--) {
                const electron = components.electrons[i];
                
                if (!electron.isActive) {
                    components.electrons.splice(i, 1);
                    continue;
                }
                
                // æ›´æ–°ä½ç½®
                electron.x += electron.speed;
                
                // æ·»åŠ è½¨è¿¹ç‚¹
                electron.trail.push({x: electron.x, y: electron.y});
                if (electron.trail.length > electron.maxTrailLength) {
                    electron.trail.shift();
                }
                
                // æ£€æŸ¥æ˜¯å¦å‡»ä¸­é˜³æ
                if (!electron.hitAnode && electron.x >= components.anode.x - 5) {
                    electron.hitAnode = true;
                    electron.isActive = false;
                    components.anode.isHit = true;
                    
                    // åˆ›å»ºXå°„çº¿å…‰å­ï¼ˆæ­¥éª¤3å’Œ4ï¼‰
                    if (experimentState.currentStep >= 3) {
                        const sourceX = components.anode.x;
                        const sourceY = electron.y;
                        
                        // åˆ›å»ºå¤šä¸ªæ–¹å‘çš„å…‰å­
                        for (let j = 0; j < 5; j++) {
                            const angle = Math.PI * 0.2 + Math.random() * Math.PI * 0.6; // ä¸»è¦å‘å‰æ–¹è¾å°„
                            components.xrayPhotons.push(createXRayPhoton(sourceX, sourceY, angle));
                        }
                    }
                }
                
                // ç»˜åˆ¶è½¨è¿¹
                if (electron.trail.length > 1) {
                    ctx.beginPath();
                    ctx.moveTo(electron.trail[0].x, electron.trail[0].y);
                    
                    for (let j = 1; j < electron.trail.length; j++) {
                        const point = electron.trail[j];
                        const alpha = j / electron.trail.length;
                        ctx.lineTo(point.x, point.y);
                    }
                    
                    ctx.strokeStyle = `rgba(79, 195, 247, ${0.1 + 0.4 * (electron.trail.length / electron.maxTrailLength)})`;
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
                
                // ç»˜åˆ¶ç”µå­
                ctx.beginPath();
                ctx.arc(electron.x, electron.y, electron.radius, 0, Math.PI * 2);
                
                // ç”µå­é¢œè‰²æ¸å˜
                const gradient = ctx.createRadialGradient(
                    electron.x, electron.y, 0,
                    electron.x, electron.y, electron.radius
                );
                gradient.addColorStop(0, '#e3f2fd');
                gradient.addColorStop(1, electron.color);
                
                ctx.fillStyle = gradient;
                ctx.fill();
                
                // ç”µå­ç¬¦å·
                ctx.fillStyle = '#0d47a1';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('-', electron.x, electron.y);
            }
        }
        
        // ç»˜åˆ¶Xå°„çº¿å…‰å­
        function drawXRayPhotons() {
            if (experimentState.currentStep < 3) return;
            
            for (let i = components.xrayPhotons.length - 1; i >= 0; i--) {
                const photon = components.xrayPhotons[i];
                
                // æ›´æ–°ä½ç½®å’Œç”Ÿå‘½å‘¨æœŸ
                photon.x += Math.cos(photon.angle) * photon.speed;
                photon.y += Math.sin(photon.angle) * photon.speed;
                photon.life -= photon.decayRate;
                
                // ç§»é™¤æ­»äº¡çš„å…‰å­
                if (photon.life <= 0) {
                    components.xrayPhotons.splice(i, 1);
                    continue;
                }
                
                // ç»˜åˆ¶å…‰å­
                ctx.beginPath();
                ctx.arc(photon.x, photon.y, photon.radius * photon.life, 0, Math.PI * 2);
                
                // å…‰å­é¢œè‰²æ¸å˜
                const gradient = ctx.createRadialGradient(
                    photon.x, photon.y, 0,
                    photon.x, photon.y, photon.radius * photon.life
                );
                gradient.addColorStop(0, '#ffffff');
                gradient.addColorStop(1, `rgba(255, 64, 129, ${photon.life})`);
                
                ctx.fillStyle = gradient;
                ctx.fill();
                
                // å…‰å­è½¨è¿¹
                ctx.beginPath();
                ctx.moveTo(photon.x - Math.cos(photon.angle) * 10, photon.y - Math.sin(photon.angle) * 10);
                ctx.lineTo(photon.x, photon.y);
                ctx.strokeStyle = `rgba(255, 64, 129, ${photon.life * 0.3})`;
                ctx.lineWidth = 1;
                ctx.stroke();
                
                // æ£€æŸ¥æ˜¯å¦å‡»ä¸­è§å…‰å±ï¼ˆæ­¥éª¤4ï¼‰
                if (experimentState.currentStep >= 4 && 
                    photon.x >= components.screen.x && 
                    photon.x <= components.screen.x + components.screen.width &&
                    photon.y >= components.screen.y && 
                    photon.y <= components.screen.y + components.screen.height) {
                    components.screen.isLit = true;
                }
            }
        }
        
        // ç»˜åˆ¶é«˜å‹ç”µæºæŒ‡ç¤º
        function drawPowerIndicator() {
            if (experimentState.currentStep < 1) return;
            
            const centerX = canvas.width / 2;
            const indicatorY = components.tube.y + components.tube.height + 50;
            
            // ç”µæºç¬¦å·
            ctx.fillStyle = '#ff9800';
            ctx.font = 'bold 18px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('âš¡', centerX - 100, indicatorY);
            ctx.fillText('âš¡', centerX + 100, indicatorY);
            
            // ç”µå‹æ˜¾ç¤º
            ctx.fillStyle = '#4fc3f7';
            ctx.font = 'bold 20px Arial';
            ctx.fillText(experimentState.voltage + ' kV', centerX, indicatorY);
            
            // è¿æ¥çº¿
            ctx.beginPath();
            ctx.moveTo(components.cathode.x + components.cathode.width / 2, components.cathode.y + components.cathode.height);
            ctx.lineTo(components.cathode.x + components.cathode.width / 2, indicatorY - 20);
            ctx.moveTo(components.anode.x + components.anode.width / 2, components.anode.y + components.anode.height);
            ctx.lineTo(components.anode.x + components.anode.width / 2, indicatorY - 20);
            ctx.strokeStyle = 'rgba(255, 152, 0, 0.6)';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.stroke();
            ctx.setLineDash([]);
        }
        
        // ç»˜åˆ¶ç”µå‹å¯¹å®éªŒå½±å“çš„è¯´æ˜
        function drawVoltageEffect() {
            if (experimentState.currentStep < 2) return;
            
            const infoX = canvas.width - 200;
            const infoY = 50;
            
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.font = '14px Arial';
            ctx.textAlign = 'left';
            
            let effectText = '';
            if (experimentState.voltage < 40) {
                effectText = 'ç”µå‹è¾ƒä½ï¼šç”µå­é€Ÿåº¦æ…¢ï¼ŒXå°„çº¿å¼±';
            } else if (experimentState.voltage < 70) {
                effectText = 'ç”µå‹é€‚ä¸­ï¼šç”µå­é€Ÿåº¦ä¸­ç­‰ï¼ŒXå°„çº¿å¼ºåº¦é€‚ä¸­';
            } else {
                effectText = 'ç”µå‹é«˜ï¼šç”µå­é€Ÿåº¦å¿«ï¼ŒXå°„çº¿å¼ºåº¦é«˜';
            }
            
            ctx.fillText('å½“å‰ç”µå‹æ•ˆæœ:', infoX, infoY);
            ctx.fillStyle = '#4fc3f7';
            ctx.font = 'bold 14px Arial';
            ctx.fillText(effectText, infoX, infoY + 25);
        }
        
        // ä¸»ç»˜åˆ¶å‡½æ•°
        function draw() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // åˆå§‹åŒ–ç»„ä»¶ä½ç½®
            initComponents();
            
            // ç»˜åˆ¶å„ä¸ªç»„ä»¶
            drawTube();
            drawCathode();
            drawAnode();
            drawScreen();
            drawPowerIndicator();
            drawElectrons();
            drawXRayPhotons();
            drawVoltageEffect();
            
            // æ›´æ–°åŠ¨ç”»æ—¶é—´
            experimentState.animationTime += 0.05;
            
            // ç»§ç»­åŠ¨ç”»å¾ªç¯
            requestAnimationFrame(draw);
        }
        
        // å¼€å§‹åŠ¨ç”»
        draw();
        
        // æŒ‰é’®äº‹ä»¶å¤„ç†
        document.getElementById('nextBtn').addEventListener('click', () => {
            if (experimentState.currentStep < experimentState.totalSteps - 1) {
                experimentState.currentStep++;
                updateStepText();
                
                // å¦‚æœæ˜¯æ­¥éª¤4ï¼Œæ¿€æ´»è§å…‰å±
                if (experimentState.currentStep === 4) {
                    components.screen.isLit = true;
                }
            }
        });
        
        document.getElementById('prevBtn').addEventListener('click', () => {
            if (experimentState.currentStep > 0) {
                experimentState.currentStep--;
                
                // å¦‚æœå›åˆ°æ­¥éª¤3ä¹‹å‰ï¼Œé‡ç½®è§å…‰å±
                if (experimentState.currentStep < 4) {
                    components.screen.isLit = false;
                    components.screen.brightness = 0;
                }
                
                // å¦‚æœå›åˆ°æ­¥éª¤2ä¹‹å‰ï¼Œé‡ç½®é˜³æå‡»ä¸­çŠ¶æ€
                if (experimentState.currentStep < 3) {
                    components.
<!--æ£€æµ‹åˆ°ä»£ç æˆªæ–­ï¼Œè‡ªåŠ¨ç»­å†™ä¸­...-->
anode.isHit = false;
                    components.anode.hitTime = 0;
                }
                
                updateStepText();
            }
        });
        
        document.getElementById('resetBtn').addEventListener('click', () => {
            experimentState.currentStep = 0;
            experimentState.isAutoPlaying = false;
            experimentState.animationTime = 0;
            
            // é‡ç½®æ‰€æœ‰ç»„ä»¶çŠ¶æ€
            components.cathode.isHeated = false;
            components.cathode.temperature = 0;
            components.anode.isHit = false;
            components.anode.hitTime = 0;
            components.screen.isLit = false;
            components.screen.brightness = 0;
            components.electrons = [];
            components.xrayPhotons = [];
            
            updateStepText();
        });
        
        document.getElementById('autoBtn').addEventListener('click', () => {
            if (experimentState.isAutoPlaying) {
                experimentState.isAutoPlaying = false;
                document.getElementById('autoBtn').innerHTML = '<span>âµ</span> è‡ªåŠ¨æ’­æ”¾';
                return;
            }
            
            experimentState.isAutoPlaying = true;
            document.getElementById('autoBtn').innerHTML = '<span>â¸</span> åœæ­¢æ’­æ”¾';
            
            // å¦‚æœå½“å‰åœ¨æœ€åä¸€æ­¥ï¼Œåˆ™é‡ç½®åˆ°ç¬¬ä¸€æ­¥
            if (experimentState.currentStep === experimentState.totalSteps - 1) {
                experimentState.currentStep = 0;
                components.cathode.isHeated = false;
                components.cathode.temperature = 0;
                components.anode.isHit = false;
                components.anode.hitTime = 0;
                components.screen.isLit = false;
                components.screen.brightness = 0;
                components.electrons = [];
                components.xrayPhotons = [];
            }
            
            // è‡ªåŠ¨æ’­æ”¾å‡½æ•°
            function autoPlayStep() {
                if (!experimentState.isAutoPlaying) return;
                
                if (experimentState.currentStep < experimentState.totalSteps - 1) {
                    experimentState.currentStep++;
                    updateStepText();
                    
                    // å¦‚æœæ˜¯æ­¥éª¤4ï¼Œæ¿€æ´»è§å…‰å±
                    if (experimentState.currentStep === 4) {
                        components.screen.isLit = true;
                    }
                    
                    // è®¾ç½®ä¸‹ä¸€æ­¥çš„å»¶è¿Ÿæ—¶é—´
                    let delay = 3000; // é»˜è®¤3ç§’
                    if (experimentState.currentStep === 1) delay = 2500;
                    if (experimentState.currentStep === 2) delay = 4000; // è§‚å¯Ÿé˜´æå°„çº¿
                    if (experimentState.currentStep === 3) delay = 5000; // è§‚å¯ŸXå°„çº¿äº§ç”Ÿ
                    if (experimentState.currentStep === 4) delay = 4000; // è§‚å¯Ÿè§å…‰å±
                    
                    setTimeout(autoPlayStep, delay);
                } else {
                    // æ’­æ”¾å®Œæˆ
                    experimentState.isAutoPlaying = false;
                    document.getElementById('autoBtn').innerHTML = '<span>âµ</span> è‡ªåŠ¨æ’­æ”¾';
                }
            }
            
            // å¼€å§‹è‡ªåŠ¨æ’­æ”¾
            setTimeout(autoPlayStep, 1000);
        });
        
        // ç”µå‹æ»‘å—äº‹ä»¶
        const voltageSlider = document.getElementById('voltageSlider');
        const voltageValue = document.getElementById('voltageValue');
        
        voltageSlider.addEventListener('input', function() {
            experimentState.voltage = parseInt(this.value);
            voltageValue.textContent = experimentState.voltage;
            
            // æ›´æ–°æ­¥éª¤æè¿°ä¸­çš„ç”µå‹å€¼
            if (stepDescriptions[1]) {
                stepDescriptions[1] = stepDescriptions[1].replace(/<span class='highlight'>\d+ kV<\/span>/, `<span class='highlight'>${experimentState.voltage} kV</span>`);
            }
            
            // å¦‚æœå½“å‰åœ¨æ­¥éª¤1æˆ–ä¹‹åï¼Œæ›´æ–°æ˜¾ç¤º
            if (experimentState.currentStep >= 1) {
                updateStepText();
            }
        });
        
        // é¶æé€‰æ‹©äº‹ä»¶
        const targetSelect = document.getElementById('targetSelect');
        
        targetSelect.addEventListener('change', function() {
            experimentState.targetMaterial = this.value;
            
            // æ›´æ–°æ­¥éª¤æè¿°ä¸­çš„é¶æåç§°
            let materialName = 'é’¨';
            if (experimentState.targetMaterial === 'copper') materialName = 'é“œ';
            if (experimentState.targetMaterial === 'molybdenum') materialName = 'é’¼';
            
            if (stepDescriptions[3]) {
                stepDescriptions[3] = stepDescriptions[3].replace(/æ’å‡»<span class='highlight'>[^<]+<\/span>é˜³æé¶æ/, `æ’å‡»<span class='highlight'>${materialName}</span>é˜³æé¶æ`);
            }
            
            // å¦‚æœå½“å‰åœ¨æ­¥éª¤3æˆ–ä¹‹åï¼Œæ›´æ–°æ˜¾ç¤º
            if (experimentState.currentStep >= 3) {
                updateStepText();
            }
        });
        
        // åˆå§‹æ›´æ–°æ­¥éª¤æ–‡æœ¬
        updateStepText();
        
        // æ·»åŠ Canvasåœ†è§’çŸ©å½¢æ”¯æŒ
        if (!CanvasRenderingContext2D.prototype.roundRect) {
            CanvasRenderingContext2D.prototype.roundRect = function(x, y, width, height, radius) {
                if (width < 2 * radius) radius = width / 2;
                if (height < 2 * radius) radius = height / 2;
                
                this.beginPath();
                this.moveTo(x + radius, y);
                this.arcTo(x + width, y, x + width, y + height, radius);
                this.arcTo(x + width, y + height, x, y + height, radius);
                this.arcTo(x, y + height, x, y, radius);
                this.arcTo(x, y, x + width, y, radius);
                this.closePath();
                return this;
            };
        }
    </script>
</body>
</html>