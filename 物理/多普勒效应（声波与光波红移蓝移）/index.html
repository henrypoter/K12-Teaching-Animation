<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šæ™®å‹’æ•ˆåº”æ•™å­¦åŠ¨ç”»</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e6e6e6;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #3498db;
        }

        h1 {
            color: #3498db;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            color: #95a5a6;
            font-size: 1.2rem;
        }

        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }

        .animation-area {
            flex: 1;
            min-width: 700px;
            background: rgba(25, 25, 35, 0.9);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid #2c3e50;
        }

        .control-panel {
            flex: 0 0 400px;
            background: rgba(30, 30, 40, 0.9);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid #2c3e50;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel-section {
            background: rgba(40, 40, 50, 0.7);
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #3498db;
        }

        h2 {
            color: #3498db;
            font-size: 1.4rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        h2 i {
            font-size: 1.2rem;
        }

        h3 {
            color: #2ecc71;
            font-size: 1.1rem;
            margin: 15px 0 10px 0;
        }

        .scene-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .scene-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px;
            background: #2c3e50;
            color: #ecf0f1;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            text-align: center;
        }

        .scene-btn:hover {
            background: #34495e;
            transform: translateY(-2px);
        }

        .scene-btn.active {
            background: #3498db;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }

        .control-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #bdc3c7;
            font-size: 0.95rem;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="range"] {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: #34495e;
            border-radius: 3px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .value-display {
            min-width: 50px;
            text-align: center;
            background: rgba(52, 152, 219, 0.2);
            padding: 4px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .animation-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .ctrl-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .play-btn {
            background: #2ecc71;
            color: white;
        }

        .play-btn:hover {
            background: #27ae60;
        }

        .reset-btn {
            background: #e74c3c;
            color: white;
        }

        .reset-btn:hover {
            background: #c0392b;
        }

        .data-panel {
            background: rgba(25, 25, 35, 0.9);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid #2c3e50;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .data-item {
            background: rgba(52, 152, 219, 0.1);
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #3498db;
        }

        .data-label {
            font-size: 0.85rem;
            color: #95a5a6;
            margin-bottom: 5px;
        }

        .data-value {
            font-size: 1.2rem;
            font-family: 'Courier New', monospace;
            color: #2ecc71;
            font-weight: bold;
        }

        .formula-display {
            background: rgba(46, 204, 113, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 3px solid #2ecc71;
            font-family: 'Cambria Math', 'Times New Roman', serif;
        }

        .formula {
            font-size: 1.3rem;
            text-align: center;
            margin: 10px 0;
            color: #f1c40f;
        }

        .formula-legend {
            font-size: 0.9rem;
            color: #bdc3c7;
            margin-top: 10px;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        canvas {
            display: block;
            background: #0f1525;
            border-radius: 8px;
            width: 100%;
            height: 500px;
            cursor: crosshair;
        }

        footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #2c3e50;
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
            }
            
            .animation-area, .control-panel {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>å¤šæ™®å‹’æ•ˆåº”æ•™å­¦åŠ¨ç”»</h1>
            <p class="subtitle">å£°æ³¢ä¸å…‰æ³¢çš„çº¢ç§»ä¸è“ç§»ç°è±¡ | äº¤äº’å¼ç‰©ç†æ¨¡æ‹Ÿ</p>
        </header>

        <div class="main-content">
            <div class="animation-area">
                <canvas id="animationCanvas"></canvas>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f1c40f;"></div>
                        <span>æ³¢æº</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #2ecc71;"></div>
                        <span>è§‚å¯Ÿè€…</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #3498db;"></div>
                        <span>é«˜é¢‘/è“ç§»åŒº</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #e74c3c;"></div>
                        <span>ä½é¢‘/çº¢ç§»åŒº</span>
                    </div>
                </div>
            </div>

            <div class="control-panel">
                <div class="panel-section">
                    <h2>ğŸ¯ åœºæ™¯é€‰æ‹©</h2>
                    <div class="scene-selector">
                        <button class="scene-btn active" data-scene="sound">å£°æ³¢æ¨¡æ‹Ÿ</button>
                        <button class="scene-btn" data-scene="light">å…‰æ³¢æ¨¡æ‹Ÿ</button>
                        <button class="scene-btn" data-scene="police">è­¦è½¦ç¤ºä¾‹</button>
                        <button class="scene-btn" data-scene="cosmic">å®‡å®™çº¢ç§»</button>
                    </div>
                </div>

                <div class="panel-section">
                    <h2>ğŸ® å®ä½“æ§åˆ¶</h2>
                    <div class="control-group">
                        <label>æ³¢æºé€Ÿåº¦: <span id="speedValue">0.0</span> m/s</label>
                        <div class="slider-container">
                            <input type="range" id="sourceSpeed" min="-100" max="100" value="0" step="1">
                            <div class="value-display" id="speedDisplay">0.0</div>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label>å‘å°„é¢‘ç‡ (fâ‚€): <span id="freqValue">440</span> Hz</label>
                        <div class="slider-container">
                            <input type="range" id="sourceFreq" min="200" max="800" value="440" step="10">
                            <div class="value-display" id="freqDisplay">440</div>
                        </div>
                    </div>
                </div>

                <div class="panel-section">
                    <h2>ğŸ‘ï¸ è§†è§‰è¾…åŠ©</h2>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" id="showWavefronts" checked>
                            <span>æ˜¾ç¤ºæ³¢é˜µé¢</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="showNormals">
                            <span>æ˜¾ç¤ºæ³¢å‰æ³•çº¿</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="showTrajectory">
                            <span>æ˜¾ç¤ºè¿åŠ¨è½¨è¿¹</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="showHistory">
                            <span>æ˜¾ç¤ºå†å²æ³¢</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="enableSound">
                            <span>å¯ç”¨å£°éŸ³åé¦ˆ</span>
                        </label>
                    </div>
                </div>

                <div class="panel-section">
                    <h2>â¯ï¸ åŠ¨ç”»æ§åˆ¶</h2>
                    <div class="animation-controls">
                        <button class="ctrl-btn play-btn" id="playPauseBtn">â¸ï¸ æš‚åœ</button>
                        <button class="ctrl-btn reset-btn" id="resetBtn">ğŸ”„ é‡ç½®</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="data-panel">
            <h2>ğŸ“Š å®æ—¶æ•°æ®</h2>
            <div class="data-grid">
                <div class="data-item">
                    <div class="data-label">æ³¢æºé€Ÿåº¦ (vâ‚›)</div>
                    <div class="data-value" id="dataSpeed">0.0 m/s</div>
                </div>
                <div class="data-item">
                    <div class="data-label">æ³¢é€Ÿ (v/c)</div>
                    <div class="data-value" id="dataWaveSpeed">340 m/s</div>
                </div>
                <div class="data-item">
                    <div class="data-label">å‘å°„é¢‘ç‡ (fâ‚€)</div>
                    <div class="data-value" id="dataEmitFreq">440 Hz</div>
                </div>
                <div class="data-item">
                    <div class="data-label">æ¥æ”¶é¢‘ç‡ (f')</div>
                    <div class="data-value" id="dataRecvFreq">440.0 Hz</div>
                </div>
                <div class="data-item">
                    <div class="data-label">é¢‘ç‡å˜åŒ–æ¯” (f'/fâ‚€)</div>
                    <div class="data-value" id="dataFreqRatio">1.000</div>
                </div>
                <div class="data-item">
                    <div class="data-label">å¤šæ™®å‹’é¢‘ç§»</div>
                    <div class="data-value" id="dataShift">0.0 Hz</div>
                </div>
            </div>

            <div class="formula-display">
                <h3>å¤šæ™®å‹’æ•ˆåº”å…¬å¼</h3>
                <div class="formula" id="formulaDisplay">
                    f' = fâ‚€ Ã— (v Â± vâ‚’) / (v âˆ“ vâ‚›)
                </div>
                <div class="formula-legend">
                    <div>f' = è§‚å¯Ÿè€…æ¥æ”¶é¢‘ç‡ | fâ‚€ = æ³¢æºå‘å°„é¢‘ç‡</div>
                    <div>v = æ³¢é€Ÿ | vâ‚› = æ³¢æºé€Ÿåº¦ | vâ‚’ = è§‚å¯Ÿè€…é€Ÿåº¦</div>
                    <div>ç¬¦å·è§„åˆ™ï¼šæ¥è¿‘æ—¶å–æ­£å·ï¼Œè¿œç¦»æ—¶å–è´Ÿå·</div>
                    <div id="currentFormula">å½“å‰ï¼šf' = 440 Ã— (340 + 0) / (340 - 0) = 440.0 Hz</div>
                </div>
            </div>
        </div>

        <footer>
            <p>å¤šæ™®å‹’æ•ˆåº”æ•™å­¦åŠ¨ç”» | äº¤äº’å¼ç‰©ç†æ¨¡æ‹Ÿ | ä½¿ç”¨HTML5 Canvaså®ç°</p>
            <p>æç¤ºï¼šæ‹–åŠ¨ç”»å¸ƒä¸Šçš„æ³¢æºæˆ–è§‚å¯Ÿè€…å¯ä»¥æ”¹å˜å®ƒä»¬çš„ä½ç½®</p>
        </footer>
    </div>

    <script>
        // éŸ³é¢‘ä¸Šä¸‹æ–‡ï¼ˆç”¨äºå£°éŸ³åé¦ˆï¼‰
        let audioContext = null;
        let oscillator = null;
        let lastFrequency = 440;

        // ä¸»Canvaså’Œä¸Šä¸‹æ–‡
        const canvas = document.getElementById('animationCanvas');
        const ctx = canvas.getContext('2d');

        // è®¾ç½®Canvaså°ºå¯¸
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = 500;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // ç‰©ç†å‚æ•°
        const config = {
            scene: 'sound', // sound, light, police, cosmic
            isPlaying: true,
            waveSpeed: 340, // å£°é€Ÿ m/s
            sourceFreq: 440, // Hz
            sourceSpeed: 0, // m/s
            sourcePos: { x: 300, y: 250 },
            observerPos: { x: 700, y: 250 },
            wavefronts: [],
            trajectory: [],
            lastWaveTime: 0,
            waveInterval: 100, // æ¯«ç§’
            time: 0,
            showWavefronts: true,
            showNormals: false,
            showTrajectory: false,
            showHistory: false,
            enableSound: false,
            draggedObject: null
        };

        // åœºæ™¯é…ç½®
        const scenes = {
            sound: {
                name: 'å£°æ³¢æ¨¡æ‹Ÿ',
                waveSpeed: 340,
                waveColor: 'rgba(52, 152, 219, 0.7)',
                bgColor: '#0f1525',
                compressColor: '#3498db',
                stretchColor: '#e74c3c',
                sourceColor: '#f1c40f',
                observerColor: '#2ecc71'
            },
            light: {
                name: 'å…‰æ³¢æ¨¡æ‹Ÿ',
                waveSpeed: 3e8,
                waveColor: 'rgba(241, 196, 15, 0.6)',
                bgColor: '#000814',
                compressColor: '#9b59b6', // è“ç´«è‰²
                stretchColor: '#e67e22', // æ©™çº¢è‰²
                sourceColor: '#ffffff',
                observerColor: '#2ecc71'
            },
            police: {
                name: 'è­¦è½¦ç¤ºä¾‹',
                waveSpeed: 340,
                waveColor: 'rgba(52, 152, 219, 0.7)',
                bgColor: '#1a3c2e',
                compressColor: '#3498db',
                stretchColor: '#e74c3c',
                sourceColor: '#f1c40f',
                observerColor: '#2ecc71'
            },
            cosmic: {
                name: 'å®‡å®™çº¢ç§»',
                waveSpeed: 3e8,
                waveColor: 'rgba(155, 89, 182, 0.6)',
                bgColor: '#000000',
                compressColor: '#3498db',
                stretchColor: '#e74c3c',
                sourceColor: '#f1c40f',
                observerColor: '#2ecc71'
            }
        };

        // åˆå§‹åŒ–
        function init() {
            config.wavefronts = [];
            config.trajectory = [];
            config.lastWaveTime = 0;
            config.time = 0;
            
            // æ ¹æ®åœºæ™¯è®¾ç½®åˆå§‹ä½ç½®
            if (config.scene === 'police') {
                config.sourcePos = { x: 200, y: 250 };
                config.observerPos = { x: 700, y: 300 };
            } else if (config.scene === 'cosmic') {
                config.sourcePos = { x: 200, y: 250 };
                config.observerPos = { x: 700, y: 250 };
            } else {
                config.sourcePos = { x: 300, y: 250 };
                config.observerPos = { x: 700, y: 250 };
            }
            
            updateWaveSpeed();
            updateUI();
            animate();
        }

        // æ›´æ–°æ³¢é€Ÿ
        function updateWaveSpeed() {
            config.waveSpeed = scenes[config.scene].waveSpeed;
            document.getElementById('dataWaveSpeed').textContent = 
                config.scene === 'sound' || config.scene === 'police' ? 
                `${config.waveSpeed} m/s` : '3.0Ã—10â¸ m/s';
        }

        // è®¡ç®—æ¥æ”¶é¢‘ç‡
        function calculateReceivedFrequency() {
            const v = config.waveSpeed;
            const vs = config.sourceSpeed;
            const f0 = config.sourceFreq;
            
            // è®¡ç®—æ³¢æºåˆ°è§‚å¯Ÿè€…çš„æ–¹å‘å‘é‡
            const dx = config.observerPos.x - config.sourcePos.x;
            const dy = config.observerPos.y - config.sourcePos.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance === 0) return f0;
            
            // è®¡ç®—ç›¸å¯¹é€Ÿåº¦åœ¨è¿çº¿æ–¹å‘ä¸Šçš„åˆ†é‡
            const directionX = dx / distance;
            const directionY = dy / distance;
            
            // æ³¢æºé€Ÿåº¦åœ¨è¿çº¿æ–¹å‘ä¸Šçš„åˆ†é‡ï¼ˆæ­£è¡¨ç¤ºè¿œç¦»è§‚å¯Ÿè€…ï¼‰
            const vs_proj = vs * (directionX * Math.cos(0) + directionY * Math.sin(0));
            
            // å¤šæ™®å‹’å…¬å¼ï¼ˆè§‚å¯Ÿè€…é™æ­¢ï¼‰
            let f_prime;
            if (vs_proj < 0) { // æ³¢æºæ¥è¿‘è§‚å¯Ÿè€…
                f_prime = f0 * v / (v + vs_proj);
            } else { // æ³¢æºè¿œç¦»è§‚å¯Ÿè€…
                f_prime = f0 * v / (v - vs_proj);
            }
            
            return f_prime;
        }

        // æ›´æ–°å£°éŸ³
        function updateSound() {
            if (!config.enableSound || !audioContext) return;
            
            const freq = calculateReceivedFrequency();
            
            if (Math.abs(freq - lastFrequency) > 0.1) {
                if (oscillator) {
                    oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
                }
                lastFrequency = freq;
            }
        }

        // å¼€å§‹/åœæ­¢å£°éŸ³
        function toggleSound(enable) {
            if (enable) {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                if (!oscillator) {
                    oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    gainNode.gain.value = 0.1;
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(config.sourceFreq, audioContext.currentTime);
                    oscillator.start();
                }
            } else {
                if (oscillator) {
                    oscillator.stop();
                    oscillator = null;
                }
            }
        }

        // ç»˜åˆ¶å‡½æ•°
        function draw() {
            const scene = scenes[config.scene];
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.fillStyle = scene.bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶åœºæ™¯ç‰¹å®šå…ƒç´ 
            if (config.scene === 'police') {
                drawPoliceScene();
            } else if (config.scene === 'cosmic') {
                drawCosmicScene();
            }
            
            // ç»˜åˆ¶è½¨è¿¹
            if (config.showTrajectory && config.trajectory.length > 1) {
                ctx.beginPath();
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.moveTo(config.trajectory[0].x, config.trajectory[0].y);
                for (let i = 1; i < config.trajectory.length; i++) {
                    ctx.lineTo(config.trajectory[i].x, config.trajectory[i].y);
                }
                ctx.stroke();
                ctx.setLineDash([]);
            }
            
            // ç»˜åˆ¶æ³¢é˜µé¢
            if (config.showWavefronts) {
                for (let i = 0; i < config.wavefronts.length; i++) {
                    const wave = config.wavefronts[i];
                    const radius = wave.radius;
                    const age = config.time - wave.time;
                    
                    // è®¡ç®—é€æ˜åº¦
                    let alpha = 1 - age / 3000;
                    if (alpha <= 0) continue;
                    
                    // æ ¹æ®åœºæ™¯é€‰æ‹©é¢œè‰²
                    let waveColor;
                    if (config.scene === 'light') {
                        // å…‰æ³¢ï¼šæ ¹æ®é¢‘ç‡åç§»é€‰æ‹©é¢œè‰²
                        const angle = Math.atan2(wave.y - config.sourcePos.y, wave.x - config.sourcePos.x);
                        const sourceAngle = Math.atan2(config.observerPos.y - config.sourcePos.y, 
                                                      config.observerPos.x - config.sourcePos.x);
                        const angleDiff = Math.abs(angle - sourceAngle);
                        
                        if (angleDiff < Math.PI/6) {
                            waveColor = scene.compressColor; // è“ç§»æ–¹å‘
                        } else if (angleDiff > Math.PI*5/6) {
                            waveColor = scene.stretchColor; // çº¢ç§»æ–¹å‘
                        } else {
                            waveColor = scene.waveColor;
                        }
                    } else {
                        // å£°æ³¢ï¼šæ ¹æ®å‹ç¼©/æ‹‰ä¼¸é€‰æ‹©é¢œè‰²
                        const dx = wave.x - config.sourcePos.x;
                        const dy = wave.y - config.sourcePos.y;
                        const angle = Math.atan2(dy, dx);
                        const motionAngle = config.sourceSpeed >= 0 ? 0 : Math.PI;
                        const angleDiff = Math.abs(angle - motionAngle);
                        
                        if (angleDiff < Math.PI/6) {
                            waveColor = scene.compressColor; // å‹ç¼©åŒºï¼ˆé«˜é¢‘ï¼‰
                        } else if (angleDiff > Math.PI*5/6) {
                            waveColor = scene.stretchColor; // æ‹‰ä¼¸åŒºï¼ˆä½é¢‘ï¼‰
                        } else {
                            waveColor = scene.waveColor;
                        }
                    }
                    
                    // ç»˜åˆ¶æ³¢é˜µé¢
                    ctx.beginPath();
                    ctx.arc(wave.x, wave.y, radius, 0, Math.PI * 2);
                    ctx.strokeStyle = waveColor.replace(')', `, ${alpha})`).replace('rgb', 'rgba');
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    // ç»˜åˆ¶æ³¢å‰æ³•çº¿
                    if (config.showNormals) {
                        ctx.beginPath();
                        ctx.moveTo(wave.x, wave.y);
                        ctx.lineTo(
                            wave.x + Math.cos(wave.angle) * 20,
                            wave.y + Math.sin(wave.angle) * 20
                        );
                        ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                        ctx.lineWidth = 1;
                        ctx.stroke();
                    }
                }
            }
            
            // ç»˜åˆ¶æ³¢æº
            ctx.beginPath();
            ctx.arc(config.sourcePos.x, config.sourcePos.y, 15, 0, Math.PI * 2);
            ctx.fillStyle = scene.sourceColor;
            ctx.fill();
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // ç»˜åˆ¶é€Ÿåº¦ç®­å¤´
            if (Math.abs(config.sourceSpeed) > 0.1) {
                const angle = config.sourceSpeed >= 0 ? 0 : Math.PI;
                const arrowLength = Math.min(Math.abs(config.sourceSpeed) * 2, 100);
                
                ctx.beginPath();
                ctx.moveTo(config.sourcePos.x, config.sourcePos.y);
                ctx.lineTo(
                    config.sourcePos.x + Math.cos(angle) * arrowLength,
                    config.sourcePos.y + Math.sin(angle) * arrowLength
                );
                ctx.strokeStyle = config.sourceSpeed > 0 ? '#2ecc71' : '#e74c3c';
                ctx.lineWidth = 3;
                ctx.stroke();
                
                // ç®­å¤´å¤´éƒ¨
                ctx.beginPath();
                ctx.moveTo(
                    config.sourcePos.x + Math.cos(angle) * arrowLength,
                    config.sourcePos.y + Math.sin(angle) * arrowLength
                );
                ctx.lineTo(
                    config.sourcePos.x + Math.cos(angle) * arrowLength - Math.cos(angle - Math.PI/6) * 10,
                    config.sourcePos.y + Math.sin(angle) * arrowLength - Math.sin(angle - Math.PI/6) * 10
                );
                ctx.lineTo(
                    config.sourcePos.x + Math.cos(angle) * arrowLength - Math.cos(angle + Math.PI/6) * 10,
                    config.sourcePos.y + Math.sin(angle) * arrowLength - Math.sin(angle + Math.PI/6) * 10
                );
                ctx.closePath();
                ctx.fillStyle = config.sourceSpeed > 0 ? '#2ecc71' : '#e74c3c';
                ctx.fill();
            }
            
            // ç»˜åˆ¶è§‚å¯Ÿè€…
            ctx.beginPath();
            ctx.arc(config.observerPos.x, config.observerPos.y, 12, 0, Math.PI * 2);
            ctx.fillStyle = scene.observerColor;
            ctx.fill();
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // ç»˜åˆ¶è§‚å¯Ÿè€…æ¥æ”¶æŒ‡ç¤ºå™¨
            const receivedFreq = calculateReceivedFrequency();
            const freqRatio = receivedFreq / config.sourceFreq;
            
            ctx.beginPath();
            ctx.arc(config.observerPos.x, config.observerPos.y, 30, 0, Math.PI * 2);
            ctx.strokeStyle = freqRatio > 1 ? scene.compressColor : 
                             freqRatio < 1 ? scene.stretchColor : '#ffffff';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            // ç»˜åˆ¶é¢‘ç‡æŒ‡ç¤ºæ¡
            const barWidth = 60;
            const barHeight = 8;
            const freqBar = (freqRatio - 0.5) * barWidth;
            
            ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.fillRect(
                config.observerPos.x - barWidth/2,
                config.observerPos.y - 50,
                barWidth,
                barHeight
            );
            
            ctx.fillStyle = freqRatio > 1 ? scene.compressColor : 
                           freqRatio < 1 ? scene.stretchColor : '#2ecc71';
            ctx.fillRect(
                config.observerPos.x - barWidth/2 + barWidth/2,
                config.observerPos.y - 50,
                freqBar,
                barHeight
            );
            
            // ç»˜åˆ¶ä¸­å¿ƒçº¿
            ctx.beginPath();
            ctx.moveTo(config.observerPos.x, config.observerPos.y - 50);
            ctx.lineTo(config.observerPos.x, config.observerPos.y - 42);
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        // ç»˜åˆ¶è­¦è½¦åœºæ™¯
        function drawPoliceScene() {
            // ç»˜åˆ¶é“è·¯
            ctx.fillStyle = '#34495e';
            ctx.fillRect(0, 280, canvas.width, 40);
            
            ctx.strokeStyle = '#f1c40f';
            ctx.lineWidth = 3;
            ctx.setLineDash([20, 20]);
            ctx.beginPath();
            ctx.moveTo(0, 300);
            ctx.lineTo(canvas.width, 300);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // ç»˜åˆ¶è­¦è½¦
            const carX = config.sourcePos.x;
            const carY = 280;
            
            ctx.fillStyle = '#3498db';
            ctx.fillRect(carX - 30, carY - 20, 60, 20);
            ctx.fillRect(carX - 20, carY - 40, 40, 20);
            
            // è½¦è½®
            ctx.fillStyle = '#2c3e50';
            ctx.beginPath();
            ctx.arc(carX - 15, carY, 8, 0, Math.PI * 2);
            ctx.arc(carX + 15, carY, 8, 0, Math.PI * 2);
            ctx.fill();
            
            // è­¦ç¯
            ctx.fillStyle = '#e74c3c';
            ctx.beginPath();
            ctx.arc(carX, carY - 30, 5, 0, Math.PI * 2);
            ctx.fill();
            
            // è§‚å¯Ÿè€…ï¼ˆäººï¼‰
            const personX = config.observerPos.x;
            const personY = config.observerPos.y;
            
            ctx.beginPath();
            ctx.arc(personX, personY - 20, 8, 0, Math.PI * 2); // å¤´
            ctx.fillStyle = '#ecf0f1';
            ctx.fill();
            
            ctx.fillStyle = '#3498db';
            ctx.fillRect(personX - 6, personY - 12, 12, 20); // èº«ä½“
            
            ctx.fillStyle = '#2c3e50';
            ctx.fillRect(personX - 8, personY + 8, 4, 20); // å·¦è…¿
            ctx.fillRect(personX + 4, personY + 8, 4, 20); // å³è…¿
        }

        // ç»˜åˆ¶å®‡å®™åœºæ™¯
        function drawCosmicScene() {
            // ç»˜åˆ¶æ˜Ÿç©º
            for (let i = 0; i < 100; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const size = Math.random() * 2;
                
                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.fill();
            }
            
            // ç»˜åˆ¶åœ°çƒï¼ˆè§‚å¯Ÿè€…ï¼‰
            ctx.beginPath();
            ctx.arc(config.observerPos.x, config.observerPos.y, 25, 0, Math.PI * 2);
            const earthGradient = ctx.createRadialGradient(
                config.observerPos.x, config.observerPos.y, 0,
                config.observerPos.x, config.observerPos.y, 25
            );
            earthGradient.addColorStop(0, '#3498db');
            earthGradient.addColorStop(1, '#1a5276');
            ctx.fillStyle = earthGradient;
            ctx.fill();
            
            // ç»˜åˆ¶æ’æ˜Ÿï¼ˆæ³¢æºï¼‰
            ctx.beginPath();
            ctx.arc(config.sourcePos.x, config.sourcePos.y, 20, 0, Math.PI * 2);
            const starGradient = ctx.createRadialGradient(
                config.sourcePos.x, config.sourcePos.y, 0,
                config.sourcePos.x, config.sourcePos.y, 20
            );
            starGradient.addColorStop(0, '#ffffff');
            starGradient.addColorStop(0.5, '#f1c40f');
            starGradient.addColorStop(1, '#e67e22');
            ctx.fillStyle = starGradient;
            ctx.fill();
            
            // æ’æ˜Ÿå…‰èŠ’
            for (let i = 0; i < 8; i++) {
                const angle = (i * Math.PI) / 4;
                const length = 30;
                
                ctx.beginPath();
                ctx.moveTo(
                    config.sourcePos.x + Math.cos(angle) * 20,
                    config.sourcePos.y + Math.sin(angle) * 20
                );
                ctx.lineTo(
                    config.sourcePos.x + Math.cos(angle) * (20 + length),
                    config.sourcePos.y + Math.sin(angle) * (20 + length)
                );
                ctx.strokeStyle = 'rgba(241, 196, 15, 0.5)';
                ctx.lineWidth = 3;
                ctx.stroke();
            }
            
            // ç»˜åˆ¶å…‰è°±å›¾
            const spectrumX = canvas.width - 200;
            const spectrumY = 100;
            const spectrumWidth = 180;
            const spectrumHeight = 60;
            
            // å…‰è°±èƒŒæ™¯
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(spect
<!--æ£€æµ‹åˆ°ä»£ç æˆªæ–­ï¼Œè‡ªåŠ¨ç»­å†™ä¸­...-->
rumX, spectrumY, spectrumWidth, spectrumHeight);
            
            // å‘å°„å…‰è°±çº¿ï¼ˆé™æ­¢æ—¶ï¼‰
            const lines = [400, 450, 500, 550, 600, 650, 700]; // ä¸åŒæ³¢é•¿çš„è°±çº¿
            const receivedFreq = calculateReceivedFrequency();
            const freqRatio = receivedFreq / config.sourceFreq;
            
            for (let i = 0; i < lines.length; i++) {
                const originalPos = spectrumX + 20 + (i * 20);
                const shiftedPos = originalPos + (freqRatio - 1) * 50; // çº¢ç§»/è“ç§»
                
                // åŸå§‹ä½ç½®ï¼ˆç°è‰²ï¼‰
                ctx.beginPath();
                ctx.moveTo(originalPos, spectrumY + 10);
                ctx.lineTo(originalPos, spectrumY + spectrumHeight - 10);
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // åç§»åä½ç½®ï¼ˆé¢œè‰²è¡¨ç¤ºçº¢ç§»/è“ç§»ï¼‰
                ctx.beginPath();
                ctx.moveTo(shiftedPos, spectrumY + 10);
                ctx.lineTo(shiftedPos, spectrumY + spectrumHeight - 10);
                ctx.strokeStyle = freqRatio > 1 ? '#3498db' : 
                                 freqRatio < 1 ? '#e74c3c' : '#2ecc71';
                ctx.lineWidth = 3;
                ctx.stroke();
                
                // è¿æ¥çº¿
                ctx.beginPath();
                ctx.moveTo(originalPos, spectrumY + spectrumHeight/2);
                ctx.lineTo(shiftedPos, spectrumY + spectrumHeight/2);
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
                ctx.lineWidth = 1;
                ctx.setLineDash([2, 2]);
                ctx.stroke();
                ctx.setLineDash([]);
            }
            
            // å…‰è°±æ ‡ç­¾
            ctx.fillStyle = '#ffffff';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('å‘å°„å…‰è°±', spectrumX + spectrumWidth/2, spectrumY - 5);
            ctx.fillText('æ¥æ”¶å…‰è°±', spectrumX + spectrumWidth/2, spectrumY + spectrumHeight + 15);
            
            // çº¢ç§»/è“ç§»æ ‡ç­¾
            if (freqRatio > 1.01) {
                ctx.fillStyle = '#3498db';
                ctx.fillText('è“ç§»', spectrumX + spectrumWidth + 30, spectrumY + spectrumHeight/2);
            } else if (freqRatio < 0.99) {
                ctx.fillStyle = '#e74c3c';
                ctx.fillText('çº¢ç§»', spectrumX + spectrumWidth + 30, spectrumY + spectrumHeight/2);
            }
        }

        // åŠ¨ç”»å¾ªç¯
        function animate() {
            if (config.isPlaying) {
                config.time += 16; // çº¦60fps
                
                // æ›´æ–°æ³¢æºä½ç½®
                if (Math.abs(config.sourceSpeed) > 0.1) {
                    const deltaX = (config.sourceSpeed * 16) / 1000; // è½¬æ¢ä¸ºåƒç´ /å¸§
                    config.sourcePos.x += deltaX;
                    
                    // è¾¹ç•Œæ£€æŸ¥
                    if (config.sourcePos.x < 50) config.sourcePos.x = 50;
                    if (config.sourcePos.x > canvas.width - 50) config.sourcePos.x = canvas.width - 50;
                    
                    // è®°å½•è½¨è¿¹
                    if (config.showTrajectory) {
                        config.trajectory.push({...config.sourcePos});
                        if (config.trajectory.length > 100) {
                            config.trajectory.shift();
                        }
                    }
                }
                
                // ç”Ÿæˆæ–°çš„æ³¢é˜µé¢
                if (config.time - config.lastWaveTime > config.waveInterval) {
                    const angle = Math.atan2(
                        config.observerPos.y - config.sourcePos.y,
                        config.observerPos.x - config.sourcePos.x
                    );
                    
                    config.wavefronts.push({
                        x: config.sourcePos.x,
                        y: config.sourcePos.y,
                        radius: 0,
                        time: config.time,
                        angle: angle
                    });
                    
                    config.lastWaveTime = config.time;
                }
                
                // æ›´æ–°æ³¢é˜µé¢åŠå¾„
                for (let i = config.wavefronts.length - 1; i >= 0; i--) {
                    const wave = config.wavefronts[i];
                    const age = config.time - wave.time;
                    wave.radius = (config.waveSpeed * age) / 1000; // è½¬æ¢ä¸ºåƒç´ 
                    
                    // ç§»é™¤å¤ªè€çš„æ³¢
                    if (age > 3000) {
                        config.wavefronts.splice(i, 1);
                    }
                }
                
                // é™åˆ¶æ³¢é˜µé¢æ•°é‡
                if (!config.showHistory) {
                    while (config.wavefronts.length > 10) {
                        config.wavefronts.shift();
                    }
                }
                
                // æ›´æ–°å£°éŸ³
                updateSound();
                
                // æ›´æ–°UIæ•°æ®
                updateDataDisplay();
            }
            
            draw();
            requestAnimationFrame(animate);
        }

        // æ›´æ–°UIæ•°æ®
        function updateDataDisplay() {
            const receivedFreq = calculateReceivedFrequency();
            const freqRatio = receivedFreq / config.sourceFreq;
            const shift = receivedFreq - config.sourceFreq;
            
            // æ›´æ–°æ•°æ®é¢æ¿
            document.getElementById('dataSpeed').textContent = 
                `${config.sourceSpeed.toFixed(1)} m/s`;
            document.getElementById('dataEmitFreq').textContent = 
                `${config.sourceFreq} Hz`;
            document.getElementById('dataRecvFreq').textContent = 
                `${receivedFreq.toFixed(1)} Hz`;
            document.getElementById('dataFreqRatio').textContent = 
                freqRatio.toFixed(3);
            document.getElementById('dataShift').textContent = 
                `${shift.toFixed(1)} Hz`;
            
            // æ›´æ–°å…¬å¼æ˜¾ç¤º
            const v = config.waveSpeed;
            const vs = config.sourceSpeed;
            const f0 = config.sourceFreq;
            
            // è®¡ç®—ç›¸å¯¹é€Ÿåº¦åˆ†é‡
            const dx = config.observerPos.x - config.sourcePos.x;
            const dy = config.observerPos.y - config.sourcePos.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            let vs_proj = 0;
            
            if (distance > 0) {
                const directionX = dx / distance;
                vs_proj = vs * directionX;
            }
            
            let formulaText;
            if (vs_proj < 0) { // æ¥è¿‘
                formulaText = `f' = ${f0} Ã— ${v} / (${v} + ${Math.abs(vs_proj).toFixed(1)}) = ${receivedFreq.toFixed(1)} Hz`;
            } else if (vs_proj > 0) { // è¿œç¦»
                formulaText = `f' = ${f0} Ã— ${v} / (${v} - ${vs_proj.toFixed(1)}) = ${receivedFreq.toFixed(1)} Hz`;
            } else {
                formulaText = `f' = ${f0} Ã— ${v} / ${v} = ${receivedFreq.toFixed(1)} Hz`;
            }
            
            document.getElementById('currentFormula').textContent = `å½“å‰ï¼š${formulaText}`;
        }

        // æ›´æ–°UIçŠ¶æ€
        function updateUI() {
            // æ›´æ–°åœºæ™¯æŒ‰é’®
            document.querySelectorAll('.scene-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.scene === config.scene);
            });
            
            // æ›´æ–°æ»‘å—å€¼æ˜¾ç¤º
            document.getElementById('speedValue').textContent = config.sourceSpeed.toFixed(1);
            document.getElementById('speedDisplay').textContent = config.sourceSpeed.toFixed(1);
            document.getElementById('freqValue').textContent = config.sourceFreq;
            document.getElementById('freqDisplay').textContent = config.sourceFreq;
            
            // æ›´æ–°å¤é€‰æ¡†
            document.getElementById('showWavefronts').checked = config.showWavefronts;
            document.getElementById('showNormals').checked = config.showNormals;
            document.getElementById('showTrajectory').checked = config.showTrajectory;
            document.getElementById('showHistory').checked = config.showHistory;
            document.getElementById('enableSound').checked = config.enableSound;
            
            // æ›´æ–°æ’­æ”¾æŒ‰é’®
            document.getElementById('playPauseBtn').textContent = 
                config.isPlaying ? 'â¸ï¸ æš‚åœ' : 'â–¶ï¸ æ’­æ”¾';
            
            // æ›´æ–°æ ‡é¢˜
            document.querySelector('h1').textContent = 
                `${scenes[config.scene].name} - å¤šæ™®å‹’æ•ˆåº”`;
        }

        // äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // åœºæ™¯åˆ‡æ¢
            document.querySelectorAll('.scene-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    config.scene = btn.dataset.scene;
                    updateWaveSpeed();
                    init();
                });
            });
            
            // æ³¢æºé€Ÿåº¦æ»‘å—
            document.getElementById('sourceSpeed').addEventListener('input', (e) => {
                config.sourceSpeed = parseFloat(e.target.value);
                document.getElementById('speedValue').textContent = config.sourceSpeed.toFixed(1);
                document.getElementById('speedDisplay').textContent = config.sourceSpeed.toFixed(1);
            });
            
            // å‘å°„é¢‘ç‡æ»‘å—
            document.getElementById('sourceFreq').addEventListener('input', (e) => {
                config.sourceFreq = parseFloat(e.target.value);
                document.getElementById('freqValue').textContent = config.sourceFreq;
                document.getElementById('freqDisplay').textContent = config.sourceFreq;
                
                // æ›´æ–°å£°éŸ³é¢‘ç‡
                if (oscillator && config.enableSound) {
                    oscillator.frequency.setValueAtTime(config.sourceFreq, audioContext.currentTime);
                }
            });
            
            // å¤é€‰æ¡†
            document.getElementById('showWavefronts').addEventListener('change', (e) => {
                config.showWavefronts = e.target.checked;
            });
            
            document.getElementById('showNormals').addEventListener('change', (e) => {
                config.showNormals = e.target.checked;
            });
            
            document.getElementById('showTrajectory').addEventListener('change', (e) => {
                config.showTrajectory = e.target.checked;
                if (!config.showTrajectory) {
                    config.trajectory = [];
                }
            });
            
            document.getElementById('showHistory').addEventListener('change', (e) => {
                config.showHistory = e.target.checked;
            });
            
            document.getElementById('enableSound').addEventListener('change', (e) => {
                config.enableSound = e.target.checked;
                toggleSound(config.enableSound);
            });
            
            // æ’­æ”¾/æš‚åœæŒ‰é’®
            document.getElementById('playPauseBtn').addEventListener('click', () => {
                config.isPlaying = !config.isPlaying;
                document.getElementById('playPauseBtn').textContent = 
                    config.isPlaying ? 'â¸ï¸ æš‚åœ' : 'â–¶ï¸ æ’­æ”¾';
            });
            
            // é‡ç½®æŒ‰é’®
            document.getElementById('resetBtn').addEventListener('click', () => {
                init();
            });
            
            // Canvasäº¤äº’
            canvas.addEventListener('mousedown', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†æ³¢æº
                const dx1 = x - config.sourcePos.x;
                const dy1 = y - config.sourcePos.y;
                const dist1 = Math.sqrt(dx1 * dx1 + dy1 * dy1);
                
                // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†è§‚å¯Ÿè€…
                const dx2 = x - config.observerPos.x;
                const dy2 = y - config.observerPos.y;
                const dist2 = Math.sqrt(dx2 * dx2 + dy2 * dy2);
                
                if (dist1 < 20) {
                    config.draggedObject = 'source';
                } else if (dist2 < 20) {
                    config.draggedObject = 'observer';
                }
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (!config.draggedObject) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                if (config.draggedObject === 'source') {
                    config.sourcePos.x = Math.max(50, Math.min(canvas.width - 50, x));
                    config.sourcePos.y = Math.max(50, Math.min(canvas.height - 50, y));
                } else if (config.draggedObject === 'observer') {
                    config.observerPos.x = Math.max(50, Math.min(canvas.width - 50, x));
                    config.observerPos.y = Math.max(50, Math.min(canvas.height - 50, y));
                }
            });
            
            canvas.addEventListener('mouseup', () => {
                config.draggedObject = null;
            });
            
            canvas.addEventListener('mouseleave', () => {
                config.draggedObject = null;
            });
            
            // è§¦æ‘¸äº‹ä»¶æ”¯æŒ
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                
                const dx1 = x - config.sourcePos.x;
                const dy1 = y - config.sourcePos.y;
                const dist1 = Math.sqrt(dx1 * dx1 + dy1 * dy1);
                
                const dx2 = x - config.observerPos.x;
                const dy2 = y - config.observerPos.y;
                const dist2 = Math.sqrt(dx2 * dx2 + dy2 * dy2);
                
                if (dist1 < 30) {
                    config.draggedObject = 'source';
                } else if (dist2 < 30) {
                    config.draggedObject = 'observer';
                }
            });
            
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (!config.draggedObject) return;
                
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                
                if (config.draggedObject === 'source') {
                    config.sourcePos.x = Math.max(50, Math.min(canvas.width - 50, x));
                    config.sourcePos.y = Math.max(50, Math.min(canvas.height - 50, y));
                } else if (config.draggedObject === 'observer') {
                    config.observerPos.x = Math.max(50, Math.min(canvas.width - 50, x));
                    config.observerPos.y = Math.max(50, Math.min(canvas.height - 50, y));
                }
            });
            
            canvas.addEventListener('touchend', () => {
                config.draggedObject = null;
            });
        }

        // åˆå§‹åŒ–åº”ç”¨
        window.addEventListener('load', () => {
            setupEventListeners();
            init();
        });
    </script>
</body>
</html>