<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é“ç”Ÿé”ˆçš„å¾®è§‚è¿‡ç¨‹ - äº¤äº’å¼æ•™å­¦åŠ¨ç”»</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background-color: rgba(255, 255, 255, 0.92);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 100, 0.1);
            padding: 30px;
            margin-top: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e6f0;
        }

        h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #3498db, #2c3e50);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 1.2rem;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 30px;
        }

        .animation-section {
            flex: 1;
            min-width: 700px;
            background-color: #1a1f2e;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        #animationCanvas {
            display: block;
            width: 100%;
            height: 500px;
            cursor: pointer;
        }

        .controls-section {
            flex: 1;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .panel {
            background-color: #f8fafc;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
            border-left: 5px solid #3498db;
        }

        .panel h2 {
            color: #2c3e50;
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel h2 i {
            color: #3498db;
        }

        .control-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 14px 10px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-3px);
        }

        .btn-secondary {
            background-color: #ecf0f1;
            color: #2c3e50;
        }

        .btn-secondary:hover {
            background-color: #d5dbdb;
            transform: translateY(-3px);
        }

        .btn-reset {
            background-color: #e74c3c;
            color: white;
            grid-column: span 3;
        }

        .btn-reset:hover {
            background-color: #c0392b;
            transform: translateY(-3px);
        }

        .slider-container {
            margin: 25px 0;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2c3e50;
        }

        .slider {
            width: 100%;
            height: 10px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(90deg, #3498db, #9b59b6);
            border-radius: 5px;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            border: 3px solid #3498db;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background-color: white;
            border-radius: 10px;
            transition: all 0.2s ease;
            border: 2px solid #ecf0f1;
        }

        .checkbox-item:hover {
            border-color: #3498db;
            transform: translateX(5px);
        }

        .checkbox-item input {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-item label {
            font-weight: 600;
            color: #2c3e50;
            cursor: pointer;
            flex: 1;
        }

        .legend {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background-color: white;
            border-radius: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .legend-text {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding: 20px;
            background-color: #f8fafc;
            border-radius: 15px;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            flex: 1;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 10px;
        }

        .step:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }

        .step.active {
            background-color: rgba(52, 152, 219, 0.15);
            transform: translateY(-5px);
        }

        .step-number {
            width: 40px;
            height: 40px;
            background-color: #3498db;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .step.active .step-number {
            background-color: #2c3e50;
            transform: scale(1.1);
        }

        .step-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .step-desc {
            font-size: 0.85rem;
            color: #7f8c8d;
            line-height: 1.4;
        }

        .reaction-equation {
            text-align: center;
            padding: 25px;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            border-radius: 15px;
            margin-top: 20px;
            font-family: 'Cambria', 'Times New Roman', serif;
        }

        .equation {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 15px 0;
            color: #ecf0f1;
        }

        .equation-step {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .equation-step.active {
            display: block;
        }

        .equation-label {
            font-size: 1.2rem;
            color: #bdc3c7;
            margin-top: 10px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tooltip {
            position: absolute;
            background-color: rgba(44, 62, 80, 0.95);
            color: white;
            padding: 12px 18px;
            border-radius: 10px;
            font-size: 0.95rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 100;
            max-width: 250px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border-left: 4px solid #3498db;
        }

        footer {
            text-align: center;
            margin-top: 30px;
            color: #7f8c8d;
            font-size: 0.9rem;
            padding-top: 20px;
            border-top: 1px solid #e0e6f0;
            width: 100%;
        }

        @media (max-width: 1100px) {
            .main-content {
                flex-direction: column;
            }
            
            .animation-section, .controls-section {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>é“ç”Ÿé”ˆçš„å¾®è§‚è¿‡ç¨‹</h1>
            <p class="subtitle">æ¢ç´¢é“åŸå­å¦‚ä½•å¤±å»ç”µå­ï¼Œä¸æ°§æ°”å’Œæ°´ååº”ç”Ÿæˆé“é”ˆçš„å¾®è§‚ç”µåŒ–å­¦æœºç†</p>
        </header>
        
        <div class="main-content">
            <section class="animation-section">
                <canvas id="animationCanvas" width="1000" height="500"></canvas>
                <div class="tooltip" id="tooltip"></div>
            </section>
            
            <section class="controls-section">
                <div class="panel">
                    <h2><i>â–¶ï¸</i> åŠ¨ç”»æ§åˆ¶</h2>
                    <div class="control-buttons">
                        <button class="btn btn-primary" id="playBtn">
                            <span>â–¶ æ’­æ”¾</span>
                        </button>
                        <button class="btn btn-primary" id="pauseBtn">
                            <span>â¸ï¸ æš‚åœ</span>
                        </button>
                        <button class="btn btn-secondary" id="stepBtn">
                            <span>â­ï¸ ä¸‹ä¸€æ­¥</span>
                        </button>
                        <button class="btn btn-secondary" id="prevBtn">
                            <span>â®ï¸ ä¸Šä¸€æ­¥</span>
                        </button>
                        <button class="btn btn-secondary" id="slowBtn">
                            <span>ğŸŒ æ…¢é€Ÿ</span>
                        </button>
                        <button class="btn btn-secondary" id="fastBtn">
                            <span>âš¡ å¿«é€Ÿ</span>
                        </button>
                        <button class="btn btn-reset" id="resetBtn">
                            <span>ğŸ”„ é‡ç½®åŠ¨ç”»</span>
                        </button>
                    </div>
                    
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>åŠ¨ç”»é€Ÿåº¦</span>
                            <span id="speedValue">æ­£å¸¸</span>
                        </div>
                        <input type="range" min="1" max="10" value="5" class="slider" id="speedSlider">
                    </div>
                    
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>åŠ¨ç”»è¿›åº¦</span>
                            <span id="progressValue">0%</span>
                        </div>
                        <input type="range" min="0" max="100" value="0" class="slider" id="progressSlider">
                    </div>
                </div>
                
                <div class="panel">
                    <h2><i>ğŸ‘ï¸</i> è§†è§‰é€‰é¡¹</h2>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="showElectrons" checked>
                            <label for="showElectrons">æ˜¾ç¤ºç”µå­æµåŠ¨è½¨è¿¹</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="showIonPaths" checked>
                            <label for="showIonPaths">æ˜¾ç¤ºç¦»å­è¿åŠ¨è·¯å¾„</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="showLabels" checked>
                            <label for="showLabels">æ˜¾ç¤ºåŒ–å­¦å¼ä¸æ³¨é‡Š</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="showWater" checked>
                            <label for="showWater">æ˜¾ç¤ºæ°´åˆ†å­å±‚</label>
                        </div>
                    </div>
                    
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #bdc3c7;"></div>
                            <div class="legend-text">é“åŸå­ (Fe)</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #3498db;"></div>
                            <div class="legend-text">ç”µå­ (eâ»)</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #2ecc71;"></div>
                            <div class="legend-text">äºšé“ç¦»å­ (FeÂ²âº)</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #e67e22;"></div>
                            <div class="legend-text">é“ç¦»å­ (FeÂ³âº)</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #e74c3c;"></div>
                            <div class="legend-text">æ°§æ°” (Oâ‚‚)</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #9b59b6;"></div>
                            <div class="legend-text">æ°¢æ°§æ ¹ (OHâ»)</div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
        
        <div class="step-indicator">
            <div class="step active" data-step="0">
                <div class="step-number">1</div>
                <div class="step-title">é“åŸå­å¤±å»ç”µå­</div>
                <div class="step-desc">Fe â†’ FeÂ²âº + 2eâ»</div>
            </div>
            <div class="step" data-step="1">
                <div class="step-number">2</div>
                <div class="step-title">æ°§æ°”è·å¾—ç”µå­</div>
                <div class="step-desc">Oâ‚‚ + 2Hâ‚‚O + 4eâ» â†’ 4OHâ»</div>
            </div>
            <div class="step" data-step="2">
                <div class="step-number">3</div>
                <div class="step-title">äºšé“ç¦»å­æ°§åŒ–</div>
                <div class="step-desc">FeÂ²âº â†’ FeÂ³âº + eâ»</div>
            </div>
            <div class="step" data-step="3">
                <div class="step-number">4</div>
                <div class="step-title">ç”Ÿæˆé“é”ˆ</div>
                <div class="step-desc">FeÂ³âº + 3OHâ» â†’ Fe(OH)â‚ƒ</div>
            </div>
        </div>
        
        <div class="reaction-equation">
            <h3>å½“å‰æ­¥éª¤ååº”æ–¹ç¨‹å¼</h3>
            <div class="equation" id="equationDisplay">
                <div class="equation-step active" data-step="0">Fe â†’ FeÂ²âº + 2eâ»</div>
                <div class="equation-step" data-step="1">Oâ‚‚ + 2Hâ‚‚O + 4eâ» â†’ 4OHâ»</div>
                <div class="equation-step" data-step="2">4FeÂ²âº + Oâ‚‚ + 4Hâ‚‚O â†’ 4FeÂ³âº + 8OHâ»</div>
                <div class="equation-step" data-step="3">FeÂ³âº + 3OHâ» â†’ Fe(OH)â‚ƒ â†’ Feâ‚‚Oâ‚ƒÂ·xHâ‚‚O</div>
            </div>
            <div class="equation-label" id="equationLabel">é˜³æååº”ï¼šé“åŸå­è¢«æ°§åŒ–ï¼Œå¤±å»ç”µå­</div>
        </div>
    </div>
    
    <footer>
        <p>æ•™å­¦åŠ¨ç”»è®¾è®¡ï¼šé“ç”Ÿé”ˆçš„å¾®è§‚ç”µåŒ–å­¦è¿‡ç¨‹ | é€‚åˆåˆä¸­/é«˜ä¸­åŒ–å­¦æ•™å­¦</p>
        <p>äº¤äº’æç¤ºï¼šå°†é¼ æ ‡æ‚¬åœåœ¨åŠ¨ç”»ä¸­çš„ç²’å­ä¸ŠæŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</p>
    </footer>

    <script>
        // è·å–Canvaså’Œä¸Šä¸‹æ–‡
        const canvas = document.getElementById('animationCanvas');
        const ctx = canvas.getContext('2d');
        const tooltip = document.getElementById('tooltip');
        
        // åŠ¨ç”»çŠ¶æ€
        let animationId = null;
        let isPlaying = false;
        let currentStep = 0;
        let animationProgress = 0;
        let animationSpeed = 5; // 1-10ï¼Œ5ä¸ºæ­£å¸¸é€Ÿåº¦
        
        // è§†è§‰é€‰é¡¹çŠ¶æ€
        let showElectrons = true;
        let showIonPaths = true;
        let showLabels = true;
        let showWater = true;
        
        // ç²’å­å®šä¹‰
        const particles = {
            ironAtoms: [],
            electrons: [],
            fe2PlusIons: [],
            fe3PlusIons: [],
            oxygenMolecules: [],
            hydroxideIons: [],
            waterMolecules: []
        };
        
        // è½¨è¿¹è®°å½•
        const electronPaths = [];
        const ionPaths = [];
        
        // åˆå§‹åŒ–ç²’å­
        function initParticles() {
            // æ¸…ç©ºæ‰€æœ‰ç²’å­
            for (let key in particles) {
                particles[key] = [];
            }
            electronPaths.length = 0;
            ionPaths.length = 0;
            
            // åˆ›å»ºé“åŸå­ï¼ˆé‡‘å±æ™¶æ ¼ï¼‰
            const ironGridSize = 8;
            const ironSpacing = 40;
            const ironStartX = 150;
            const ironStartY = 300;
            
            for (let i = 0; i < ironGridSize; i++) {
                for (let j = 0; j < ironGridSize; j++) {
                    const x = ironStartX + i * ironSpacing;
                    const y = ironStartY + j * ironSpacing;
                    
                    particles.ironAtoms.push({
                        x, y,
                        radius: 12,
                        color: '#bdc3c7',
                        label: 'Fe',
                        state: 'atom', // atom, losing, ion
                        electronCount: 2, // æ¨¡æ‹Ÿå¤±å»çš„ç”µå­æ•°
                        lostElectrons: 0
                    });
                }
            }
            
            // åˆ›å»ºæ°§æ°”åˆ†å­ï¼ˆåœ¨æº¶æ¶²ä¸­ï¼‰
            for (let i = 0; i < 5; i++) {
                particles.oxygenMolecules.push({
                    x: 600 + Math.random() * 200,
                    y: 100 + Math.random() * 150,
                    radius: 10,
                    color: '#e74c3c',
                    label: 'Oâ‚‚',
                    state: 'molecule',
                    electronsNeeded: 4,
                    electronsReceived: 0
                });
            }
            
            // åˆ›å»ºæ°´åˆ†å­
            if (showWater) {
                for (let i = 0; i < 30; i++) {
                    particles.waterMolecules.push({
                        x: 400 + Math.random() * 400,
                        y: 50 + Math.random() * 200,
                        radius: 8,
                        color: '#3498db',
                        label: 'Hâ‚‚O',
                        angle: Math.random() * Math.PI * 2,
                        rotationSpeed: 0.02
                    });
                }
            }
            
            // åˆå§‹åŒ–è¿›åº¦
            animationProgress = 0;
            currentStep = 0;
            updateStepIndicator();
            updateEquationDisplay();
        }
        
        // ç»˜åˆ¶é‡‘å±æ™¶æ ¼èƒŒæ™¯
        function drawMetalBackground() {
            // é‡‘å±è¡¨é¢
            ctx.fillStyle = '#2c3e50';
            ctx.fillRect(100, 250, 400, 200);
            
            // æ™¶æ ¼çº¿
            ctx.strokeStyle = 'rgba(189, 195, 199, 0.3)';
            ctx.lineWidth = 1;
            
            for (let i = 0; i <= 8; i++) {
                const x = 100 + i * 50;
                ctx.beginPath();
                ctx.moveTo(x, 250);
                ctx.lineTo(x, 450);
                ctx.stroke();
                
                const y = 250 + i * 25;
                ctx.beginPath();
                ctx.moveTo(100, y);
                ctx.lineTo(500, y);
                ctx.stroke();
            }
            
            // é‡‘å±æ ‡ç­¾
            if (showLabels) {
                ctx.fillStyle = '#ecf0f1';
                ctx.font = 'bold 18px Arial';
                ctx.fillText('é‡‘å±é“ (Fe)', 250, 240);
                ctx.font = '14px Arial';
                ctx.fillText('é“åŸå­æ™¶æ ¼', 260, 470);
            }
        }
        
        // ç»˜åˆ¶æ°´å±‚
        function drawWaterLayer() {
            if (!showWater) return;
            
            // åŠé€æ˜æ°´å±‚
            ctx.fillStyle = 'rgba(52, 152, 219, 0.15)';
            ctx.fillRect(100, 150, 800, 300);
            
            // æ°´åˆ†å­
            particles.waterMolecules.forEach(water => {
                // æ›´æ–°æ—‹è½¬
                water.angle += water.rotationSpeed;
                
                // ç»˜åˆ¶æ°´åˆ†å­ï¼ˆç®€åŒ–Vå½¢ï¼‰
                ctx.save();
                ctx.translate(water.x, water.y);
                ctx.rotate(water.angle);
                
                // æ°§åŸå­ï¼ˆä¸­å¿ƒï¼‰
                ctx.fillStyle = water.color;
                ctx.beginPath();
                ctx.arc(0, 0, water.radius, 0, Math.PI * 2);
                ctx.fill();
                
                // æ°¢åŸå­ï¼ˆä¸¤ä¾§ï¼‰
                ctx.fillStyle = '#ecf0f1';
                ctx.beginPath();
                ctx.arc(-10, -8, water.radius * 0.6, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(10, -8, water.radius * 0.6, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.restore();
                
                // æ ‡ç­¾
                if (showLabels) {
                    ctx.fillStyle = '#3498db';
                    ctx.font = '12px Arial';
                    ctx.fillText(water.label, water.x - 10, water.y - 15);
                }
            });
            
            // æ°´å±‚æ ‡ç­¾
            if (showLabels) {
                ctx.fillStyle = '#3498db';
                ctx.font = 'bold 16px Arial';
                ctx.fillText('æ°´è†œå±‚ (Hâ‚‚O + ç”µè§£è´¨)', 600, 80);
            }
        }
        
        // ç»˜åˆ¶é“åŸå­å’Œç¦»å­
        function drawIronParticles() {
            particles.ironAtoms.forEach((atom, index) => {
                // æ ¹æ®çŠ¶æ€å†³å®šé¢œè‰²
                let color = atom.color;
                let label = atom.label;
                
                if (atom.state === 'losing' || atom.state === 'ion') {
                    if (atom.lostElectrons === 2) {
                        color = '#2ecc71'; // FeÂ²âº ç»¿è‰²
                        label = 'FeÂ²âº';
                    } else if (atom.lostElectrons > 2) {
                        color = '#e67e22'; // FeÂ³âº æ©™è‰²
                        label = 'FeÂ³âº';
                    }
                }
                
                // ç»˜åˆ¶åŸå­/ç¦»å­
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(atom.x, atom.y, atom.radius, 0, Math.PI * 2);
                ctx.fill();
                
                // é‡‘å±å…‰æ³½æ•ˆæœ
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.beginPath();
                ctx.arc(atom.x - atom.radius * 0.3, atom.y - atom.radius * 0.3, atom.radius * 0.4, 0, Math.PI * 2);
                ctx.fill();
                
                // æ ‡ç­¾
                if (showLabels) {
                    ctx.fillStyle = '#2c3e50';
                    ctx.font = 'bold 14px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(label, atom.x, atom.y + 4);
                    ctx.textAlign = 'left';
                }
                
                // å¦‚æœæ­£åœ¨å¤±å»ç”µå­ï¼Œæ˜¾ç¤ºåŠ¨ç”»æ•ˆæœ
                if (atom.state === 'losing' && atom.lostElectrons < atom.electronCount) {
                    const progress = animationProgress / 100;
                    const electronAngle = (atom.lostElectrons * Math.PI) + progress * Math.PI * 2;
                    
                    // ç”µå­è½¨é“
                    ctx.strokeStyle = 'rgba(52, 152, 219, 0.5)';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.arc(atom.x, atom.y, atom.radius + 15, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    // ç”µå­
                    const electronX = atom.x + Math.cos(electronAngle) * (atom.radius + 15);
                    const electronY = atom.y + Math.sin(electronAngle) * (atom.radius + 15);
                    
                    ctx.fillStyle = '#3498db';
                    ctx.beginPath();
                    ctx.arc(electronX, electronY, 5, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // ç”µå­å…‰æ™•
                    ctx.fillStyle = 'rgba(52, 152, 219, 0.3)';
                    ctx.beginPath();
                    ctx.arc(electronX, electronY, 8, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // è®°å½•ç”µå­è·¯å¾„
                    if (showElectrons) {
                        electronPaths.push({
                            x: electronX,
                            y: electronY,
                            alpha: 1.0
                        });
                    }
                }
                
                // å¦‚æœæ˜¯ç¦»å­ä¸”å·²ç¦»å¼€é‡‘å±ï¼Œå‘ä¸Šç§»åŠ¨
                if (atom.state === 'ion' && atom.y > 200) {
                    atom.y -= 0.5;
                    
                    // è®°å½•ç¦»å­è·¯å¾„
                    if (showIonPaths) {
                        ionPaths.push({
                            x: atom.x,
                            y: atom.y,
                            color: color,
                            alpha: 1.0
                        });
                    }
                }
            });
        }
        
        // ç»˜åˆ¶æ°§æ°”åˆ†å­
        function drawOxygenMolecules() {
            particles.oxygenMolecules.forEach(oxygen => {
                // ç»˜åˆ¶æ°§æ°”åˆ†å­ï¼ˆä¸¤ä¸ªè¿æ¥çš„çƒï¼‰
                ctx.save();
                ctx.translate(oxygen.x, oxygen.y);
                
                // å·¦ä¾§æ°§åŸå­
                ctx.fillStyle = oxygen.color;
                ctx.beginPath();
                ctx.arc(-8, 0, oxygen.radius, 0, Math.PI * 2);
                ctx.fill();
                
                // å³ä¾§æ°§åŸå­
                ctx.beginPath();
                ctx.arc(8, 0, oxygen.radius, 0, Math.PI * 2);
                ctx.fill();
                
                // è¿æ¥çº¿
                ctx.strokeStyle = oxygen.color;
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(-8, 0);
                ctx.lineTo(8, 0);
                ctx.stroke();
                
                ctx.restore();
                
                // æ ‡ç­¾
                if (showLabels) {
                    ctx.fillStyle = oxygen.color;
                    ctx.font = 'bold 14px Arial';
                    ctx.fillText(oxygen.label, oxygen.x - 10, oxygen.y - 15);
                }
                
                // å¦‚æœæ­£åœ¨æ¥æ”¶ç”µå­ï¼Œæ˜¾ç¤ºåŠ¨ç”»
                if (oxygen.electronsReceived > 0 && oxygen.electronsReceived < oxygen.electronsNeeded) {
                    const angle = (oxygen.electronsReceived * Math.PI / 2) + (animationProgress / 100) * Math.PI;
                    
                    ctx.fillStyle = '#3498db';
                    ctx.beginPath();
                    ctx.arc(
                        oxygen.x + Math.cos(angle) * 20,
                        oxygen.y + Math.sin(angle) * 20,
                        4, 0, Math.PI * 2
                    );
                    ctx.fill();
                }
                
                // å¦‚æœæ¥æ”¶å®Œç”µå­ï¼Œè½¬åŒ–ä¸ºæ°¢æ°§æ ¹ç¦»å­
                if (oxygen.electronsReceived >= oxygen.electronsNeeded && oxygen.state === 'molecule') {
                    oxygen.state = 'converting';
                    
                    // åˆ›å»ºæ°¢æ°§æ ¹ç¦»å­
                    for (let i = 0; i < 4; i++) {
                        particles.hydroxideIons.push({
                            x: oxygen.x,
                            y: oxygen.y,
                            radius: 9,
                            color: '#9b59b6',
                            label: 'OHâ»',
                            targetX: 700 + Math.random() * 150,
                            targetY: 300 + Math.random() * 100,
                            speed: 0.5,
                            arrived: false
                        });
                    }
                }
            });
        }
        
        // ç»˜åˆ¶æ°¢æ°§æ ¹ç¦»å­
        function drawHydroxideIons() {
            particles.hydroxideIons.forEach((ion, index) => {
                // å‘ç›®æ ‡ç§»åŠ¨
                if (!ion.arrived) {
                    const dx = ion.targetX - ion.x;
                    const dy = ion.targetY - ion.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance > 2) {
                        ion.x += (dx / distance) * ion.speed;
                        ion.y += (dy / distance) * ion.speed;
                    } else {
                        ion.arrived = true;
                    }
                    
                    // è®°å½•è·¯å¾„
                    if (showIonPaths) {
                        ionPaths.push({
                            x: ion.x,
                            y: ion.y,
                            color: ion.color,
                            alpha: 1.0
                        });
                    }
                }
                
                // ç»˜åˆ¶ç¦»å­
                ctx.fillStyle = ion.color;
                ctx.beginPath();
                ctx.arc(ion.x, ion.y, ion.radius, 0, Math.PI * 2);
                ctx.fill();
                
                // è´Ÿç”µè·æŒ‡ç¤º
                ctx.strokeStyle = '#9b59b6';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(ion.x, ion.y, ion.radius + 3, 0, Math.PI * 2);
                ctx.stroke();
                
                // æ ‡ç­¾
                if (showLabels) {
                    ctx.fillStyle = ion.color;
                    ctx.font = 'bold 14px Arial';
                    ctx.fillText(ion.label, ion.x - 12, ion.y - 15);
                }
            });
        }
        
        // ç»˜åˆ¶ç”µå­
        function drawElectrons() {
            particles.electrons.forEach((electron, index) => {
                // æ›´æ–°ä½ç½®
                electron.x += electron.vx;
                electron.y += electron.vy;
                
                // ç»˜åˆ¶ç”µå­
                ctx.fillStyle = electron.color;
                ctx.beginPath();
                ctx.arc(electron.x, electron.y, electron.radius, 0, Math.PI * 2);
                ctx.fill();
                
                // ç”µå­å…‰æ™•
                ctx.fillStyle = 'rgba(52, 152, 219, 0.3)';
                ctx.beginPath();
                ctx.arc(electron.x, electron.y, electron.radius + 3, 0, Math.PI * 2);
                ctx.fill();
                
                // è®°å½•è·¯å¾„
                if (showElectrons) {
                    electronPaths.push({
                        x: electron.x,
                        y: electron.y,
                        alpha: 1.0
                    });
                }
                
                // å¦‚æœç”µå­åˆ°è¾¾æ°§æ°”åˆ†å­ï¼Œç§»é™¤ç”µå­å¹¶å¢åŠ æ°§æ°”çš„ç”µå­è®¡æ•°
                particles.oxygenMolecules.forEach(oxygen => {
                    const dx = electron.x - oxygen.x;
                    const dy = electron.y - oxygen.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < 30 && oxygen.electronsReceived < oxygen.electronsNeeded) {
                        particles.electrons.splice(index, 1);
                        oxygen.electronsReceived++;
                    }
                });
            });
        }
        
        // ç»˜åˆ¶è½¨è¿¹
        function drawPaths() {
            // ç»˜åˆ¶ç”µå­è½¨è¿¹
            if (showElectrons) {
                electronPaths.forEach((path, index) => {
                    ctx.fillStyle = `rgba(52, 152, 219, ${path.alpha})`;
                    ctx.beginPath();
                    ctx.arc(path.x, path.y, 2, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // é€æ¸æ·¡å‡º
                    path.alpha -= 0.01;
                    if (path.alpha <= 0) {
                        electronPaths.splice(index, 1);
                    }
                });
            }
            
            // ç»˜åˆ¶ç¦»å­è½¨è¿¹
            if (showIonPaths) {
                ionPaths.forEach((path, index) => {
                    ctx.fillStyle = `rgba(${hexToRgb(path.color)}, ${path.alpha})`;
                    ctx.beginPath();
                    ctx.arc(path.x, path.y, 3, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // é€æ¸æ·¡å‡º
                    path.alpha -= 0.005;
                    if (path.alpha <= 0) {
                        ionPaths.splice(index, 1);
                    }
                });
            }
        }
        
        // å·¥å…·å‡½æ•°ï¼šåå…­è¿›åˆ¶é¢œè‰²è½¬RGB
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? 
                `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : 
                '0, 0, 0';
        }
        
        // æ›´æ–°åŠ¨ç”»è¿›åº¦
        function updateAnimation() {
            if (!isPlaying) return;
            
            // æ ¹æ®é€Ÿåº¦æ›´æ–°è¿›åº¦
            animationProgress += animationSpeed * 0.1;
            
            // é™åˆ¶è¿›åº¦èŒƒå›´
            if (animationProgress > 100) {
                animationProgress = 100;
                if (currentStep < 3) {
                    currentStep++;
                    animationProgress = 0;
                    updateStepIndicator();
                    updateEquationDisplay();
                } else {
                    isPlaying = false;
                    document.getElementById('playBtn').innerHTML = '<span>â–¶ æ’­æ”¾</span>';
                }
            }
            
            // æ›´æ–°è¿›åº¦æ˜¾ç¤º
            document.getElementById('progressValue').textContent = `${Math.round(animationProgress)}%`;
            document.getElementById('progressSlider').value = animationProgress;
            
            // æ ¹æ®å½“å‰æ­¥éª¤å’Œè¿›åº¦æ›´æ–°ç²’å­çŠ¶æ€
            updateParticleStates();
            

<!--æ£€æµ‹åˆ°ä»£ç æˆªæ–­ï¼Œè‡ªåŠ¨ç»­å†™ä¸­...-->
// æ ¹æ®å½“å‰æ­¥éª¤å’Œè¿›åº¦æ›´æ–°ç²’å­çŠ¶æ€
            updateParticleStates();
            
            // ç»˜åˆ¶ä¸‹ä¸€å¸§
            drawFrame();
            
            // ç»§ç»­åŠ¨ç”»å¾ªç¯
            animationId = requestAnimationFrame(updateAnimation);
        }
        
        // æ›´æ–°ç²’å­çŠ¶æ€
        function updateParticleStates() {
            // æ­¥éª¤1: é“åŸå­å¤±å»ç”µå­
            if (currentStep === 0) {
                const activeAtoms = particles.ironAtoms.slice(0, 4); // å‰4ä¸ªåŸå­å‚ä¸ååº”
                
                activeAtoms.forEach((atom, index) => {
                    if (animationProgress > index * 20 && atom.state === 'atom') {
                        atom.state = 'losing';
                    }
                    
                    if (atom.state === 'losing' && animationProgress > 20 + index * 15) {
                        atom.lostElectrons = 2;
                        
                        // åˆ›å»ºç”µå­
                        for (let i = 0; i < 2; i++) {
                            particles.electrons.push({
                                x: atom.x,
                                y: atom.y,
                                radius: 5,
                                color: '#3498db',
                                vx: (Math.random() - 0.5) * 2 + 2,
                                vy: -2 - Math.random() * 2,
                                label: 'eâ»'
                            });
                        }
                        
                        atom.state = 'ion';
                    }
                });
            }
            
            // æ­¥éª¤2: æ°§æ°”è·å¾—ç”µå­
            if (currentStep === 1) {
                // ç”µå­é£å‘æ°§æ°”
                particles.electrons.forEach(electron => {
                    const nearestOxygen = particles.oxygenMolecules[0];
                    if (nearestOxygen) {
                        const dx = nearestOxygen.x - electron.x;
                        const dy = nearestOxygen.y - electron.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance > 10) {
                            electron.vx = (dx / distance) * 3;
                            electron.vy = (dy / distance) * 3;
                        }
                    }
                });
            }
            
            // æ­¥éª¤3: äºšé“ç¦»å­æ°§åŒ–ä¸ºé“ç¦»å­
            if (currentStep === 2) {
                particles.ironAtoms.forEach((atom, index) => {
                    if (atom.state === 'ion' && atom.lostElectrons === 2 && animationProgress > index * 15) {
                        atom.lostElectrons = 3;
                        atom.color = '#e67e22';
                        
                        // åˆ›å»ºé¢å¤–çš„ç”µå­
                        particles.electrons.push({
                            x: atom.x,
                            y: atom.y,
                            radius: 5,
                            color: '#3498db',
                            vx: (Math.random() - 0.5) * 2 + 2,
                            vy: -2 - Math.random() * 2,
                            label: 'eâ»'
                        });
                    }
                });
            }
            
            // æ­¥éª¤4: ç”Ÿæˆé“é”ˆ
            if (currentStep === 3) {
                // é“ç¦»å­å’Œæ°¢æ°§æ ¹ç¦»å­ç»“åˆ
                particles.ironAtoms.forEach((atom, index) => {
                    if (atom.state === 'ion' && atom.lostElectrons === 3 && atom.y > 200) {
                        atom.y -= 0.3; // å‡æ…¢ä¸Šå‡é€Ÿåº¦
                    }
                });
                
                // åœ¨å³ä¾§ç”Ÿæˆé“é”ˆæ²‰æ·€
                if (animationProgress > 50) {
                    // é“é”ˆæ²‰æ·€æ•ˆæœ
                    ctx.fillStyle = 'rgba(192, 57, 43, 0.1)';
                    ctx.fillRect(650, 350, 200, 50);
                }
            }
        }
        
        // ç»˜åˆ¶å®Œæ•´å¸§
        function drawFrame() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶èƒŒæ™¯
            drawMetalBackground();
            drawWaterLayer();
            
            // ç»˜åˆ¶è½¨è¿¹
            drawPaths();
            
            // ç»˜åˆ¶ç²’å­
            drawIronParticles();
            drawOxygenMolecules();
            drawHydroxideIons();
            drawElectrons();
            
            // ç»˜åˆ¶æ­¥éª¤æŒ‡ç¤ºå™¨
            drawStepIndicator();
            
            // ç»˜åˆ¶é“é”ˆåŒºåŸŸ
            if (currentStep === 3 && animationProgress > 30) {
                drawRustFormation();
            }
        }
        
        // ç»˜åˆ¶æ­¥éª¤æŒ‡ç¤ºå™¨
        function drawStepIndicator() {
            const stepTexts = [
                "æ­¥éª¤ 1: é“åŸå­å¤±å»ç”µå­ (æ°§åŒ–)",
                "æ­¥éª¤ 2: æ°§æ°”è·å¾—ç”µå­ (è¿˜åŸ)",
                "æ­¥éª¤ 3: äºšé“ç¦»å­è¿›ä¸€æ­¥æ°§åŒ–",
                "æ­¥éª¤ 4: ç”Ÿæˆæ°´åˆæ°§åŒ–é“ (é“é”ˆ)"
            ];
            
            const stepColors = ['#3498db', '#e74c3c', '#e67e22', '#c0392b'];
            
            ctx.fillStyle = stepColors[currentStep];
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(stepTexts[currentStep], canvas.width / 2, 40);
            ctx.textAlign = 'left';
            
            // è¿›åº¦æ¡
            ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.fillRect(canvas.width / 2 - 100, 50, 200, 10);
            
            ctx.fillStyle = stepColors[currentStep];
            ctx.fillRect(canvas.width / 2 - 100, 50, (animationProgress / 100) * 200, 10);
        }
        
        // ç»˜åˆ¶é“é”ˆå½¢æˆ
        function drawRustFormation() {
            const rustX = 700;
            const rustY = 380;
            const rustWidth = 150;
            const rustHeight = 40;
            
            // é“é”ˆæ²‰æ·€
            ctx.fillStyle = 'rgba(192, 57, 43, 0.3)';
            ctx.fillRect(rustX, rustY, rustWidth, rustHeight);
            
            // é“é”ˆæ™¶ä½“ï¼ˆç®€åŒ–è¡¨ç¤ºï¼‰
            for (let i = 0; i < 15; i++) {
                const x = rustX + Math.random() * rustWidth;
                const y = rustY + Math.random() * rustHeight;
                const size = 3 + Math.random() * 5;
                
                ctx.fillStyle = 'rgba(231, 76, 60, 0.8)';
                ctx.beginPath();
                ctx.rect(x, y, size, size);
                ctx.fill();
            }
            
            // æ ‡ç­¾
            if (showLabels) {
                ctx.fillStyle = '#c0392b';
                ctx.font = 'bold 16px Arial';
                ctx.fillText('é“é”ˆ (Feâ‚‚Oâ‚ƒÂ·xHâ‚‚O)', rustX + 30, rustY - 10);
            }
        }
        
        // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
        function updateStepIndicator() {
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            
            document.querySelector(`.step[data-step="${currentStep}"]`).classList.add('active');
        }
        
        // æ›´æ–°æ–¹ç¨‹å¼æ˜¾ç¤º
        function updateEquationDisplay() {
            document.querySelectorAll('.equation-step').forEach(step => {
                step.classList.remove('active');
            });
            
            document.querySelector(`.equation-step[data-step="${currentStep}"]`).classList.add('active');
            
            // æ›´æ–°æ–¹ç¨‹å¼æ ‡ç­¾
            const equationLabels = [
                "é˜³æååº”ï¼šé“åŸå­è¢«æ°§åŒ–ï¼Œå¤±å»ç”µå­",
                "é˜´æååº”ï¼šæ°§æ°”è¢«è¿˜åŸï¼Œè·å¾—ç”µå­å¹¶ä¸æ°´ååº”",
                "è¿›ä¸€æ­¥æ°§åŒ–ï¼šäºšé“ç¦»å­åœ¨æº¶æ¶²ä¸­æ°§åŒ–ä¸ºé“ç¦»å­",
                "æ²‰æ·€ååº”ï¼šé“ç¦»å­ä¸æ°¢æ°§æ ¹ç»“åˆç”Ÿæˆé“é”ˆ"
            ];
            
            document.getElementById('equationLabel').textContent = equationLabels[currentStep];
        }
        
        // é¼ æ ‡æ‚¬åœæ£€æµ‹
        function handleMouseMove(e) {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            let tooltipText = '';
            
            // æ£€æµ‹é“åŸå­/ç¦»å­
            particles.ironAtoms.forEach(atom => {
                const dx = mouseX - atom.x;
                const dy = mouseY - atom.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < atom.radius) {
                    if (atom.state === 'atom') {
                        tooltipText = 'é“åŸå­ (Fe)<br>é‡‘å±æ™¶æ ¼ä¸­çš„ä¸­æ€§åŸå­';
                    } else if (atom.lostElectrons === 2) {
                        tooltipText = 'äºšé“ç¦»å­ (FeÂ²âº)<br>å¤±å»2ä¸ªç”µå­ï¼Œå¸¦2ä¸ªæ­£ç”µè·';
                    } else if (atom.lostElectrons === 3) {
                        tooltipText = 'é“ç¦»å­ (FeÂ³âº)<br>å¤±å»3ä¸ªç”µå­ï¼Œå¸¦3ä¸ªæ­£ç”µè·';
                    }
                }
            });
            
            // æ£€æµ‹æ°§æ°”åˆ†å­
            particles.oxygenMolecules.forEach(oxygen => {
                const dx = mouseX - oxygen.x;
                const dy = mouseY - oxygen.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < oxygen.radius * 2) {
                    tooltipText = `æ°§æ°”åˆ†å­ (Oâ‚‚)<br>æ°§åŒ–å‰‚ï¼Œè·å¾—ç”µå­è¢«è¿˜åŸ<br>å·²æ¥æ”¶ç”µå­: ${oxygen.electronsReceived}/${oxygen.electronsNeeded}`;
                }
            });
            
            // æ£€æµ‹ç”µå­
            particles.electrons.forEach(electron => {
                const dx = mouseX - electron.x;
                const dy = mouseY - electron.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < electron.radius * 2) {
                    tooltipText = 'ç”µå­ (eâ»)<br>å¸¦è´Ÿç”µè·ï¼Œä»é“åŸå­æµå‘æ°§æ°”';
                }
            });
            
            // æ£€æµ‹æ°¢æ°§æ ¹ç¦»å­
            particles.hydroxideIons.forEach(ion => {
                const dx = mouseX - ion.x;
                const dy = mouseY - ion.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < ion.radius) {
                    tooltipText = 'æ°¢æ°§æ ¹ç¦»å­ (OHâ»)<br>æ°§æ°”è¿˜åŸååº”çš„äº§ç‰©ï¼Œå¸¦è´Ÿç”µè·';
                }
            });
            
            // æ˜¾ç¤º/éšè—å·¥å…·æç¤º
            if (tooltipText) {
                tooltip.innerHTML = tooltipText;
                tooltip.style.left = (mouseX + 15) + 'px';
                tooltip.style.top = (mouseY + 15) + 'px';
                tooltip.style.opacity = '1';
            } else {
                tooltip.style.opacity = '0';
            }
        }
        
        // åˆå§‹åŒ–
        function init() {
            initParticles();
            drawFrame();
            
            // äº‹ä»¶ç›‘å¬å™¨
            canvas.addEventListener('mousemove', handleMouseMove);
            
            // æ§åˆ¶æŒ‰é’®
            document.getElementById('playBtn').addEventListener('click', () => {
                if (!isPlaying) {
                    isPlaying = true;
                    document.getElementById('playBtn').innerHTML = '<span>â¸ï¸ æš‚åœ</span>';
                    animationId = requestAnimationFrame(updateAnimation);
                } else {
                    isPlaying = false;
                    document.getElementById('playBtn').innerHTML = '<span>â–¶ æ’­æ”¾</span>';
                    if (animationId) cancelAnimationFrame(animationId);
                }
            });
            
            document.getElementById('pauseBtn').addEventListener('click', () => {
                isPlaying = false;
                document.getElementById('playBtn').innerHTML = '<span>â–¶ æ’­æ”¾</span>';
                if (animationId) cancelAnimationFrame(animationId);
            });
            
            document.getElementById('stepBtn').addEventListener('click', () => {
                if (currentStep < 3) {
                    currentStep++;
                    animationProgress = 0;
                } else if (animationProgress < 100) {
                    animationProgress = Math.min(animationProgress + 20, 100);
                }
                
                updateStepIndicator();
                updateEquationDisplay();
                updateParticleStates();
                drawFrame();
                
                document.getElementById('progressValue').textContent = `${Math.round(animationProgress)}%`;
                document.getElementById('progressSlider').value = animationProgress;
            });
            
            document.getElementById('prevBtn').addEventListener('click', () => {
                if (currentStep > 0) {
                    currentStep--;
                    animationProgress = 0;
                } else if (animationProgress > 0) {
                    animationProgress = Math.max(animationProgress - 20, 0);
                }
                
                updateStepIndicator();
                updateEquationDisplay();
                updateParticleStates();
                drawFrame();
                
                document.getElementById('progressValue').textContent = `${Math.round(animationProgress)}%`;
                document.getElementById('progressSlider').value = animationProgress;
            });
            
            document.getElementById('slowBtn').addEventListener('click', () => {
                animationSpeed = Math.max(1, animationSpeed - 2);
                updateSpeedDisplay();
            });
            
            document.getElementById('fastBtn').addEventListener('click', () => {
                animationSpeed = Math.min(10, animationSpeed + 2);
                updateSpeedDisplay();
            });
            
            document.getElementById('resetBtn').addEventListener('click', () => {
                isPlaying = false;
                document.getElementById('playBtn').innerHTML = '<span>â–¶ æ’­æ”¾</span>';
                if (animationId) cancelAnimationFrame(animationId);
                
                currentStep = 0;
                animationProgress = 0;
                animationSpeed = 5;
                
                initParticles();
                updateStepIndicator();
                updateEquationDisplay();
                updateSpeedDisplay();
                
                document.getElementById('progressValue').textContent = '0%';
                document.getElementById('progressSlider').value = 0;
                
                drawFrame();
            });
            
            // é€Ÿåº¦æ»‘å—
            document.getElementById('speedSlider').addEventListener('input', (e) => {
                animationSpeed = parseInt(e.target.value);
                updateSpeedDisplay();
            });
            
            // è¿›åº¦æ»‘å—
            document.getElementById('progressSlider').addEventListener('input', (e) => {
                animationProgress = parseInt(e.target.value);
                document.getElementById('progressValue').textContent = `${animationProgress}%`;
                
                // æ ¹æ®è¿›åº¦ç¡®å®šå½“å‰æ­¥éª¤
                if (animationProgress === 100 && currentStep < 3) {
                    currentStep++;
                    animationProgress = 0;
                    updateStepIndicator();
                    updateEquationDisplay();
                }
                
                updateParticleStates();
                drawFrame();
            });
            
            // è§†è§‰é€‰é¡¹
            document.getElementById('showElectrons').addEventListener('change', (e) => {
                showElectrons = e.target.checked;
                drawFrame();
            });
            
            document.getElementById('showIonPaths').addEventListener('change', (e) => {
                showIonPaths = e.target.checked;
                drawFrame();
            });
            
            document.getElementById('showLabels').addEventListener('change', (e) => {
                showLabels = e.target.checked;
                drawFrame();
            });
            
            document.getElementById('showWater').addEventListener('change', (e) => {
                showWater = e.target.checked;
                initParticles();
                drawFrame();
            });
            
            // æ­¥éª¤å¯¼èˆª
            document.querySelectorAll('.step').forEach(step => {
                step.addEventListener('click', () => {
                    const stepNum = parseInt(step.getAttribute('data-step'));
                    currentStep = stepNum;
                    animationProgress = 0;
                    
                    updateStepIndicator();
                    updateEquationDisplay();
                    updateParticleStates();
                    drawFrame();
                    
                    document.getElementById('progressValue').textContent = '0%';
                    document.getElementById('progressSlider').value = 0;
                });
            });
            
            // æ›´æ–°é€Ÿåº¦æ˜¾ç¤º
            function updateSpeedDisplay() {
                document.getElementById('speedSlider').value = animationSpeed;
                const speedLabels = ['ææ…¢', 'å¾ˆæ…¢', 'è¾ƒæ…¢', 'ç¨æ…¢', 'æ­£å¸¸', 'ç¨å¿«', 'è¾ƒå¿«', 'å¾ˆå¿«', 'æå¿«', 'æœ€å¿«'];
                document.getElementById('speedValue').textContent = speedLabels[animationSpeed - 1] || 'æ­£å¸¸';
            }
            
            // åˆå§‹æ˜¾ç¤º
            updateSpeedDisplay();
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>