<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®éªŒå®¤åˆ¶å–äºŒæ°§åŒ–ç¢³å¾®è§‚è¿‡ç¨‹åŠ¨ç”»</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #e6f7ff 0%, #f0f9ff 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #333;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            width: 100%;
            max-width: 1000px;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.2rem;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 1.1rem;
            margin-bottom: 15px;
        }
        
        .equation {
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 15px;
            margin: 15px auto;
            font-size: 1.5rem;
            font-weight: bold;
            color: #2980b9;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            text-align: center;
        }
        
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            max-width: 1200px;
            width: 100%;
            justify-content: center;
        }
        
        .animation-area {
            flex: 1;
            min-width: 600px;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .canvas-container {
            flex: 1;
            position: relative;
            background: linear-gradient(to bottom, #87CEEB 0%, #E0F7FF 100%);
            overflow: hidden;
        }
        
        #reactionCanvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        
        .info-panel {
            flex: 0 0 350px;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            padding: 25px;
            display: flex;
            flex-direction: column;
        }
        
        .panel-title {
            color: #2c3e50;
            font-size: 1.4rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .step-indicator {
            margin-bottom: 25px;
        }
        
        .step-list {
            list-style-type: none;
        }
        
        .step-item {
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            background-color: #f8f9fa;
            border-left: 4px solid #bdc3c7;
            transition: all 0.3s ease;
        }
        
        .step-item.active {
            background-color: #e3f2fd;
            border-left-color: #2196f3;
            font-weight: bold;
            color: #1565c0;
        }
        
        .step-number {
            display: inline-block;
            width: 26px;
            height: 26px;
            background-color: #bdc3c7;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 26px;
            margin-right: 10px;
            font-size: 0.9rem;
        }
        
        .step-item.active .step-number {
            background-color: #2196f3;
        }
        
        .legend {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid #ecf0f1;
        }
        
        .legend-title {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .legend-items {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 20px;
            background-color: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: #2196f3;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0d8bf2;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
        }
        
        .btn-outline {
            background-color: transparent;
            color: #2196f3;
            border: 2px solid #2196f3;
        }
        
        .btn-outline:hover {
            background-color: #e3f2fd;
        }
        
        .view-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 15px;
            background-color: #f1f8ff;
            border-bottom: 1px solid #e9ecef;
        }
        
        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .speed-slider {
            flex: 1;
        }
        
        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            pointer-events: none;
            z-index: 100;
            max-width: 200px;
            transform: translate(-50%, -100%);
            margin-top: -10px;
            display: none;
        }
        
        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.85) transparent transparent transparent;
        }
        
        @media (max-width: 1100px) {
            .container {
                flex-direction: column;
                align-items: center;
            }
            
            .animation-area, .info-panel {
                width: 100%;
                min-width: unset;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>å®éªŒå®¤åˆ¶å–äºŒæ°§åŒ–ç¢³å¾®è§‚è¿‡ç¨‹</h1>
        <p class="subtitle">CaCOâ‚ƒ + 2HCl â†’ CaClâ‚‚ + Hâ‚‚O + COâ‚‚â†‘ çš„åˆ†å­å±‚é¢å¯è§†åŒ–</p>
        <div class="equation">
            CaCOâ‚ƒ(s) + 2Hâº(aq) â†’ CaÂ²âº(aq) + Hâ‚‚O(l) + COâ‚‚(g)â†‘
        </div>
    </div>
    
    <div class="container">
        <div class="animation-area">
            <div class="view-controls">
                <button id="macroViewBtn" class="btn btn-outline">
                    <span>ğŸ”</span> å®è§‚è§†è§’
                </button>
                <button id="microViewBtn" class="btn btn-primary">
                    <span>ğŸ”¬</span> å¾®è§‚è§†è§’
                </button>
            </div>
            
            <div class="canvas-container">
                <canvas id="reactionCanvas"></canvas>
                <div id="tooltip" class="tooltip"></div>
            </div>
            
            <div class="controls">
                <button id="resetBtn" class="btn btn-secondary">
                    <span>ğŸ”„</span> é‡ç½®
                </button>
                <button id="prevBtn" class="btn btn-secondary">
                    <span>â—€</span> ä¸Šä¸€æ­¥
                </button>
                <button id="playPauseBtn" class="btn btn-primary">
                    <span>â–¶</span> æ’­æ”¾
                </button>
                <button id="nextBtn" class="btn btn-secondary">
                    <span>â–¶</span> ä¸‹ä¸€æ­¥
                </button>
            </div>
            
            <div class="speed-control">
                <span>åŠ¨ç”»é€Ÿåº¦:</span>
                <input type="range" id="speedSlider" class="speed-slider" min="0.5" max="3" step="0.5" value="1">
                <span id="speedValue">æ­£å¸¸</span>
            </div>
        </div>
        
        <div class="info-panel">
            <h2 class="panel-title">ååº”æ­¥éª¤</h2>
            
            <div class="step-indicator">
                <ul class="step-list">
                    <li class="step-item active" data-step="0">
                        <span class="step-number">1</span>
                        å›ºä½“CaCOâ‚ƒä¸ç¨€ç›é…¸æ¥è§¦
                    </li>
                    <li class="step-item" data-step="1">
                        <span class="step-number">2</span>
                        Hâºç¦»å­æ”»å‡»COâ‚ƒÂ²â»ç¦»å­
                    </li>
                    <li class="step-item" data-step="2">
                        <span class="step-number">3</span>
                        å½¢æˆHâ‚‚COâ‚ƒå¹¶åˆ†è§£ä¸ºHâ‚‚Oå’ŒCOâ‚‚
                    </li>
                    <li class="step-item" data-step="3">
                        <span class="step-number">4</span>
                        COâ‚‚åˆ†å­é€¸å‡ºæº¶æ¶²
                    </li>
                    <li class="step-item" data-step="4">
                        <span class="step-number">5</span>
                        ååº”å®Œæˆï¼Œç”ŸæˆCaÂ²âºå’ŒClâ»ç¦»å­
                    </li>
                </ul>
            </div>
            
            <div class="current-step-info">
                <h3 class="panel-title">å½“å‰æ­¥éª¤è¯´æ˜</h3>
                <div id="stepDescription" class="step-description">
                    å¤§ç†çŸ³ï¼ˆä¸»è¦æˆåˆ†CaCOâ‚ƒï¼‰å›ºä½“ä¸ç¨€ç›é…¸æ¥è§¦ã€‚å›ºä½“è¡¨é¢çš„CaCOâ‚ƒåˆ†å­å¼€å§‹æº¶è§£è¿›å…¥æº¶æ¶²ã€‚
                </div>
            </div>
            
            <div class="legend">
                <h3 class="legend-title">åˆ†å­/ç¦»å­å›¾ä¾‹</h3>
                <div class="legend-items">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #95a5a6;"></div>
                        <span>é’™ç¦»å­ CaÂ²âº</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e74c3c;"></div>
                        <span>æ°§åŸå­ O</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #7f8c8d;"></div>
                        <span>ç¢³åŸå­ C</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #ff6b9d;"></div>
                        <span>æ°¢ç¦»å­ Hâº</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #2ecc71;"></div>
                        <span>æ°¯ç¦»å­ Clâ»</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #3498db;"></div>
                        <span>æ°´åˆ†å­ Hâ‚‚O</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        const canvas = document.getElementById('reactionCanvas');
        const ctx = canvas.getContext('2d');
        const tooltip = document.getElementById('tooltip');
        const stepItems = document.querySelectorAll('.step-item');
        const stepDescription = document.getElementById('stepDescription');
        const speedSlider = document.getElementById('speedSlider');
        const speedValue = document.getElementById('speedValue');
        
        // åŠ¨ç”»çŠ¶æ€
        let animationId = null;
        let isPlaying = false;
        let currentStep = 0;
        let animationSpeed = 1.0;
        let isMicroView = true;
        
        // æ­¥éª¤æè¿°
        const stepDescriptions = [
            "å¤§ç†çŸ³ï¼ˆä¸»è¦æˆåˆ†CaCOâ‚ƒï¼‰å›ºä½“ä¸ç¨€ç›é…¸æ¥è§¦ã€‚å›ºä½“è¡¨é¢çš„CaCOâ‚ƒåˆ†å­å¼€å§‹æº¶è§£è¿›å…¥æº¶æ¶²ï¼Œè§£ç¦»ä¸ºCaÂ²âºå’ŒCOâ‚ƒÂ²â»ç¦»å­ã€‚",
            "æº¶æ¶²ä¸­çš„Hâºç¦»å­ï¼ˆæ¥è‡ªHClï¼‰æ”»å‡»COâ‚ƒÂ²â»ç¦»å­ã€‚æ¯ä¸ªCOâ‚ƒÂ²â»ç¦»å­ä¸2ä¸ªHâºç¦»å­ç»“åˆï¼Œå½¢æˆä¸ç¨³å®šçš„Hâ‚‚COâ‚ƒï¼ˆç¢³é…¸ï¼‰ã€‚",
            "Hâ‚‚COâ‚ƒåˆ†å­æä¸ç¨³å®šï¼Œç«‹å³åˆ†è§£ä¸ºä¸€ä¸ªæ°´åˆ†å­ï¼ˆHâ‚‚Oï¼‰å’Œä¸€ä¸ªäºŒæ°§åŒ–ç¢³åˆ†å­ï¼ˆCOâ‚‚ï¼‰ã€‚è¿™æ˜¯ååº”çš„å…³é”®æ­¥éª¤ã€‚",
            "COâ‚‚åˆ†å­åœ¨æ°´ä¸­çš„æº¶è§£åº¦è¾ƒä½ï¼Œå› æ­¤ä»æº¶æ¶²ä¸­é€¸å‡ºï¼Œå½¢æˆæ°”æ³¡ã€‚æ°”æ³¡ä¸Šå‡åˆ°æ¶²é¢ï¼Œè¿›å…¥ç©ºæ°”ä¸­ã€‚",
            "ååº”å®Œæˆåï¼Œæº¶æ¶²ä¸­ç•™ä¸‹CaÂ²âºå’ŒClâ»ç¦»å­ï¼Œå®ƒä»¬ç»“åˆå½¢æˆCaClâ‚‚ï¼ˆæ°¯åŒ–é’™ï¼‰ã€‚å¤§ç†çŸ³å›ºä½“ä¸æ–­æº¶è§£ï¼Œç›´åˆ°ååº”ç‰©è€—å°½ã€‚"
        ];
        
        // åŸå­é¢œè‰²å®šä¹‰ (CPKè§„åˆ™)
        const atomColors = {
            'C': '#7f8c8d',   // ç¢³ - ç°è‰²
            'O': '#e74c3c',   // æ°§ - çº¢è‰²
            'H': '#ffffff',   // æ°¢ - ç™½è‰²
            'Cl': '#2ecc71',  // æ°¯ - ç»¿è‰²
            'Ca': '#95a5a6',  // é’™ - æµ…ç°è‰²
            'H+': '#ff6b9d'   // æ°¢ç¦»å­ - ç²‰è‰²
        };
        
        // åˆ†å­å’Œç¦»å­å®šä¹‰
        class Particle {
            constructor(x, y, type, charge = 0) {
                this.x = x;
                this.y = y;
                this.type = type;
                this.charge = charge;
                this.vx = 0;
                this.vy = 0;
                this.radius = 0;
                this.color = '#ffffff';
                this.label = '';
                this.isActive = true;
                this.bondedTo = [];
                this.initProperties();
            }
            
            initProperties() {
                switch(this.type) {
                    case 'Ca2+':
                        this.radius = 12;
                        this.color = atomColors.Ca;
                        this.label = 'CaÂ²âº';
                        break;
                    case 'CO3-2':
                        this.radius = 18;
                        this.color = '#d35400';
                        this.label = 'COâ‚ƒÂ²â»';
                        break;
                    case 'H+':
                        this.radius = 10;
                        this.color = atomColors['H+'];
                        this.label = 'Hâº';
                        break;
                    case 'Cl-':
                        this.radius = 11;
                        this.color = atomColors.Cl;
                        this.label = 'Clâ»';
                        break;
                    case 'H2O':
                        this.radius = 14;
                        this.color = '#3498db';
                        this.label = 'Hâ‚‚O';
                        break;
                    case 'CO2':
                        this.radius = 16;
                        this.color = '#f39c12';
                        this.label = 'COâ‚‚';
                        break;
                    case 'C':
                        this.radius = 10;
                        this.color = atomColors.C;
                        break;
                    case 'O':
                        this.radius = 9;
                        this.color = atomColors.O;
                        break;
                }
            }
            
            draw() {
                if (!this.isActive) return;
                
                // ç»˜åˆ¶ç²’å­
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
                
                // ç»˜åˆ¶è¾¹æ¡†
                ctx.strokeStyle = 'rgba(0, 0, 0, 0.2)';
                ctx.lineWidth = 1;
                ctx.stroke();
                
                // ç»˜åˆ¶æ ‡ç­¾
                if (this.label) {
                    ctx.fillStyle = '#2c3e50';
                    ctx.font = 'bold 12px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(this.label, this.x, this.y);
                }
                
                // ç»˜åˆ¶ç”µè·ç¬¦å·
                if (this.charge !== 0) {
                    ctx.fillStyle = this.charge > 0 ? '#e74c3c' : '#3498db';
                    ctx.font = '10px Arial';
                    ctx.textAlign = 'right';
                    ctx.textBaseline = 'top';
                    const chargeText = this.charge > 0 ? 
                        (this.charge === 1 ? '+' : this.charge + '+') : 
                        (this.charge === -1 ? 'âˆ’' : this.charge + 'âˆ’');
                    ctx.fillText(chargeText, this.x + this.radius - 2, this.y - this.radius + 2);
                }
            }
            
            update() {
                if (!this.isActive) return;
                
                // åº”ç”¨éšæœºè¿åŠ¨ï¼ˆå¸ƒæœ—è¿åŠ¨ï¼‰
                this.vx += (Math.random() - 0.5) * 0.2 * animationSpeed;
                this.vy += (Math.random() - 0.5) * 0.2 * animationSpeed;
                
                // é™åˆ¶é€Ÿåº¦
                const maxSpeed = 1.5 * animationSpeed;
                const speed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
                if (speed > maxSpeed) {
                    this.vx = (this.vx / speed) * maxSpeed;
                    this.vy = (this.vy / speed) * maxSpeed;
                }
                
                // åº”ç”¨é˜»å°¼
                this.vx *= 0.95;
                this.vy *= 0.95;
                
                // æ›´æ–°ä½ç½®
                this.x += this.vx;
                this.y += this.vy;
                
                // è¾¹ç•Œæ£€æŸ¥
                const canvasWidth = canvas.width;
                const canvasHeight = canvas.height;
                
                if (this.x < this.radius) {
                    this.x = this.radius;
                    this.vx = Math.abs(this.vx) * 0.5;
                }
                if (this.x > canvasWidth - this.radius) {
                    this.x = canvasWidth - this.radius;
                    this.vx = -Math.abs(this.vx) * 0.5;
                }
                if (this.y < this.radius) {
                    this.y = this.radius;
                    this.vy = Math.abs(this.vy) * 0.5;
                }
                if (this.y > canvasHeight - this.radius) {
                    this.y = canvasHeight - this.radius;
                    this.vy = -Math.abs(this.vy) * 0.5;
                }
            }
            
            isMouseOver(mx, my) {
                const dx = mx - this.x;
                const dy = my - this.y;
                return dx * dx + dy * dy <= this.radius * this.radius;
            }
        }
        
        // ååº”ç³»ç»Ÿ
        class ReactionSystem {
            constructor() {
                this.particles = [];
                this.solidParticles = [];
                this.bubbles = [];
                this.stepProgress = 0;
                this.stepDuration = 300; // æ¯æ­¥åŠ¨ç”»å¸§æ•°
                this.initSystem();
            }
            
            initSystem() {
                this.particles = [];
                this.solidParticles = [];
                this.bubbles = [];
                this.stepProgress = 0;
                
                const canvasWidth = canvas.width;
                const canvasHeight = canvas.height;
                
                // åˆ›å»ºå›ºä½“CaCOâ‚ƒï¼ˆåº•éƒ¨ï¼‰
                const solidWidth = 300;
                const solidHeight = 80;
                const solidX = canvasWidth / 2 - solidWidth / 2;
                const solidY = canvasHeight - solidHeight - 20;
                
                for (let i = 0; i < 25; i++) {
                    const x = solidX + Math.random() * solidWidth;
                    const y = solidY + Math.random() * solidHeight;
                    const particle = new Particle(x, y, 'CO3-2');
                    particle.vx = 0;
                    particle.vy = 0;
                    particle.isInSolid = true;
                    this.solidParticles.push(particle);
                }
                
                // åˆ›å»ºæº¶æ¶²ä¸­çš„ç¦»å­
                // H+ ç¦»å­
                for (let i = 0; i < 15; i++) {
                    const x = 100 + Math.random() * (canvasWidth - 200);
                    const y = 150 + Math.random() * (solidY - 200);
                    const particle = new Particle(x, y, 'H+');
                    particle.charge = 1;
                    this.particles.push(particle);
                }
                
                // Cl- ç¦»å­
                for (let i = 0; i < 15; i++) {
                    const x = 100 + Math.random() * (canvasWidth - 200);
                    const y = 150 + Math.random() * (solidY - 200);
                    const particle = new Particle(x, y, 'Cl-');
                    particle.charge = -1;
                    this.particles.push(particle);
                }
                
                // H2O åˆ†å­
                for (let i = 0; i < 30; i++) {
                    const x = 100 + Math.random() * (canvasWidth - 200);
                    const y = 150 + Math.random() * (solidY - 200);
                    const particle = new Particle(x, y, 'H2O');
                    this.particles.push(particle);
                }
            }
            
            update() {
                this.stepProgress++;
                
                // æ ¹æ®å½“å‰æ­¥éª¤æ›´æ–°ç³»ç»Ÿ
                switch(currentStep) {
                    case 0: // å›ºä½“æº¶è§£
                        this.updateStep0();
                        break;
                    case 1: // H+æ”»å‡»CO3-2
                        this.updateStep1();
                        break;
                    case 2: // å½¢æˆH2CO3å¹¶åˆ†è§£
                        this.updateStep2();
                        break;
                    case 3: // CO2é€¸å‡º
                        this.updateStep3();
                        break;
                    case 4: // ååº”å®Œæˆ
                        this.updateStep4();
                        break;
                }
                
                // æ›´æ–°æ‰€æœ‰ç²’å­
                this.particles.forEach(p => p.update());
                
                // æ›´æ–°æ°”æ³¡
                this.bubbles.forEach(bubble => {
                    bubble.y -= 2 * animationSpeed;
                    bubble.x += Math.sin(bubble.y * 0.05) * 0.5;
                    
                    // ç§»é™¤è¶…å‡ºç”»å¸ƒçš„æ°”æ³¡
                    if (bubble.y < -20) {
                        bubble.isActive = false;
                    }
                });
                
                // è¿‡æ»¤æ‰ä¸æ´»è·ƒçš„æ°”æ³¡
                this.bubbles = this.bubbles.filter(b => b.isActive);
                
                // è‡ªåŠ¨è¿›å…¥ä¸‹ä¸€æ­¥
                if (this.stepProgress > this.stepDuration && isPlaying) {
                    if (currentStep < 4) {
                        goToStep(currentStep + 1);
                    } else {
                        isPlaying = false;
                        document.getElementById('playPauseBtn').innerHTML = '<span>â–¶</span> æ’­æ”¾';
                    }
                }
            }
            
            updateStep0() {
                // å›ºä½“é€æ¸æº¶è§£
                if (this.stepProgress % 20 === 0 && this.solidParticles.length > 0) {
                    const particle = this.solidParticles.pop();
                    particle.isInSolid = false;
                    particle.vx = (Math.random() - 0.5) * 2;
                    particle.vy = -1 - Math.random() * 2;
                    
                    // åŒæ—¶é‡Šæ”¾Ca2+ç¦»å­
                    const caParticle = new Particle(
                        particle.x + 20, 
                        particle.y, 
                        'Ca2+'
                    );
                    caParticle.charge = 2;
                    caParticle.vx = (Math.random() - 0.5) * 2;
                    caParticle.vy = -1 - Math.random() * 2;
                    this.particles.push(caParticle);
                    
                    this.particles.push(particle);
                }
            }
            
            updateStep1() {
                // H+ç¦»å­å‘CO3-2ç¦»å­ç§»åŠ¨
                const co3Particles = this.particles.filter(p => p.type === 'CO3-2');
                const hPlusParticles = this.particles.filter(p => p.type === 'H+');
                
                co3Particles.forEach(co3 => {
                    // å¯»æ‰¾æœ€è¿‘çš„H+ç¦»å­
                    let closestH = null;
                    let minDist = Infinity;
                    
                    hPlusParticles.forEach(h => {
                        if (h.bondedTo.length > 0) continue; // å·²ç»ç»“åˆçš„H+
                        
                        const dx = h.x - co3.x;
                        const dy = h.y - co3.y;
                        const dist = dx * dx + dy * dy;
                        
                        if (dist < minDist && dist < 10000) {
                            minDist = dist;
                            closestH = h;
                        }
                    });
                    
                    // å¦‚æœæ‰¾åˆ°H+ç¦»å­ä¸”CO3-2è¿˜æ²¡æœ‰ç»“åˆ2ä¸ªH+
                    if (closestH && co3.bondedTo.length < 2) {
                        const dx = co3.x - closestH.x;
                        const dy = co3.y - closestH.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        
                        if (dist > 30) {
                            // å‘CO3-2ç§»åŠ¨
                            closestH.vx -= dx / dist * 0.3 * animationSpeed;
                            closestH.vy -= dy / dist * 0.3 * animationSpeed;
                        } else if (dist < 25) {
                            // ç»“åˆ
                            closestH.bondedTo.push(co3);
                            co3.bondedTo.push(closestH);
                            
                            // æ”¹å˜é¢œè‰²è¡¨ç¤ºç»“åˆ
                            if (co3.bondedTo.length === 2) {
                                co3.color = '#9b59b6'; // ç´«è‰²è¡¨ç¤ºH2CO3
                                co3.label = 'Hâ‚‚COâ‚ƒ';
                            }
                        }
                    }
                });
            }
            
            updateStep2() {
                // å¯»æ‰¾å·²ç»“åˆ2ä¸ªH+çš„CO3-2ï¼ˆå³H2CO3ï¼‰
                const h2co3Particles = this.particles.filter(p => 
                    p.type === 'CO3-2' && p.bondedTo.length === 2
                );
                
                h2co3Particles.forEach(h2co3 => {
                    // é€æ¸åˆ†è§£
                    if (this.stepProgress > 100) {
                        // åˆ†è§£ä¸ºCO2å’ŒH2O
                        h2co3.isActive = false;
                        
                        // åˆ›å»ºCO2åˆ†å­
                        const co2 = new Particle(h2co3.x, h2co3.y, 'CO2');
                        co2.vx = (Math.random() - 0.5) * 2;
                        co2.vy = -1 - Math.random();
                        this.particles.push(co2);
                        
                        // åˆ›å»ºH2Oåˆ†å­
                        const h2o = new Particle(h2co3.x + 15, h2co3.y, 'H2O');
                        h2o.vx = (Math.random() - 0.5) * 2;
                        h2o.vy = -0.5 - Math.random();
                        this.particles.push(h2o);
                        
                        // ç§»é™¤ç»“åˆçš„H+ç¦»å­
                        h2co3.bondedTo.forEach(h => {
                            h.isActive = false;
                        });
                    }
                });
            }
            
            updateStep3() {
                // CO2åˆ†å­ä¸Šå‡å¹¶å½¢æˆæ°”æ³¡
                const co2Particles = this.particles.filter(p => p.type === 'CO2');
                
                co2Particles.forEach(co2 => {
                    // å‘ä¸Šè¿åŠ¨
                    co2.vy -= 0.05 * animationSpeed;
                    
                    // å½“æ¥è¿‘é¡¶éƒ¨æ—¶å½¢æˆæ°”æ³¡
                    if (co2.y < 150 && Math.random() < 0.02) {
                        this.bubbles.push({
                            x: co2.x,
                            y: co2.y,
                            radius: 15 + Math.random() * 10,
                            isActive: true
                        });
                        co2.isActive = false;
                    }
                });
            }
            
            updateStep4() {
                // ååº”å®Œæˆï¼Œç²’å­è‡ªç”±è¿åŠ¨
                // å¯ä»¥æ·»åŠ ä¸€äº›æœ€ç»ˆçŠ¶æ€çš„è§†è§‰æ•ˆæœ
            }
            
            draw() {
                // ç»˜åˆ¶çƒ§æ¯ï¼ˆå®è§‚è§†å›¾ï¼‰
                if (!isMicroView) {
                    this.drawBeaker();
                    return;
                }
                
                // ç»˜åˆ¶å¾®è§‚è§†å›¾
                
                // ç»˜åˆ¶å›ºä½“åŒºåŸŸ
                ctx.fillStyle = 'rgba(189, 195, 199, 0.7)';
                ctx.fillRect(canvas.width/2 - 150, canvas.height - 100, 300, 80);
                
                // ç»˜åˆ¶å›ºä½“ç²’å­
                this.solidParticles.forEach(p => {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fillStyle = p.color;
                    ctx.fill();
                    
                    ctx.strokeStyle = 'rgba(0, 0, 0, 0.2)';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                });
                
                // ç»˜åˆ¶è¿æ¥çº¿ï¼ˆåŒ–å­¦é”®ï¼‰
                this.particles.forEach(p => {
                    if (p.bondedTo.length > 0) {
                        p.bondedTo.forEach(bonded => {
                            ctx.beginPath();
                            ctx.moveTo(p.x, p.y);
                            ctx.lineTo(bonded.x, bonded.y);
                            ctx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
                            ctx.lineWidth = 2;
                            ctx.stroke();
                        });
                    }
                });
                
                // ç»˜åˆ¶ç²’å­
                this.particles.forEach(p => p.draw());
                
                // ç»˜åˆ¶æ°”æ³¡
                this.bubbles.forEach(bubble => {
                    ctx.beginPath();
                    ctx.arc(bubble.x, bubble.y, bubble.radius, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                    ctx.fill();
                    
                    ctx.strokeStyle = 'rgba(52, 152, 219, 0.6)';
                    ctx.lineWidth = 1.5;
                    ctx.stroke();
                    
                    // æ°”æ³¡é«˜å…‰
                    ctx.beginPath();
                    ctx.arc(bubble.x - bubble.radius/3, bubble.y - bubble.radius/3, bubble.radius/4, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                    ctx.fill();
                });
                
                // ç»˜åˆ¶æ­¥éª¤é«˜äº®
                this.drawStepHighlight();
            }
            
            drawBeaker() {
                const canvasWidth = canvas.width;
                const canvasHeight = canvas.height;
                
                // ç»˜åˆ¶çƒ§æ¯
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.strokeStyle = '#7f8c8d';
                ctx.lineWidth = 3;
                
                // çƒ§æ¯ä¸»ä½“
                ctx.beginPath();
                ctx.moveTo(canvasWidth/2 - 120, canvasHeight - 50);
                ctx.lineTo(canvasWidth/2 - 150, canvasHeight - 200);
                ctx.lineTo(canvasWidth/2 - 120, canvasHeight - 350);
                ctx.lineTo(canvasWidth/2 + 120, canvasHeight - 350);
                ctx.lineTo(canvasWidth/2 + 150, canvasHeight - 200);
                ctx.lineTo(canvasWidth/2 + 120, canvasHeight - 50);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
                
                // æ¶²ä½“
                ctx.fillStyle = 'rgba(52, 152, 219, 0.3)';
                ctx.beginPath();
                ctx.moveTo(canvasWidth/2 - 130, canvasHeight - 200);
                ctx.lineTo(canvasWidth/2 - 125, canvasHeight - 300);
                ctx.lineTo(canvasWidth/2 + 125, canvasHeight - 300);
                ctx.lineTo(canvasWidth/2 + 130, canvasHeight - 200);
                ctx.closePath();
                ctx.fill();
                
                // å›ºä½“ï¼ˆå¤§ç†çŸ³ï¼‰
                ctx.fillStyle = 'rgba(189, 195, 199, 0.9)';
                ctx.beginPath();
                ctx.ellipse(canvasWidth/2, canvasHeight - 180, 80, 20, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // æ°”æ³¡
                for (let i = 0; i < 15; i++) {
                    const x = canvasWidth/2 - 80 + Math.random() * 160;
                    const y = canvasHeight - 250 - Math.random() * 100;
                    const radius = 3 + Math.random() * 5;
                    
                    ctx.beginPath();
                    ctx.arc(x, y, radius, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                    ctx.fill();
                }
                
                // æ ‡ç­¾
                ctx.fillStyle = '#2c3e50';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('çƒ§æ¯ï¼ˆå®è§‚è§†å›¾ï¼‰', canvasWidth/2, 50);
                ctx.font = '18px Arial';
                ctx.fillText('ç¨€ç›é…¸ + å¤§ç†çŸ³', canvasWidth/2, canvasHeight - 400);
                ctx.fillText('è§‚å¯Ÿæ°”æ³¡ï¼ˆCOâ‚‚ï¼‰äº§ç”Ÿ', canvasWidth/2, canvasHeight - 370);
            }
            
            drawStepHighlight() {
                // æ ¹æ®å½“å‰æ­¥éª¤é«˜äº®ç›¸å…³ç²’å­
                ctx.globalAlpha = 0.3;
                
                switch(currentStep) {
                    case 0:
                        // é«˜äº®å›ºä½“ç²’å­
                        this.solidParticles.forEach(p => {
                            ctx.beginPath();
                            ctx.arc(p.x, p.y, p.radius + 5, 0, Math.PI * 2);
                            ctx.fillStyle = '#f1c40f';
                            ctx.fill();
                        });
                        break;
                    case 1:
                        // é«˜äº®H+å’ŒCO3-2
                        this.particles.forEach(p => {
                            if (p.type === 'H+' || p.type === 'CO3-2') {
                                ctx.beginPath();
                                ctx.arc(p.x, p.y, p.radius + 5, 0, Math.PI * 2);
                                ctx.fillStyle = p.type === 'H+' ? '#ff6b9d' : '#d35400';
                                ctx.fill();
                            }
                        });
                        break;
                    case 2:
                        // é«˜äº®H2CO3
                        this.particles.forEach(p => {
                            if (p.type === 'CO3-2' && p.bondedTo.length === 2) {
                                ctx.beginPath();
                                ctx.arc(p.x, p.y, p.radius + 5, 0, Math.PI * 2);
                                ctx.fillStyle = '#9b59b6';
                                ctx
<!--æ£€æµ‹åˆ°ä»£ç æˆªæ–­ï¼Œè‡ªåŠ¨ç»­å†™ä¸­...-->
fill();
                            }
                        });
                        break;
                    case 3:
                        // é«˜äº®CO2å’Œæ°”æ³¡
                        this.particles.forEach(p => {
                            if (p.type === 'CO2') {
                                ctx.beginPath();
                                ctx.arc(p.x, p.y, p.radius + 5, 0, Math.PI * 2);
                                ctx.fillStyle = '#f39c12';
                                ctx.fill();
                            }
                        });
                        this.bubbles.forEach(bubble => {
                            ctx.beginPath();
                            ctx.arc(bubble.x, bubble.y, bubble.radius + 5, 0, Math.PI * 2);
                            ctx.fillStyle = '#3498db';
                            ctx.fill();
                        });
                        break;
                    case 4:
                        // é«˜äº®Ca2+å’ŒCl-
                        this.particles.forEach(p => {
                            if (p.type === 'Ca2+' || p.type === 'Cl-') {
                                ctx.beginPath();
                                ctx.arc(p.x, p.y, p.radius + 5, 0, Math.PI * 2);
                                ctx.fillStyle = p.type === 'Ca2+' ? '#95a5a6' : '#2ecc71';
                                ctx.fill();
                            }
                        });
                        break;
                }
                
                ctx.globalAlpha = 1.0;
            }
        }

        // åˆ›å»ºååº”ç³»ç»Ÿå®ä¾‹
        let reactionSystem = new ReactionSystem();

        // è°ƒæ•´ç”»å¸ƒå¤§å°
        function resizeCanvas() {
            const container = document.querySelector('.canvas-container');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }

        // åˆå§‹åŒ–
        function init() {
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // åˆå§‹ç»˜åˆ¶
            draw();
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners();
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æ’­æ”¾/æš‚åœæŒ‰é’®
            document.getElementById('playPauseBtn').addEventListener('click', () => {
                isPlaying = !isPlaying;
                document.getElementById('playPauseBtn').innerHTML = isPlaying ? 
                    '<span>â¸</span> æš‚åœ' : '<span>â–¶</span> æ’­æ”¾';
                
                if (isPlaying) {
                    animate();
                } else {
                    if (animationId) {
                        cancelAnimationFrame(animationId);
                        animationId = null;
                    }
                }
            });
            
            // ä¸Šä¸€æ­¥æŒ‰é’®
            document.getElementById('prevBtn').addEventListener('click', () => {
                if (currentStep > 0) {
                    goToStep(currentStep - 1);
                }
            });
            
            // ä¸‹ä¸€æ­¥æŒ‰é’®
            document.getElementById('nextBtn').addEventListener('click', () => {
                if (currentStep < 4) {
                    goToStep(currentStep + 1);
                }
            });
            
            // é‡ç½®æŒ‰é’®
            document.getElementById('resetBtn').addEventListener('click', () => {
                reactionSystem = new ReactionSystem();
                goToStep(0);
                isPlaying = false;
                document.getElementById('playPauseBtn').innerHTML = '<span>â–¶</span> æ’­æ”¾';
            });
            
            // å®è§‚è§†è§’æŒ‰é’®
            document.getElementById('macroViewBtn').addEventListener('click', () => {
                isMicroView = false;
                document.getElementById('microViewBtn').classList.remove('btn-primary');
                document.getElementById('microViewBtn').classList.add('btn-outline');
                document.getElementById('macroViewBtn').classList.remove('btn-outline');
                document.getElementById('macroViewBtn').classList.add('btn-primary');
            });
            
            // å¾®è§‚è§†è§’æŒ‰é’®
            document.getElementById('microViewBtn').addEventListener('click', () => {
                isMicroView = true;
                document.getElementById('macroViewBtn').classList.remove('btn-primary');
                document.getElementById('macroViewBtn').classList.add('btn-outline');
                document.getElementById('microViewBtn').classList.remove('btn-outline');
                document.getElementById('microViewBtn').classList.add('btn-primary');
            });
            
            // é€Ÿåº¦æ»‘å—
            speedSlider.addEventListener('input', () => {
                animationSpeed = parseFloat(speedSlider.value);
                const speedLabels = {
                    0.5: 'æ…¢é€Ÿ',
                    1.0: 'æ­£å¸¸',
                    1.5: 'ä¸­é€Ÿ',
                    2.0: 'å¿«é€Ÿ',
                    2.5: 'é«˜é€Ÿ',
                    3.0: 'æé€Ÿ'
                };
                speedValue.textContent = speedLabels[animationSpeed] || 'æ­£å¸¸';
            });
            
            // æ­¥éª¤æŒ‡ç¤ºå™¨ç‚¹å‡»
            stepItems.forEach(item => {
                item.addEventListener('click', () => {
                    const step = parseInt(item.getAttribute('data-step'));
                    goToStep(step);
                });
            });
            
            // é¼ æ ‡ç§»åŠ¨äº‹ä»¶ï¼ˆç”¨äºæç¤ºï¼‰
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                let hoveredParticle = null;
                
                // æ£€æŸ¥æ˜¯å¦æ‚¬åœåœ¨ç²’å­ä¸Š
                reactionSystem.particles.forEach(p => {
                    if (p.isMouseOver(mouseX, mouseY)) {
                        hoveredParticle = p;
                    }
                });
                
                reactionSystem.solidParticles.forEach(p => {
                    if (p.isMouseOver(mouseX, mouseY)) {
                        hoveredParticle = p;
                    }
                });
                
                if (hoveredParticle) {
                    tooltip.style.display = 'block';
                    tooltip.style.left = mouseX + 'px';
                    tooltip.style.top = mouseY + 'px';
                    
                    let tooltipText = hoveredParticle.label;
                    if (hoveredParticle.type === 'CO3-2' && hoveredParticle.bondedTo.length === 2) {
                        tooltipText = 'ç¢³é…¸ Hâ‚‚COâ‚ƒ (ä¸ç¨³å®š)';
                    } else if (hoveredParticle.charge !== 0) {
                        tooltipText += ` (${hoveredParticle.charge > 0 ? '+' : ''}${hoveredParticle.charge}ç”µè·)`;
                    }
                    
                    tooltip.textContent = tooltipText;
                } else {
                    tooltip.style.display = 'none';
                }
            });
            
            canvas.addEventListener('mouseleave', () => {
                tooltip.style.display = 'none';
            });
        }

        // è·³è½¬åˆ°æŒ‡å®šæ­¥éª¤
        function goToStep(step) {
            currentStep = step;
            reactionSystem.stepProgress = 0;
            
            // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
            stepItems.forEach((item, index) => {
                if (index === step) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            // æ›´æ–°æ­¥éª¤æè¿°
            stepDescription.textContent = stepDescriptions[step];
            
            // å¦‚æœæ˜¯æœ€åä¸€æ­¥ï¼Œç¡®ä¿æ‰€æœ‰ååº”å®Œæˆ
            if (step === 4) {
                // ç¡®ä¿æ‰€æœ‰CO3-2éƒ½ååº”äº†
                reactionSystem.particles.forEach(p => {
                    if (p.type === 'CO3-2' && p.bondedTo.length < 2) {
                        p.bondedTo = [];
                        p.isActive = false;
                    }
                });
            }
        }

        // åŠ¨ç”»å¾ªç¯
        function animate() {
            if (!isPlaying) return;
            
            update();
            draw();
            animationId = requestAnimationFrame(animate);
        }

        // æ›´æ–°åŠ¨ç”»çŠ¶æ€
        function update() {
            reactionSystem.update();
        }

        // ç»˜åˆ¶åœºæ™¯
        function draw() {
            // æ¸…é™¤ç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶èƒŒæ™¯
            if (isMicroView) {
                // å¾®è§‚è§†å›¾èƒŒæ™¯
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, '#87CEEB');
                gradient.addColorStop(1, '#E0F7FF');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // ç»˜åˆ¶ç½‘æ ¼ï¼ˆå¾®è§‚èƒŒæ™¯ï¼‰
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                ctx.lineWidth = 1;
                const gridSize = 40;
                
                for (let x = 0; x < canvas.width; x += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvas.height);
                    ctx.stroke();
                }
                
                for (let y = 0; y < canvas.height; y += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvas.width, y);
                    ctx.stroke();
                }
            }
            
            // ç»˜åˆ¶ååº”ç³»ç»Ÿ
            reactionSystem.draw();
            
            // ç»˜åˆ¶å½“å‰æ­¥éª¤æ ‡ç­¾
            if (isMicroView) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(`æ­¥éª¤ ${currentStep + 1}: ${stepDescriptions[currentStep].split('ã€‚')[0]}`, 20, 30);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>