<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸€æ°§åŒ–ç¢³æ¯’æ€§ï¼šä¸è¡€çº¢è›‹ç™½ç»“åˆçš„å¾®è§‚åŠ¨ç”»</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #f0f0f0;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        header {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        h1 {
            color: #ff6b6b;
            margin-bottom: 10px;
            font-size: 2.2rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .subtitle {
            color: #4ecdc4;
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .animation-section {
            flex: 3;
            min-width: 300px;
        }

        .controls-section {
            flex: 1;
            min-width: 280px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .canvas-container {
            position: relative;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
            height: 600px;
        }

        #animationCanvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .scene-labels {
            position: absolute;
            top: 20px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 30px;
            pointer-events: none;
        }

        .scene-label {
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.1rem;
            border: 2px solid;
        }

        .lungs-label {
            color: #4ecdc4;
            border-color: #4ecdc4;
        }

        .tissue-label {
            color: #ff9ff3;
            border-color: #ff9ff3;
        }

        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .control-group {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .control-title {
            color: #4ecdc4;
            margin-bottom: 12px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-title i {
            font-size: 1.2rem;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }

        button {
            background: linear-gradient(135deg, #2d3436 0%, #636e72 100%);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 120px;
            font-weight: 500;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        button.active {
            background: linear-gradient(135deg, #0984e3 0%, #74b9ff 100%);
            box-shadow: 0 0 10px rgba(116, 185, 255, 0.5);
        }

        .speed-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .speed-btn {
            flex: 1;
            min-width: 60px;
        }

        .slider-container {
            margin-top: 10px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #2d3436;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ff6b6b;
            cursor: pointer;
            border: 2px solid white;
        }

        .value-display {
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: #ff6b6b;
            margin-top: 5px;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #4ecdc4;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .info-panel {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 20px;
        }

        .info-title {
            color: #feca57;
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-content {
            line-height: 1.6;
            color: #e0e0e0;
        }

        .key-point {
            background: rgba(254, 202, 87, 0.1);
            border-left: 4px solid #feca57;
            padding: 12px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }

        .molecule-info {
            display: none;
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid;
            max-width: 300px;
            z-index: 100;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .canvas-container {
                height: 500px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ä¸€æ°§åŒ–ç¢³æ¯’æ€§ï¼šä¸è¡€çº¢è›‹ç™½ç»“åˆçš„å¾®è§‚åŠ¨ç”»</h1>
            <p class="subtitle">æ¢ç´¢COå¦‚ä½•ç«äº‰æ€§ç»“åˆè¡€çº¢è›‹ç™½ï¼Œå¯¼è‡´ç»„ç»‡ç¼ºæ°§çš„å¾®è§‚æœºåˆ¶</p>
        </header>

        <div class="main-content">
            <div class="animation-section">
                <div class="canvas-container">
                    <canvas id="animationCanvas"></canvas>
                    
                    <div class="scene-labels">
                        <div class="scene-label lungs-label">ğŸ¥ è‚ºæ³¡/è‚ºæ¯›ç»†è¡€ç®¡ (å¯Œæ°§ç¯å¢ƒ)</div>
                        <div class="scene-label tissue-label">ğŸ’ª ç»„ç»‡/ç»„ç»‡æ¯›ç»†è¡€ç®¡ (ç¼ºæ°§ç¯å¢ƒ)</div>
                    </div>
                    
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ff6b6b;"></div>
                            <span>è¡€çº¢è›‹ç™½ (Hb)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #74b9ff;"></div>
                            <span>æ°§æ°”åˆ†å­ (Oâ‚‚)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ff4757;"></div>
                            <span>ä¸€æ°§åŒ–ç¢³åˆ†å­ (CO)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ff9ff3;"></div>
                            <span>ç¢³æ°§è¡€çº¢è›‹ç™½ (HbCO)</span>
                        </div>
                    </div>
                    
                    <div id="moleculeInfo" class="molecule-info"></div>
                </div>
            </div>

            <div class="controls-section">
                <div class="control-group">
                    <div class="control-title">ğŸ¬ åŠ¨ç”»æ§åˆ¶</div>
                    <div class="button-group">
                        <button id="playBtn" class="active">â–¶ æ’­æ”¾</button>
                        <button id="pauseBtn">â¸ æš‚åœ</button>
                        <button id="resetBtn">ğŸ”„ é‡ç½®</button>
                    </div>
                    
                    <div class="speed-controls">
                        <button class="speed-btn" data-speed="0.5">0.5x</button>
                        <button class="speed-btn active" data-speed="1">1x</button>
                        <button class="speed-btn" data-speed="2">2x</button>
                    </div>
                </div>

                <div class="control-group">
                    <div class="control-title">ğŸ”¬ è§‚å¯Ÿæ¨¡å¼</div>
                    <div class="button-group">
                        <button id="normalMode" class="active">æ­£å¸¸è¿æ°§</button>
                        <button id="coMode">COä¸­æ¯’</button>
                        <button id="compareMode">å¯¹æ¯”æ¨¡å¼</button>
                    </div>
                </div>

                <div class="control-group">
                    <div class="control-title">âš™ï¸ ç¯å¢ƒå‚æ•°</div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>COæµ“åº¦ï¼š</span>
                            <span id="coValue">0%</span>
                        </div>
                        <input type="range" id="coSlider" min="0" max="100" value="0">
                    </div>
                    
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-value" id="hbcoPercent">0%</div>
                            <div class="stat-label">HbCOæ¯”ä¾‹</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="o2Delivery">100%</div>
                            <div class="stat-label">Oâ‚‚è¾“é€æ•ˆç‡</div>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <div class="control-title">ğŸ“Š å®æ—¶æ•°æ®</div>
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-value" id="totalHb">0</div>
                            <div class="stat-label">è¡€çº¢è›‹ç™½æ€»æ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="boundO2">0</div>
                            <div class="stat-label">ç»“åˆOâ‚‚æ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="boundCO">0</div>
                            <div class="stat-label">ç»“åˆCOæ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="freeSites">0</div>
                            <div class="stat-label">ç©ºé—²ä½ç‚¹</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="info-panel">
            <div class="info-title">ğŸ’¡ å…³é”®æœºåˆ¶è¯´æ˜</div>
            <div class="info-content">
                <p>ä¸€æ°§åŒ–ç¢³(CO)ä¸­æ¯’çš„æ ¸å¿ƒæœºåˆ¶ï¼š</p>
                
                <div class="key-point">
                    <strong>1. ç«äº‰æ€§ç»“åˆï¼š</strong> COä¸Oâ‚‚ç«äº‰è¡€çº¢è›‹ç™½(Hb)ä¸Šç›¸åŒçš„ç»“åˆä½ç‚¹ï¼ˆè¡€çº¢ç´ ä¸­çš„äºšé“ç¦»å­ï¼‰ã€‚
                </div>
                
                <div class="key-point">
                    <strong>2. è¶…é«˜äº²å’ŒåŠ›ï¼š</strong> COä¸Hbçš„äº²å’ŒåŠ›æ˜¯Oâ‚‚çš„<strong>200-250å€</strong>ï¼Œç»“åˆæ›´å¿«é€Ÿã€æ›´ç‰¢å›ºã€‚
                </div>
                
                <div class="key-point">
                    <strong>3. ç¢³æ°§è¡€çº¢è›‹ç™½(HbCO)å½¢æˆï¼š</strong> COä¸Hbç»“åˆå½¢æˆHbCOï¼Œå…¶è§£ç¦»é€Ÿåº¦ææ…¢ï¼ˆåŠè¡°æœŸçº¦4-6å°æ—¶ï¼‰ï¼Œå¯¼è‡´Hbå¤±å»è¿æ°§åŠŸèƒ½ã€‚
                </div>
                
                <div class="key-point">
                    <strong>4. ç»„ç»‡ç¼ºæ°§ï¼š</strong> å³ä½¿è¡€æ¶²ä¸­Oâ‚‚å«é‡æ­£å¸¸ï¼Œä½†Hbè¢«CO"é”å®š"ï¼Œæ— æ³•å‘ç»„ç»‡é‡Šæ”¾Oâ‚‚ï¼Œå¯¼è‡´ç»„ç»‡ç¼ºæ°§ã€‚
                </div>
                
                <p style="margin-top: 15px; color: #ff6b6b;">
                    <strong>âš ï¸ ä¸´åºŠç‰¹å¾ï¼š</strong> ç¢³æ°§è¡€çº¢è›‹ç™½å‘ˆæ¨±æ¡ƒçº¢è‰²ï¼Œæ‚£è€…çš®è‚¤å¯å‡ºç°ç‰¹å¾æ€§çš„"æ¨±æ¡ƒçº¢"å¤–è§‚ï¼ˆä½†å¹¶éæ‰€æœ‰ç—…ä¾‹éƒ½å‡ºç°ï¼‰ã€‚
                </p>
            </div>
        </div>
    </div>

    <script>
        // è·å–Canvaså’Œä¸Šä¸‹æ–‡
        const canvas = document.getElementById('animationCanvas');
        const ctx = canvas.getContext('2d');
        const moleculeInfo = document.getElementById('moleculeInfo');

        // è®¾ç½®Canvaså°ºå¯¸
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }
        
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // åŠ¨ç”»çŠ¶æ€
        let animationId = null;
        let isPlaying = true;
        let speed = 1;
        let mode = 'normal'; // 'normal', 'co', 'compare'
        let coConcentration = 0; // 0-100%

        // åˆ†å­å®šä¹‰
        const molecules = {
            Hb: { color: '#ff6b6b', radius: 25, name: 'è¡€çº¢è›‹ç™½', info: 'å››èšä½“è›‹ç™½ï¼Œæœ‰4ä¸ªæ°§ç»“åˆä½ç‚¹' },
            O2: { color: '#74b9ff', radius: 8, name: 'æ°§æ°”åˆ†å­', info: 'Oâ‚‚ï¼Œä¸Hbç»“åˆåŠ›ï¼š1x' },
            CO: { color: '#ff4757', radius: 10, name: 'ä¸€æ°§åŒ–ç¢³', info: 'COï¼Œä¸Hbç»“åˆåŠ›ï¼š200-250x Oâ‚‚' },
            HbCO: { color: '#ff9ff3', radius: 25, name: 'ç¢³æ°§è¡€çº¢è›‹ç™½', info: 'COä¸Hbçš„ç»“åˆç‰©ï¼Œè§£ç¦»ææ…¢' }
        };

        // åœºæ™¯å®šä¹‰
        const scenes = {
            lungs: { x: 0, width: 0.5, color: 'rgba(78, 205, 196, 0.1)', label: 'è‚ºæ³¡åŒº' },
            tissue: { x: 0.5, width: 0.5, color: 'rgba(255, 159, 243, 0.1)', label: 'ç»„ç»‡åŒº' }
        };

        // è¡€çº¢è›‹ç™½æ•°ç»„
        let hemoglobins = [];
        const HbCount = 15;

        // æ°§æ°”å’Œä¸€æ°§åŒ–ç¢³åˆ†å­æ•°ç»„
        let oxygenMolecules = [];
        let coMolecules = [];
        const O2Count = 40;
        const COCount = 20;

        // åˆå§‹åŒ–æ‰€æœ‰å…ƒç´ 
        function init() {
            hemoglobins = [];
            oxygenMolecules = [];
            coMolecules = [];

            // åˆå§‹åŒ–è¡€çº¢è›‹ç™½
            for (let i = 0; i < HbCount; i++) {
                hemoglobins.push({
                    x: Math.random() * canvas.width,
                    y: 100 + (i * (canvas.height - 200) / HbCount),
                    vx: (Math.random() - 0.5) * 0.5,
                    vy: 0,
                    radius: molecules.Hb.radius,
                    color: molecules.Hb.color,
                    bindingSites: [null, null, null, null], // 4ä¸ªç»“åˆä½ç‚¹
                    isCOBound: false,
                    id: i
                });
            }

            // åˆå§‹åŒ–æ°§æ°”åˆ†å­ï¼ˆä¸»è¦åœ¨è‚ºæ³¡åŒºï¼‰
            for (let i = 0; i < O2Count; i++) {
                oxygenMolecules.push({
                    x: Math.random() * canvas.width * 0.4,
                    y: Math.random() * canvas.height,
                    vx: (Math.random() - 0.5) * 1.5,
                    vy: (Math.random() - 0.5) * 1.5,
                    radius: molecules.O2.radius,
                    color: molecules.O2.color,
                    isBound: false,
                    boundTo: null,
                    siteIndex: null
                });
            }

            // åˆå§‹åŒ–ä¸€æ°§åŒ–ç¢³åˆ†å­
            updateCOMolecules();
        }

        // æ ¹æ®COæµ“åº¦æ›´æ–°COåˆ†å­æ•°é‡
        function updateCOMolecules() {
            const targetCount = Math.floor(COCount * (coConcentration / 100));
            
            // ç§»é™¤å¤šä½™çš„COåˆ†å­
            if (coMolecules.length > targetCount) {
                coMolecules = coMolecules.slice(0, targetCount);
            }
            // æ·»åŠ æ–°çš„COåˆ†å­
            else if (coMolecules.length < targetCount) {
                for (let i = coMolecules.length; i < targetCount; i++) {
                    coMolecules.push({
                        x: Math.random() * canvas.width * 0.4,
                        y: Math.random() * canvas.height,
                        vx: (Math.random() - 0.5) * 1.2,
                        vy: (Math.random() - 0.5) * 1.2,
                        radius: molecules.CO.radius,
                        color: molecules.CO.color,
                        isBound: false,
                        boundTo: null,
                        siteIndex: null
                    });
                }
            }
        }

        // ç»˜åˆ¶åœºæ™¯èƒŒæ™¯
        function drawBackground() {
            // ç»˜åˆ¶è‚ºæ³¡åŒº
            ctx.fillStyle = scenes.lungs.color;
            ctx.fillRect(0, 0, canvas.width * scenes.lungs.width, canvas.height);
            
            // ç»˜åˆ¶ç»„ç»‡åŒº
            ctx.fillStyle = scenes.tissue.color;
            ctx.fillRect(canvas.width * scenes.tissue.x, 0, 
                        canvas.width * scenes.tissue.width, canvas.height);
            
            // ç»˜åˆ¶åˆ†ç•Œçº¿
            ctx.beginPath();
            ctx.moveTo(canvas.width * 0.5, 0);
            ctx.lineTo(canvas.width * 0.5, canvas.height);
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.stroke();
            ctx.setLineDash([]);
        }

        // ç»˜åˆ¶è¡€çº¢è›‹ç™½
        function drawHemoglobin(hb) {
            // ç»˜åˆ¶ä¸»ä½“
            ctx.beginPath();
            ctx.arc(hb.x, hb.y, hb.radius, 0, Math.PI * 2);
            
            // å¦‚æœç»“åˆäº†COï¼Œä½¿ç”¨HbCOé¢œè‰²
            if (hb.isCOBound) {
                ctx.fillStyle = molecules.HbCO.color;
            } else {
                ctx.fillStyle = hb.color;
            }
            ctx.fill();
            
            // ç»˜åˆ¶è¾¹æ¡†
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // ç»˜åˆ¶ç»“åˆä½ç‚¹
            for (let i = 0; i < 4; i++) {
                const angle = (i * Math.PI / 2) + (Date.now() / 1000) * 0.5;
                const siteX = hb.x + Math.cos(angle) * (hb.radius - 5);
                const siteY = hb.y + Math.sin(angle) * (hb.radius - 5);
                
                ctx.beginPath();
                ctx.arc(siteX, siteY, 6, 0, Math.PI * 2);
                
                if (hb.bindingSites[i]) {
                    // ä½ç‚¹è¢«å æ®
                    if (hb.bindingSites[i].type === 'CO') {
                        ctx.fillStyle = molecules.CO.color;
                    } else {
                        ctx.fillStyle = molecules.O2.color;
                    }
                } else {
                    // ç©ºé—²ä½ç‚¹
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
                }
                ctx.fill();
                
                // ä½ç‚¹è¾¹æ¡†
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.lineWidth = 1;
                ctx.stroke();
            }
            
            // ç»˜åˆ¶Hbç¼–å·ï¼ˆè°ƒè¯•ç”¨ï¼‰
            if (mode === 'compare') {
                ctx.fillStyle = 'white';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`Hb${hb.id}`, hb.x, hb.y + hb.radius + 15);
            }
        }

        // ç»˜åˆ¶æ°”ä½“åˆ†å­
        function drawGasMolecule(mol, type) {
            ctx.beginPath();
            ctx.arc(mol.x, mol.y, mol.radius, 0, Math.PI * 2);
            ctx.fillStyle = mol.color;
            ctx.fill();
            
            // ç»˜åˆ¶è¾¹æ¡†
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 1;
            ctx.stroke();
            
            // ç»˜åˆ¶åˆ†å­ç¬¦å·
            ctx.fillStyle = 'white';
            ctx.font = 'bold 10px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            if (type === 'O2') {
                ctx.fillText('Oâ‚‚', mol.x, mol.y);
            } else if (type === 'CO') {
                ctx.fillText('CO', mol.x, mol.y);
            }
            
            // å¦‚æœç»“åˆäº†ï¼Œç»˜åˆ¶è¿æ¥çº¿
            if (mol.isBound && mol.boundTo) {
                const hb = hemoglobins[mol.boundTo];
                const angle = (mol.siteIndex * Math.PI / 2) + (Date.now() / 1000) * 0.5;
                const siteX = hb.x + Math.cos(angle) * (hb.radius - 5);
                const siteY = hb.y + Math.sin(angle) * (hb.radius - 5);
                
                ctx.beginPath();
                ctx.moveTo(mol.x, mol.y);
                ctx.lineTo(siteX, siteY);
                ctx.strokeStyle = type === 'CO' ? '#ff4757' : '#74b9ff';
                ctx.lineWidth = 2;
                ctx.setLineDash([2, 2]);
                ctx.stroke();
                ctx.setLineDash([]);
            }
        }

        // æ›´æ–°è¡€çº¢è›‹ç™½çŠ¶æ€
        function updateHemoglobin(hb, deltaTime) {
            // ç§»åŠ¨
            hb.x += hb.vx * speed;
            hb.y += hb.vy * speed;
            
            // è¾¹ç•Œæ£€æŸ¥
            if (hb.x < hb.radius) hb.x = hb.radius;
            if (hb.x > canvas.width - hb.radius) hb.x = canvas.width - hb.radius;
            if (hb.y < hb.radius) hb.y = hb.radius;
            if (hb.y > canvas.height - hb.radius) hb.y = canvas.height - hb.radius;
            
            // åœ¨è‚ºæ³¡åŒºå‘å³ç§»åŠ¨ï¼Œåœ¨ç»„ç»‡åŒºå‘å·¦ç§»åŠ¨
            if (hb.x < canvas.width * 0.5) {
                hb.vx += 0.01 * speed;
            } else {
                hb.vx -= 0.01 * speed;
            }
            
            // é™åˆ¶é€Ÿåº¦
            hb.vx = Math.max(-2, Math.min(2, hb.vx * 0.99));
            
            // æ£€æŸ¥æ˜¯å¦åœ¨ç»„ç»‡åŒºé‡Šæ”¾æ°§æ°”
            if (hb.x > canvas.width * 0.5 && mode !== 'co') {
                for (let i = 0; i < 4; i++) {
                    if (hb.bindingSites[i] && hb.bindingSites[i].type === 'O2') {
                        // æœ‰ä¸€å®šæ¦‚ç‡é‡Šæ”¾æ°§æ°”
                        if (Math.random() < 0.02 * speed) {
                            releaseGas(hb, i, 'O2');
                        }
                    }
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦åœ¨è‚ºæ³¡åŒºç»“åˆæ°”ä½“
            if (hb.x < canvas.width * 0.5) {
                tryBindGases(hb);
            }
            
            // æ›´æ–°COç»“åˆçŠ¶æ€
            hb.isCOBound = hb.bindingSites.some(site => site && site.type === 'CO');
        }

        // å°è¯•ç»“åˆæ°”ä½“åˆ†å­
        function tryBindGases(hb) {
            // é¦–å…ˆå°è¯•ç»“åˆCOï¼ˆäº²å’ŒåŠ›æ›´é«˜ï¼‰
            for (let i = 0; i < coMolecules.length; i++) {
                const co = coMolecules[i];
                if (!co.isBound) {
                    const distance = Math.sqrt(
                        Math.pow(co.x - hb.x, 2) + Math.pow(co.y - hb.y, 2)
                    );
                    
                    if (distance < hb.radius + co.radius + 20) {
                        // å¯»æ‰¾ç©ºé—²ä½ç‚¹
                        for (let siteIndex = 0; siteIndex < 4; siteIndex++) {
                            if (!hb.bindingSites[siteIndex]) {
                                // COç»“åˆæ¦‚ç‡æ›´é«˜
                                if (Math.random() < 0.1 * (coConcentration / 100 + 0.1)) {
                                    bindGas(hb, siteIndex, co, 'CO');
                                    return;
                                }
                            }
                        }
                    }
                }
            }
            
            // ç„¶åå°è¯•ç»“åˆO2
            if (mode !== 'co') {
                for (let i = 0; i < oxygenMolecules.length; i++) {
                    const o2 = oxygenMolecules[i];
                    if (!o2.isBound) {
                        const distance = Math.sqrt(
                            Math.pow(o2.x - hb.x, 2) + Math.pow(o2.y - hb.y, 2)
                        );
                        
                        if (distance < hb.radius + o2.radius + 15) {
                            // å¯»æ‰¾ç©ºé—²ä½ç‚¹
                            for (let siteIndex = 0; siteIndex < 4; siteIndex++) {
                                if (!hb.bindingSites[siteIndex]) {
                                    // O2ç»“åˆæ¦‚ç‡è¾ƒä½ï¼ˆæ¨¡æ‹ŸCOç«äº‰ï¼‰
                                    const coCompetition = 1 - (coConcentration / 200);
                                    if (Math.random() < 0.05 * coCompetition) {
                                        bindGas(hb, siteIndex, o2, 'O2');
                                        return;
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        // ç»“åˆæ°”ä½“åˆ†å­
        function bindGas(hb, siteIndex, molecule, type) {
            hb.bindingSites[siteIndex] = {
                type: type,
                moleculeIndex: molecule === 'O2' ? 
                    oxygenMolecules.indexOf(molecule) : 
                    coMolecules.indexOf(molecule)
            };
            
            molecule.isBound = true;
            molecule.boundTo = hb.id;
            molecule.siteIndex = siteIndex;
            
            // å°†åˆ†å­ç§»åŠ¨åˆ°ç»“åˆä½ç½®
            const angle = (siteIndex * Math.PI / 2) + (Date.now() / 1000) * 0.5;
            molecule.x = hb.x + Math.cos(angle) * (hb.radius + molecule.radius + 2);
            molecule.y = hb.y + Math.sin(angle) * (hb.radius + molecule.radius + 2);
        }

        // é‡Šæ”¾æ°”ä½“åˆ†å­
        function releaseGas(hb, siteIndex, type) {
            const site = hb.bindingSites[siteIndex];
            if (!site) return;
            
            hb.bindingSites[siteIndex] = null;
            
            if (type === 'O2') {
                const o2 = oxygenMolecules[site.moleculeIndex];
                if (o2) {
                    o2.isBound = false;
                    o2.boundTo = null;
                    o2.siteIndex = null;
                    // ç»™ä¸€ä¸ªå‘ä¸Šçš„é€Ÿåº¦æ¨¡æ‹Ÿé‡Šæ”¾
                    o2.vx = (Math.random() - 0.5) * 2;
                    o2.vy = -Math.random() * 2;
                }
            } else if (type === 'CO') {
                // COå¾ˆéš¾é‡Šæ”¾ï¼ˆæ¨¡æ‹Ÿå…¶é«˜äº²å’ŒåŠ›ï¼‰
                if (Math.random() < 0.005) { // å¾ˆä½çš„é‡Šæ”¾æ¦‚ç‡
                    const co = coMolecules[site.moleculeIndex];
                    if (co) {
                        co.isBound = false;
                        co.boundTo = null;
                        co.siteIndex = null;
                    }
                    hb.bindingSites[siteIndex] = null;
                }
            }
        }

        // æ›´æ–°æ°”ä½“åˆ†å­
        function updateGasMolecule(mol, type) {
            if (mol.isBound) {
                // å¦‚æœç»“åˆäº†ï¼Œè·Ÿéšè¡€çº¢è›‹ç™½ç§»åŠ¨
                if (mol.boundTo !== null && hemoglobins[mol.boundTo]) {
                    const hb = hemoglobins[mol.boundTo];
                    const angle = (mol.siteIndex * Math.PI / 2) + (Date.now() / 1000) * 0.5;
                    mol.x = hb.x + Math.cos(angle) * (hb.radius + mol.radius + 2);
                    mol.y = hb.y + Math.sin(angle) * (hb.radius + mol.radius + 2);
                }
            } else {
                // è‡ªç”±ç§»åŠ¨
                mol.x += mol.vx * speed;
                mol.y += mol.vy * speed;
                
                // è¾¹ç•Œåå¼¹
                if (mol.x < mol.radius || mol.x > canvas.width - mol.radius) {
                    mol.vx *= -0.9;
                }
                if (mol.y < mol.radius || mol.y > canvas.height - mol.radius) {
                    mol.vy *= -0.9;
                }
                
                // é™åˆ¶åœ¨è‚ºæ³¡åŒºï¼ˆCOå’ŒO2ä¸»è¦åœ¨è‚ºæ³¡åŒºç”Ÿæˆï¼‰
                if (type === 'O2' || type === 'CO') {
                    if (mol.x > canvas.width * 0.4 && mol.vx > 0) {
                        mol.vx *= -1;
                    }
                }
                
                // ç¼“æ…¢å‡é€Ÿ
                mol.vx *= 0.995;
                mol.vy *= 0.995;
            }
        }

        // è®¡ç®—ç»Ÿè®¡æ•°æ®
        function calculateStats() {
            let totalBoundO2 = 0;
            let totalBoundCO = 0;
            let totalFreeSites = 0;
            let hbWithCO = 0;
            
            hemoglobins.forEach(hb => {
                hb.bindingSites.forEach(site => {
                    if (site) {
                        if (site.type === 'O2') totalBoundO2++;
                        if (site.type === 'CO') totalBoundCO++;
                    } else {
                        totalFreeSites++;
                    }
                });
                if (hb.isCOBound) hbWithCO++;
            });
            
            const hbcoPercent = ((hbWithCO / HbCount) * 100).toFixed(1);
            const o2Delivery = Math.max(0, 100 - (coConcentration * 0.8)).toFixed(0);
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('totalHb').textContent = HbCount;
            document.getElementById('boundO2').textContent = totalBoundO2;
            document.getElementById('boundCO').textContent = totalBoundCO;
            document.getElementById('freeSites').textContent = totalFreeSites;
            document.getElementById('hbcoPercent').textContent = `${hbcoPercent}%`;
            document.getElementById('o2Delivery').textContent = `${o2Delivery}%`;
        }

        // ä¸»åŠ¨ç”»å¾ªç¯
        function animate() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶èƒŒæ™¯
            drawBackground();
            
            // æ›´æ–°å’Œç»˜åˆ¶æ‰€æœ‰å…ƒç´ 
            hemoglobins.forEach(hb => {
                updateHemoglobin(hb, 16);
                drawHemoglobin(hb);
            });
            
            oxygenMolecules.forEach(o2 => {
                updateGasMolecule(o2, 'O2');
                drawGasMolecule(o2, 'O2');
            });
            
            coMolecules.forEach(co => {
                updateGasMolecule(co, 'CO');
                drawGasMolecule(co, 'CO');
            });
            
            // è®¡ç®—å¹¶æ˜¾ç¤ºç»Ÿè®¡æ•°æ®
            calculateStats();
            
            // ç»§ç»­åŠ¨ç”»å¾ªç¯
            if (isPlaying) {
                animationId = requestAnimationFrame(animate);
            }
        }

        // äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('playBtn').addEventListener('click', () => {
            isPlaying = true;
            if (!animationId) {
                animate();
            }
            updateButtonStates('playBtn');
        });

        document.getElementById('pauseBtn').addEventListener('click', () => {
            isPlaying = false;
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            updateButtonStates('pauseBtn');
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            init();
            if (isPlaying && !animationId) {
                animate();
            }
        });

        // é€Ÿåº¦æ§åˆ¶
        document.querySelectorAll('.speed-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                speed = parseFloat(this.dataset.speed);
                document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // æ¨¡å¼æ§åˆ¶
        document.getElementById('normalMode').addEventListener('click', () => {
            mode = 'normal';
            updateButtonStates('normalMode', 'mode');
        });

        document.getElementById('coMode').addEventListener('click', () => {
            mode = 'co';
            updateButtonStates('coMode', 'mode');
        });

        document.getElementById('compareMode').addEventListener('click', () => {
            mode = 'compare';
            updateButtonStates('compareMode', 'mode');
        });

        // COæµ“åº¦æ»‘å—
        const coSlider = document.getElementById('coSlider');
        const coValue = document.getElementById('coValue');
        
        coSlider.addEventListener('input', function() {
            co
<!--æ£€æµ‹åˆ°ä»£ç æˆªæ–­ï¼Œè‡ªåŠ¨ç»­å†™ä¸­...-->
Concentration = parseInt(this.value);
            coValue.textContent = `${coConcentration}%`;
            updateCOMolecules();
        });

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtonStates(activeId, group = 'control') {
            if (group === 'control') {
                document.querySelectorAll('.button-group:first-child button').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById(activeId).classList.add('active');
            } else if (group === 'mode') {
                document.querySelectorAll('.button-group:nth-child(2) button').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById(activeId).classList.add('active');
            } else if (group === 'speed') {
                document.querySelectorAll('.speed-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`.speed-btn[data-speed="${activeId}"]`).classList.add('active');
            }
        }

        // Canvasç‚¹å‡»äº‹ä»¶ - æ˜¾ç¤ºåˆ†å­ä¿¡æ¯
        canvas.addEventListener('mousemove', function(event) {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            let foundMolecule = null;
            let moleculeType = '';
            
            // æ£€æŸ¥æ˜¯å¦åœ¨è¡€çº¢è›‹ç™½ä¸Š
            for (const hb of hemoglobins) {
                const distance = Math.sqrt(Math.pow(x - hb.x, 2) + Math.pow(y - hb.y, 2));
                if (distance < hb.radius) {
                    foundMolecule = hb;
                    moleculeType = hb.isCOBound ? 'HbCO' : 'Hb';
                    break;
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦åœ¨æ°§æ°”åˆ†å­ä¸Š
            if (!foundMolecule) {
                for (const o2 of oxygenMolecules) {
                    const distance = Math.sqrt(Math.pow(x - o2.x, 2) + Math.pow(y - o2.y, 2));
                    if (distance < o2.radius) {
                        foundMolecule = o2;
                        moleculeType = 'O2';
                        break;
                    }
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦åœ¨COåˆ†å­ä¸Š
            if (!foundMolecule) {
                for (const co of coMolecules) {
                    const distance = Math.sqrt(Math.pow(x - co.x, 2) + Math.pow(y - co.y, 2));
                    if (distance < co.radius) {
                        foundMolecule = co;
                        moleculeType = 'CO';
                        break;
                    }
                }
            }
            
            // æ˜¾ç¤ºæˆ–éšè—ä¿¡æ¯æ¡†
            if (foundMolecule) {
                const molecule = molecules[moleculeType];
                moleculeInfo.innerHTML = `
                    <strong style="color: ${molecule.color}; font-size: 1.1em;">${molecule.name}</strong><br>
                    <div style="margin-top: 8px; font-size: 0.9em;">${molecule.info}</div>
                    ${moleculeType === 'Hb' ? '<div style="margin-top: 5px; color: #74b9ff;">æœ‰4ä¸ªOâ‚‚ç»“åˆä½ç‚¹</div>' : ''}
                    ${moleculeType === 'CO' ? '<div style="margin-top: 5px; color: #ff6b6b;">ä¸Hbäº²å’ŒåŠ›: 200-250Ã— Oâ‚‚</div>' : ''}
                    ${moleculeType === 'HbCO' ? '<div style="margin-top: 5px; color: #ff9ff3;">è§£ç¦»åŠè¡°æœŸ: 4-6å°æ—¶</div>' : ''}
                `;
                moleculeInfo.style.display = 'block';
                moleculeInfo.style.left = (x + 15) + 'px';
                moleculeInfo.style.top = (y + 15) + 'px';
                moleculeInfo.style.borderColor = molecule.color;
            } else {
                moleculeInfo.style.display = 'none';
            }
        });

        canvas.addEventListener('mouseleave', function() {
            moleculeInfo.style.display = 'none';
        });

        // åˆå§‹åŒ–å¹¶å¼€å§‹åŠ¨ç”»
        init();
        animate();

        // æ·»åŠ é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(event) {
            switch(event.key) {
                case ' ':
                    event.preventDefault();
                    if (isPlaying) {
                        document.getElementById('pauseBtn').click();
                    } else {
                        document.getElementById('playBtn').click();
                    }
                    break;
                case 'r':
                case 'R':
                    document.getElementById('resetBtn').click();
                    break;
                case '1':
                    document.getElementById('normalMode').click();
                    break;
                case '2':
                    document.getElementById('coMode').click();
                    break;
                case '3':
                    document.getElementById('compareMode').click();
                    break;
            }
        });

        // æ·»åŠ åˆå§‹æç¤º
        setTimeout(() => {
            alert('æç¤ºï¼š\n1. ä½¿ç”¨æ»‘å—è°ƒèŠ‚COæµ“åº¦è§‚å¯Ÿæ•ˆæœ\n2. é¼ æ ‡æ‚¬åœåœ¨åˆ†å­ä¸ŠæŸ¥çœ‹è¯¦ç»†ä¿¡æ¯\n3. ç©ºæ ¼é”®ï¼šæ’­æ”¾/æš‚åœï¼ŒRé”®ï¼šé‡ç½®\n4. æ•°å­—é”®1-3åˆ‡æ¢è§‚å¯Ÿæ¨¡å¼');
        }, 1000);
    </script>
</body>
</html>