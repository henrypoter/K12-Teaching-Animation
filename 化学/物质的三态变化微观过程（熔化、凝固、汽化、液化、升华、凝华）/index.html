<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰©è´¨ä¸‰æ€å˜åŒ–å¾®è§‚è¿‡ç¨‹æ•™å­¦åŠ¨ç”»</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            background-color: #2c3e50;
            color: #ecf0f1;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #3498db;
        }

        h1 {
            color: #1abc9c;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }

        .subtitle {
            color: #bdc3c7;
            font-size: 1.1rem;
        }

        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-panel {
            flex: 1;
            min-width: 300px;
            background-color: rgba(44, 62, 80, 0.8);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #34495e;
        }

        .animation-area {
            flex: 2;
            min-width: 500px;
            background-color: #1a252f;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            border: 1px solid #34495e;
        }

        .module-tabs {
            display: flex;
            margin-bottom: 25px;
            background-color: #34495e;
            border-radius: 8px;
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            background-color: #3d566e;
        }

        .tab.active {
            background-color: #2c3e50;
            border-bottom: 3px solid #1abc9c;
            color: #1abc9c;
        }

        .control-group {
            margin-bottom: 25px;
        }

        h3 {
            color: #1abc9c;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .slider-container {
            margin-bottom: 10px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .slider-label span {
            font-size: 0.9rem;
        }

        .temperature-slider {
            width: 100%;
            height: 30px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, #3498db, #ecf0f1, #e67e22);
            outline: none;
            border-radius: 15px;
            border: 2px solid #34495e;
        }

        .temperature-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #ecf0f1;
            cursor: pointer;
            border: 3px solid #2c3e50;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        .marker-line {
            position: absolute;
            height: 100%;
            width: 2px;
            background-color: rgba(236, 240, 241, 0.7);
            top: 0;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            flex: 1;
            min-width: 120px;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-secondary {
            background-color: #7f8c8d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #6c7b7d;
        }

        .btn-success {
            background-color: #2ecc71;
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .info-panel {
            background-color: rgba(26, 37, 47, 0.9);
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .status-dot {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 10px;
            background-color: #1abc9c;
        }

        .status-text {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .process-description {
            margin-bottom: 15px;
            min-height: 60px;
            font-size: 1.1rem;
        }

        .energy-flow {
            display: flex;
            align-items: center;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .energy-icon {
            font-size: 1.5rem;
            margin-right: 10px;
        }

        .heat-absorption {
            color: #e67e22;
        }

        .heat-release {
            color: #3498db;
        }

        .macro-example {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background-color: rgba(44, 62, 80, 0.8);
            border-radius: 8px;
            padding: 15px;
            max-width: 200px;
            border: 1px solid #34495e;
        }

        .macro-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #f1c40f;
        }

        .macro-icon {
            font-size: 3rem;
            text-align: center;
            margin: 10px 0;
        }

        .macro-desc {
            font-size: 0.9rem;
        }

        canvas {
            display: block;
            background-color: #1a252f;
        }

        .view-options {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .checkbox-label input {
            margin-right: 8px;
        }

        footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #34495e;
            color: #95a5a6;
            font-size: 0.9rem;
        }

        @media (max-width: 900px) {
            .main-content {
                flex-direction: column;
            }
            
            .animation-area, .control-panel {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ç‰©è´¨ä¸‰æ€å˜åŒ–å¾®è§‚è¿‡ç¨‹</h1>
            <p class="subtitle">æ¢ç´¢ç†”åŒ–ã€å‡å›ºã€æ±½åŒ–ã€æ¶²åŒ–ã€å‡åã€å‡åçš„å¾®è§‚æœ¬è´¨</p>
        </header>

        <div class="main-content">
            <div class="control-panel">
                <div class="module-tabs">
                    <div class="tab active" data-module="solid-liquid">å›ºæ€ â†” æ¶²æ€</div>
                    <div class="tab" data-module="liquid-gas">æ¶²æ€ â†” æ°”æ€</div>
                    <div class="tab" data-module="solid-gas">å›ºæ€ â†” æ°”æ€</div>
                </div>

                <div class="control-group">
                    <h3>æ¸©åº¦ä¸èƒ½é‡æ§åˆ¶</h3>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span style="color: #3498db;">å†·å´</span>
                            <span style="color: #e67e22;">åŠ çƒ­</span>
                        </div>
                        <input type="range" min="-50" max="150" value="0" class="temperature-slider" id="tempSlider">
                        <div class="marker-line" id="meltingLine" style="left: 30%; display: none;"></div>
                        <div class="marker-line" id="boilingLine" style="left: 70%; display: none;"></div>
                    </div>
                    <div style="text-align: center; margin-top: 5px; font-size: 0.9rem;">
                        å½“å‰æ¸©åº¦: <span id="currentTemp">0</span>Â°C
                    </div>
                </div>

                <div class="control-group">
                    <h3>åŠ¨ç”»æ§åˆ¶</h3>
                    <div class="button-group">
                        <button id="playPauseBtn" class="btn-primary">æš‚åœ</button>
                        <button id="resetBtn" class="btn-secondary">é‡ç½®</button>
                        <button id="stepBtn" class="btn-success" disabled>å•æ­¥å‰è¿›</button>
                    </div>
                </div>

                <div class="control-group">
                    <h3>è§†å›¾é€‰é¡¹</h3>
                    <div class="view-options">
                        <label class="checkbox-label">
                            <input type="checkbox" id="showForces" checked>
                            <span>æ˜¾ç¤ºåˆ†å­é—´ä½œç”¨åŠ›</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="showTraces">
                            <span>æ˜¾ç¤ºè¿åŠ¨è½¨è¿¹</span>
                        </label>
                    </div>
                </div>

                <div class="info-panel">
                    <div class="status-indicator">
                        <div class="status-dot" id="statusDot"></div>
                        <div class="status-text" id="statusText">å›ºæ€</div>
                    </div>
                    
                    <div class="process-description" id="processDesc">
                        ç²’å­åœ¨æ™¶æ ¼ä½ç½®é™„è¿‘æŒ¯åŠ¨ï¼Œåˆ†å­é—´ä½œç”¨åŠ›å¼ºï¼Œæ’åˆ—è§„åˆ™ã€‚
                    </div>
                    
                    <div class="energy-flow" id="energyFlow">
                        <div class="energy-icon">â†’</div>
                        <div>æ¸©åº¦å˜åŒ–ä¸­...</div>
                    </div>
                </div>
            </div>

            <div class="animation-area">
                <canvas id="particleCanvas" width="800" height="600"></canvas>
                
                <div class="macro-example" id="macroExample">
                    <div class="macro-title">å®è§‚å®ä¾‹</div>
                    <div class="macro-icon" id="macroIcon">â„ï¸</div>
                    <div class="macro-desc" id="macroDesc">å†°åœ¨å®¤æ¸©ä¸‹é€æ¸èåŒ–æˆæ°´</div>
                </div>
            </div>
        </div>

        <footer>
            <p>æ•™å­¦åŠ¨ç”»è®¾è®¡ | å¾®è§‚ç²’å­æ¨¡å‹æ¨¡æ‹Ÿ | æ‹–åŠ¨æ»‘å—è§‚å¯Ÿæ¸©åº¦å˜åŒ–å¯¹ç‰©è´¨çŠ¶æ€çš„å½±å“</p>
            <p>æ³¨æ„ï¼šæœ¬åŠ¨ç”»ä¸­çš„ç²’å­æ¨¡å‹ä¸ºç®€åŒ–ç¤ºæ„å›¾ï¼Œç”¨äºå¸®åŠ©ç†è§£å¾®è§‚è¿‡ç¨‹</p>
        </footer>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let canvas, ctx;
        let particles = [];
        let animationId;
        let isPlaying = true;
        let currentModule = 'solid-liquid';
        let temperature = 0;
        let showForces = true;
        let showTraces = false;
        
        // æ¨¡å—é…ç½®
        const modules = {
            'solid-liquid': {
                name: 'å›ºæ€ â†” æ¶²æ€',
                meltingPoint: 0,
                initialTemp: -20,
                macroIcon: 'â„ï¸',
                macroDesc: 'å†°åœ¨å®¤æ¸©ä¸‹é€æ¸èåŒ–æˆæ°´',
                states: {
                    solid: {
                        name: 'å›ºæ€',
                        color: '#3498db',
                        desc: 'ç²’å­åœ¨æ™¶æ ¼ä½ç½®é™„è¿‘æŒ¯åŠ¨ï¼Œåˆ†å­é—´ä½œç”¨åŠ›å¼ºï¼Œæ’åˆ—è§„åˆ™ã€‚',
                        energy: 'æ¸©åº¦å˜åŒ–ä¸­...'
                    },
                    melting: {
                        name: 'ç†”åŒ–ä¸­',
                        color: '#9b59b6',
                        desc: 'åŠ çƒ­ä½¿ç²’å­æŒ¯åŠ¨åŠ å‰§ï¼Œæ™¶æ ¼ç»“æ„é€æ¸ç ´åï¼Œåˆ†å­é—´ä½œç”¨åŠ›å‡å¼±ã€‚',
                        energy: 'â†‘ å¸çƒ­è¿‡ç¨‹'
                    },
                    liquid: {
                        name: 'æ¶²æ€',
                        color: '#1abc9c',
                        desc: 'ç²’å­å¯ä»¥ç›¸å¯¹æ»‘åŠ¨ï¼Œæ’åˆ—è¾ƒå¯†ä½†æ— åºï¼Œåˆ†å­é—´ä½œç”¨åŠ›é€‚ä¸­ã€‚',
                        energy: 'æ¸©åº¦å˜åŒ–ä¸­...'
                    },
                    freezing: {
                        name: 'å‡å›ºä¸­',
                        color: '#9b59b6',
                        desc: 'å†·å´ä½¿ç²’å­è¿åŠ¨å‡ç¼“ï¼Œé€æ¸å½¢æˆè§„åˆ™æ’åˆ—ï¼Œåˆ†å­é—´ä½œç”¨åŠ›å¢å¼ºã€‚',
                        energy: 'â†“ æ”¾çƒ­è¿‡ç¨‹'
                    }
                }
            },
            'liquid-gas': {
                name: 'æ¶²æ€ â†” æ°”æ€',
                boilingPoint: 100,
                initialTemp: 50,
                macroIcon: 'ğŸ’§',
                macroDesc: 'æ°´åŠ çƒ­æ²¸è…¾å˜æˆæ°´è’¸æ°”',
                states: {
                    liquid: {
                        name: 'æ¶²æ€',
                        color: '#1abc9c',
                        desc: 'ç²’å­å¯ä»¥ç›¸å¯¹æ»‘åŠ¨ï¼Œæ’åˆ—è¾ƒå¯†ä½†æ— åºï¼Œåˆ†å­é—´ä½œç”¨åŠ›é€‚ä¸­ã€‚',
                        energy: 'æ¸©åº¦å˜åŒ–ä¸­...'
                    },
                    vaporizing: {
                        name: 'æ±½åŒ–ä¸­',
                        color: '#e67e22',
                        desc: 'åŠ çƒ­ä½¿ç²’å­è¿åŠ¨å‰§çƒˆï¼Œéƒ¨åˆ†ç²’å­è·å¾—è¶³å¤Ÿèƒ½é‡æŒ£è„±æ¶²ä½“è¡¨é¢ã€‚',
                        energy: 'â†‘ å¸çƒ­è¿‡ç¨‹'
                    },
                    gas: {
                        name: 'æ°”æ€',
                        color: '#e74c3c',
                        desc: 'ç²’å­é«˜é€Ÿè‡ªç”±è¿åŠ¨ï¼Œé—´è·å¾ˆå¤§ï¼Œåˆ†å­é—´ä½œç”¨åŠ›å¾ˆå¼±ã€‚',
                        energy: 'æ¸©åº¦å˜åŒ–ä¸­...'
                    },
                    condensing: {
                        name: 'æ¶²åŒ–ä¸­',
                        color: '#3498db',
                        desc: 'å†·å´ä½¿ç²’å­è¿åŠ¨å‡æ…¢ï¼Œç›¸äº’é è¿‘å¹¶èšé›†ï¼Œå½¢æˆæ¶²ä½“ã€‚',
                        energy: 'â†“ æ”¾çƒ­è¿‡ç¨‹'
                    }
                }
            },
            'solid-gas': {
                name: 'å›ºæ€ â†” æ°”æ€',
                sublimationPoint: -10,
                initialTemp: -30,
                macroIcon: 'ğŸ§Š',
                macroDesc: 'å¹²å†°ï¼ˆå›ºæ€äºŒæ°§åŒ–ç¢³ï¼‰ç›´æ¥å˜æˆæ°”ä½“',
                states: {
                    solid: {
                        name: 'å›ºæ€',
                        color: '#3498db',
                        desc: 'ç²’å­åœ¨æ™¶æ ¼ä½ç½®é™„è¿‘æŒ¯åŠ¨ï¼Œåˆ†å­é—´ä½œç”¨åŠ›å¼ºï¼Œæ’åˆ—è§„åˆ™ã€‚',
                        energy: 'æ¸©åº¦å˜åŒ–ä¸­...'
                    },
                    sublimating: {
                        name: 'å‡åä¸­',
                        color: '#f1c40f',
                        desc: 'åŠ çƒ­ä½¿è¡¨é¢ç²’å­ç›´æ¥è·å¾—è¶³å¤Ÿèƒ½é‡ï¼Œè·³è¿‡æ¶²æ€é˜¶æ®µå˜ä¸ºæ°”ä½“ã€‚',
                        energy: 'â†‘ å¸çƒ­è¿‡ç¨‹'
                    },
                    gas: {
                        name: 'æ°”æ€',
                        color: '#e74c3c',
                        desc: 'ç²’å­é«˜é€Ÿè‡ªç”±è¿åŠ¨ï¼Œé—´è·å¾ˆå¤§ï¼Œåˆ†å­é—´ä½œç”¨åŠ›å¾ˆå¼±ã€‚',
                        energy: 'æ¸©åº¦å˜åŒ–ä¸­...'
                    },
                    depositing: {
                        name: 'å‡åä¸­',
                        color: '#f1c40f',
                        desc: 'å†·å´ä½¿æ°”ä½“ç²’å­ç›´æ¥æ²‰ç§¯ä¸ºå›ºä½“ï¼Œè·³è¿‡æ¶²æ€é˜¶æ®µã€‚',
                        energy: 'â†“ æ”¾çƒ­è¿‡ç¨‹'
                    }
                }
            }
        };

        // ç²’å­ç±»
        class Particle {
            constructor(x, y, state) {
                this.x = x;
                this.y = y;
                this.vx = 0;
                this.vy = 0;
                this.radius = 6;
                this.state = state; // 'solid', 'liquid', 'gas'
                this.color = '#1abc9c';
                this.trace = [];
                this.maxTraceLength = 20;
                this.inLattice = true;
                this.latticeX = x;
                this.latticeY = y;
                this.oscillation = Math.random() * Math.PI * 2;
            }

            update(temperature, moduleConfig) {
                // æ ¹æ®æ¨¡å—å’Œæ¸©åº¦ç¡®å®šçŠ¶æ€
                this.determineState(temperature, moduleConfig);
                
                // æ›´æ–°é¢œè‰²
                this.updateColor(temperature);
                
                // æ ¹æ®çŠ¶æ€æ›´æ–°è¿åŠ¨
                switch(this.state) {
                    case 'solid':
                        this.updateSolid();
                        break;
                    case 'liquid':
                        this.updateLiquid(temperature);
                        break;
                    case 'gas':
                        this.updateGas(temperature);
                        break;
                }
                
                // è¾¹ç•Œç¢°æ’
                this.handleBoundaries();
                
                // è®°å½•è½¨è¿¹
                if (showTraces) {
                    this.trace.push({x: this.x, y: this.y});
                    if (this.trace.length > this.maxTraceLength) {
                        this.trace.shift();
                    }
                } else {
                    this.trace = [];
                }
            }

            determineState(temperature, moduleConfig) {
                if (currentModule === 'solid-liquid') {
                    if (temperature < moduleConfig.meltingPoint - 5) {
                        this.state = 'solid';
                    } else if (temperature > moduleConfig.meltingPoint + 5) {
                        this.state = 'liquid';
                    } else {
                        this.state = temperature < moduleConfig.meltingPoint ? 'solid' : 'liquid';
                    }
                } else if (currentModule === 'liquid-gas') {
                    if (temperature < moduleConfig.boilingPoint - 10) {
                        this.state = 'liquid';
                    } else if (temperature > moduleConfig.boilingPoint + 10) {
                        this.state = 'gas';
                    } else {
                        this.state = temperature < moduleConfig.boilingPoint ? 'liquid' : 'gas';
                    }
                } else if (currentModule === 'solid-gas') {
                    if (temperature < moduleConfig.sublimationPoint - 5) {
                        this.state = 'solid';
                    } else if (temperature > moduleConfig.sublimationPoint + 5) {
                        this.state = 'gas';
                    } else {
                        this.state = temperature < moduleConfig.sublimationPoint ? 'solid' : 'gas';
                    }
                }
            }

            updateColor(temperature) {
                // æ ¹æ®æ¸©åº¦æ¸å˜é¢œè‰²
                let t = (temperature + 50) / 200; // å½’ä¸€åŒ–åˆ°0-1
                t = Math.max(0, Math.min(1, t));
                
                // ä»å†·è“è‰²åˆ°æš–æ©™è‰²
                const coldColor = {r: 52, g: 152, b: 219};   // #3498db
                const warmColor = {r: 230, g: 126, b: 34};  // #e67e22
                
                const r = Math.round(coldColor.r + (warmColor.r - coldColor.r) * t);
                const g = Math.round(coldColor.g + (warmColor.g - coldColor.g) * t);
                const b = Math.round(coldColor.b + (warmColor.b - coldColor.b) * t);
                
                this.color = `rgb(${r}, ${g}, ${b})`;
            }

            updateSolid() {
                // å›ºæ€ç²’å­åœ¨æ™¶æ ¼ä½ç½®é™„è¿‘æŒ¯åŠ¨
                this.oscillation += 0.05;
                const amplitude = 1.5;
                this.x = this.latticeX + Math.sin(this.oscillation) * amplitude;
                this.y = this.latticeY + Math.cos(this.oscillation * 1.3) * amplitude;
                this.vx = 0;
                this.vy = 0;
            }

            updateLiquid(temperature) {
                // æ¶²æ€ç²’å­å¯ä»¥æ»‘åŠ¨ï¼Œæœ‰éšæœºè¿åŠ¨
                const speed = 0.5 + (temperature / 100) * 1.5;
                
                // æ·»åŠ ä¸€äº›éšæœºè¿åŠ¨
                this.vx += (Math.random() - 0.5) * 0.2;
                this.vy += (Math.random() - 0.5) * 0.2;
                
                // é™åˆ¶é€Ÿåº¦
                const maxSpeed = speed;
                const currentSpeed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
                if (currentSpeed > maxSpeed) {
                    this.vx = (this.vx / currentSpeed) * maxSpeed;
                    this.vy = (this.vy / currentSpeed) * maxSpeed;
                }
                
                // åº”ç”¨é€Ÿåº¦
                this.x += this.vx;
                this.y += this.vy;
                
                // ç¼“æ…¢å‡é€Ÿ
                this.vx *= 0.95;
                this.vy *= 0.95;
            }

            updateGas(temperature) {
                // æ°”æ€ç²’å­é«˜é€Ÿè‡ªç”±è¿åŠ¨
                const speed = 2 + (temperature / 100) * 3;
                
                // æ·»åŠ éšæœºåŠ é€Ÿåº¦
                this.vx += (Math.random() - 0.5) * 0.5;
                this.vy += (Math.random() - 0.5) * 0.5;
                
                // é™åˆ¶é€Ÿåº¦
                const maxSpeed = speed;
                const currentSpeed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
                if (currentSpeed > maxSpeed) {
                    this.vx = (this.vx / currentSpeed) * maxSpeed;
                    this.vy = (this.vy / currentSpeed) * maxSpeed;
                }
                
                // åº”ç”¨é€Ÿåº¦
                this.x += this.vx;
                this.y += this.vy;
            }

            handleBoundaries() {
                const padding = 50;
                
                if (this.x < padding) {
                    this.x = padding;
                    this.vx = Math.abs(this.vx) * 0.8;
                }
                if (this.x > canvas.width - padding) {
                    this.x = canvas.width - padding;
                    this.vx = -Math.abs(this.vx) * 0.8;
                }
                if (this.y < padding) {
                    this.y = padding;
                    this.vy = Math.abs(this.vy) * 0.8;
                }
                if (this.y > canvas.height - padding) {
                    this.y = canvas.height - padding;
                    this.vy = -Math.abs(this.vy) * 0.8;
                }
            }

            draw() {
                // ç»˜åˆ¶è½¨è¿¹
                if (showTraces && this.trace.length > 1) {
                    ctx.beginPath();
                    ctx.moveTo(this.trace[0].x, this.trace[0].y);
                    
                    for (let i = 1; i < this.trace.length; i++) {
                        ctx.lineTo(this.trace[i].x, this.trace[i].y);
                    }
                    
                    ctx.strokeStyle = `${this.color}30`;
                    ctx.lineWidth = 1;
                    ctx.stroke();
                }
                
                // ç»˜åˆ¶ç²’å­
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
                
                // æ·»åŠ é«˜å…‰æ•ˆæœ
                ctx.beginPath();
                ctx.arc(this.x - this.radius/3, this.y - this.radius/3, this.radius/3, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.fill();
            }
        }

        // åˆå§‹åŒ–ç²’å­ç³»ç»Ÿ
        function initParticles() {
            particles = [];
            const moduleConfig = modules[currentModule];
            
            // æ ¹æ®å½“å‰æ¨¡å—åˆ›å»ºä¸åŒæ’åˆ—çš„ç²’å­
            if (currentModule === 'solid-liquid' || currentModule === 'solid-gas') {
                // åˆ›å»ºæ™¶æ ¼æ’åˆ—ï¼ˆå›ºæ€ï¼‰
                const rows = 12;
                const cols = 16;
                const spacingX = (canvas.width - 100) / cols;
                const spacingY = (canvas.height - 100) / rows;
                const offsetX = 50;
                const offsetY = 50;
                
                for (let i = 0; i < rows; i++) {
                    for (let j = 0; j < cols; j++) {
                        const x = offsetX + j * spacingX + (i % 2) * spacingX/2;
                        const y = offsetY + i * spacingY;
                        const particle = new Particle(x, y, 'solid');
                        particle.latticeX = x;
                        particle.latticeY = y;
                        particles.push(particle);
                    }
                }
            } else if (currentModule === 'liquid-gas') {
                // åˆ›å»ºæ¶²æ€çš„éšæœºå¯†é›†æ’åˆ—
                const count = 150;
                for (let i = 0; i < count; i++) {
                    const x = 50 + Math.random() * (canvas.width - 100);
                    const y = 50 + Math.random() * (canvas.height - 100);
                    const particle = new Particle(x, y, 'liquid');
                    particles.push(particle);
                }
            }
            
            // è®¾ç½®åˆå§‹æ¸©åº¦
            temperature = moduleConfig.initialTemp;
            document.getElementById('tempSlider').value = temperature;
            document.getElementById('currentTemp').textContent = temperature;
            
            updateUI();
        }

        // ç»˜åˆ¶åˆ†å­é—´ä½œç”¨åŠ›è¿çº¿
        function drawForces() {
            if (!showForces) return;
            
            const maxDistance = 40;
            
            for (let i = 0; i < particles.length; i++) {
                for (let j = i + 1; j < particles.length; j++) {
                    const p1 = particles[i];
                    const p2 = particles[j];
                    
                    const dx = p1.x - p2.x;
                    const dy = p1.y - p2.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    // åªåœ¨ç²’å­è·ç¦»è¾ƒè¿‘ä¸”çŠ¶æ€ä¸æ˜¯æ°”æ€æ—¶ç»˜åˆ¶ä½œç”¨åŠ›çº¿
                    if (distance < maxDistance && p1.state !== 'gas' && p2.state !== 'gas') {
                        // æ ¹æ®è·ç¦»è°ƒæ•´è¿çº¿é€æ˜åº¦
                        const alpha = 1 - (distance / maxDistance);
                        
                        ctx.beginPath();
                        ctx.moveTo(p1.x, p1.y);
                        ctx.lineTo(p2.x, p2.y);
                        
                        // æ ¹æ®çŠ¶æ€å’Œè·ç¦»è°ƒæ•´è¿çº¿é¢œè‰²å’Œæ ·å¼
                        let lineColor;
                        let lineWidth;
                        
                        if (p1.state === 'solid' && p2.state === 'solid') {
                            lineColor = `rgba(52, 152, 219, ${alpha * 0.7})`; // è“è‰²ï¼Œè¡¨ç¤ºå¼ºä½œç”¨åŠ›
                            lineWidth = 2;
                        } else {
                            lineColor = `rgba(26, 188, 156, ${alpha * 0.4})`; // é’è‰²ï¼Œè¡¨ç¤ºè¾ƒå¼±ä½œç”¨åŠ›
                            lineWidth = 1;
                        }
                        
                        ctx.strokeStyle = lineColor;
                        ctx.lineWidth = lineWidth;
                        ctx.stroke();
                    }
                }
            }
        }

        // è·å–å½“å‰çŠ¶æ€æè¿°
        function getCurrentState() {
            const moduleConfig = modules[currentModule];
            
            if (currentModule === 'solid-liquid') {
                if (temperature < moduleConfig.meltingPoint - 5) {
                    return moduleConfig.states.solid;
                } else if (temperature > moduleConfig.meltingPoint + 5) {
                    return moduleConfig.states.liquid;
                } else if (temperature < moduleConfig.meltingPoint) {
                    return moduleConfig.states.freezing;
                } else {
                    return moduleConfig.states.melting;
                }
            } else if (currentModule === 'liquid-gas') {
                if (temperature < moduleConfig.boilingPoint - 10) {
                    return moduleConfig.states.liquid;
                } else if (temperature > moduleConfig.boilingPoint + 10) {
                    return moduleConfig.states.gas;
                } else if (temperature < moduleConfig.boilingPoint) {
                    return moduleConfig.states.condensing;
                } else {
                    return moduleConfig.states.vaporizing;
                }
            } else if (currentModule === 'solid-gas') {
                if (temperature < moduleConfig.sublimationPoint - 5) {
                    return moduleConfig.states.solid;
                } else if (temperature > moduleConfig.sublimationPoint + 5) {
                    return moduleConfig.states.gas;
                } else if (temperature < moduleConfig.sublimationPoint) {
                    return moduleConfig.states.depositing;
                } else {
                    return moduleConfig.states.sublimating;
                }
            }
        }

        // æ›´æ–°UIæ˜¾ç¤º
        function updateUI() {
            const state = getCurrentState();
            const moduleConfig = modules[currentModule];
            
            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            document.getElementById('statusText').textContent = state.name;
            document.getElementById('statusDot').style.backgroundColor = state.color;
            
            // æ›´æ–°è¿‡ç¨‹æè¿°
            document.getElementById('processDesc').textContent = state.desc;
            
            // æ›´æ–°èƒ½é‡æµå‘
            const energyFlow = document.getElementById('energyFlow');
            energyFlow.innerHTML = '';
            
            const energyIcon = document.createElement('div');
            energyIcon.className = 'energy-icon';
            
            const energyText = document.createElement('div');
            
            if (state.energy.includes('å¸çƒ­')) {
                energyIcon.textContent = 'â†‘';
                energyIcon.style.color = '#e67e22';
                energyText.className = 'heat-absorption';
                energyText.textContent = state.energy;
            } else if (state.energy.includes('æ”¾çƒ­')) {
                energyIcon.textContent = 'â†“';
                energyIcon.style.color = '#3498db';
                energyText.className = 'heat-release';
                energyText.textContent = state.energy;
            } else {
                energyIcon.textContent = 'â†’';
                energyIcon.style.color = '#ecf0f1';
                energyText.textContent = state.energy;
            }
            
            energyFlow.appendChild(energyIcon);
            energyFlow.appendChild(energyText);
            
            // æ›´æ–°å®è§‚å®ä¾‹
            document.getElementById('macroIcon').textContent = moduleConfig.macroIcon;
            document.getElementById('macroDesc').textContent = moduleConfig.macroDesc;
            
            // æ›´æ–°æ¸©åº¦æ ‡è®°çº¿
            const meltingLine = document.getElementById('meltingLine');
            const boilingLine = document.getElementById('boilingLine');
            
            if (currentModule === 'solid-liquid') {
                meltingLine.style.display = 'block';
                meltingLine.style.left = `${((moduleConfig.meltingPoint + 50) / 200) * 100}%`;
                boilingLine.style.display = 'none';
            } else if (currentModule === 'liquid-gas') {
                meltingLine.style.display = 'none';
                boilingLine.style.display = 'block';
                boilingLine.style.left = `${((moduleConfig.boilingPoint + 50) / 200) * 100}%`;
            } else {
                meltingLine.style.display = 'none';
                boilingLine.style.display = 'none';
            }
        }

        // åŠ¨ç”»å¾ªç¯
        function animate() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶èƒŒæ™¯ç½‘æ ¼ï¼ˆè¾…åŠ©å‚è€ƒï¼‰
            ctx.strokeStyle = 'rgba(52, 73, 94, 0.2)';
            ctx.lineWidth = 1;
            
            // æ°´å¹³çº¿
            for (let y = 50; y < canvas.height; y += 50) {
                ctx.beginPath();
                ctx.moveTo(50, y);
                ctx.lineTo(canvas.width - 50, y);
                ctx.stroke();
            }
            
            // å‚ç›´çº¿
            for (let x = 50; x < canvas.width; x += 50) {
                ctx.beginPath();
                ctx.moveTo(x, 50);
                ctx.lineTo(x, canvas.height - 50);
                ctx.stroke();
            }
            
            // æ›´æ–°å’Œç»˜åˆ¶ç²’å­
            const moduleConfig = modules[currentModule];
            
            for (const particle of particles) {
                particle.update(temperature, moduleConfig);
                particle.draw();
            }
            
            // ç»˜åˆ¶åˆ†å­é—´ä½œç”¨åŠ›
            drawForces();
            
            // ç»§ç»­åŠ¨ç”»å¾ªç¯
            if (isPlaying) {
                animationId = requestAnimationFrame(animate);
            }
        }

        // DOMåŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è·å–Canvasä¸Šä¸‹æ–‡
            canvas = document.getElementById('particleCanvas');
            ctx = canvas.getContext('2d');
            
            // è°ƒæ•´Canvaså¤§å°ä»¥é€‚åº”å®¹å™¨
            function resizeCanvas() {
                const container = canvas.parentElement;
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
                
                // é‡æ–°åˆå§‹åŒ–ç²’å­ä»¥é€‚åº”æ–°å°ºå¯¸
                initParticles();
            }
            
            // åˆå§‹è°ƒæ•´å¤§å°
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // åˆå§‹åŒ–ç²’å­
            initParticles();
            
            // å¼€å§‹åŠ¨ç”»
            animate();
            
            // æ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // æ›´æ–°æ´»åŠ¨æ ‡ç­¾
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // æ›´æ–°å½“å‰æ¨¡å—
                    currentModule = this.dataset.module;
                    
                    // é‡æ–°åˆå§‹åŒ–ç²’å­
                    initParticles();
                });
            });
            
            // æ¸©åº¦æ»‘å—äº‹ä»¶
            const tempSlider = document.getElementById('tempSlider');
            tempSlider.addEventListener('input', function() {
                temperature = parseInt(this.value);
                document.getElementById('currentTemp').textContent = temperature;
                updateUI();
            });
            
            // æ’­æ”¾/æš‚åœæŒ‰é’®
            document.getElementById('playPauseBtn').addEventListener('click', function() {
                isPlaying = !isPlaying;
                this.textContent = isPlaying ? 'æš‚åœ' : 'æ’­æ”¾';
                document.getElementById('stepBtn').disabled = isPlaying;
                
                if (isPlaying) {
                    animate();
                } else {
                    cancelAnimationFrame(animationId);
                }
            });
            
            // é‡ç½®æŒ‰é’®
            document.getElementById('resetBtn').addEventListener('click', function() {
                initParticles();
            });
            
            // å•æ­¥å‰è¿›æŒ‰é’®
            document.getElementById('stepBtn').addEventListener('click', function() {
                if (!isPlaying) {
                    // æ‰‹åŠ¨æ‰§è¡Œä¸€å¸§åŠ¨ç”»
                    cancelAnimationFrame(animationId);
                    animate();
                }
            });
            
            // è§†å›¾é€‰é¡¹
            document.getElementById('showForces').addEventListener('change', function() {
                showForces = this.checked;
            });
            
            document.getElementById('showTraces').addEventListener('change', function() {
                showTraces = this.checked;
            });
        });
    </script>
</body>
</html>