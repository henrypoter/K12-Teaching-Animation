<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>复分解反应：AgNO₃ + NaCl → AgCl↓ + NaNO₃ 离子交换动画</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #333;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            width: 100%;
            max-width: 900px;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        .equation-container {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            border-left: 5px solid #3498db;
        }
        
        .equation {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            color: #2c3e50;
        }
        
        .equation .highlight {
            color: #e74c3c;
            background-color: rgba(231, 76, 60, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .main-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            max-width: 900px;
            width: 100%;
            justify-content: center;
        }
        
        .animation-container {
            flex: 1;
            min-width: 300px;
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }
        
        .canvas-container {
            position: relative;
            flex-grow: 1;
            background-color: #f8fafc;
            border-bottom: 1px solid #eaeaea;
        }
        
        #reactionCanvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        
        .controls {
            padding: 15px;
            background-color: #f8fafc;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }
        
        .control-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            background-color: #3498db;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .control-btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }
        
        .control-btn:active {
            transform: translateY(0);
        }
        
        .control-btn.reset {
            background-color: #e74c3c;
        }
        
        .control-btn.reset:hover {
            background-color: #c0392b;
            box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
        }
        
        .control-btn.step {
            background-color: #2ecc71;
        }
        
        .control-btn.step:hover {
            background-color: #27ae60;
            box-shadow: 0 4px 8px rgba(46, 204, 113, 0.3);
        }
        
        .info-panel {
            flex: 1;
            min-width: 250px;
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }
        
        .info-title {
            color: #2c3e50;
            font-size: 20px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }
        
        .step-info {
            flex-grow: 1;
            margin-bottom: 20px;
        }
        
        .step-title {
            color: #3498db;
            font-size: 18px;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .step-description {
            color: #555;
            line-height: 1.6;
            margin-bottom: 15px;
            padding: 12px;
            background-color: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .legend {
            margin-top: 10px;
        }
        
        .legend-title {
            color: #2c3e50;
            font-size: 16px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .legend-items {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        
        .legend-text {
            font-size: 14px;
            color: #555;
        }
        
        .footer {
            margin-top: 20px;
            text-align: center;
            color: #7f8c8d;
            font-size: 14px;
            max-width: 900px;
            width: 100%;
            padding-top: 15px;
            border-top: 1px solid #eaeaea;
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 10px;
        }
        
        .step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ddd;
            transition: all 0.3s ease;
        }
        
        .step-dot.active {
            background-color: #3498db;
            transform: scale(1.2);
        }
        
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .animation-container, .info-panel {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>复分解反应：沉淀生成</h1>
        <div class="subtitle">AgNO₃ + NaCl → AgCl↓ + NaNO₃ 离子交换微观过程</div>
        
        <div class="equation-container">
            <div class="equation">
                AgNO<sub>3</sub>(aq) + NaCl(aq) → 
                <span class="highlight" id="agcl-equation">AgCl↓</span> + NaNO<sub>3</sub>(aq)
            </div>
        </div>
    </div>
    
    <div class="main-container">
        <div class="animation-container">
            <div class="canvas-container">
                <canvas id="reactionCanvas"></canvas>
            </div>
            
            <div class="controls">
                <button class="control-btn" id="playPauseBtn">
                    <span id="playIcon">▶</span> <span id="playText">播放</span>
                </button>
                <button class="control-btn reset" id="resetBtn">↺ 重置</button>
                <button class="control-btn step" id="prevStepBtn">◀ 上一步</button>
                <button class="control-btn step" id="nextStepBtn">下一步 ▶</button>
            </div>
            
            <div class="step-indicator">
                <div class="step-dot active" data-step="0"></div>
                <div class="step-dot" data-step="1"></div>
                <div class="step-dot" data-step="2"></div>
                <div class="step-dot" data-step="3"></div>
                <div class="step-dot" data-step="4"></div>
            </div>
        </div>
        
        <div class="info-panel">
            <div class="info-title">反应过程说明</div>
            
            <div class="step-info">
                <div class="step-title" id="stepTitle">步骤 1: 初始状态</div>
                <div class="step-description" id="stepDescription">
                    左侧为硝酸银(AgNO₃)溶液，含有自由移动的Ag⁺和NO₃⁻离子。
                    右侧为氯化钠(NaCl)溶液，含有自由移动的Na⁺和Cl⁻离子。
                    两种溶液尚未混合，离子在各自区域内做无规则运动。
                </div>
            </div>
            
            <div class="legend">
                <div class="legend-title">图例说明</div>
                <div class="legend-items">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #bdc3c7;"></div>
                        <div class="legend-text">Ag⁺ (银离子)</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #2ecc71;"></div>
                        <div class="legend-text">Cl⁻ (氯离子)</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f1c40f;"></div>
                        <div class="legend-text">Na⁺ (钠离子)</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #3498db;"></div>
                        <div class="legend-text">NO₃⁻ (硝酸根离子)</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #ecf0f1; border: 1px solid #bdc3c7;"></div>
                        <div class="legend-text">AgCl (氯化银沉淀)</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: transparent; border: 2px dashed #9b59b6;"></div>
                        <div class="legend-text">反应区域</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <p>教学动画设计：展示复分解反应中离子交换和沉淀生成的微观过程 | 适用于初中/高中化学教学</p>
    </div>

    <script>
        // 获取Canvas元素和上下文
        const canvas = document.getElementById('reactionCanvas');
        const ctx = canvas.getContext('2d');
        
        // 设置Canvas尺寸
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }
        
        // 初始调整尺寸
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // 动画状态
        let animationState = {
            step: 0, // 0:初始, 1:混合, 2:扩散, 3:沉淀生成, 4:最终状态
            isPlaying: false,
            progress: 0, // 当前步骤进度 0-1
            lastTime: 0,
            animationId: null
        };
        
        // 离子定义
        const ION_TYPES = {
            AG: { name: 'Ag⁺', color: '#bdc3c7', radius: 12, charge: '+', symbol: 'Ag' },
            CL: { name: 'Cl⁻', color: '#2ecc71', radius: 14, charge: '-', symbol: 'Cl' },
            NA: { name: 'Na⁺', color: '#f1c40f', radius: 10, charge: '+', symbol: 'Na' },
            NO3: { name: 'NO₃⁻', color: '#3498db', radius: 16, charge: '-', symbol: 'NO₃' }
        };
        
        // 沉淀定义
        const PRECIPITATE = {
            name: 'AgCl',
            color: '#ecf0f1',
            borderColor: '#bdc3c7',
            radius: 8
        };
        
        // 离子数组
        let ions = [];
        let precipitates = [];
        
        // 步骤信息
        const stepInfo = [
            {
                title: "步骤 1: 初始状态",
                description: "左侧为硝酸银(AgNO₃)溶液，含有自由移动的Ag⁺和NO₃⁻离子。右侧为氯化钠(NaCl)溶液，含有自由移动的Na⁺和Cl⁻离子。两种溶液尚未混合，离子在各自区域内做无规则运动。"
            },
            {
                title: "步骤 2: 溶液混合",
                description: "两种溶液开始混合。中间的隔板消失，Ag⁺、NO₃⁻、Na⁺和Cl⁻离子开始在全部溶液区域内自由扩散和运动。这是一个物理混合过程。"
            },
            {
                title: "步骤 3: 离子扩散与相遇",
                description: "离子在溶液中做无规则运动（布朗运动）。Ag⁺和Cl⁻离子在运动过程中相互靠近。当它们进入一定距离（反应半径）时，由于静电吸引和形成难溶性物质AgCl的趋势，它们会相互结合。"
            },
            {
                title: "步骤 4: 沉淀生成",
                description: "Ag⁺和Cl⁻结合形成AgCl沉淀。沉淀颗粒最初较小，然后逐渐聚集长大。由于AgCl难溶于水，沉淀颗粒在重力作用下沉降至容器底部。Na⁺和NO₃⁻离子仍留在溶液中自由移动。"
            },
            {
                title: "步骤 5: 最终状态",
                description: "反应完成。溶液中主要含有Na⁺和NO₃⁻离子，它们不形成沉淀，继续自由移动。容器底部聚集了白色的AgCl沉淀。这就是复分解反应：AgNO₃ + NaCl → AgCl↓ + NaNO₃的微观过程。"
            }
        ];
        
        // 初始化离子
        function initIons() {
            ions = [];
            precipitates = [];
            
            const canvasWidth = canvas.width;
            const canvasHeight = canvas.height;
            
            // 初始状态：离子分居左右两侧
            if (animationState.step === 0) {
                // 左侧：Ag⁺ 和 NO₃⁻
                for (let i = 0; i < 15; i++) {
                    ions.push({
                        type: ION_TYPES.AG,
                        x: Math.random() * (canvasWidth * 0.4 - 40) + 20,
                        y: Math.random() * (canvasHeight - 100) + 50,
                        vx: (Math.random() - 0.5) * 0.8,
                        vy: (Math.random() - 0.5) * 0.8,
                        isActive: true
                    });
                }
                
                for (let i = 0; i < 15; i++) {
                    ions.push({
                        type: ION_TYPES.NO3,
                        x: Math.random() * (canvasWidth * 0.4 - 40) + 20,
                        y: Math.random() * (canvasHeight - 100) + 50,
                        vx: (Math.random() - 0.5) * 0.6,
                        vy: (Math.random() - 0.5) * 0.6,
                        isActive: true
                    });
                }
                
                // 右侧：Na⁺ 和 Cl⁻
                for (let i = 0; i < 15; i++) {
                    ions.push({
                        type: ION_TYPES.NA,
                        x: Math.random() * (canvasWidth * 0.4 - 40) + canvasWidth * 0.6,
                        y: Math.random() * (canvasHeight - 100) + 50,
                        vx: (Math.random() - 0.5) * 1.0,
                        vy: (Math.random() - 0.5) * 1.0,
                        isActive: true
                    });
                }
                
                for (let i = 0; i < 15; i++) {
                    ions.push({
                        type: ION_TYPES.CL,
                        x: Math.random() * (canvasWidth * 0.4 - 40) + canvasWidth * 0.6,
                        y: Math.random() * (canvasHeight - 100) + 50,
                        vx: (Math.random() - 0.5) * 0.7,
                        vy: (Math.random() - 0.5) * 0.7,
                        isActive: true
                    });
                }
            } else {
                // 其他步骤：离子在全区域运动
                for (let i = 0; i < 15; i++) {
                    ions.push({
                        type: ION_TYPES.AG,
                        x: Math.random() * (canvasWidth - 40) + 20,
                        y: Math.random() * (canvasHeight - 100) + 50,
                        vx: (Math.random() - 0.5) * 0.8,
                        vy: (Math.random() - 0.5) * 0.8,
                        isActive: true
                    });
                }
                
                for (let i = 0; i < 15; i++) {
                    ions.push({
                        type: ION_TYPES.NO3,
                        x: Math.random() * (canvasWidth - 40) + 20,
                        y: Math.random() * (canvasHeight - 100) + 50,
                        vx: (Math.random() - 0.5) * 0.6,
                        vy: (Math.random() - 0.5) * 0.6,
                        isActive: true
                    });
                }
                
                for (let i = 0; i < 15; i++) {
                    ions.push({
                        type: ION_TYPES.NA,
                        x: Math.random() * (canvasWidth - 40) + 20,
                        y: Math.random() * (canvasHeight - 100) + 50,
                        vx: (Math.random() - 0.5) * 1.0,
                        vy: (Math.random() - 0.5) * 1.0,
                        isActive: true
                    });
                }
                
                for (let i = 0; i < 15; i++) {
                    ions.push({
                        type: ION_TYPES.CL,
                        x: Math.random() * (canvasWidth - 40) + 20,
                        y: Math.random() * (canvasHeight - 100) + 50,
                        vx: (Math.random() - 0.5) * 0.7,
                        vy: (Math.random() - 0.5) * 0.7,
                        isActive: true
                    });
                }
                
                // 如果步骤3或4，生成一些沉淀
                if (animationState.step >= 3) {
                    const precipitateCount = animationState.step === 3 ? 
                        Math.floor(animationState.progress * 20) : 20;
                    
                    for (let i = 0; i < precipitateCount; i++) {
                        precipitates.push({
                            x: Math.random() * (canvasWidth - 60) + 30,
                            y: canvasHeight - 40 - Math.random() * 30,
                            size: 1 + Math.random() * 1.5
                        });
                    }
                }
            }
        }
        
        // 绘制离子
        function drawIon(ion) {
            ctx.save();
            
            // 绘制离子主体
            ctx.beginPath();
            ctx.arc(ion.x, ion.y, ion.type.radius, 0, Math.PI * 2);
            ctx.fillStyle = ion.type.color;
            ctx.fill();
            
            // 绘制离子边框
            ctx.lineWidth = 2;
            ctx.strokeStyle = ion.type.charge === '+' ? '#e74c3c' : '#3498db';
            ctx.stroke();
            
            // 绘制离子符号
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(ion.type.symbol, ion.x, ion.y);
            
            // 绘制电荷
            ctx.font = 'bold 12px Arial';
            ctx.fillText(ion.type.charge, ion.x + ion.type.radius * 0.7, ion.y - ion.type.radius * 0.7);
            
            ctx.restore();
        }
        
        // 绘制沉淀
        function drawPrecipitate(p) {
            ctx.save();
            
            ctx.beginPath();
            ctx.arc(p.x, p.y, PRECIPITATE.radius * p.size, 0, Math.PI * 2);
            ctx.fillStyle = PRECIPITATE.color;
            ctx.fill();
            
            ctx.lineWidth = 1;
            ctx.strokeStyle = PRECIPITATE.borderColor;
            ctx.stroke();
            
            // 绘制沉淀符号
            ctx.fillStyle = '#7f8c8d';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('AgCl', p.x, p.y);
            
            ctx.restore();
        }
        
        // 绘制容器和背景
        function drawContainer() {
            const canvasWidth = canvas.width;
            const canvasHeight = canvas.height;
            
            ctx.save();
            
            // 绘制背景
            ctx.fillStyle = '#f8fafc';
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);
            
            // 绘制容器
            ctx.strokeStyle = '#3498db';
            ctx.lineWidth = 3;
            ctx.strokeRect(20, 40, canvasWidth - 40, canvasHeight - 80);
            
            // 绘制容器底部（沉淀区）
            ctx.fillStyle = 'rgba(236, 240, 241, 0.3)';
            ctx.fillRect(25, canvasHeight - 60, canvasWidth - 50, 35);
            
            // 绘制步骤特定的元素
            if (animationState.step === 0) {
                // 绘制分隔线
                ctx.strokeStyle = '#e74c3c';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(canvasWidth / 2, 45);
                ctx.lineTo(canvasWidth / 2, canvasHeight - 65);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // 标注左侧溶液
                ctx.fillStyle = '#2c3e50';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('AgNO₃溶液', canvasWidth / 4, 30);
                
                // 标注右侧溶液
                ctx.fillText('NaCl溶液', canvasWidth * 3 / 4, 30);
            }
            
            // 绘制反应区域（步骤2-4）
            if (animationState.step >= 1 && animationState.step <= 3) {
                ctx.strokeStyle = '#9b59b6';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.strokeRect(30, 50, canvasWidth - 60, canvasHeight - 140);
                ctx.setLineDash([]);
                
                // 标注反应区域
                ctx.fillStyle = '#9b59b6';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('离子反应区域', canvasWidth / 2, canvasHeight - 15);
            }
            
            // 高亮AgCl沉淀（步骤3-4）
            if (animationState.step >= 3) {
                const equationElement = document.getElementById('agcl-equation');
                equationElement.style.backgroundColor = 'rgba(231, 76, 60, 0.2)';
                equationElement.style.boxShadow = '0 0 8px rgba(231, 76, 60, 0.5)';
            } else {
                const equationElement = document.getElementById('agcl-equation');
                equationElement.style.backgroundColor = 'rgba(231, 76, 60, 0.1)';
                equationElement.style.boxShadow = 'none';
            }
            
            ctx.restore();
        }
        
        // 更新离子位置
        function updateIons(deltaTime) {
            const canvasWidth = canvas.width;
            const canvasHeight = canvas.height;
            
            // 根据步骤调整离子行为
            ions.forEach(ion => {
                if (!ion.isActive) return;
                
                // 更新位置
                ion.x += ion.vx * deltaTime * 0.05;
                ion.y += ion.vy * deltaTime * 0.05;
                
                // 边界碰撞检测
                const boundaryLeft = 25;
                const boundaryRight = canvasWidth - 25;
                const boundaryTop = 45;
                const boundaryBottom = canvasHeight - 65;
                
                // 步骤0：离子不能越过中线
                if (animationState.step === 0) {
                    const midX = canvasWidth / 2;
                    if (ion.type === ION_TYPES.AG || ion.type === ION_TYPES.NO3) {
                        // 左侧离子
                        if (ion.x + ion.type.radius > midX) {
                            ion.x = midX - ion.type.radius;
                            ion.vx *= -0.8;
                        }
                    } else {
                        // 右侧离子
                        if (ion.x - ion.type.radius < midX) {
                            ion.x = midX + ion.type.radius;
                            ion.vx *= -0.8;
                        }
                    }
                }
                
                // 通用边界检测
                if (ion.x - ion.type.radius < boundaryLeft) {
                    ion.x = boundaryLeft + ion.type.radius;
                    ion.vx *= -0.8;
                }
                if (ion.x + ion.type.radius > boundaryRight) {
                    ion.x = boundaryRight - ion.type.radius;
                    ion.vx *= -0.8;
                }
                if (ion.y - ion.type.radius < boundaryTop) {
                    ion.y = boundaryTop + ion.type.radius;
                    ion.vy *= -0.8;
                }
                if (ion.y + ion.type.radius > boundaryBottom) {
                    ion.y = boundaryBottom - ion.type.radius;
                    ion.vy *= -0.8;
                }
                
                // 步骤3：Ag⁺和Cl⁻相遇形成沉淀
                if (animationState.step === 3 && animationState.progress > 0.3) {
                    // 查找Ag⁺和Cl⁻离子
                    const agIons = ions.filter(i => i.type === ION_TYPES.AG && i.isActive);
                    const clIons = ions.filter(i => i.type === ION_TYPES.CL && i.isActive);
                    
                    // 随机让一些Ag⁺和Cl⁻离子结合形成沉淀
                    if (agIons.length > 0 && clIons.length > 0 && Math.random() < 0.01 * animationState.progress) {
                        const agIndex = Math.floor(Math.random() * agIons.length);
                        const clIndex = Math.floor(Math.random() * clIons.length);
                        
                        // 标记这些离子为不活跃（已反应）
                        agIons[agIndex].isActive = false;
                        clIons[clIndex].isActive = false;
                        
                        // 在沉淀区添加沉淀
                        precipitates.push({
                            x: Math.random() * (canvasWidth - 60) + 30,
                            y: canvasHeight - 40 - Math.random() * 30,
                            size: 0.5 + Math.random() * 1.0
                        });
                    }
                }
                
                // 添加随机运动变化
                if (Math.random() < 0.02) {
                    ion.vx += (Math.random() - 0.5) * 0.2;
                    ion.vy += (Math.random() - 0.5) * 0.2;
                }
                
                // 限制速度
                const maxSpeed = 2.0;
                const speed = Math.sqrt(ion.vx * ion.vx + ion.vy * ion.vy);
                if (speed > maxSpeed) {
                    ion.vx = (ion.vx / speed) * maxSpeed;
                    ion.vy = (ion.vy / speed) * maxSpeed;
                }
            });
            
            // 步骤4：沉淀沉降
            if (animationState.step === 4) {
                precipitates.forEach(p => {
                    // 轻微随机运动
                    p.x += (Math.random() - 0.5) * 0.1;
                    p.y += Math.random() * 0.05;
                    
                    // 确保沉淀在底部区域
                    if (p.y > canvasHeight - 40) {
                        p.y = canvasHeight - 40;
                    }
                    if (p.y < canvasHeight - 70) {
                        p.y = canvasHeight - 70;
                    }
                });
            }
        }
        
        // 绘制所有元素
        function draw() {
            // 清除画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 绘制容器和背景
            drawContainer();
            
            // 绘制沉淀
            precipitates.forEach(drawPrecipitate);
            
            // 绘制离子
            ions.forEach(drawIon);
            
            // 步骤3：绘制Ag⁺和Cl⁻之间的连接线（当它们靠近时）
            if (animationState.step === 3 && animationState.progress > 0.2) {
                const agIons = ions.filter(i => i.type === ION_TYPES.AG && i.isActive);
                const clIons = ions.filter(i => i.type === ION_TYPES.CL && i.isActive);
                
                // 随机绘制一些连接线
                agIons.forEach(agIon => {
                    clIons.forEach(clIon => {
                        const dx = agIon.x - clIon.x;
                        const dy = agIon.y - clIon.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < 80 && Math.random() < 0.1) {
                            ctx.save();
                            ctx.strokeStyle = `rgba(231, 76, 60, ${0.7 * (1 - distance/80)})`;
                            ctx.lineWidth = 2;
                            ctx.setLineDash([3, 3]);
                            ctx.beginPath();
                            ctx.moveTo(agIon.x, agIon.y);
                            ctx.lineTo(clIon.x, clIon.y);
                            ctx.stroke();
                            ctx.setLineDash([]);
                            ctx.restore();
                        }
                    });
                });
            }
        }
        
        // 动画循环
        function animate(timestamp) {
            if (!animationState.lastTime) animationState.lastTime = timestamp;
            const deltaTime = timestamp - animationState.lastTime;
            animationState.lastTime = timestamp;
            
            // 如果正在播放，更新进度
            if (animationState.isPlaying && animationState.step < 4) {
                animationState.progress += deltaTime / 3000; // 3秒完成一个步骤
                
                if (animationState.progress >= 1) {
                    animationState.progress = 0;
                    animationState.step++;
                    
                    if (animationState.step > 4) {
                        animationState.step = 4;
                        animationState.isPlaying = false;
                        updatePlayButton();
                    }
                    
                    initIons();
                    updateStepInfo();
                }
            }
            
            // 更新离子位置
            updateIons(deltaTime);
            
            // 绘制所有元素
            draw();
            
            // 继续动画循环
            animationState.animationId = requestAnimationFrame(animate);
        }
        
        // 更新步骤信息
        function updateStepInfo() {
            const stepTitle = document.getElementById('stepTitle');
            const stepDescription = document.getElementById('stepDescription');
            
            stepTitle.textContent = stepInfo[animationState.step].title;
            stepDescription.textContent = stepInfo[animationState.step].description;
            
            // 更新步骤指示器
            document.querySelectorAll('.step-dot').forEach((dot, index) => {
                if (index === animationState.step) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
        }
        
        // 更新播放按钮状态
        function updatePlayButton() {
            const playIcon = document.getElementById('playIcon');
            const playText = document.getElementById('playText');
            
            if (animationState.isPlaying) {
                playIcon.textContent = '⏸';
                playText.textContent = '暂停';
            } else {
                playIcon.textContent = '▶';
                playText.textContent = '播放';
            }
        }
        
        // 播放/暂停动画
        function togglePlayPause() {
            animationState.isPlaying = !animationState.isPlaying;
            updatePlayButton();
        }
        
        // 重置动画
        function resetAnimation() {
            animationState.step = 0;
            animationState.progress = 0;
            animationState.isPlaying = false;
            
            initIons();
            updateStepInfo();
            updatePlayButton();
        }
        
        // 下一步
        function nextStep() {
            if (animationState.step < 4) {
                animationState.step++;
                animationState.progress = 0;
                animationState.isPlaying = false;
                
                initIons();
                updateStepInfo();
                updatePlayButton();
            }
        }
        
        // 上一步
        function prevStep() {
            if (animationState.step > 0) {
                animationState.step--;
                animationState.progress = 0;
                animationState.isPlaying = false;
                
                initIons();
                updateStepInfo();
                updatePlayButton();
            }
        }
        
        // 事件监听
        document.getElementById('playPauseBtn').addEventListener('click', togglePlayPause);
        document.getElementById('resetBtn').addEventListener('click', resetAnimation);
        document.getElementById('nextStepBtn').addEventListener('click', nextStep);
        document.getElementById('prevStepBtn').addEventListener('click', prevStep);
        
        // 步骤指示器点击事件
        document.querySelectorAll('.step-dot').forEach(dot => {
            dot.addEventListener('click', function() {
                const step = parseInt(this.getAttribute('data-step'));
                if (step !== animationState.step) {
                    animationState.step = step;
                    animationState.progress = 0;
                    animationState.isPlaying = false;
                    
                    initIons();
                    updateStepInfo();
                    updatePlayButton();
                }
            });
        });
        
        // 初始化
        initIons();
        updateStepInfo();
        animate(0);
        
        // 添加Canvas点击交互：显示离子信息
        canvas.addEventListener('click', function(event) {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            // 检查是否点击了离子
            for (const ion of ions) {
                const dx = x - ion.x;
                const dy = y - ion.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance <
<!--检测到代码截断，自动续写中...-->
ion.type.radius + 5) {
                    // 显示离子信息
                    alert(`点击了: ${ion.type.name}\n符号: ${ion.type.symbol}\n电荷: ${ion.type.charge}\n状态: ${ion.isActive ? '自由离子' : '已反应'}`);
                    return;
                }
            }
            
            // 检查是否点击了沉淀
            for (const precipitate of precipitates) {
                const dx = x - precipitate.x;
                const dy = y - precipitate.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < PRECIPITATE.radius * precipitate.size + 5) {
                    // 显示沉淀信息
                    alert(`点击了: ${PRECIPITATE.name} 沉淀\n化学式: AgCl\n状态: 固体沉淀\n说明: 难溶于水，从溶液中析出`);
                    return;
                }
            }
        });
        
        // 添加Canvas悬停交互：高亮离子
        let hoveredIon = null;
        
        canvas.addEventListener('mousemove', function(event) {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            let foundIon = null;
            
            // 检查鼠标是否在离子上
            for (const ion of ions) {
                const dx = x - ion.x;
                const dy = y - ion.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < ion.type.radius + 5) {
                    foundIon = ion;
                    break;
                }
            }
            
            // 如果悬停的离子发生变化，更新并重绘
            if (foundIon !== hoveredIon) {
                hoveredIon = foundIon;
                
                // 改变鼠标样式
                canvas.style.cursor = hoveredIon ? 'pointer' : 'default';
                
                // 如果悬停在离子上，临时改变其外观
                if (hoveredIon) {
                    // 保存原始颜色
                    if (!hoveredIon.originalColor) {
                        hoveredIon.originalColor = hoveredIon.type.color;
                    }
                    // 高亮颜色
                    hoveredIon.type.color = '#e74c3c';
                } else {
                    // 恢复所有离子的原始颜色
                    ions.forEach(ion => {
                        if (ion.originalColor) {
                            ion.type.color = ion.originalColor;
                            delete ion.originalColor;
                        }
                    });
                }
            }
        });
    </script>
</body>
</html>