<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é•æ¡åœ¨ç©ºæ°”ä¸­ç‡ƒçƒ§ - å®è§‚ä¸å¾®è§‚æ•™å­¦åŠ¨ç”»</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            width: 100%;
            max-width: 900px;
        }

        h1 {
            color: #ffffff;
            margin-bottom: 8px;
            font-size: 2.2rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .subtitle {
            color: #a0d2ff;
            font-size: 1.1rem;
            margin-bottom: 15px;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 900px;
            gap: 20px;
        }

        .animation-area {
            width: 100%;
            height: 500px;
            background-color: #1a2734;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid #2a3a4a;
        }

        #mainCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            width: 100%;
            padding: 15px;
            background: rgba(30, 40, 55, 0.8);
            border-radius: 10px;
            border: 1px solid #3a4a5a;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 120px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background-color: #4a9eff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #3a8eef;
        }

        .btn-success {
            background-color: #4CAF50;
            color: white;
        }

        .btn-success:hover {
            background-color: #3d9b41;
        }

        .btn-warning {
            background-color: #ff9800;
            color: white;
        }

        .btn-warning:hover {
            background-color: #e68900;
        }

        .btn-danger {
            background-color: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background-color: #e53935;
        }

        .btn-view {
            background-color: #673ab7;
            color: white;
        }

        .btn-view:hover {
            background-color: #5e35b1;
        }

        .btn:disabled {
            background-color: #555;
            color: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .info-panel {
            width: 100%;
            background: rgba(25, 35, 50, 0.9);
            border-radius: 10px;
            padding: 20px;
            border-left: 5px solid #4a9eff;
            line-height: 1.6;
        }

        .info-panel h3 {
            color: #4a9eff;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .step {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #3a4a5a;
            transition: background-color 0.3s;
        }

        .step.active {
            background-color: #4a9eff;
            box-shadow: 0 0 8px #4a9eff;
        }

        .equation {
            text-align: center;
            font-size: 1.8rem;
            margin: 15px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            font-family: 'Cambria', 'Times New Roman', serif;
        }

        .highlight {
            color: #ffcc00;
            font-weight: bold;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 100;
            border: 1px solid #444;
            max-width: 200px;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }
            
            .animation-area {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ”¥ é•æ¡åœ¨ç©ºæ°”ä¸­ç‡ƒçƒ§</h1>
        <p class="subtitle">å®è§‚ç°è±¡ä¸å¾®è§‚ååº”è¿‡ç¨‹çš„å¯è§†åŒ–æ•™å­¦åŠ¨ç”»</p>
    </div>

    <div class="container">
        <div class="step-indicator">
            <div class="step active" data-step="0"></div>
            <div class="step" data-step="1"></div>
            <div class="step" data-step="2"></div>
            <div class="step" data-step="3"></div>
            <div class="step" data-step="4"></div>
        </div>

        <div class="animation-area">
            <canvas id="mainCanvas"></canvas>
            <div class="tooltip" id="tooltip"></div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" id="prevBtn">
                <span>â—€</span> ä¸Šä¸€æ­¥
            </button>
            <button class="btn btn-success" id="nextBtn">
                ä¸‹ä¸€æ­¥ <span>â–¶</span>
            </button>
            <button class="btn btn-warning" id="startBtn">
                ğŸ”¥ ç‚¹ç‡ƒ/å¼€å§‹ååº”
            </button>
            <button class="btn btn-warning" id="pauseBtn">
                â¸ï¸ æš‚åœ/ç»§ç»­
            </button>
            <button class="btn btn-danger" id="resetBtn">
                â†º é‡ç½®
            </button>
            <button class="btn btn-view" id="macroViewBtn">
                ğŸ” å®è§‚è§†å›¾
            </button>
            <button class="btn btn-view" id="microViewBtn">
                âš›ï¸ å¾®è§‚è§†å›¾
            </button>
        </div>

        <div class="info-panel">
            <h3>ğŸ“š æ•™å­¦ä¿¡æ¯</h3>
            <div id="infoText">
                <p><strong>å½“å‰æ­¥éª¤ï¼š</strong> å‡†å¤‡é˜¶æ®µ - è§‚å¯Ÿé•æ¡å’Œç©ºæ°”ç¯å¢ƒ</p>
                <p><strong>è¯´æ˜ï¼š</strong> è¿™æ˜¯ä¸€ä¸ªå®‰å…¨ã€å¯æ§çš„è™šæ‹Ÿå®éªŒç¯å¢ƒã€‚è¯·ç‚¹å‡»"ä¸‹ä¸€æ­¥"å¼€å§‹å­¦ä¹ ï¼Œæˆ–ç›´æ¥ä½¿ç”¨"ç‚¹ç‡ƒ"æŒ‰é’®è§¦å‘ååº”ã€‚</p>
            </div>
            
            <div class="equation" id="equation">
                2Mg + Oâ‚‚ â†’ 2MgO
            </div>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #cccccc;"></div>
                    <span>é•åŸå­ (Mg)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ff3333;"></div>
                    <span>æ°§åŸå­ (O)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ffff99;"></div>
                    <span>ç‡ƒçƒ§ç™½å…‰</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #4CAF50;"></div>
                    <span>æ°§åŒ–é• (MgO)</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡å’ŒçŠ¶æ€ç®¡ç†
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const tooltip = document.getElementById('tooltip');
        const infoText = document.getElementById('infoText');
        const equation = document.getElementById('equation');
        
        // è®¾ç½®Canvaså°ºå¯¸
        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }
        
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        
        // åŠ¨ç”»çŠ¶æ€
        let animationState = {
            currentStep: 0,
            totalSteps: 5,
            isMacroView: true,
            isReactionStarted: false,
            isPaused: false,
            reactionProgress: 0,
            animationFrameId: null,
            lastTimestamp: 0
        };
        
        // æ­¥éª¤ä¿¡æ¯
        const stepInfo = [
            {
                title: "å‡†å¤‡é˜¶æ®µ",
                description: "è§‚å¯Ÿå®éªŒææ–™ï¼šé•æ¡ï¼ˆé“¶ç™½è‰²é‡‘å±ï¼‰å’Œç©ºæ°”ä¸­çš„æ°§æ°”ã€‚åœ¨å®è§‚è§†å›¾ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°é•æ¡æ”¾ç½®åœ¨ç©ºæ°”ä¸­ã€‚ç‚¹å‡»'å¾®è§‚è§†å›¾'æŒ‰é’®å¯ä»¥æŸ¥çœ‹åŸå­å’Œåˆ†å­çš„åˆå§‹çŠ¶æ€ã€‚",
                equation: "å‡†å¤‡ååº”ç‰©..."
            },
            {
                title: "å®è§‚ç°è±¡ï¼šç‚¹ç‡ƒé•æ¡",
                description: "ç‚¹å‡»'ç‚¹ç‡ƒ'æŒ‰é’®ï¼Œè§‚å¯Ÿé•æ¡åœ¨ç©ºæ°”ä¸­ç‡ƒçƒ§çš„å®è§‚ç°è±¡ã€‚ä½ ä¼šçœ‹åˆ°å‰§çƒˆçš„ç™½å…‰ï¼Œè¿™æ˜¯é•ä¸æ°§æ°”ååº”é‡Šæ”¾å¤§é‡èƒ½é‡çš„è¡¨ç°ã€‚",
                equation: "2Mg + Oâ‚‚ + èƒ½é‡ â†’ ?"
            },
            {
                title: "å¾®è§‚è§†è§’ï¼šåŒ–å­¦é”®æ–­è£‚",
                description: "åˆ‡æ¢åˆ°å¾®è§‚è§†å›¾ã€‚æ°§æ°”åˆ†å­ï¼ˆOâ‚‚ï¼‰ä¸­çš„åŒ–å­¦é”®å’Œé•åŸå­ä¹‹é—´çš„é‡‘å±é”®åœ¨èƒ½é‡ä½œç”¨ä¸‹æ–­è£‚ã€‚æ³¨æ„è§‚å¯ŸåŒ–å­¦é”®ï¼ˆç°è‰²çŸ­çº¿ï¼‰çš„æ–­è£‚è¿‡ç¨‹ã€‚",
                equation: "2Mg + Oâ‚‚ â†’ 2Mg + 2O (åŸå­)"
            },
            {
                title: "å¾®è§‚è§†è§’ï¼šåŸå­é‡ç»„",
                description: "è‡ªç”±çš„é•åŸå­å’Œæ°§åŸå­é‡æ–°ç»„åˆï¼Œå½¢æˆæ–°çš„åŒ–å­¦é”®ï¼Œç”Ÿæˆæ°§åŒ–é•ï¼ˆMgOï¼‰ã€‚æ³¨æ„åŸå­ç§»åŠ¨çš„è·¯å¾„å’Œæ–°é”®çš„å½¢æˆã€‚",
                equation: "2Mg + 2O â†’ 2MgO"
            },
            {
                title: "æ€»ç»“ä¸åŒ–å­¦æ–¹ç¨‹å¼",
                description: "ååº”å®Œæˆï¼é•ä¸æ°§æ°”ååº”ç”Ÿæˆæ°§åŒ–é•ï¼ŒåŒæ—¶é‡Šæ”¾å¤§é‡èƒ½é‡ï¼ˆä»¥å…‰å’Œçƒ­çš„å½¢å¼ï¼‰ã€‚è¿™å°±æ˜¯é•æ¡ç‡ƒçƒ§å‘å‡ºå‰§çƒˆç™½å…‰çš„åŸå› ã€‚",
                equation: "2Mg + Oâ‚‚ â†’ 2MgO + èƒ½é‡ï¼ˆå…‰ä¸çƒ­ï¼‰"
            }
        ];
        
        // å¾®è§‚å…ƒç´ å®šä¹‰
        const microElements = {
            mgAtoms: [],
            o2Molecules: [],
            freeOAtoms: [],
            mgoMolecules: [],
            bonds: []
        };
        
        // å®è§‚å…ƒç´ å®šä¹‰
        const macroElements = {
            magnesiumStrip: {
                x: 0,
                y: 0,
                width: 0,
                height: 0,
                color: '#e0e0e0'
            },
            flames: [],
            lightEffects: []
        };
        
        // åˆå§‹åŒ–å¾®è§‚å…ƒç´ 
        function initMicroElements() {
            microElements.mgAtoms = [];
            microElements.o2Molecules = [];
            microElements.freeOAtoms = [];
            microElements.mgoMolecules = [];
            microElements.bonds = [];
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            // åˆ›å»ºé•åŸå­ï¼ˆå·¦ä¾§ï¼‰
            for (let i = 0; i < 4; i++) {
                microElements.mgAtoms.push({
                    x: centerX - 150 + i * 40,
                    y: centerY,
                    radius: 12,
                    color: '#cccccc',
                    targetX: centerX - 150 + i * 40,
                    targetY: centerY,
                    isMoving: false,
                    type: 'mg'
                });
            }
            
            // åˆ›å»ºæ°§æ°”åˆ†å­ï¼ˆå³ä¾§ï¼‰
            for (let i = 0; i < 2; i++) {
                const o2X = centerX + 100 + i * 80;
                const o2Y = centerY;
                
                microElements.o2Molecules.push({
                    x: o2X,
                    y: o2Y,
                    atoms: [
                        {x: o2X - 8, y: o2Y, radius: 10, color: '#ff3333', type: 'o'},
                        {x: o2X + 8, y: o2Y, radius: 10, color: '#ff3333', type: 'o'}
                    ],
                    bondLength: 16,
                    isBondBroken: false
                });
                
                // æ·»åŠ åŒ–å­¦é”®
                microElements.bonds.push({
                    x1: o2X - 8,
                    y1: o2Y,
                    x2: o2X + 8,
                    y2: o2Y,
                    width: 3,
                    color: '#555555',
                    isVisible: true
                });
            }
        }
        
        // åˆå§‹åŒ–å®è§‚å…ƒç´ 
        function initMacroElements() {
            macroElements.magnesiumStrip = {
                x: canvas.width / 2 - 100,
                y: canvas.height / 2 - 15,
                width: 200,
                height: 30,
                color: '#e0e0e0'
            };
            
            macroElements.flames = [];
            macroElements.lightEffects = [];
        }
        
        // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
        function updateStepIndicator() {
            const steps = document.querySelectorAll('.step');
            steps.forEach((step, index) => {
                if (index === animationState.currentStep) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            });
        }
        
        // æ›´æ–°ä¿¡æ¯é¢æ¿
        function updateInfoPanel() {
            const step = stepInfo[animationState.currentStep];
            infoText.innerHTML = `
                <p><strong>å½“å‰æ­¥éª¤ï¼š</strong> ${step.title}</p>
                <p><strong>è¯´æ˜ï¼š</strong> ${step.description}</p>
            `;
            
            // é«˜äº®æ–¹ç¨‹å¼çš„ä¸åŒéƒ¨åˆ†
            let eqHTML = step.equation;
            if (animationState.currentStep === 4) {
                eqHTML = eqHTML.replace(/(2Mg)/g, '<span class="highlight">$1</span>')
                              .replace(/(Oâ‚‚)/g, '<span class="highlight">$1</span>')
                              .replace(/(2MgO)/g, '<span class="highlight">$1</span>');
            }
            equation.innerHTML = eqHTML;
        }
        
        // ç»˜åˆ¶å¾®è§‚åœºæ™¯
        function drawMicroScene() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶èƒŒæ™¯
            ctx.fillStyle = '#1a2734';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶æ ‡é¢˜
            ctx.fillStyle = '#4a9eff';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('å¾®è§‚è§†å›¾ï¼šåŸå­ä¸åˆ†å­çš„ååº”', canvas.width / 2, 40);
            
            // ç»˜åˆ¶ååº”ç‰©æ ‡ç­¾
            ctx.fillStyle = '#a0d2ff';
            ctx.font = '16px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('ååº”ç‰©', canvas.width / 2 - 200, 80);
            ctx.textAlign = 'right';
            ctx.fillText('ç”Ÿæˆç‰©', canvas.width / 2 + 200, 80);
            ctx.textAlign = 'center';
            
            // ç»˜åˆ¶åŒ–å­¦é”®
            microElements.bonds.forEach(bond => {
                if (bond.isVisible) {
                    ctx.beginPath();
                    ctx.moveTo(bond.x1, bond.y1);
                    ctx.lineTo(bond.x2, bond.y2);
                    ctx.strokeStyle = bond.color;
                    ctx.lineWidth = bond.width;
                    ctx.stroke();
                }
            });
            
            // ç»˜åˆ¶é•åŸå­
            microElements.mgAtoms.forEach(atom => {
                // ç»˜åˆ¶åŸå­
                const gradient = ctx.createRadialGradient(
                    atom.x, atom.y, 0,
                    atom.x, atom.y, atom.radius
                );
                gradient.addColorStop(0, '#ffffff');
                gradient.addColorStop(1, atom.color);
                
                ctx.beginPath();
                ctx.arc(atom.x, atom.y, atom.radius, 0, Math.PI * 2);
                ctx.fillStyle = gradient;
                ctx.fill();
                
                // ç»˜åˆ¶åŸå­ç¬¦å·
                ctx.fillStyle = '#333';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('Mg', atom.x, atom.y);
            });
            
            // ç»˜åˆ¶æ°§æ°”åˆ†å­å’Œè‡ªç”±æ°§åŸå­
            microElements.o2Molecules.forEach(molecule => {
                molecule.atoms.forEach(atom => {
                    const gradient = ctx.createRadialGradient(
                        atom.x, atom.y, 0,
                        atom.x, atom.y, atom.radius
                    );
                    gradient.addColorStop(0, '#ffffff');
                    gradient.addColorStop(1, atom.color);
                    
                    ctx.beginPath();
                    ctx.arc(atom.x, atom.y, atom.radius, 0, Math.PI * 2);
                    ctx.fillStyle = gradient;
                    ctx.fill();
                    
                    ctx.fillStyle = '#333';
                    ctx.font = 'bold 12px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('O', atom.x, atom.y);
                });
            });
            
            // ç»˜åˆ¶è‡ªç”±æ°§åŸå­
            microElements.freeOAtoms.forEach(atom => {
                const gradient = ctx.createRadialGradient(
                    atom.x, atom.y, 0,
                    atom.x, atom.y, atom.radius
                );
                gradient.addColorStop(0, '#ffffff');
                gradient.addColorStop(1, atom.color);
                
                ctx.beginPath();
                ctx.arc(atom.x, atom.y, atom.radius, 0, Math.PI * 2);
                ctx.fillStyle = gradient;
                ctx.fill();
                
                ctx.fillStyle = '#333';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('O', atom.x, atom.y);
            });
            
            // ç»˜åˆ¶æ°§åŒ–é•åˆ†å­
            microElements.mgoMolecules.forEach(molecule => {
                // ç»˜åˆ¶é•åŸå­
                const mgGradient = ctx.createRadialGradient(
                    molecule.mg.x, molecule.mg.y, 0,
                    molecule.mg.x, molecule.mg.y, molecule.mg.radius
                );
                mgGradient.addColorStop(0, '#ffffff');
                mgGradient.addColorStop(1, molecule.mg.color);
                
                ctx.beginPath();
                ctx.arc(molecule.mg.x, molecule.mg.y, molecule.mg.radius, 0, Math.PI * 2);
                ctx.fillStyle = mgGradient;
                ctx.fill();
                
                ctx.fillStyle = '#333';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('Mg', molecule.mg.x, molecule.mg.y);
                
                // ç»˜åˆ¶æ°§åŸå­
                const oGradient = ctx.createRadialGradient(
                    molecule.o.x, molecule.o.y, 0,
                    molecule.o.x, molecule.o.y, molecule.o.radius
                );
                oGradient.addColorStop(0, '#ffffff');
                oGradient.addColorStop(1, molecule.o.color);
                
                ctx.beginPath();
                ctx.arc(molecule.o.x, molecule.o.y, molecule.o.radius, 0, Math.PI * 2);
                ctx.fillStyle = oGradient;
                ctx.fill();
                
                ctx.fillStyle = '#333';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('O', molecule.o.x, molecule.o.y);
                
                // ç»˜åˆ¶åŒ–å­¦é”®
                if (molecule.bondVisible) {
                    ctx.beginPath();
                    ctx.moveTo(molecule.mg.x, molecule.mg.y);
                    ctx.lineTo(molecule.o.x, molecule.o.y);
                    ctx.strokeStyle = '#4CAF50';
                    ctx.lineWidth = 3;
                    ctx.stroke();
                }
            });
            
            // ç»˜åˆ¶ååº”è¿›åº¦ç®­å¤´
            if (animationState.reactionProgress > 0) {
                ctx.strokeStyle = '#4a9eff';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(canvas.width / 2 - 50, canvas.height / 2);
                ctx.lineTo(canvas.width / 2 + 50, canvas.height / 2);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // ç»˜åˆ¶ç®­å¤´
                ctx.fillStyle = '#4a9eff';
                ctx.beginPath();
                ctx.moveTo(canvas.width / 2 + 50, canvas.height / 2);
                ctx.lineTo(canvas.width / 2 + 40, canvas.height / 2 - 5);
                ctx.lineTo(canvas.width / 2 + 40, canvas.height / 2 + 5);
                ctx.closePath();
                ctx.fill();
            }
        }
        
        // ç»˜åˆ¶å®è§‚åœºæ™¯
        function drawMacroScene() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶èƒŒæ™¯
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#0a1929');
            gradient.addColorStop(1, '#1a2734');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶æ ‡é¢˜
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('å®è§‚è§†å›¾ï¼šé•æ¡åœ¨ç©ºæ°”ä¸­ç‡ƒçƒ§', canvas.width / 2, 40);
            
            // ç»˜åˆ¶å®éªŒå°
            ctx.fillStyle = '#3a2c1a';
            ctx.fillRect(0, canvas.height - 100, canvas.width, 100);
            
            // ç»˜åˆ¶å®éªŒå°çº¹ç†
            ctx.strokeStyle = '#2a1c0a';
            ctx.lineWidth = 2;
            for (let i = 0; i < canvas.width; i += 20) {
                ctx.beginPath();
                ctx.moveTo(i, canvas.height - 100);
                ctx.lineTo(i, canvas.height);
                ctx.stroke();
            }
            
            // ç»˜åˆ¶é•æ¡
            const mg = macroElements.magnesiumStrip;
            
            // é‡‘å±å…‰æ³½æ•ˆæœ
            const mgGradient = ctx.createLinearGradient(mg.x, mg.y, mg.x, mg.y + mg.height);
            mgGradient.addColorStop(0, '#ffffff');
            mgGradient.addColorStop(0.3, mg.color);
            mgGradient.addColorStop(0.7, mg.color);
            mgGradient.addColorStop(1, '#a0a0a0');
            
            ctx.fillStyle = mgGradient;
            ctx.fillRect(mg.x, mg.y, mg.width, mg.height);
            
            // é•æ¡é«˜å…‰
            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.fillRect(mg.x + 5, mg.y + 5, mg.width - 10, 8);
            
            // ç»˜åˆ¶ç‡ƒçƒ§æ•ˆæœ
            if (animationState.isReactionStarted && animationState.reactionProgress > 0) {
                // è®¡ç®—ç‡ƒçƒ§å¼ºåº¦
                const intensity = Math.sin(Date.now() / 100) * 0.3 + 0.7;
                
                // ç»˜åˆ¶ç™½å…‰æ ¸å¿ƒ
                const lightGradient = ctx.createRadialGradient(
                    mg.x + mg.width / 2, mg.y, 0,
                    mg.x + mg.width / 2, mg.y, 100 * intensity
                );
                lightGradient.addColorStop(0, 'rgba(255, 255, 255, 0.9)');
                lightGradient.addColorStop(0.3, 'rgba(255, 255, 153, 0.7)');
                lightGradient.addColorStop(0.6, 'rgba(255, 204, 102, 0.4)');
                lightGradient.addColorStop(1, 'rgba(255, 153, 51, 0)');
                
                ctx.fillStyle = lightGradient;
                ctx.beginPath();
                ctx.arc(mg.x + mg.width / 2, mg.y, 100 * intensity, 0, Math.PI * 2);
                ctx.fill();
                
                // ç»˜åˆ¶ç«èŠ±
                const now = Date.now();
                if (now % 100 < 20) {
                    for (let i = 0; i < 5; i++) {
                        const angle = Math.random() * Math.PI * 2;
                        const distance = 50 + Math.random() * 50;
                        const sparkX = mg.x + mg.width / 2 + Math.cos(angle) * distance;
                        const sparkY = mg.y + Math.sin(angle) * distance;
                        
                        ctx.beginPath();
                        ctx.arc(sparkX, sparkY, 2 + Math.random() * 3, 0, Math.PI * 2);
                        ctx.fillStyle = `rgba(255, ${200 + Math.random() * 55}, 0, 0.8)`;
                        ctx.fill();
                    }
                }
                
                // æ·»åŠ å…‰æ™•æ•ˆæœåˆ°æ•´ä¸ªåœºæ™¯
                ctx.fillStyle = 'rgba(255, 255, 200, 0.05)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            
            // ç»˜åˆ¶æ ‡ç­¾
            ctx.fillStyle = '#a0d2ff';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('é•æ¡ (Mg)', mg.x + mg.width / 2, mg.y + mg.height + 25);
            
            if (!animationState.isReactionStarted) {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                ctx.font = 'italic 14px Arial';
                ctx.fillText('ç‚¹å‡»"ç‚¹ç‡ƒ"æŒ‰é’®å¼€å§‹ååº”', canvas.width / 2, canvas.height - 40);
            }
        }
        
        // å¾®è§‚ååº”åŠ¨ç”»
        function animateMicroReaction(timestamp) {
            if (!animationState.lastTimestamp) {
                animationState.lastTimestamp = timestamp;
            }
            
            const deltaTime = timestamp - animationState.lastTimestamp;
            animationState.lastTimestamp = timestamp;
            
            if (animationState.isPaused) {
                animationState.animationFrameId = requestAnimationFrame(animateMicroReaction);
                drawMicroScene();
                return;
            }
            
            // æ›´æ–°ååº”è¿›åº¦
            if (animationState.isReactionStarted && animationState.reactionProgress < 1) {
                animationState.reactionProgress += deltaTime / 3000; // 3ç§’å®Œæˆååº”
                if (animationState.reactionProgress > 1) {
                    animationState.reactionProgress = 1;
                }
            }
            
            // æ ¹æ®ååº”è¿›åº¦æ›´æ–°å¾®è§‚å…ƒç´ 
            const progress = animationState.reactionProgress;
            
            // é˜¶æ®µ1: åŒ–å­¦é”®æ–­è£‚ (0-0.3)
            if (progress > 0 && progress <= 0.3) {
                const bondBreakProgress = progress / 0.3;
                
                // æ°§æ°”åˆ†å­åŒ–å­¦é”®æ–­è£‚
                microElements.o2Molecules.forEach((molecule, index) => {
                    if (!molecule.isBondBroken) {
                        // æ›´æ–°åŸå­ä½ç½®ï¼ˆç¨å¾®åˆ†å¼€ï¼‰
                        molecule.atoms[0].x = molecule.x - 8 - bondBreakProgress * 20;
                        molecule.atoms[1].x = molecule.x + 8 + bondBreakProgress * 20;
                        
                        // æ›´æ–°åŒ–å­¦é”®
                        if (microElements.bonds[index]) {
                            microElements.bonds[index].x1 = molecule.atoms[0].x;
                            microElements.bonds[index].x2 = molecule.atoms[1].x;
                            microElements.bonds[index].width = 3 * (1 - bondBreakProgress);
                        }
                        
                        if (bondBreakProgress >= 1) {
                            molecule.isBondBroken = true;
                            // å°†æ°§åŸå­æ·»åŠ åˆ°è‡ªç”±åŸå­åˆ—è¡¨
                            microElements.freeOAtoms.push(
                                {...molecule.atoms[0], targetX: canvas.width / 2 - 30, targetY: canvas.height / 2},
                                {...molecule.atoms[1], targetX: canvas.width / 2 + 30, targetY: canvas.height / 2}
                            );
                        }
                    }
                });
            }
            
            // é˜¶æ®µ2: åŸå­ç§»åŠ¨å’Œé‡ç»„ (0.3-0.8)
            if (progress > 0.3 && progress <= 0.8) {
                const moveProgress = (progress - 0.3) / 0.5;
                
                // é•åŸå­ç§»åŠ¨
                microElements.mgAtoms.forEach((atom, index) => {
                    atom.targetX = canvas.width / 2 - 60 + (index % 2) * 40;
                    atom.targetY = canvas.height / 2 - 20 + Math.floor(index / 2) * 40;
                    
                    atom.x += (atom.targetX - atom.x) * 0.05;
                    atom.y += (atom.targetY - atom.y) * 0.05;
                });
                
                // è‡ªç”±æ°§åŸå­ç§»åŠ¨
                microElements.freeOAtoms.forEach((atom, index) => {
                    atom.x += (atom.targetX - atom.x) * 0.05;
                    atom.y += (atom.targetY - atom.y) * 0.05;
                });
            }
            
            // é˜¶æ®µ3: å½¢æˆæ°§åŒ–é• (0.8-1)
            if (progress > 0.8 && progress <= 1) {
                const formationProgress = (progress - 0.8) / 0.2;
                
                // åˆ›å»ºæ°§åŒ–é•åˆ†å­ï¼ˆå¦‚æœå°šæœªåˆ›å»ºï¼‰
                if (microElements.mgoMolecules.length === 0) {
                    for (let i = 0; i < 4; i++) {
                        const row = Math.floor(i / 2);
                        const col = i % 2;
                        
                        microElements.mgoMolecules.push({
                            mg: {
                                x: canvas.width / 2 + 100 + col * 80,
                                y: canvas.height / 2 - 40 + row * 80,
                                radius: 12,
                                color: '#cccccc',
                                type: 'mg'
                            },
                            o: {
                                x: canvas.width / 2 + 100 + col * 80 + 20,
                                y: canvas.height / 2 - 40 + row * 80,
                                radius: 10,
                                color: '#ff3333',
                                type: 'o'
                            },
                            bondVisible: false
                        });
                    }
                }
                
                // åŠ¨ç”»æ˜¾ç¤ºæ°§åŒ–é•åˆ†å­
                microElements.mgoMolecules.forEach(molecule => {
                    molecule.bondVisible = formationProgress > 0.5;
                    
                    // æ¸å˜åŠ¨ç”»
                    if (formationProgress < 1) {
                        molecule.mg.color = `rgb(${Math.floor(204 + 51 * formationProgress)}, ${Math.floor(204 + 51 * formationProgress)}, ${Math.floor(204 + 51 * formationProgress)})`;
                        molecule.o.color = `rgb(${Math.floor(255 - 102 * formationProgress)}, ${Math.floor(51 + 102 * formationProgress)}, ${Math.floor(51 + 102 * formationProgress)})`;
                    }
                });
            }
            
            drawMicroScene();
            
            if (animationState.isReactionStarted && animationState.reactionProgress < 1) {
                animationState.animationFrameId = requestAnimationFrame(animateMicroReaction);
            }
        }
        
        // å®è§‚ç‡ƒçƒ§åŠ¨ç”»
        function animateMacroReaction(timestamp) {
            if (!animationState.lastTimestamp) {
                animationState.lastTimestamp = timestamp;
            }
            
            const deltaTime = timestamp - animationState.lastTimestamp;
            animationState.lastTimestamp = timestamp;
            
            if (animationState.isPaused) {
                animationState.animationFrameId = requestAnimationFrame(animateMacroReaction);
                drawMacroScene();
                return;
            }
            
            // æ›´æ–°ååº”è¿›åº¦
            if (animationState.isReactionStarted && animationState.reactionProgress < 1) {
                animationState.reactionProgress += deltaTime / 2000; // 2ç§’å®Œæˆå®è§‚ååº”
                if (animationState.reactionProgress > 1) {
                    animationState.reactionProgress = 1;
                }
            }
            
            drawMacroScene();
            
            if (animationState.isReactionStarted && animationState.reactionProgress < 1) {
                animationState.animationFrameId = requestAnimationFrame(animateMacroReaction);
            }
        }
        
        // ä¸»åŠ¨ç”»å¾ªç¯
        function animate(timestamp) {
            if (animationState.isMacroView) {
                animateMacroReaction(timestamp);
            } else {
                animateMicroReaction(timestamp);
            }
        }
        
        // å¼€å§‹åŠ¨ç”»
        function startAnimation() {
            if (animationState.animationFrameId) {
                cancelAnimationFrame(animationState.animationFrameId);
            }
            animationState.lastTimestamp = 0;
            animationState.animationFrameId = requestAnimationFrame(animate);
        }
        
        // äº‹ä»¶å¤„ç†å‡½æ•°
        function goToStep(step) {
            if (step >= 0 && step < animationState.totalSteps) {
                animationState.currentStep = step;
                
                // æ ¹æ®æ­¥éª¤æ›´æ–°çŠ¶æ€
                if (step === 1 || step === 2 || step === 3) {
                    if (!animationState.isReactionStarted) {
                        animationState.isReactionStarted = true;
                        animationState.reactionProgress = 0;
                    }
                }
                
                if (step === 2 || step === 3) {
                    animationState.isMacroView = false;
                    document.getElementById('macroViewBtn').classList.remove('active');
                    document.getElementById('microViewBtn').classList.add('active');
                } else if (step === 1) {
                    animationState.isMacroView = true;
                    document.getElementById('macroViewBtn').classList.add('active');
                    document.getElementById('microViewBtn').classList.remove('active');
                }
                
                updateStepIndicator();
                updateInfoPanel();
                startAnimation();
            }
        }

<!--æ£€æµ‹åˆ°ä»£ç æˆªæ–­ï¼Œè‡ªåŠ¨ç»­å†™ä¸­...-->
function nextStep() {
    if (animationState.currentStep < animationState.totalSteps - 1) {
        goToStep(animationState.currentStep + 1);
    }
}

function prevStep() {
    if (animationState.currentStep > 0) {
        goToStep(animationState.currentStep - 1);
    }
}

function startReaction() {
    if (!animationState.isReactionStarted) {
        animationState.isReactionStarted = true;
        animationState.reactionProgress = 0;
        animationState.isPaused = false;
        
        // å¦‚æœå½“å‰åœ¨æ­¥éª¤0ï¼Œè‡ªåŠ¨è·³åˆ°æ­¥éª¤1
        if (animationState.currentStep === 0) {
            goToStep(1);
        } else {
            startAnimation();
        }
        
        document.getElementById('startBtn').disabled = true;
        document.getElementById('pauseBtn').textContent = 'â¸ï¸ æš‚åœ';
    }
}

function togglePause() {
    animationState.isPaused = !animationState.isPaused;
    document.getElementById('pauseBtn').textContent = animationState.isPaused ? 'â–¶ï¸ ç»§ç»­' : 'â¸ï¸ æš‚åœ';
    
    if (!animationState.isPaused) {
        startAnimation();
    }
}

function resetAnimation() {
    // åœæ­¢å½“å‰åŠ¨ç”»
    if (animationState.animationFrameId) {
        cancelAnimationFrame(animationState.animationFrameId);
        animationState.animationFrameId = null;
    }
    
    // é‡ç½®çŠ¶æ€
    animationState.currentStep = 0;
    animationState.isReactionStarted = false;
    animationState.isPaused = false;
    animationState.reactionProgress = 0;
    animationState.isMacroView = true;
    
    // é‡æ–°åˆå§‹åŒ–å…ƒç´ 
    initMicroElements();
    initMacroElements();
    
    // æ›´æ–°UI
    updateStepIndicator();
    updateInfoPanel();
    document.getElementById('startBtn').disabled = false;
    document.getElementById('pauseBtn').textContent = 'â¸ï¸ æš‚åœ';
    document.getElementById('macroViewBtn').classList.add('active');
    document.getElementById('microViewBtn').classList.remove('active');
    
    // ç»˜åˆ¶åˆå§‹åœºæ™¯
    drawMacroScene();
}

function switchToMacroView() {
    animationState.isMacroView = true;
    document.getElementById('macroViewBtn').classList.add('active');
    document.getElementById('microViewBtn').classList.remove('active');
    startAnimation();
}

function switchToMicroView() {
    animationState.isMacroView = false;
    document.getElementById('macroViewBtn').classList.remove('active');
    document.getElementById('microViewBtn').classList.add('active');
    startAnimation();
}

// Canvasé¼ æ ‡äº¤äº’
canvas.addEventListener('mousemove', function(event) {
    const rect = canvas.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const y = event.clientY - rect.top;
    
    let tooltipText = '';
    
    if (!animationState.isMacroView) {
        // æ£€æŸ¥é•åŸå­
        microElements.mgAtoms.forEach(atom => {
            const distance = Math.sqrt((x - atom.x) ** 2 + (y - atom.y) ** 2);
            if (distance <= atom.radius) {
                tooltipText = 'é•åŸå­ (Mg)';
            }
        });
        
        // æ£€æŸ¥æ°§æ°”åˆ†å­
        microElements.o2Molecules.forEach(molecule => {
            molecule.atoms.forEach(atom => {
                const distance = Math.sqrt((x - atom.x) ** 2 + (y - atom.y) ** 2);
                if (distance <= atom.radius) {
                    tooltipText = 'æ°§åŸå­ (O) - æ°§æ°”åˆ†å­(Oâ‚‚)çš„ä¸€éƒ¨åˆ†';
                }
            });
        });
        
        // æ£€æŸ¥è‡ªç”±æ°§åŸå­
        microElements.freeOAtoms.forEach(atom => {
            const distance = Math.sqrt((x - atom.x) ** 2 + (y - atom.y) ** 2);
            if (distance <= atom.radius) {
                tooltipText = 'è‡ªç”±æ°§åŸå­ (O)';
            }
        });
        
        // æ£€æŸ¥æ°§åŒ–é•
        microElements.mgoMolecules.forEach(molecule => {
            const distanceMg = Math.sqrt((x - molecule.mg.x) ** 2 + (y - molecule.mg.y) ** 2);
            const distanceO = Math.sqrt((x - molecule.o.x) ** 2 + (y - molecule.o.y) ** 2);
            
            if (distanceMg <= molecule.mg.radius) {
                tooltipText = 'é•åŸå­ (Mg) - æ°§åŒ–é•(MgO)çš„ä¸€éƒ¨åˆ†';
            } else if (distanceO <= molecule.o.radius) {
                tooltipText = 'æ°§åŸå­ (O) - æ°§åŒ–é•(MgO)çš„ä¸€éƒ¨åˆ†';
            }
        });
    } else {
        // å®è§‚è§†å›¾ä¸­çš„äº¤äº’
        const mg = macroElements.magnesiumStrip;
        if (x >= mg.x && x <= mg.x + mg.width && 
            y >= mg.y && y <= mg.y + mg.height) {
            tooltipText = 'é•æ¡ (Mg) - é“¶ç™½è‰²é‡‘å±';
        }
    }
    
    if (tooltipText) {
        tooltip.textContent = tooltipText;
        tooltip.style.left = (event.clientX + 15) + 'px';
        tooltip.style.top = (event.clientY + 15) + 'px';
        tooltip.style.opacity = '1';
    } else {
        tooltip.style.opacity = '0';
    }
});

canvas.addEventListener('mouseleave', function() {
    tooltip.style.opacity = '0';
});

// æŒ‰é’®äº‹ä»¶ç›‘å¬
document.getElementById('nextBtn').addEventListener('click', nextStep);
document.getElementById('prevBtn').addEventListener('click', prevStep);
document.getElementById('startBtn').addEventListener('click', startReaction);
document.getElementById('pauseBtn').addEventListener('click', togglePause);
document.getElementById('resetBtn').addEventListener('click', resetAnimation);
document.getElementById('macroViewBtn').addEventListener('click', switchToMacroView);
document.getElementById('microViewBtn').addEventListener('click', switchToMicroView);

// é”®ç›˜å¿«æ·é”®
document.addEventListener('keydown', function(event) {
    switch(event.key) {
        case 'ArrowRight':
        case ' ':
            if (event.target === document.body) {
                event.preventDefault();
                nextStep();
            }
            break;
        case 'ArrowLeft':
            if (event.target === document.body) {
                event.preventDefault();
                prevStep();
            }
            break;
        case 'r':
        case 'R':
            if (event.target === document.body) {
                resetAnimation();
            }
            break;
        case 'p':
        case 'P':
            if (event.target === document.body) {
                togglePause();
            }
            break;
    }
});

// åˆå§‹åŒ–
function init() {
    initMicroElements();
    initMacroElements();
    updateStepIndicator();
    updateInfoPanel();
    drawMacroScene();
    
    // è®¾ç½®åˆå§‹è§†å›¾æŒ‰é’®çŠ¶æ€
    document.getElementById('macroViewBtn').classList.add('active');
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
window.addEventListener('load', init);

// åˆå§‹ç»˜åˆ¶
drawMacroScene();
</script>
</body>
</html>