<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…¸ç¢±ä¸­å’Œååº”å¾®è§‚æœ¬è´¨åŠ¨ç”» | Hâº + OHâ» â†’ Hâ‚‚O</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a3a 0%, #0f1a2f 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
            max-width: 900px;
            width: 100%;
        }

        h1 {
            color: #ffffff;
            margin-bottom: 10px;
            font-size: 2.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .subtitle {
            font-size: 1.2rem;
            color: #88C1E3;
            margin-bottom: 15px;
        }

        .equation {
            font-size: 2.8rem;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px 30px;
            border-radius: 12px;
            display: inline-block;
            margin: 15px 0;
            border: 2px solid rgba(136, 193, 227, 0.3);
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            max-width: 1200px;
            width: 100%;
            justify-content: center;
        }

        .canvas-container {
            flex: 1;
            min-width: 600px;
            background-color: rgba(15, 26, 47, 0.8);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            flex-direction: column;
        }

        .canvas-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .view-toggle {
            display: flex;
            gap: 10px;
        }

        .view-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .view-btn.active {
            background: #2A5CFF;
            color: white;
            font-weight: bold;
        }

        .view-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.2);
        }

        canvas {
            background-color: rgba(15, 26, 47, 0.9);
            border-radius: 12px;
            width: 100%;
            flex-grow: 1;
            display: block;
            cursor: pointer;
        }

        .controls-container {
            width: 350px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 22px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .panel h2 {
            color: #88C1E3;
            margin-bottom: 18px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel h2 i {
            font-size: 1.2rem;
        }

        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
            min-width: 120px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2A5CFF 0%, #1a4ae0 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #3a6cff 0%, #2a5af0 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(42, 92, 255, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #FF375B 0%, #e01a40 100%);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #FF476B 0%, #f02a50 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 55, 91, 0.4);
        }

        .toggle-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .toggle-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .toggle-item:last-child {
            border-bottom: none;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ion-preview {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
        }

        .h-plus-preview {
            background: radial-gradient(circle at 30% 30%, #FF375B, #b30024);
            box-shadow: 0 0 10px #FF375B;
        }

        .oh-minus-preview {
            background: radial-gradient(circle at 30% 30%, #2A5CFF, #0a2a9e);
            box-shadow: 0 0 10px #2A5CFF;
        }

        .water-preview {
            width: 30px;
            height: 20px;
            background: #88C1E3;
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 54px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.2);
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #2A5CFF;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .stat-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: bold;
            margin: 5px 0;
        }

        .h-plus-stat {
            color: #FF375B;
            text-shadow: 0 0 8px rgba(255, 55, 91, 0.5);
        }

        .oh-minus-stat {
            color: #2A5CFF;
            text-shadow: 0 0 8px rgba(42, 92, 255, 0.5);
        }

        .water-stat {
            color: #88C1E3;
            text-shadow: 0 0 8px rgba(136, 193, 227, 0.5);
            grid-column: span 2;
        }

        .step-info {
            background: rgba(0, 0, 0, 0.2);
            padding: 18px;
            border-radius: 10px;
            border-left: 4px solid #88C1E3;
            margin-top: 10px;
            min-height: 80px;
            display: flex;
            align-items: center;
        }

        .legend {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .footer {
            margin-top: 30px;
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.9rem;
            max-width: 900px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        @media (max-width: 1100px) {
            .container {
                flex-direction: column;
                align-items: center;
            }
            
            .canvas-container, .controls-container {
                width: 100%;
                min-width: unset;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>é…¸ç¢±ä¸­å’Œååº”çš„å¾®è§‚æœ¬è´¨</h1>
        <div class="subtitle">å¯è§†åŒ–æ¢ç´¢æ°¢ç¦»å­ä¸æ°¢æ°§æ ¹ç¦»å­å¦‚ä½•ç»“åˆç”Ÿæˆæ°´åˆ†å­</div>
        <div class="equation">Hâº + OHâ» â†’ Hâ‚‚O</div>
    </div>

    <div class="container">
        <div class="canvas-container">
            <div class="canvas-title">
                <h2>ååº”å¯è§†åŒ–åŒºåŸŸ</h2>
                <div class="view-toggle">
                    <button id="macroViewBtn" class="view-btn">å®è§‚è§†å›¾</button>
                    <button id="microViewBtn" class="view-btn active">å¾®è§‚è§†å›¾</button>
                </div>
            </div>
            <canvas id="reactionCanvas" width="800" height="600"></canvas>
        </div>

        <div class="controls-container">
            <div class="panel">
                <h2>ğŸ¬ åŠ¨ç”»æ§åˆ¶</h2>
                <div class="button-group">
                    <button id="playBtn" class="btn btn-primary">
                        <span>â–¶ï¸ æ’­æ”¾</span>
                    </button>
                    <button id="pauseBtn" class="btn btn-secondary">
                        <span>â¸ï¸ æš‚åœ</span>
                    </button>
                    <button id="resetBtn" class="btn btn-danger">
                        <span>ğŸ”„ é‡ç½®</span>
                    </button>
                </div>
                <div class="button-group">
                    <button id="step1Btn" class="btn btn-secondary">æ­¥éª¤1: åˆå§‹çŠ¶æ€</button>
                    <button id="step2Btn" class="btn btn-secondary">æ­¥éª¤2: ç¦»å­è¿åŠ¨</button>
                    <button id="step3Btn" class="btn btn-secondary">æ­¥éª¤3: ç¢°æ’ç»“åˆ</button>
                    <button id="step4Btn" class="btn btn-secondary">æ­¥éª¤4: ååº”å®Œæˆ</button>
                </div>
                <div class="step-info" id="stepInfo">
                    ç‚¹å‡»"æ’­æ”¾"æŒ‰é’®å¼€å§‹åŠ¨ç”»ï¼Œæˆ–ä½¿ç”¨"æ­¥éª¤æ¼”ç¤º"åˆ†æ­¥å­¦ä¹ ã€‚
                </div>
            </div>

            <div class="panel">
                <h2>ğŸ” ç²’å­æ˜¾ç¤ºæ§åˆ¶</h2>
                <div class="toggle-group">
                    <div class="toggle-item">
                        <div class="toggle-label">
                            <div class="ion-preview h-plus-preview"></div>
                            <span>é«˜äº® Hâº ç¦»å­</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="highlightHPlus">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="toggle-item">
                        <div class="toggle-label">
                            <div class="ion-preview oh-minus-preview"></div>
                            <span>é«˜äº® OHâ» ç¦»å­</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="highlightOHMinus">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="toggle-item">
                        <div class="toggle-label">
                            <div class="ion-preview" style="background: #AAAAAA;"></div>
                            <span>æ˜¾ç¤ºèƒŒæ™¯ç¦»å­ (Naâº, Clâ»)</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="showBackgroundIons" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h2>ğŸ“Š ååº”å®æ—¶æ•°æ®</h2>
                <div class="stats">
                    <div class="stat-item">
                        <div>å‰©ä½™ Hâº</div>
                        <div id="hPlusCount" class="stat-value h-plus-stat">20</div>
                        <div>æ°¢ç¦»å­</div>
                    </div>
                    <div class="stat-item">
                        <div>å‰©ä½™ OHâ»</div>
                        <div id="ohMinusCount" class="stat-value oh-minus-stat">20</div>
                        <div>æ°¢æ°§æ ¹ç¦»å­</div>
                    </div>
                    <div class="stat-item water-stat">
                        <div>å·²ç”Ÿæˆ Hâ‚‚O</div>
                        <div id="waterCount" class="stat-value">0</div>
                        <div>æ°´åˆ†å­</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="legend">
        <div class="legend-item">
            <div class="ion-preview h-plus-preview"></div>
            <span>Hâº æ°¢ç¦»å­ (æ¥è‡ªé…¸)</span>
        </div>
        <div class="legend-item">
            <div class="ion-preview oh-minus-preview"></div>
            <span>OHâ» æ°¢æ°§æ ¹ç¦»å­ (æ¥è‡ªç¢±)</span>
        </div>
        <div class="legend-item">
            <div class="water-preview"></div>
            <span>Hâ‚‚O æ°´åˆ†å­ (ååº”äº§ç‰©)</span>
        </div>
        <div class="legend-item">
            <div class="ion-preview" style="background: #AAAAAA;"></div>
            <span>èƒŒæ™¯ç¦»å­ (Naâº, Clâ»)</span>
        </div>
    </div>

    <div class="footer">
        <p>æ•™å­¦åŠ¨ç”»è®¾è®¡ï¼šé…¸ç¢±ä¸­å’Œååº”å¾®è§‚æœ¬è´¨ | Hâº + OHâ» â†’ Hâ‚‚O | ä½¿ç”¨HTML5 Canvaså®ç°</p>
        <p>æç¤ºï¼šç‚¹å‡»å¾®è§‚è§†å›¾ä¸­çš„ç¦»å­å¯ä»¥æ‰‹åŠ¨è§¦å‘ååº”ï¼Œå°è¯•ç‚¹å‡»ä¸€ä¸ªHâºå’Œä¸€ä¸ªOHâ»ç¦»å­ï¼</p>
    </div>

    <script>
        // è·å–Canvaså’Œä¸Šä¸‹æ–‡
        const canvas = document.getElementById('reactionCanvas');
        const ctx = canvas.getContext('2d');

        // è°ƒæ•´Canvaså¤§å°ä»¥é€‚åº”å®¹å™¨
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight * 0.9;
            initParticles();
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // çŠ¶æ€å˜é‡
        let animationId = null;
        let isPlaying = false;
        let currentStep = 0;
        let isMacroView = false;

        // ç²’å­ç³»ç»Ÿ
        const particles = {
            hPlus: [],    // Hâºç¦»å­
            ohMinus: [],  // OHâ»ç¦»å­
            water: [],    // æ°´åˆ†å­
            background: [] // èƒŒæ™¯ç¦»å­
        };

        // é…ç½®
        const config = {
            totalHParticles: 20,
            totalOHParticles: 20,
            totalBackgroundParticles: 15,
            reactionRadius: 25,
            particleSpeed: 1.5,
            highlightHPlus: false,
            highlightOHMinus: false,
            showBackgroundIons: true
        };

        // æ­¥éª¤è¯´æ˜
        const stepDescriptions = [
            "æ­¥éª¤1: åˆå§‹çŠ¶æ€ - é…¸æº¶æ¶²ä¸­å«æœ‰Hâºç¦»å­ï¼Œç¢±æº¶æ¶²ä¸­å«æœ‰OHâ»ç¦»å­ï¼Œå®ƒä»¬å‡åŒ€åˆ†å¸ƒåœ¨æº¶æ¶²ä¸­ã€‚",
            "æ­¥éª¤2: ç¦»å­è¿åŠ¨ - Hâºå’ŒOHâ»ç¦»å­åœ¨æº¶æ¶²ä¸­åšæ— è§„åˆ™è¿åŠ¨ï¼Œå½“å®ƒä»¬ç›¸äº’é è¿‘æ—¶å¯èƒ½å‘ç”Ÿç¢°æ’ã€‚",
            "æ­¥éª¤3: ç¢°æ’ç»“åˆ - Hâºå’ŒOHâ»ç¦»å­ç¢°æ’åç»“åˆï¼Œå½¢æˆæ°´åˆ†å­(Hâ‚‚O)ã€‚è¿™æ˜¯ä¸€ä¸ªæ”¾çƒ­ååº”ã€‚",
            "æ­¥éª¤4: ååº”å®Œæˆ - å½“æ‰€æœ‰Hâºå’ŒOHâ»ç¦»å­éƒ½ç»“åˆåï¼Œååº”å®Œæˆï¼Œæº¶æ¶²ä¸­åªå‰©ä¸‹æ°´åˆ†å­å’ŒèƒŒæ™¯ç¦»å­ã€‚"
        ];

        // ç²’å­ç±»
        class Particle {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.type = type; // 'hPlus', 'ohMinus', 'water', 'background'
                this.vx = (Math.random() - 0.5) * config.particleSpeed;
                this.vy = (Math.random() - 0.5) * config.particleSpeed;
                this.radius = type === 'water' ? 12 : 10;
                this.active = true;
                this.highlight = false;
                this.pulse = 0;
                this.pulseDirection = 1;
                
                // è®¾ç½®é¢œè‰²
                switch(type) {
                    case 'hPlus':
                        this.color = '#FF375B';
                        this.glowColor = 'rgba(255, 55, 91, 0.7)';
                        break;
                    case 'ohMinus':
                        this.color = '#2A5CFF';
                        this.glowColor = 'rgba(42, 92, 255, 0.7)';
                        break;
                    case 'water':
                        this.color = '#88C1E3';
                        this.glowColor = 'rgba(136, 193, 227, 0.5)';
                        break;
                    default:
                        this.color = '#AAAAAA';
                        this.glowColor = 'rgba(170, 170, 170, 0.3)';
                }
            }

            update() {
                if (!this.active) return;
                
                // æ›´æ–°ä½ç½®
                this.x += this.vx;
                this.y += this.vy;
                
                // è¾¹ç•Œç¢°æ’
                if (this.x < this.radius || this.x > canvas.width - this.radius) {
                    this.vx = -this.vx;
                    this.x = this.x < this.radius ? this.radius : canvas.width - this.radius;
                }
                if (this.y < this.radius || this.y > canvas.height - this.radius) {
                    this.vy = -this.vy;
                    this.y = this.y < this.radius ? this.radius : canvas.height - this.radius;
                }
                
                // æ›´æ–°è„‰å†²æ•ˆæœ
                if (this.highlight) {
                    this.pulse += 0.05 * this.pulseDirection;
                    if (this.pulse > 1 || this.pulse < 0) {
                        this.pulseDirection *= -1;
                    }
                }
            }

            draw() {
                if (!this.active) return;
                
                ctx.save();
                
                // ç»˜åˆ¶å‘å…‰æ•ˆæœ
                if ((this.type === 'hPlus' && config.highlightHPlus) || 
                    (this.type === 'ohMinus' && config.highlightOHMinus) ||
                    this.highlight) {
                    
                    const glowRadius = this.radius + 5 + (this.highlight ? this.pulse * 5 : 0);
                    const gradient = ctx.createRadialGradient(
                        this.x, this.y, 0,
                        this.x, this.y, glowRadius
                    );
                    
                    gradient.addColorStop(0, this.glowColor);
                    gradient.addColorStop(1, 'transparent');
                    
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, glowRadius, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                // ç»˜åˆ¶ç²’å­ä¸»ä½“
                if (this.type === 'water') {
                    // ç»˜åˆ¶æ°´åˆ†å­ï¼ˆæ¤­åœ†å½¢ï¼‰
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.ellipse(this.x, this.y, this.radius, this.radius * 0.7, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // ç»˜åˆ¶æ°´åˆ†å­ä¸­çš„"Hâ‚‚O"æ–‡å­—
                    ctx.fillStyle = '#0F1A2F';
                    ctx.font = 'bold 10px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('Hâ‚‚O', this.x, this.y);
                } else {
                    // ç»˜åˆ¶ç¦»å­ï¼ˆåœ†å½¢ï¼‰
                    const gradient = ctx.createRadialGradient(
                        this.x - this.radius/3, this.y - this.radius/3, 0,
                        this.x, this.y, this.radius
                    );
                    
                    if (this.type === 'hPlus') {
                        gradient.addColorStop(0, '#FF6B8B');
                        gradient.addColorStop(1, '#FF375B');
                    } else if (this.type === 'ohMinus') {
                        gradient.addColorStop(0, '#5A7CFF');
                        gradient.addColorStop(1, '#2A5CFF');
                    } else {
                        gradient.addColorStop(0, '#CCCCCC');
                        gradient.addColorStop(1, '#AAAAAA');
                    }
                    
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // ç»˜åˆ¶ç¦»å­ç¬¦å·
                    ctx.fillStyle = '#FFFFFF';
                    ctx.font = 'bold 12px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    let symbol = '';
                    if (this.type === 'hPlus') symbol = 'Hâº';
                    else if (this.type === 'ohMinus') symbol = 'OHâ»';
                    else if (this.type === 'background') symbol = Math.random() > 0.5 ? 'Naâº' : 'Clâ»';
                    
                    ctx.fillText(symbol, this.x, this.y);
                }
                
                ctx.restore();
            }

            isPointInside(x, y) {
                const distance = Math.sqrt((x - this.x) ** 2 + (y - this.y) ** 2);
                return distance <= this.radius;
            }
        }

        // åˆå§‹åŒ–ç²’å­
        function initParticles() {
            particles.hPlus = [];
            particles.ohMinus = [];
            particles.water = [];
            particles.background = [];
            
            // åˆ›å»ºHâºç¦»å­ï¼ˆå·¦ä¾§åŒºåŸŸï¼‰
            for (let i = 0; i < config.totalHParticles; i++) {
                const x = Math.random() * (canvas.width / 2 - 50) + 30;
                const y = Math.random() * (canvas.height - 60) + 30;
                particles.hPlus.push(new Particle(x, y, 'hPlus'));
            }
            
            // åˆ›å»ºOHâ»ç¦»å­ï¼ˆå³ä¾§åŒºåŸŸï¼‰
            for (let i = 0; i < config.totalOHParticles; i++) {
                const x = Math.random() * (canvas.width / 2 - 50) + canvas.width / 2 + 20;
                const y = Math.random() * (canvas.height - 60) + 30;
                particles.ohMinus.push(new Particle(x, y, 'ohMinus'));
            }
            
            // åˆ›å»ºèƒŒæ™¯ç¦»å­
            for (let i = 0; i < config.totalBackgroundParticles; i++) {
                const x = Math.random() * (canvas.width - 60) + 30;
                const y = Math.random() * (canvas.height - 60) + 30;
                particles.background.push(new Particle(x, y, 'background'));
            }
            
            updateStats();
        }

        // æ£€æŸ¥å¹¶å¤„ç†ååº”
        function checkReactions() {
            for (let i = particles.hPlus.length - 1; i >= 0; i--) {
                const hPlus = particles.hPlus[i];
                if (!hPlus.active) continue;
                
                for (let j = particles.ohMinus.length - 1; j >= 0; j--) {
                    const ohMinus = particles.ohMinus[j];
                    if (!ohMinus.active) continue;
                    
                    const distance = Math.sqrt(
                        (hPlus.x - ohMinus.x) ** 2 + (hPlus.y - ohMinus.y) ** 2
                    );
                    
                    if (distance < config.reactionRadius && isPlaying) {
                        // åˆ›å»ºæ°´åˆ†å­
                        const waterX = (hPlus.x + ohMinus.x) / 2;
                        const waterY = (hPlus.y + ohMinus.y) / 2;
                        particles.water.push(new Particle(waterX, waterY, 'water'));
                        
                        // ç§»é™¤ååº”ç¦»å­
                        hPlus.active = false;
                        ohMinus.active = false;
                        
                        updateStats();
                        break;
                    }
                }
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const activeHPlus = particles.hPlus.filter(p => p.active).length;
            const activeOHMinus = particles.ohMinus.filter(p => p.active).length;
            
            document.getElementById('hPlusCount').textContent = activeHPlus;
            document.getElementById('ohMinusCount').textContent = activeOHMinus;
            document.getElementById('waterCount').textContent = particles.water.length;
        }

        // ç»˜åˆ¶å®è§‚è§†å›¾
        function drawMacroView() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.fillStyle = '#0F1A2F';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶æ ‡é¢˜
            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('é…¸ç¢±ä¸­å’Œååº” - å®è§‚è§†å›¾', canvas.width / 2, 40);
            
            // ç»˜åˆ¶çƒ§æ¯
            const beakerWidth = 150;
            const beakerHeight = 200;
            const leftBeakerX = canvas.width / 4 - beakerWidth / 2;
            const rightBeakerX = canvas.width * 3/4 - beakerWidth / 2;
            const beakerY = canvas.height / 2 - beakerHeight / 2 + 30;
            
            // å·¦çƒ§æ¯ï¼ˆé…¸ï¼‰
            ctx.fillStyle = 'rgba(255, 55, 91, 0.3)';
            ctx.fillRect(leftBeakerX, beakerY, beakerWidth, beakerHeight);
            ctx.strokeStyle = '#FFFFFF';
            ctx.lineWidth = 3;
            ctx.strokeRect(leftBeakerX, beakerY, beakerWidth, beakerHeight);
            
            // å³çƒ§æ¯ï¼ˆç¢±ï¼‰
            ctx.fillStyle = 'rgba(42, 92, 255, 0.3)';
            ctx.fillRect(rightBeakerX, beakerY, beakerWidth, beakerHeight);
            ctx.strokeStyle = '#FFFFFF';
            ctx.strokeRect(rightBeakerX, beakerY, beakerWidth, beakerHeight);
            
            // çƒ§æ¯æ ‡ç­¾
            ctx.fillStyle = '#FF375B';
            ctx.font = 'bold 20px Arial';
            ctx.fillText('HCl æº¶æ¶²', leftBeakerX + beakerWidth / 2, beakerY - 20);
            
            ctx.fillStyle = '#2A5CFF';
            ctx.fillText('NaOH æº¶æ¶²', rightBeakerX + beakerWidth / 2, beakerY - 20);
            
            // ç»˜åˆ¶æ··åˆç®­å¤´
            const arrowY = beakerY + beakerHeight / 2;
            ctx.strokeStyle = '#88C1E3';
            ctx.lineWidth = 5;
            ctx.beginPath();
            ctx.moveTo(leftBeakerX + beakerWidth + 20, arrowY);
            ctx.lineTo(rightBeakerX - 20, arrowY);
            
            // ç®­å¤´å¤´éƒ¨
            ctx.lineTo(rightBeakerX - 40, arrowY - 10);
            ctx.moveTo(rightBeakerX - 20, arrowY);
            ctx.lineTo(rightBeakerX - 40, arrowY + 10);
            ctx.stroke();
            
            // ç»˜åˆ¶ååº”æ–¹ç¨‹å¼
            ctx.fillStyle = '#88C1E3';
            ctx.font = 'bold 32px Arial';
            ctx.fillText('Hâº + OHâ» â†’ Hâ‚‚O', canvas.width / 2, beakerY + beakerHeight + 60);
            
            // ç»˜åˆ¶è¯´æ˜æ–‡å­—
            ctx.fillStyle = '#CCCCCC';
            ctx.font = '16px Arial';
            ctx.fillText('ç‚¹å‡»"å¾®è§‚è§†å›¾"æŒ‰é’®è§‚å¯Ÿç¦»å­çº§åˆ«çš„ååº”è¿‡ç¨‹', canvas.width / 2, canvas.height - 30);
        }

        // ç»˜åˆ¶å¾®è§‚è§†å›¾
        function drawMicroView() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.fillStyle = '#0F1A2F';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶æ ‡é¢˜å’Œç½‘æ ¼
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            ctx.lineWidth = 1;
            
            // ç»˜åˆ¶ç½‘æ ¼çº¿
            const gridSize = 40;
            for (let x = 0; x < canvas.width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            for (let y = 0; y < canvas.height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            
            // ç»˜åˆ¶åŒºåŸŸåˆ†éš”çº¿
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2, 0);
            ctx.lineTo(canvas.width / 2, canvas.height);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // ç»˜åˆ¶åŒºåŸŸæ ‡ç­¾
            ctx.fillStyle = '#FF375B';
            ctx.font = 'bold 18px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('é…¸æº¶æ¶²åŒºåŸŸ (Hâº)', canvas.width / 4, 30);
            
            ctx.fillStyle = '#2A5CFF';
            ctx.fillText('ç¢±æº¶æ¶²åŒºåŸŸ (OHâ»)', canvas.width * 3/4, 30);
            
            // æ›´æ–°å’Œç»˜åˆ¶ç²’å­
            if (isPlaying) {
                checkReactions();
            }
            
            // ç»˜åˆ¶èƒŒæ™¯ç¦»å­
            if (config.showBackgroundIons) {
                particles.background.forEach(p => {
                    p.update();
                    p.draw();
                });
            }
            
            // ç»˜åˆ¶æ°´åˆ†å­
            particles.water.forEach(p => {
                p.update();
                p.draw();
            });
            
            // ç»˜åˆ¶Hâºç¦»å­
            particles.hPlus.forEach(p => {
                p.update();
                p.draw();
            });
            
            // ç»˜åˆ¶OHâ»ç¦»å­
            particles.ohMinus.forEach(p => {
                p.update();
                p.draw();
            });
            
            // ç»˜åˆ¶ååº”æ–¹ç¨‹å¼
            ctx.fillStyle = '#88C1E3';
            ctx.font = 'bold 28px Arial';
            ctx.fillText('Hâº + OHâ» â†’ Hâ‚‚O', canvas.width / 2, canvas.height - 30);
            
            // ç»˜åˆ¶ååº”è¿›åº¦
            const totalReactions = Math.min(config.totalHParticles, config.totalOHParticles);
            const completedReactions = particles.water.length;
            const progress = completedReactions / totalReactions;
            
            if (progress > 0 && progress < 1) {
                ctx.fillStyle = 'rgba(136, 193, 227, 0.2)';
                ctx.fillRect(canvas.width / 2 - 100, canvas.height - 60, 200, 20);
                
                ctx.fillStyle = '#88C1E3';
                ctx.fillRect(canvas.width / 2 - 100, canvas.height - 60, 200 * progress, 20);
                
                ctx.fillStyle = '#FFFFFF';
                ctx.font = '14px Arial';
                ctx.fillText(
                    `ååº”è¿›åº¦: ${Math.round(progress * 100)}%`, 
                    canvas.width / 2, 
                    canvas.height - 48
                );
            }
        }

        // åŠ¨ç”»å¾ªç¯
        function animate() {
            if (isMacroView) {
                drawMacroView();
            } else {
                drawMicroView();
            }
            
            if (isPlaying) {
                animationId = requestAnimationFrame(animate);
            }
        }

        // å¼€å§‹åŠ¨ç”»
        function startAnimation() {
            if (!isPlaying) {
                isPlaying = true;
                document.getElementById('stepInfo').textContent = "åŠ¨ç”»æ’­æ”¾ä¸­: è§‚å¯ŸHâºå’ŒOHâ»ç¦»å­å¦‚ä½•è¿åŠ¨ã€ç¢°æ’å¹¶ç”Ÿæˆæ°´åˆ†å­ã€‚";
                animate();
            }
        }

        // æš‚åœåŠ¨ç”»
        function pauseAnimation() {
            isPlaying = false;
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            document.getElementById('stepInfo').textContent = "åŠ¨ç”»å·²æš‚åœã€‚ç‚¹å‡»æ’­æ”¾ç»§ç»­ï¼Œæˆ–ä½¿ç”¨æ­¥éª¤æ¼”ç¤ºã€‚";
        }

        // é‡ç½®åŠ¨ç”»
        function resetAnimation() {
            pauseAnimation();
            currentStep = 0;
            initParticles();
            document.getElementById('stepInfo').textContent = "å·²é‡ç½®ã€‚ç‚¹å‡»æ’­æ”¾æŒ‰é’®å¼€å§‹åŠ¨ç”»ï¼Œæˆ–ä½¿ç”¨æ­¥éª¤æ¼”ç¤ºã€‚";
            
            if (!isMacroView) {
                animate(); // ç»˜åˆ¶é™æ€è§†å›¾
            }
        }

        // æ­¥éª¤æ¼”ç¤ºå‡½æ•°
        function goToStep(step) {
            currentStep = step;
            pauseAnimation();
            
            // æ ¹æ®æ­¥éª¤è®¾ç½®çŠ¶æ€
            switch(step) {
                case 1: // åˆå§‹çŠ¶æ€
                    resetAnimation();
                    document.getElementById('stepInfo').textContent = stepDescriptions[0];
                    break;
                case 2: // ç¦»å­è¿åŠ¨
                    resetAnimation();
                    isPlaying = true;
                    document.getElementById('stepInfo').textContent = stepDescriptions[1];
                    animate();

<!--æ£€æµ‹åˆ°ä»£ç æˆªæ–­ï¼Œè‡ªåŠ¨ç»­å†™ä¸­...-->
                    setTimeout(() => pauseAnimation(), 2000);
                    break;
                case 3: // ç¢°æ’ç»“åˆ
                    resetAnimation();
                    // è®©ä¸€äº›ç¦»å­é è¿‘ä»¥ä¾¿ç¢°æ’
                    particles.hPlus.forEach((p, i) => {
                        if (i < 8) {
                            p.x = canvas.width / 2 - 50 + i * 10;
                            p.y = canvas.height / 2;
                            p.vx = 1;
                        }
                    });
                    
                    particles.ohMinus.forEach((p, i) => {
                        if (i < 8) {
                            p.x = canvas.width / 2 + 50 - i * 10;
                            p.y = canvas.height / 2;
                            p.vx = -1;
                        }
                    });
                    
                    isPlaying = true;
                    document.getElementById('stepInfo').textContent = stepDescriptions[2];
                    animate();
                    setTimeout(() => pauseAnimation(), 3000);
                    break;
                case 4: // ååº”å®Œæˆ
                    resetAnimation();
                    // æ‰‹åŠ¨è§¦å‘æ‰€æœ‰ååº”
                    particles.hPlus.forEach(p => {
                        if (p.active) {
                            p.active = false;
                            const waterX = p.x;
                            const waterY = p.y;
                            particles.water.push(new Particle(waterX, waterY, 'water'));
                        }
                    });
                    
                    particles.ohMinus.forEach(p => {
                        if (p.active) p.active = false;
                    });
                    
                    updateStats();
                    document.getElementById('stepInfo').textContent = stepDescriptions[3];
                    animate();
                    break;
            }
        }

        // åˆ‡æ¢è§†å›¾
        function switchView(isMacro) {
            isMacroView = isMacro;
            
            if (isMacro) {
                document.getElementById('macroViewBtn').classList.add('active');
                document.getElementById('microViewBtn').classList.remove('active');
                pauseAnimation();
                drawMacroView();
            } else {
                document.getElementById('macroViewBtn').classList.remove('active');
                document.getElementById('microViewBtn').classList.add('active');
                drawMicroView();
            }
        }

        // å¤„ç†Canvasç‚¹å‡»ï¼ˆæ‰‹åŠ¨è§¦å‘ååº”ï¼‰
        canvas.addEventListener('click', function(event) {
            if (isMacroView) {
                // åœ¨å®è§‚è§†å›¾ä¸­ç‚¹å‡»åˆ‡æ¢åˆ°å¾®è§‚è§†å›¾
                switchView(false);
                return;
            }
            
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            // æŸ¥æ‰¾ç‚¹å‡»çš„Hâºç¦»å­
            let clickedHPlus = null;
            for (let i = 0; i < particles.hPlus.length; i++) {
                if (particles.hPlus[i].active && particles.hPlus[i].isPointInside(x, y)) {
                    clickedHPlus = particles.hPlus[i];
                    clickedHPlus.highlight = true;
                    break;
                }
            }
            
            // æŸ¥æ‰¾ç‚¹å‡»çš„OHâ»ç¦»å­
            let clickedOHMinus = null;
            for (let i = 0; i < particles.ohMinus.length; i++) {
                if (particles.ohMinus[i].active && particles.ohMinus[i].isPointInside(x, y)) {
                    clickedOHMinus = particles.ohMinus[i];
                    clickedOHMinus.highlight = true;
                    break;
                }
            }
            
            // å¦‚æœç‚¹å‡»äº†ä¸€ä¸ªHâºå’Œä¸€ä¸ªOHâ»ï¼Œè®©å®ƒä»¬ååº”
            if (clickedHPlus && clickedOHMinus) {
                // åˆ›å»ºæ°´åˆ†å­
                const waterX = (clickedHPlus.x + clickedOHMinus.x) / 2;
                const waterY = (clickedHPlus.y + clickedOHMinus.y) / 2;
                particles.water.push(new Particle(waterX, waterY, 'water'));
                
                // ç§»é™¤ååº”ç¦»å­
                clickedHPlus.active = false;
                clickedOHMinus.active = false;
                
                updateStats();
                
                // ç§»é™¤é«˜äº®æ•ˆæœ
                setTimeout(() => {
                    if (clickedHPlus) clickedHPlus.highlight = false;
                    if (clickedOHMinus) clickedOHMinus.highlight = false;
                }, 1000);
            } else if (clickedHPlus || clickedOHMinus) {
                // å¦‚æœåªç‚¹å‡»äº†ä¸€ä¸ªç¦»å­ï¼Œç¨åç§»é™¤é«˜äº®
                setTimeout(() => {
                    if (clickedHPlus) clickedHPlus.highlight = false;
                    if (clickedOHMinus) clickedOHMinus.highlight = false;
                }, 1000);
            }
        });

        // äº‹ä»¶ç›‘å¬å™¨è®¾ç½®
        document.getElementById('playBtn').addEventListener('click', startAnimation);
        document.getElementById('pauseBtn').addEventListener('click', pauseAnimation);
        document.getElementById('resetBtn').addEventListener('click', resetAnimation);
        
        document.getElementById('step1Btn').addEventListener('click', () => goToStep(1));
        document.getElementById('step2Btn').addEventListener('click', () => goToStep(2));
        document.getElementById('step3Btn').addEventListener('click', () => goToStep(3));
        document.getElementById('step4Btn').addEventListener('click', () => goToStep(4));
        
        document.getElementById('macroViewBtn').addEventListener('click', () => switchView(true));
        document.getElementById('microViewBtn').addEventListener('click', () => switchView(false));
        
        document.getElementById('highlightHPlus').addEventListener('change', function() {
            config.highlightHPlus = this.checked;
        });
        
        document.getElementById('highlightOHMinus').addEventListener('change', function() {
            config.highlightOHMinus = this.checked;
        });
        
        document.getElementById('showBackgroundIons').addEventListener('change', function() {
            config.showBackgroundIons = this.checked;
        });

        // åˆå§‹åŒ–
        initParticles();
        animate(); // åˆå§‹ç»˜åˆ¶

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(event) {
            switch(event.key) {
                case ' ':
                    // ç©ºæ ¼é”®åˆ‡æ¢æ’­æ”¾/æš‚åœ
                    if (isPlaying) {
                        pauseAnimation();
                    } else {
                        startAnimation();
                    }
                    event.preventDefault();
                    break;
                case 'r':
                case 'R':
                    // Ré”®é‡ç½®
                    resetAnimation();
                    break;
                case '1':
                    goToStep(1);
                    break;
                case '2':
                    goToStep(2);
                    break;
                case '3':
                    goToStep(3);
                    break;
                case '4':
                    goToStep(4);
                    break;
            }
        });
    </script>
</body>
</html>