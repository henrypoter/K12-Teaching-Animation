<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å½’å¹¶æ’åºå¯è§†åŒ– - åˆ†æ²»çš„è‰ºæœ¯</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            background-color: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            max-width: 800px;
        }

        h1 {
            color: #5eead4;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(94, 234, 212, 0.3);
        }

        .subtitle {
            color: #94a3b8;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            max-width: 1400px;
            width: 100%;
            justify-content: center;
        }

        .panel {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(94, 234, 212, 0.1);
        }

        .left-panel {
            flex: 1;
            min-width: 500px;
            max-width: 700px;
        }

        .right-panel {
            flex: 1;
            min-width: 500px;
            max-width: 600px;
        }

        .panel-title {
            color: #5eead4;
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(94, 234, 212, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel-title i {
            font-size: 1.2rem;
        }

        .canvas-container {
            position: relative;
            width: 100%;
            height: 400px;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        canvas {
            display: block;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 10px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #5eead4, #2dd4bf);
            color: #0f172a;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(94, 234, 212, 0.4);
        }

        .btn-secondary {
            background: rgba(148, 163, 184, 0.2);
            color: #e2e8f0;
        }

        .btn-secondary:hover {
            background: rgba(148, 163, 184, 0.3);
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .input-section {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 10px;
        }

        .input-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #94a3b8;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 12px;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(94, 234, 212, 0.3);
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 1rem;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #5eead4;
            box-shadow: 0 0 0 2px rgba(94, 234, 212, 0.2);
        }

        .toggle-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .toggle-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle-item:hover {
            background: rgba(15, 23, 42, 0.8);
        }

        .toggle-item input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .info-panel {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .info-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        }

        .info-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .info-label {
            color: #94a3b8;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .info-value {
            color: #e2e8f0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .status-highlight {
            color: #fde047;
            font-weight: 700;
        }

        .color-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(148, 163, 184, 0.2);
        }

        .color-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .color-box {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .color-default { background-color: #ffffff; border: 1px solid #64748b; }
        .color-compare { background-color: #fb923c; }
        .color-selected { background-color: #fde047; }
        .color-left { background-color: #93c5fd; }
        .color-right { background-color: #f9a8d4; }
        .color-sorted { background-color: #4ade80; }

        .pseudocode {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 10px;
            padding: 20px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .code-line {
            padding: 5px 10px;
            border-radius: 5px;
            margin-bottom: 2px;
            transition: background 0.3s ease;
        }

        .code-line.active {
            background: rgba(94, 234, 212, 0.2);
            color: #5eead4;
            font-weight: 600;
        }

        .code-line.comment {
            color: #94a3b8;
            font-style: italic;
        }

        .code-line.keyword {
            color: #f472b6;
        }

        .code-line.function {
            color: #60a5fa;
        }

        .footer {
            margin-top: 40px;
            text-align: center;
            color: #64748b;
            font-size: 0.9rem;
            padding: 20px;
            max-width: 800px;
        }

        @media (max-width: 1100px) {
            .container {
                flex-direction: column;
                align-items: center;
            }
            
            .left-panel, .right-panel {
                min-width: 90%;
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>å½’å¹¶æ’åºå¯è§†åŒ–</h1>
        <div class="subtitle">åˆ†æ²»ç­–ç•¥ Â· é€’å½’ä¹‹ç¾ Â· åˆå¹¶è‰ºæœ¯</div>
    </div>

    <div class="container">
        <!-- å·¦é¢æ¿ï¼šæ•°ç»„æ“ä½œè§†å›¾ -->
        <div class="panel left-panel">
            <div class="panel-title">
                <span>ğŸ“Š æ•°ç»„æ“ä½œè§†å›¾</span>
            </div>
            
            <div class="canvas-container">
                <canvas id="arrayCanvas" width="650" height="400"></canvas>
            </div>
            
            <div class="controls">
                <button id="playBtn" class="btn btn-primary">
                    <span>â–¶ï¸ æ’­æ”¾</span>
                </button>
                <button id="pauseBtn" class="btn btn-secondary">
                    <span>â¸ï¸ æš‚åœ</span>
                </button>
                <button id="stepBtn" class="btn btn-secondary">
                    <span>â­ï¸ ä¸‹ä¸€æ­¥</span>
                </button>
                <button id="prevBtn" class="btn btn-secondary">
                    <span>â®ï¸ ä¸Šä¸€æ­¥</span>
                </button>
                <button id="resetBtn" class="btn btn-secondary">
                    <span>ğŸ”„ é‡ç½®</span>
                </button>
                
                <div style="flex: 1; min-width: 150px;">
                    <label for="speedSlider">åŠ¨ç”»é€Ÿåº¦</label>
                    <input type="range" id="speedSlider" min="1" max="10" value="5">
                </div>
            </div>
            
            <div class="input-section">
                <div class="input-group">
                    <label for="arrayInput">è‡ªå®šä¹‰æ•°ç»„ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                    <input type="text" id="arrayInput" value="38, 27, 43, 3, 9, 82, 10">
                </div>
                
                <div class="input-group">
                    <label for="presetSelect">é¢„è®¾ç¤ºä¾‹</label>
                    <select id="presetSelect">
                        <option value="custom">è‡ªå®šä¹‰</option>
                        <option value="random">éšæœºæ•°ç»„</option>
                        <option value="reverse">é€†åºæ•°ç»„</option>
                        <option value="nearly">åŸºæœ¬æœ‰åºæ•°ç»„</option>
                        <option value="small">å°å‹æ•°ç»„</option>
                    </select>
                </div>
            </div>
            
            <div class="info-panel">
                <div class="info-item">
                    <div class="info-label">å½“å‰æ“ä½œ</div>
                    <div id="currentOperation" class="info-value">ç­‰å¾…å¼€å§‹...</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">å½“å‰å­æ•°ç»„èŒƒå›´</div>
                    <div id="currentRange" class="info-value">-</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">æ­¥éª¤è®¡æ•°</div>
                    <div id="stepCount" class="info-value">0</div>
                </div>
                
                <div class="color-legend">
                    <div class="color-item">
                        <div class="color-box color-default"></div>
                        <span>é»˜è®¤å…ƒç´ </span>
                    </div>
                    <div class="color-item">
                        <div class="color-box color-compare"></div>
                        <span>æ¯”è¾ƒä¸­</span>
                    </div>
                    <div class="color-item">
                        <div class="color-box color-selected"></div>
                        <span>å·²é€‰ä¸­</span>
                    </div>
                    <div class="color-item">
                        <div class="color-box color-left"></div>
                        <span>å·¦å­æ•°ç»„</span>
                    </div>
                    <div class="color-item">
                        <div class="color-box color-right"></div>
                        <span>å³å­æ•°ç»„</span>
                    </div>
                    <div class="color-item">
                        <div class="color-box color-sorted"></div>
                        <span>å·²æ’åº</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å³é¢æ¿ï¼šé€’å½’æ ‘è§†å›¾ -->
        <div class="panel right-panel">
            <div class="panel-title">
                <span>ğŸŒ³ é€’å½’æ ‘è§†å›¾</span>
            </div>
            
            <div class="canvas-container">
                <canvas id="treeCanvas" width="550" height="400"></canvas>
            </div>
            
            <div class="toggle-section">
                <div class="toggle-item">
                    <input type="checkbox" id="showTreeToggle" checked>
                    <label for="showTreeToggle">æ˜¾ç¤ºé€’å½’æ ‘</label>
                </div>
                
                <div class="toggle-item">
                    <input type="checkbox" id="highlightPathToggle" checked>
                    <label for="highlightPathToggle">é«˜äº®é€’å½’è·¯å¾„</label>
                </div>
                
                <div class="toggle-item">
                    <input type="checkbox" id="showCodeToggle" checked>
                    <label for="showCodeToggle">æ˜¾ç¤ºä»£ç è”åŠ¨</label>
                </div>
            </div>
            
            <div id="pseudocodePanel" class="pseudocode">
                <div class="code-line comment">// å½’å¹¶æ’åºä¸»å‡½æ•°</div>
                <div id="codeLine1" class="code-line">function mergeSort(arr, left, right) {</div>
                <div id="codeLine2" class="code-line">  if (left < right) {</div>
                <div id="codeLine3" class="code-line">    let mid = Math.floor((left + right) / 2);</div>
                <div id="codeLine4" class="code-line">    mergeSort(arr, left, mid);      // é€’å½’æ’åºå·¦åŠéƒ¨åˆ†</div>
                <div id="codeLine5" class="code-line">    mergeSort(arr, mid + 1, right); // é€’å½’æ’åºå³åŠéƒ¨åˆ†</div>
                <div id="codeLine6" class="code-line">    merge(arr, left, mid, right);   // åˆå¹¶ä¸¤ä¸ªæœ‰åºæ•°ç»„</div>
                <div id="codeLine7" class="code-line">  }</div>
                <div id="codeLine8" class="code-line">}</div>
                <div class="code-line comment" style="margin-top: 15px;">// åˆå¹¶å‡½æ•°</div>
                <div id="codeLine9" class="code-line">function merge(arr, left, mid, right) {</div>
                <div id="codeLine10" class="code-line">  let temp = [];</div>
                <div id="codeLine11" class="code-line">  let i = left, j = mid + 1;</div>
                <div id="codeLine12" class="code-line">  while (i <= mid && j <= right) {</div>
                <div id="codeLine13" class="code-line">    if (arr[i] <= arr[j]) {</div>
                <div id="codeLine14" class="code-line">      temp.push(arr[i]); i++;</div>
                <div id="codeLine15" class="code-line">    } else {</div>
                <div id="codeLine16" class="code-line">      temp.push(arr[j]); j++;</div>
                <div id="codeLine17" class="code-line">    }</div>
                <div id="codeLine18" class="code-line">  }</div>
                <div id="codeLine19" class="code-line">  while (i <= mid) { temp.push(arr[i]); i++; }</div>
                <div id="codeLine20" class="code-line">  while (j <= right) { temp.push(arr[j]); j++; }</div>
                <div id="codeLine21" class="code-line">  for (let k = left; k <= right; k++) {</div>
                <div id="codeLine22" class="code-line">    arr[k] = temp[k - left];</div>
                <div id="codeLine23" class="code-line">  }</div>
                <div id="codeLine24" class="code-line">}</div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <p>å½’å¹¶æ’åºæ˜¯ä¸€ç§é‡‡ç”¨åˆ†æ²»ç­–ç•¥çš„ç¨³å®šæ’åºç®—æ³•ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(n log n)ã€‚é€šè¿‡é€’å½’åœ°å°†æ•°ç»„åˆ†è§£ï¼Œç„¶ååˆå¹¶æœ‰åºå­æ•°ç»„ï¼Œæœ€ç»ˆå®Œæˆæ’åºã€‚</p>
        <p style="margin-top: 10px;">äº¤äº’å¼æ•™å­¦åŠ¨ç”» Â© 2023 | è®¾è®¡çµæ„Ÿï¼šé£è±¡è€å¸ˆ</p>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let originalArray = [38, 27, 43, 3, 9, 82, 10];
        let currentArray = [...originalArray];
        let animationSteps = [];
        let currentStep = 0;
        let isPlaying = false;
        let animationSpeed = 5;
        let animationInterval;
        
        // é…ç½®é€‰é¡¹
        let showTree = true;
        let highlightPath = true;
        let showCode = true;
        
        // è·å–DOMå…ƒç´ 
        const arrayCanvas = document.getElementById('arrayCanvas');
        const treeCanvas = document.getElementById('treeCanvas');
        const arrayCtx = arrayCanvas.getContext('2d');
        const treeCtx = treeCanvas.getContext('2d');
        
        // è·å–æ§åˆ¶å…ƒç´ 
        const playBtn = document.getElementById('playBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const stepBtn = document.getElementById('stepBtn');
        const prevBtn = document.getElementById('prevBtn');
        const resetBtn = document.getElementById('resetBtn');
        const speedSlider = document.getElementById('speedSlider');
        const arrayInput = document.getElementById('arrayInput');
        const presetSelect = document.getElementById('presetSelect');
        
        // è·å–ä¿¡æ¯æ˜¾ç¤ºå…ƒç´ 
        const currentOperation = document.getElementById('currentOperation');
        const currentRange = document.getElementById('currentRange');
        const stepCount = document.getElementById('stepCount');
        
        // è·å–åˆ‡æ¢å¼€å…³
        const showTreeToggle = document.getElementById('showTreeToggle');
        const highlightPathToggle = document.getElementById('highlightPathToggle');
        const showCodeToggle = document.getElementById('showCodeToggle');
        
        // è·å–ä»£ç è¡Œå…ƒç´ 
        const codeLines = {};
        for (let i = 1; i <= 24; i++) {
            codeLines[i] = document.getElementById(`codeLine${i}`);
        }
        
        // å½’å¹¶æ’åºç®—æ³•å®ç°ï¼ˆç”ŸæˆåŠ¨ç”»æ­¥éª¤ï¼‰
        function generateMergeSortSteps(arr) {
            const steps = [];
            const tempArray = [...arr];
            
            function mergeSort(arr, left, right, depth, path) {
                const stepId = steps.length;
                steps.push({
                    type: 'enter',
                    left, right, depth, path,
                    stepId,
                    operation: `è¿›å…¥å½’å¹¶æ’åº: [${left}, ${right}]`
                });
                
                if (left < right) {
                    const mid = Math.floor((left + right) / 2);
                    
                    // é€’å½’å·¦åŠéƒ¨åˆ†
                    const leftPath = [...path, 'L'];
                    mergeSort(arr, left, mid, depth + 1, leftPath);
                    
                    // é€’å½’å³åŠéƒ¨åˆ†
                    const rightPath = [...path, 'R'];
                    mergeSort(arr, mid + 1, right, depth + 1, rightPath);
                    
                    // åˆå¹¶
                    merge(arr, left, mid, right, depth, path);
                } else {
                    steps.push({
                        type: 'base',
                        left, right, depth, path,
                        stepId: steps.length,
                        operation: `åŸºæœ¬æƒ…å†µ: å•ä¸ªå…ƒç´  [${left}]`
                    });
                }
                
                steps.push({
                    type: 'exit',
                    left, right, depth, path,
                    stepId: steps.length,
                    operation: `é€€å‡ºå½’å¹¶æ’åº: [${left}, ${right}]`
                });
            }
            
            function merge(arr, left, mid, right, depth, path) {
                const temp = [];
                let i = left;
                let j = mid + 1;
                let k = 0;
                
                steps.push({
                    type: 'merge_start',
                    left, mid, right, depth, path,
                    stepId: steps.length,
                    operation: `å¼€å§‹åˆå¹¶: [${left}, ${mid}] å’Œ [${mid+1}, ${right}]`
                });
                
                // æ¯”è¾ƒå¹¶åˆå¹¶
                while (i <= mid && j <= right) {
                    steps.push({
                        type: 'compare',
                        left, mid, right, i, j, depth, path,
                        stepId: steps.length,
                        operation: `æ¯”è¾ƒ: arr[${i}]=${arr[i]} å’Œ arr[${j}]=${arr[j]}`
                    });
                    
                    if (arr[i] <= arr[j]) {
                        steps.push({
                            type: 'select_left',
                            left, mid, right, i, j, depth, path,
                            stepId: steps.length,
                            operation: `é€‰æ‹©å·¦å…ƒç´ : arr[${i}]=${arr[i]}`
                        });
                        temp[k++] = arr[i++];
                    } else {
                        steps.push({
                            type: 'select_right',
                            left, mid, right, i, j, depth, path,
                            stepId: steps.length,
                            operation: `é€‰æ‹©å³å…ƒç´ : arr[${j}]=${arr[j]}`
                        });
                        temp[k++] = arr[j++];
                    }
                }
                
                // å¤åˆ¶å‰©ä½™å…ƒç´ 
                while (i <= mid) {
                    steps.push({
                        type: 'copy_left',
                        left, mid, right, i, depth, path,
                        stepId: steps.length,
                        operation: `å¤åˆ¶å·¦å‰©ä½™å…ƒç´ : arr[${i}]=${arr[i]}`
                    });
                    temp[k++] = arr[i++];
                }
                
                while (j <= right) {
                    steps.push({
                        type: 'copy_right',
                        left, mid, right, j, depth, path,
                        stepId: steps.length,
                        operation: `å¤åˆ¶å³å‰©ä½™å…ƒç´ : arr[${j}]=${arr[j]}`
                    });
                    temp[k++] = arr[j++];
                }
                
                // å¤åˆ¶å›åŸæ•°ç»„
                for (let t = 0; t < k; t++) {
                    arr[left + t] = temp[t];
                    steps.push({
                        type: 'copy_back',
                        left, mid, right, index: left + t, value: temp[t], depth, path,
                        stepId: steps.length,
                        operation: `å¤åˆ¶å›åŸæ•°ç»„: arr[${left + t}] = ${temp[t]}`
                    });
                }
                
                steps.push({
                    type: 'merge_end',
                    left, mid, right, depth, path,
                    stepId: steps.length,
                    operation: `åˆå¹¶å®Œæˆ: [${left}, ${right}] å·²æ’åº`
                });
            }
            
            mergeSort(tempArray, 0, tempArray.length - 1, 0, ['ROOT']);
            return steps;
        }
        
        // ç»˜åˆ¶æ•°ç»„è§†å›¾
        function drawArrayView(step) {
            const canvas = arrayCanvas;
            const ctx = arrayCtx;
            const width = canvas.width;
            const height = canvas.height;
            
            // æ¸…é™¤ç”»å¸ƒ
            ctx.clearRect(0, 0, width, height);
            
            // ç»˜åˆ¶èƒŒæ™¯
            ctx.fillStyle = 'rgba(15, 23, 42, 0.5)';
            ctx.fillRect(0, 0, width, height);
            
            // å¦‚æœæ²¡æœ‰æ­¥éª¤ï¼Œç»˜åˆ¶åˆå§‹æ•°ç»„
            if (!step) {
                drawArray(currentArray, 0, currentArray.length - 1, 'default');
                return;
            }
            
            // æ ¹æ®æ­¥éª¤ç±»å‹ç»˜åˆ¶
            const { type, left, right, mid, i, j, index, value, depth, path } = step;
            
            switch (type) {
                case 'enter':
                case 'exit':
                case 'base':
                    drawArray(currentArray, left, right, 'highlight_range');
                    break;
                    
                case 'merge_start':
                    drawArray(currentArray, left, mid, 'left_array');
                    drawArray(currentArray, mid + 1, right, 'right_array');
                    break;
                    
                case 'compare':
                    drawArray(currentArray, left, mid, 'left_array');
                    drawArray(currentArray, mid + 1, right, 'right_array');
                    drawArrayElement(i, 'compare');
                    drawArrayElement(j, 'compare');
                    break;
                    
                case 'select_left':
                    drawArray(currentArray, left, mid, 'left_array');
                    drawArray(currentArray, mid + 1, right, 'right_array');
                    drawArrayElement(i, 'selected');
                    break;
                    
                case 'select_right':
                    drawArray(currentArray, left, mid, 'left_array');
                    drawArray(currentArray, mid + 1, right, 'right_array');
                    drawArrayElement(j, 'selected');
                    break;
                    
                case 'copy_back':
                    // æ›´æ–°æ•°ç»„å€¼
                    if (index >= 0 && index < currentArray.length) {
                        currentArray[index] = value;
                    }
                    drawArray(currentArray, left, right, 'sorted');
                    drawArrayElement(index, 'selected');
                    break;
                    
                default:
                    drawArray(currentArray, 0, currentArray.length - 1, 'default');
            }
            
            // ç»˜åˆ¶å½“å‰æ“ä½œä¿¡æ¯
            if (step.operation) {
                ctx.fillStyle = '#5eead4';
                ctx.font = '16px "Segoe UI", sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(step.operation, width / 2, 30);
            }
        }
        
        // ç»˜åˆ¶æ•°ç»„
        function drawArray(arr, start, end, style) {
            const canvas = arrayCanvas;
            const ctx = arrayCtx;
            const width = canvas.width;
            const height = canvas.height;
            
            const totalElements = arr.length;
            const barWidth = (width - 100) / totalElements;
            const maxBarHeight = height - 100;
            const maxValue = Math.max(...arr);
            
            // ç¡®å®šé¢œè‰²
            let fillColor, borderColor;
            switch (style) {
                case 'highlight_range':
                    fillColor = 'rgba(253, 224, 71, 0.3)';
                    borderColor = '#fde047';
                    break;
                case 'left_array':
                    fillColor = 'rgba(147, 197, 253, 0.3)';
                    borderColor = '#93c5fd';
                    break;
                case 'right_array':
                    fillColor = 'rgba(249, 168, 212, 0.3)';
                    borderColor = '#f9a8d4';
                    break;
                case 'sorted':
                    fillColor = 'rgba(74, 222, 128, 0.3)';
                    borderColor = '#4ade80';
                    break;
                default:
                    fillColor = 'rgba(255, 255, 255, 0.1)';
                    borderColor = '#64748b';
            }
            
            // ç»˜åˆ¶æ•°ç»„å…ƒç´ 
            for (let idx = 0; idx < arr.length; idx++) {
                const x = 50 + idx * barWidth;
                const barHeight = (arr[idx] / maxValue) * maxBarHeight;
                const y = height - 50 - barHeight;
                
                // å¦‚æœå…ƒç´ åœ¨æŒ‡å®šèŒƒå›´å†…ï¼Œä½¿ç”¨ç‰¹æ®Šæ ·å¼
                if (idx >= start && idx <= end) {
                    ctx.fillStyle = fillColor;
                    ctx.fillRect(x, y, barWidth - 2, barHeight);
                    
                    ctx.strokeStyle = borderColor;
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x, y, barWidth - 2, barHeight);
                } else {
                    // é»˜è®¤æ ·å¼
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
                    ctx.fillRect(x, y, barWidth - 2, barHeight);
                    
                    ctx.strokeStyle = '#64748b';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(x, y, barWidth - 2, barHeight);
                }
                
                // ç»˜åˆ¶æ•°å€¼
                ctx.fillStyle = '#e2e8f0';
                ctx.font = '14px "Segoe UI", sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(arr[idx], x + (barWidth - 2) / 2, y - 10);
                
                // ç»˜åˆ¶ç´¢å¼•
                ctx.fillStyle = '#94a3b8';
                ctx.font = '12px "Segoe UI", sans-serif';
                ctx.fillText(idx, x + (barWidth - 2) / 2, height - 25);
            }
        }
        
        // ç»˜åˆ¶å•ä¸ªæ•°ç»„å…ƒç´ ï¼ˆé«˜äº®ï¼‰
        function drawArrayElement(index, style) {
            const canvas = arrayCanvas;
            const ctx = arrayCtx;
            const width = canvas.width;
            const height = canvas.height;
            
            const totalElements = currentArray.length;
            const barWidth = (width - 100) / totalElements;
            const maxBarHeight = height - 100;
            const maxValue = Math.max(...currentArray);
            
            const x = 50 + index * barWidth;
            const barHeight = (currentArray[index] / maxValue) * maxBarHeight;
            const y = height - 50 - barHeight;
            
            // ç¡®å®šé¢œè‰²
            let fillColor, borderColor;
            switch (style) {
                case 'compare':
                    fillColor = 'rgba(251, 146, 60, 0.7)';
                    borderColor = '#fb923c';
                    break;
                case 'selected':
                    fillColor = 'rgba(253, 224, 71, 0.7)';
                    borderColor = '#fde047';
                    break;
                default:
                    return;
            }
            
            // ç»˜åˆ¶é«˜äº®å…ƒç´ 
            ctx.fillStyle = fillColor;
            ctx.fillRect(x - 2, y - 2, barWidth + 2, barHeight + 4);
            
            ctx.strokeStyle = borderColor;
            ctx.lineWidth = 3;
            ctx.strokeRect(x - 2, y - 2, barWidth + 2, barHeight + 4);
            
            // é‡æ–°ç»˜åˆ¶æ•°å€¼ï¼ˆç¡®ä¿åœ¨é¡¶éƒ¨ï¼‰
            ctx.fillStyle = '#0f172a';
            ctx.font = 'bold 14px "Segoe UI", sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(currentArray[index], x + (barWidth - 2) / 2, y - 10);
        }
        
        // ç»˜åˆ¶é€’å½’æ ‘
        function drawTreeView(step) {
            if (!showTree) return;
            
            const canvas = treeCanvas;
            const ctx = treeCtx;
            const width = canvas.width;
            const height = canvas.height;
            
            // æ¸…é™¤ç”»å¸ƒ
            ctx.clearRect(0, 0, width, height);
            
            // ç»˜åˆ¶èƒŒæ™¯
            ctx.fillStyle = 'rgba(15, 23, 42, 0.5)';
            ctx.fillRect(0, 0, width, height);
            
            // å¦‚æœæ²¡æœ‰æ­¥éª¤ï¼Œç»˜åˆ¶ç©ºæ ‘
            if (!step) {
                ctx.fillStyle = '#5eead4';
                ctx.font = '18px "Segoe UI", sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('ç‚¹å‡»"æ’­æ”¾"å¼€å§‹å¯è§†åŒ–é€’å½’æ ‘', width / 2, height / 2);
                return;
            }
            
            // ç»˜åˆ¶é€’å½’æ ‘
            const { depth, path, left, right, type } = step;
            
            // è®¡ç®—èŠ‚ç‚¹ä½ç½®
            const maxDepth = 5;
            const nodeRadius = 20;
            const levelHeight = 70;
            
            // ç»˜åˆ¶æ‰€æœ‰å†å²èŠ‚ç‚¹
            for (let i = 0; i <= currentStep; i++) {
                const stepInfo = animationSteps[i];
                if (!stepInfo || !stepInfo.path) continue;
                
                // è®¡ç®—èŠ‚ç‚¹ä½ç½®
                const nodeDepth = stepInfo.depth;
                const pathStr = stepInfo.path.join('');
                
                // è®¡ç®—æ°´å¹³ä½ç½®ï¼ˆåŸºäºè·¯å¾„ï¼‰
                let position = 0.5; // æ ¹èŠ‚ç‚¹åœ¨ä¸­é—´
                for (let j = 1; j < stepInfo.path.length; j++) {
                    const direction = stepInfo.path[j];
                    const offset = Math.pow(0.5, j + 1);
                    position += direction === 'L' ? -offset : offset;
                }
                
                const x = 50 + position * (width - 100);
                const y = 50 + nodeDepth * levelHeight;
                
                // ç¡®å®šèŠ‚ç‚¹é¢œè‰²
                let nodeColor = '#334155';
                let borderColor = '#64748b';
                let textColor = '#e2e8f0';
                
                // é«˜äº®å½“å‰è·¯å¾„
                if (highlightPath && isPathPrefix(stepInfo.path, path)) {
                    nodeColor = 'rgba(94, 234, 212, 0.3)';
                    borderColor = '#5eead4';
                }
                
                // å½“å‰èŠ‚ç‚¹ç‰¹æ®Šé«˜äº®
                if (i === currentStep) {
                    nodeColor = 'rgba(253, 224, 71, 0.5)';
                    borderColor = '#fde047';
                }
                
                // ç»˜åˆ¶èŠ‚ç‚¹
                ctx.beginPath();
                ctx.arc(x, y, nodeRadius, 0, Math.PI * 2);
                ctx.fillStyle = nodeColor;
                ctx.fill();
                ctx.strokeStyle = borderColor;
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // ç»˜åˆ¶èŠ‚ç‚¹æ–‡æœ¬
                ctx.fillStyle = textColor;
                ctx.font = '12px "Segoe UI", sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                let displayText = '';
                if (stepInfo.type === 'base') {
                    displayText = `[${left}]`;
                } else if (stepInfo.left !== undefined && stepInfo.right !== undefined) {
                    displayText = `[${stepInfo.left},${stepInfo.right}]`;
                } else {
                    displayText = pathStr.substring(0, 4) + (pathStr.length > 4 ? '...' : '');
                }
                
                ctx.fillText(displayText, x, y);
                
                // ç»˜åˆ¶è¿æ¥çº¿ï¼ˆè¿æ¥åˆ°çˆ¶èŠ‚ç‚¹ï¼‰
                if (stepInfo.path.length > 1) {
                    const parentPath = stepInfo.path.slice(0, -1);
                    const parentStep = findStepByPath(parentPath);
                    
                    if (parentStep) {
                        // è®¡ç®—çˆ¶èŠ‚ç‚¹ä½ç½®
                        let parentPosition = 0.5;
                        for (let j = 1; j < parentPath.length; j++) {
                            const direction = parentPath[j];
                            const offset = Math.pow(0.5, j + 1);
                            parentPosition
<!--æ£€æµ‹åˆ°ä»£ç æˆªæ–­ï¼Œè‡ªåŠ¨ç»­å†™ä¸­...-->
+= direction === 'L' ? -offset : offset;
                        }
                        
                        const parentX = 50 + parentPosition * (width - 100);
                        const parentY = 50 + parentStep.depth * levelHeight;
                        
                        // ç»˜åˆ¶è¿æ¥çº¿
                        ctx.beginPath();
                        ctx.moveTo(parentX, parentY + nodeRadius);
                        ctx.lineTo(x, y - nodeRadius);
                        ctx.strokeStyle = highlightPath && isPathPrefix(parentPath, path) ? '#5eead4' : '#475569';
                        ctx.lineWidth = 1.5;
                        ctx.stroke();
                    }
                }
            }
            
            // ç»˜åˆ¶å½“å‰æ“ä½œä¿¡æ¯
            if (step.operation) {
                ctx.fillStyle = '#5eead4';
                ctx.font = '16px "Segoe UI", sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(step.operation, width / 2, height - 20);
            }
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥è·¯å¾„å‰ç¼€
        function isPathPrefix(prefix, fullPath) {
            if (prefix.length > fullPath.length) return false;
            for (let i = 0; i < prefix.length; i++) {
                if (prefix[i] !== fullPath[i]) return false;
            }
            return true;
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®è·¯å¾„æŸ¥æ‰¾æ­¥éª¤
        function findStepByPath(path) {
            for (let i = currentStep; i >= 0; i--) {
                if (animationSteps[i] && 
                    animationSteps[i].path.length === path.length &&
                    animationSteps[i].path.every((val, idx) => val === path[idx])) {
                    return animationSteps[i];
                }
            }
            return null;
        }
        
        // æ›´æ–°ä»£ç é«˜äº®
        function updateCodeHighlight(step) {
            if (!showCode) {
                // æ¸…é™¤æ‰€æœ‰é«˜äº®
                for (let i = 1; i <= 24; i++) {
                    codeLines[i].classList.remove('active');
                }
                return;
            }
            
            // æ¸…é™¤æ‰€æœ‰é«˜äº®
            for (let i = 1; i <= 24; i++) {
                codeLines[i].classList.remove('active');
            }
            
            if (!step) return;
            
            // æ ¹æ®æ­¥éª¤ç±»å‹é«˜äº®å¯¹åº”ä»£ç è¡Œ
            const { type } = step;
            
            switch (type) {
                case 'enter':
                    codeLines[1].classList.add('active');
                    codeLines[2].classList.add('active');
                    break;
                    
                case 'base':
                    codeLines[7].classList.add('active');
                    break;
                    
                case 'merge_start':
                    codeLines[6].classList.add('active');
                    codeLines[9].classList.add('active');
                    break;
                    
                case 'compare':
                    codeLines[12].classList.add('active');
                    codeLines[13].classList.add('active');
                    break;
                    
                case 'select_left':
                    codeLines[14].classList.add('active');
                    break;
                    
                case 'select_right':
                    codeLines[16].classList.add('active');
                    break;
                    
                case 'copy_left':
                case 'copy_right':
                    codeLines[19].classList.add('active');
                    codeLines[20].classList.add('active');
                    break;
                    
                case 'copy_back':
                    codeLines[21].classList.add('active');
                    codeLines[22].classList.add('active');
                    break;
                    
                case 'merge_end':
                    codeLines[23].classList.add('active');
                    codeLines[24].classList.add('active');
                    break;
                    
                case 'exit':
                    codeLines[8].classList.add('active');
                    break;
            }
        }
        
        // æ›´æ–°ä¿¡æ¯é¢æ¿
        function updateInfoPanel(step) {
            if (!step) {
                currentOperation.textContent = 'ç­‰å¾…å¼€å§‹...';
                currentRange.textContent = '-';
                stepCount.textContent = '0';
                return;
            }
            
            currentOperation.textContent = step.operation;
            stepCount.textContent = currentStep + 1;
            
            if (step.left !== undefined && step.right !== undefined) {
                currentRange.textContent = `[${step.left}, ${step.right}]`;
            } else {
                currentRange.textContent = '-';
            }
        }
        
        // æ‰§è¡Œä¸€æ­¥åŠ¨ç”»
        function executeStep(stepIndex) {
            if (stepIndex < 0 || stepIndex >= animationSteps.length) return;
            
            currentStep = stepIndex;
            const step = animationSteps[stepIndex];
            
            // æ›´æ–°æ•°ç»„çŠ¶æ€ï¼ˆå¯¹äºcopy_backæ­¥éª¤ï¼‰
            if (step.type === 'copy_back' && step.index !== undefined && step.value !== undefined) {
                currentArray[step.index] = step.value;
            }
            
            // æ›´æ–°æ˜¾ç¤º
            drawArrayView(step);
            drawTreeView(step);
            updateCodeHighlight(step);
            updateInfoPanel(step);
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateButtonStates();
        }
        
        // ä¸‹ä¸€æ­¥
        function nextStep() {
            if (currentStep < animationSteps.length - 1) {
                executeStep(currentStep + 1);
            } else {
                pauseAnimation();
            }
        }
        
        // ä¸Šä¸€æ­¥
        function prevStep() {
            if (currentStep > 0) {
                // éœ€è¦é‡æ–°è®¡ç®—æ•°ç»„çŠ¶æ€
                resetArrayState();
                for (let i = 0; i < currentStep - 1; i++) {
                    const step = animationSteps[i];
                    if (step.type === 'copy_back' && step.index !== undefined && step.value !== undefined) {
                        currentArray[step.index] = step.value;
                    }
                }
                executeStep(currentStep - 1);
            }
        }
        
        // é‡ç½®æ•°ç»„çŠ¶æ€
        function resetArrayState() {
            currentArray = [...originalArray];
        }
        
        // æ’­æ”¾åŠ¨ç”»
        function playAnimation() {
            if (isPlaying) return;
            
            isPlaying = true;
            updateButtonStates();
            
            animationInterval = setInterval(() => {
                if (currentStep < animationSteps.length - 1) {
                    nextStep();
                } else {
                    pauseAnimation();
                }
            }, 1000 / animationSpeed);
        }
        
        // æš‚åœåŠ¨ç”»
        function pauseAnimation() {
            isPlaying = false;
            clearInterval(animationInterval);
            updateButtonStates();
        }
        
        // é‡ç½®åŠ¨ç”»
        function resetAnimation() {
            pauseAnimation();
            currentStep = 0;
            resetArrayState();
            drawArrayView(null);
            drawTreeView(null);
            updateCodeHighlight(null);
            updateInfoPanel(null);
            updateButtonStates();
        }
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtonStates() {
            playBtn.disabled = isPlaying || currentStep >= animationSteps.length - 1;
            pauseBtn.disabled = !isPlaying;
            stepBtn.disabled = isPlaying || currentStep >= animationSteps.length - 1;
            prevBtn.disabled = isPlaying || currentStep <= 0;
        }
        
        // ç”Ÿæˆéšæœºæ•°ç»„
        function generateRandomArray(size = 8) {
            const arr = [];
            for (let i = 0; i < size; i++) {
                arr.push(Math.floor(Math.random() * 90) + 10);
            }
            return arr;
        }
        
        // ç”Ÿæˆé€†åºæ•°ç»„
        function generateReverseArray(size = 8) {
            const arr = [];
            for (let i = size; i > 0; i--) {
                arr.push(i * 10);
            }
            return arr;
        }
        
        // ç”ŸæˆåŸºæœ¬æœ‰åºæ•°ç»„
        function generateNearlySortedArray(size = 8) {
            const arr = [];
            for (let i = 0; i < size; i++) {
                arr.push((i + 1) * 10);
            }
            // äº¤æ¢å‡ å¯¹å…ƒç´ 
            for (let i = 0; i < 2; i++) {
                const idx1 = Math.floor(Math.random() * size);
                const idx2 = Math.floor(Math.random() * size);
                [arr[idx1], arr[idx2]] = [arr[idx2], arr[idx1]];
            }
            return arr;
        }
        
        // åˆå§‹åŒ–
        function init() {
            // ç”Ÿæˆåˆå§‹åŠ¨ç”»æ­¥éª¤
            animationSteps = generateMergeSortSteps(originalArray);
            
            // ç»˜åˆ¶åˆå§‹çŠ¶æ€
            drawArrayView(null);
            drawTreeView(null);
            updateCodeHighlight(null);
            updateInfoPanel(null);
            updateButtonStates();
            
            // äº‹ä»¶ç›‘å¬å™¨
            playBtn.addEventListener('click', playAnimation);
            pauseBtn.addEventListener('click', pauseAnimation);
            stepBtn.addEventListener('click', nextStep);
            prevBtn.addEventListener('click', prevStep);
            resetBtn.addEventListener('click', resetAnimation);
            
            speedSlider.addEventListener('input', function() {
                animationSpeed = parseInt(this.value);
                if (isPlaying) {
                    pauseAnimation();
                    playAnimation();
                }
            });
            
            arrayInput.addEventListener('change', function() {
                const input = this.value.trim();
                if (input) {
                    const newArray = input.split(',').map(num => parseInt(num.trim())).filter(num => !isNaN(num));
                    if (newArray.length > 0) {
                        originalArray = newArray;
                        resetAnimation();
                        animationSteps = generateMergeSortSteps(originalArray);
                        presetSelect.value = 'custom';
                    }
                }
            });
            
            presetSelect.addEventListener('change', function() {
                const preset = this.value;
                
                switch (preset) {
                    case 'random':
                        originalArray = generateRandomArray();
                        break;
                    case 'reverse':
                        originalArray = generateReverseArray();
                        break;
                    case 'nearly':
                        originalArray = generateNearlySortedArray();
                        break;
                    case 'small':
                        originalArray = [5, 2, 8, 1];
                        break;
                    case 'custom':
                        return; // ä¿æŒå½“å‰æ•°ç»„
                }
                
                arrayInput.value = originalArray.join(', ');
                resetAnimation();
                animationSteps = generateMergeSortSteps(originalArray);
            });
            
            showTreeToggle.addEventListener('change', function() {
                showTree = this.checked;
                drawTreeView(animationSteps[currentStep]);
            });
            
            highlightPathToggle.addEventListener('change', function() {
                highlightPath = this.checked;
                drawTreeView(animationSteps[currentStep]);
            });
            
            showCodeToggle.addEventListener('change', function() {
                showCode = this.checked;
                updateCodeHighlight(animationSteps[currentStep]);
            });
            
            // åˆå§‹ç”Ÿæˆæ­¥éª¤
            resetAnimation();
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>