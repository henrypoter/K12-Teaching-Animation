<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿæ€ç³»ç»Ÿç‰©è´¨å¾ªç¯ä¸èƒ½é‡æµåŠ¨æ•™å­¦åŠ¨ç”»</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(to bottom, #0a1a2d, #1a3a5f);
            color: #e0f7ff;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 213, 79, 0.3);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(to right, #4fc3f7, #a5d6a7);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.5;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .animation-container {
            flex: 1;
            min-width: 800px;
            background: rgba(10, 30, 50, 0.7);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(100, 180, 255, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .controls-panel {
            width: 350px;
            background: rgba(15, 40, 70, 0.8);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(120, 200, 255, 0.2);
        }
        
        .panel-section {
            margin-bottom: 30px;
        }
        
        .panel-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #81d4fa;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(129, 212, 250, 0.3);
        }
        
        .mode-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .mode-btn {
            padding: 14px 10px;
            background: rgba(30, 70, 120, 0.8);
            border: 2px solid rgba(100, 180, 255, 0.3);
            border-radius: 10px;
            color: #e0f7ff;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .mode-btn:hover {
            background: rgba(40, 90, 150, 0.9);
            transform: translateY(-2px);
        }
        
        .mode-btn.active {
            background: rgba(79, 195, 247, 0.25);
            border-color: #4fc3f7;
            box-shadow: 0 0 15px rgba(79, 195, 247, 0.4);
        }
        
        .control-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .control-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .play-btn {
            background: linear-gradient(to right, #2e7d32, #4caf50);
            color: white;
        }
        
        .reset-btn {
            background: linear-gradient(to right, #1565c0, #2196f3);
            color: white;
        }
        
        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .slider-container {
            margin-bottom: 20px;
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .slider-value {
            color: #ffcc80;
            font-weight: 600;
        }
        
        .slider {
            width: 100%;
            height: 10px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(50, 100, 150, 0.7);
            border-radius: 5px;
            outline: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #4fc3f7;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        
        .info-panel {
            background: rgba(20, 50, 90, 0.8);
            border-radius: 15px;
            padding: 25px;
            margin-top: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(120, 200, 255, 0.2);
        }
        
        .info-title {
            font-size: 1.4rem;
            margin-bottom: 15px;
            color: #a5d6a7;
        }
        
        .info-content {
            line-height: 1.6;
            font-size: 1.05rem;
        }
        
        .highlight {
            color: #ffcc80;
            font-weight: 600;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        canvas {
            display: block;
            border-radius: 10px;
            background: rgba(5, 20, 40, 0.9);
        }
        
        .data-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .data-item {
            background: rgba(30, 70, 120, 0.5);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #4fc3f7;
        }
        
        .data-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #ffcc80;
            margin-top: 5px;
        }
        
        .data-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .human-impact-controls {
            background: rgba(120, 40, 40, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border: 1px solid rgba(255, 100, 100, 0.3);
        }
        
        .impact-title {
            color: #ffab91;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        
        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
            }
            
            .animation-container, .controls-panel {
                min-width: 100%;
            }
        }
        
        .click-hint {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            color: #b3e5fc;
            border: 1px solid rgba(179, 229, 252, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ç”Ÿæ€ç³»ç»Ÿç‰©è´¨å¾ªç¯ä¸èƒ½é‡æµåŠ¨</h1>
            <p class="subtitle">æ¢ç´¢ç¢³å¾ªç¯ã€æ°®å¾ªç¯ä¸èƒ½é‡æµåŠ¨çš„å…¨çƒåŠ¨æ€è¿‡ç¨‹ã€‚ç‚¹å‡»ç”»å¸ƒä¸­çš„å…ƒç´ æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ï¼Œè°ƒæ•´å‚æ•°è§‚å¯Ÿäººç±»æ´»åŠ¨çš„å½±å“ã€‚</p>
        </header>
        
        <div class="main-content">
            <div class="animation-container">
                <canvas id="ecosystemCanvas" width="1100" height="700"></canvas>
                <div class="click-hint">ğŸ’¡ æç¤ºï¼šç‚¹å‡»ç”»å¸ƒä¸­çš„å…ƒç´ ï¼ˆå‚¨åº“ã€ç”Ÿç‰©ã€ç®­å¤´ï¼‰æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</div>
            </div>
            
            <div class="controls-panel">
                <div class="panel-section">
                    <h3 class="panel-title">æ¨¡å¼é€‰æ‹©</h3>
                    <div class="mode-buttons">
                        <button class="mode-btn active" data-mode="carbon">ç¢³å¾ªç¯</button>
                        <button class="mode-btn" data-mode="nitrogen">æ°®å¾ªç¯</button>
                        <button class="mode-btn" data-mode="energy">èƒ½é‡æµåŠ¨</button>
                        <button class="mode-btn" data-mode="compare">å¯¹æ¯”è§†å›¾</button>
                    </div>
                    
                    <div class="control-buttons">
                        <button class="control-btn play-btn" id="playBtn">â–¶ æ’­æ”¾</button>
                        <button class="control-btn reset-btn" id="resetBtn">â†º é‡ç½®</button>
                    </div>
                    
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>åŠ¨ç”»é€Ÿåº¦</span>
                            <span class="slider-value" id="speedValue">1.0x</span>
                        </div>
                        <input type="range" min="0.1" max="3" step="0.1" value="1" class="slider" id="speedSlider">
                    </div>
                </div>
                
                <div class="panel-section">
                    <h3 class="panel-title">äººç±»æ´»åŠ¨å½±å“æ¨¡æ‹Ÿ</h3>
                    <div class="human-impact-controls">
                        <div class="impact-title">ç¢³å¾ªç¯å½±å“</div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>åŒ–çŸ³ç‡ƒæ–™ç‡ƒçƒ§</span>
                                <span class="slider-value" id="fuelValue">50%</span>
                            </div>
                            <input type="range" min="0" max="100" step="1" value="50" class="slider" id="fuelSlider">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>æ£®æ—ç ä¼</span>
                                <span class="slider-value" id="deforestValue">30%</span>
                            </div>
                            <input type="range" min="0" max="100" step="1" value="30" class="slider" id="deforestSlider">
                        </div>
                        
                        <div class="impact-title" style="margin-top: 15px;">æ°®å¾ªç¯å½±å“</div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>åŒ–è‚¥ä½¿ç”¨</span>
                                <span class="slider-value" id="fertilizerValue">40%</span>
                            </div>
                            <input type="range" min="0" max="100" step="1" value="40" class="slider" id="fertilizerSlider">
                        </div>
                    </div>
                </div>
                
                <div class="data-display">
                    <div class="data-item">
                        <div class="data-label">å¤§æ°”COâ‚‚æµ“åº¦</div>
                        <div class="data-value" id="co2Value">415 ppm</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">å…¨çƒæ¸©åº¦å˜åŒ–</div>
                        <div class="data-value" id="tempValue">+1.2Â°C</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">æ°®å›ºå®šæ€»é‡</div>
                        <div class="data-value" id="nitrogenValue">140 Tg/å¹´</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">èƒ½é‡ä¼ é€’æ•ˆç‡</div>
                        <div class="data-value" id="energyValue">10%</div>
                    </div>
                </div>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #4db6ac;"></div>
                        <span>ç¢³åŸå­</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #7986cb;"></div>
                        <span>æ°®åŸå­</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #ffb74d;"></div>
                        <span>èƒ½é‡ç²’å­</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #81c784;"></div>
                        <span>ç”Ÿäº§è€…</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="info-panel">
            <h3 class="info-title" id="infoTitle">ç”Ÿæ€ç³»ç»Ÿç‰©è´¨å¾ªç¯ä¸èƒ½é‡æµåŠ¨</h3>
            <div class="info-content" id="infoContent">
                æ¬¢è¿ä½¿ç”¨ç”Ÿæ€ç³»ç»Ÿæ•™å­¦åŠ¨ç”»ï¼è¯·é€‰æ‹©ä¸€ç§æ¨¡å¼å¼€å§‹æ¢ç´¢ï¼š
                <br><br>
                <span class="highlight">ç¢³å¾ªç¯</span>ï¼šç¢³å…ƒç´ åœ¨å¤§æ°”ã€ç”Ÿç‰©ã€æµ·æ´‹å’Œåœ°å£³ä¹‹é—´çš„å¾ªç¯è¿‡ç¨‹ã€‚
                <br>
                <span class="highlight">æ°®å¾ªç¯</span>ï¼šæ°®å…ƒç´ åœ¨å¤§æ°”ã€ç”Ÿç‰©å’ŒåœŸå£¤ä¹‹é—´çš„è½¬åŒ–ä¸å¾ªç¯è¿‡ç¨‹ã€‚
                <br>
                <span class="highlight">èƒ½é‡æµåŠ¨</span>ï¼šå¤ªé˜³èƒ½å¦‚ä½•é€šè¿‡é£Ÿç‰©é“¾ä¼ é€’ï¼Œå¹¶ä»¥çƒ­èƒ½å½¢å¼æ•£å¤±ã€‚
                <br>
                <span class="highlight">å¯¹æ¯”è§†å›¾</span>ï¼šåŒæ—¶å±•ç¤ºç‰©è´¨å¾ªç¯ä¸èƒ½é‡æµåŠ¨ï¼Œç†è§£ä¸¤è€…çš„æœ¬è´¨å·®å¼‚ã€‚
                <br><br>
                ç‚¹å‡»ç”»å¸ƒä¸­çš„ä»»ä½•å…ƒç´ ï¼ˆå‚¨åº“ã€ç”Ÿç‰©è§’è‰²ã€è¿‡ç¨‹ç®­å¤´ï¼‰æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ã€‚
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        const canvas = document.getElementById('ecosystemCanvas');
        const ctx = canvas.getContext('2d');
        let animationId = null;
        let isPlaying = true;
        let currentMode = 'carbon';
        let animationSpeed = 1.0;
        let time = 0;
        
        // äººç±»æ´»åŠ¨å½±å“å‚æ•°
        let humanImpact = {
            fuelBurning: 0.5,    // åŒ–çŸ³ç‡ƒæ–™ç‡ƒçƒ§å¼ºåº¦ (0-1)
            deforestation: 0.3,  // æ£®æ—ç ä¼ç¨‹åº¦ (0-1)
            fertilizerUse: 0.4   // åŒ–è‚¥ä½¿ç”¨å¼ºåº¦ (0-1)
        };
        
        // æ•°æ®çŠ¶æ€
        let dataState = {
            co2Concentration: 415,  // ppm
            temperatureChange: 1.2, // Â°C
            nitrogenFixed: 140,     // Tg/å¹´
            energyEfficiency: 10    // %
        };
        
        // ç”Ÿæ€ç³»ç»Ÿå…ƒç´ å®šä¹‰
        const elements = {
            reservoirs: [
                { id: 'atmosphere', name: 'å¤§æ°”', x: 550, y: 100, radius: 80, color: '#81d4fa', type: 'carbon', content: 'COâ‚‚, Nâ‚‚' },
                { id: 'forest', name: 'æ£®æ—', x: 300, y: 400, radius: 70, color: '#66bb6a', type: 'carbon', content: 'æœ‰æœºç¢³' },
                { id: 'ocean', name: 'æµ·æ´‹', x: 800, y: 500, radius: 90, color: '#29b6f6', type: 'carbon', content: 'æº¶è§£ç¢³' },
                { id: 'soil', name: 'åœŸå£¤', x: 550, y: 550, radius: 60, color: '#8d6e63', type: 'both', content: 'æœ‰æœºè´¨, ç¡é…¸ç›' },
                { id: 'fossil', name: 'åŒ–çŸ³ç‡ƒæ–™', x: 850, y: 300, radius: 50, color: '#5d4037', type: 'carbon', content: 'ç…¤, çŸ³æ²¹, å¤©ç„¶æ°”' }
            ],
            
            organisms: [
                { id: 'producers', name: 'ç”Ÿäº§è€…', x: 300, y: 300, radius: 40, color: '#81c784', type: 'both' },
                { id: 'consumers', name: 'æ¶ˆè´¹è€…', x: 400, y: 350, radius: 35, color: '#ffb74d', type: 'both' },
                { id: 'decomposers', name: 'åˆ†è§£è€…', x: 550, y: 600, radius: 30, color: '#ba68c8', type: 'both' },
                { id: 'nitrogenFixers', name: 'å›ºæ°®ç”Ÿç‰©', x: 700, y: 400, radius: 35, color: '#64b5f6', type: 'nitrogen' }
            ],
            
            processes: [
                { id: 'photosynthesis', name: 'å…‰åˆä½œç”¨', from: 'atmosphere', to: 'producers', color: '#4caf50', width: 4, type: 'carbon' },
                { id: 'respiration', name: 'å‘¼å¸ä½œç”¨', from: 'producers', to: 'atmosphere', color: '#ff9800', width: 3, type: 'carbon' },
                { id: 'consumption', name: 'æ‘„é£Ÿ', from: 'producers', to: 'consumers', color: '#ffb74d', width: 3, type: 'both' },
                { id: 'decomposition', name: 'åˆ†è§£ä½œç”¨', from: 'consumers', to: 'soil', color: '#8d6e63', width: 3, type: 'both' },
                { id: 'fossilBurning', name: 'åŒ–çŸ³ç‡ƒæ–™ç‡ƒçƒ§', from: 'fossil', to: 'atmosphere', color: '#f44336', width: 4, type: 'carbon' },
                { id: 'oceanUptake', name: 'æµ·æ´‹å¸æ”¶', from: 'atmosphere', to: 'ocean', color: '#29b6f6', width: 3, type: 'carbon' },
                { id: 'nitrogenFixation', name: 'å›ºæ°®ä½œç”¨', from: 'atmosphere', to: 'nitrogenFixers', color: '#7986cb', width: 4, type: 'nitrogen' },
                { id: 'nitrogenToSoil', name: 'æ°®è¿›å…¥åœŸå£¤', from: 'nitrogenFixers', to: 'soil', color: '#9575cd', width: 3, type: 'nitrogen' },
                { id: 'plantUptake', name: 'æ¤ç‰©å¸æ”¶', from: 'soil', to: 'producers', color: '#4db6ac', width: 3, type: 'both' }
            ],
            
            energyFlow: [
                { id: 'sunToProducers', name: 'å¤ªé˜³èƒ½è¾“å…¥', from: {x: 100, y: 150}, to: 'producers', color: '#ffeb3b', width: 5, type: 'energy' },
                { id: 'producersToConsumers', name: 'åˆçº§æ¶ˆè´¹è€…', from: 'producers', to: 'consumers', color: '#ffb74d', width: 4, type: 'energy' },
                { id: 'consumersToDecomposers', name: 'æ¬¡çº§æ¶ˆè´¹è€…/åˆ†è§£', from: 'consumers', to: 'decomposers', color: '#ff9800', width: 3, type: 'energy' },
                { id: 'energyLoss', name: 'çƒ­èƒ½æ•£å¤±', from: 'decomposers', to: {x: 1000, y: 100}, color: '#f44336', width: 2, type: 'energy' }
            ]
        };
        
        // ç²’å­ç³»ç»Ÿ
        const particles = {
            carbon: [],
            nitrogen: [],
            energy: []
        };
        
        // åˆå§‹åŒ–ç²’å­
        function initParticles() {
            particles.carbon = [];
            particles.nitrogen = [];
            particles.energy = [];
            
            // åˆ›å»ºç¢³ç²’å­
            for (let i = 0; i < 50; i++) {
                particles.carbon.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: 4 + Math.random() * 3,
                    speed: 0.5 + Math.random() * 1,
                    path: null,
                    progress: Math.random(),
                    color: '#4db6ac'
                });
            }
            
            // åˆ›å»ºæ°®ç²’å­
            for (let i = 0; i < 40; i++) {
                particles.nitrogen.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: 4 + Math.random() * 3,
                    speed: 0.5 + Math.random() * 1,
                    path: null,
                    progress: Math.random(),
                    color: '#7986cb'
                });
            }
            
            // åˆ›å»ºèƒ½é‡ç²’å­
            for (let i = 0; i < 30; i++) {
                particles.energy.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: 5 + Math.random() * 4,
                    speed: 1 + Math.random() * 1.5,
                    path: null,
                    progress: Math.random(),
                    color: '#ffb74d',
                    glow: true
                });
            }
        }
        
        // è·å–å…ƒç´ ä½ç½®
        function getElementPosition(id) {
            // æ£€æŸ¥æ˜¯å¦æ˜¯å‚¨åº“
            const reservoir = elements.reservoirs.find(r => r.id === id);
            if (reservoir) return {x: reservoir.x, y: reservoir.y};
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯ç”Ÿç‰©
            const organism = elements.organisms.find(o => o.id === id);
            if (organism) return {x: organism.x, y: organism.y};
            
            return null;
        }
        
        // ç»˜åˆ¶èƒŒæ™¯
        function drawBackground() {
            // å¤©ç©ºæ¸å˜
            const skyGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            skyGradient.addColorStop(0, '#0a1a2d');
            skyGradient.addColorStop(1, '#1a3a5f');
            ctx.fillStyle = skyGradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // é™†åœ°
            ctx.fillStyle = '#2e7d32';
            ctx.beginPath();
            ctx.moveTo(0, canvas.height);
            ctx.bezierCurveTo(200, 500, 400, 550, canvas.width, canvas.height);
            ctx.lineTo(canvas.width, canvas.height);
            ctx.lineTo(0, canvas.height);
            ctx.closePath();
            ctx.fill();
            
            // æµ·æ´‹
            ctx.fillStyle = '#1565c0';
            ctx.beginPath();
            ctx.moveTo(0, canvas.height);
            ctx.bezierCurveTo(300, 600, 700, 550, canvas.width, canvas.height);
            ctx.lineTo(canvas.width, canvas.height);
            ctx.lineTo(0, canvas.height);
            ctx.closePath();
            ctx.fill();
            
            // å¤ªé˜³ï¼ˆèƒ½é‡æ¨¡å¼ï¼‰
            if (currentMode === 'energy' || currentMode === 'compare') {
                ctx.beginPath();
                const sunX = 100, sunY = 150, sunRadius = 40;
                const sunGradient = ctx.createRadialGradient(sunX, sunY, 5, sunX, sunY, sunRadius);
                sunGradient.addColorStop(0, '#ffff00');
                sunGradient.addColorStop(1, '#ff9800');
                ctx.fillStyle = sunGradient;
                ctx.arc(sunX, sunY, sunRadius, 0, Math.PI * 2);
                ctx.fill();
                
                // å¤ªé˜³å…‰èŠ’
                ctx.strokeStyle = 'rgba(255, 235, 59, 0.7)';
                ctx.lineWidth = 3;
                for (let i = 0; i < 12; i++) {
                    const angle = (i * Math.PI) / 6;
                    const startX = sunX + Math.cos(angle) * sunRadius;
                    const startY = sunY + Math.sin(angle) * sunRadius;
                    const endX = sunX + Math.cos(angle) * (sunRadius + 25);
                    const endY = sunY + Math.sin(angle) * (sunRadius + 25);
                    
                    ctx.beginPath();
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(endX, endY);
                    ctx.stroke();
                }
                
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('å¤ªé˜³', sunX, sunY + sunRadius + 25);
            }
        }
        
        // ç»˜åˆ¶å‚¨åº“
        function drawReservoirs() {
            elements.reservoirs.forEach(reservoir => {
                // æ ¹æ®å½“å‰æ¨¡å¼å†³å®šæ˜¯å¦ç»˜åˆ¶
                if (currentMode === 'carbon' && !reservoir.type.includes('carbon')) return;
                if (currentMode === 'nitrogen' && !reservoir.type.includes('both')) return;
                if (currentMode === 'energy') return;
                
                // ç»˜åˆ¶å‚¨åº“åœ†åœˆ
                ctx.beginPath();
                ctx.arc(reservoir.x, reservoir.y, reservoir.radius, 0, Math.PI * 2);
                
                // æ ¹æ®äººç±»å½±å“è°ƒæ•´é¢œè‰²
                let color = reservoir.color;
                if (reservoir.id === 'atmosphere' && humanImpact.fuelBurning > 0.5) {
                    color = '#ff8a65'; // å¤§æ°”å—æ±¡æŸ“å˜æ©™è‰²
                }
                if (reservoir.id === 'forest' && humanImpact.deforestation > 0.5) {
                    color = '#a1887f'; // æ£®æ—ç ä¼å˜æ£•è‰²
                }
                
                ctx.fillStyle = color + '80'; // 80è¡¨ç¤º50%é€æ˜åº¦
                ctx.fill();
                
                ctx.strokeStyle = color;
                ctx.lineWidth = 3;
                ctx.stroke();
                
                // ç»˜åˆ¶å‚¨åº“æ ‡ç­¾
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 18px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(reservoir.name, reservoir.x, reservoir.y - reservoir.radius - 10);
                
                // ç»˜åˆ¶å‚¨åº“å†…å®¹
                ctx.font = '14px Arial';
                ctx.fillText(reservoir.content, reservoir.x, reservoir.y + 5);
            });
        }
        
        // ç»˜åˆ¶ç”Ÿç‰©
        function drawOrganisms() {
            elements.organisms.forEach(organism => {
                // æ ¹æ®å½“å‰æ¨¡å¼å†³å®šæ˜¯å¦ç»˜åˆ¶
                if (currentMode === 'carbon' && organism.type === 'nitrogen') return;
                if (currentMode === 'nitrogen' && organism.type === 'carbon') return;
                if (currentMode === 'energy' && organism.id !== 'producers' && 
                    organism.id !== 'consumers' && organism.id !== 'decomposers') return;
                
                // ç»˜åˆ¶ç”Ÿç‰©åœ†åœˆ
                ctx.beginPath();
                ctx.arc(organism.x, organism.y, organism.radius, 0, Math.PI * 2);
                ctx.fillStyle = organism.color + '80';
                ctx.fill();
                
                ctx.strokeStyle = organism.color;
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // ç»˜åˆ¶ç”Ÿç‰©æ ‡ç­¾
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                
                // æ ¹æ®ç”Ÿç‰©ç±»å‹è°ƒæ•´æ ‡ç­¾ä½ç½®
                let labelY = organism.y - organism.radius - 10;
                if (organism.id === 'decomposers') labelY = organism.y + organism.radius + 20;
                
                ctx.fillText(organism.name, organism.x, labelY);
            });
        }
        
        // ç»˜åˆ¶è¿‡ç¨‹ç®­å¤´
        function drawProcesses() {
            // ç»˜åˆ¶ç‰©è´¨å¾ªç¯è¿‡ç¨‹
            if (currentMode !== 'energy') {
                elements.processes.forEach(process => {
                    // æ ¹æ®å½“å‰æ¨¡å¼è¿‡æ»¤
                    if (currentMode === 'carbon' && process.type !== 'carbon') return;
                    if (currentMode === 'nitrogen' && process.type !== 'nitrogen') return;
                    
                    const fromPos = getElementPosition(process.from);
                    const toPos = getElementPosition(process.to);
                    
                    if (!fromPos || !toPos) return;
                    
                    drawArrow(fromPos.x, fromPos.y, toPos.x, toPos.y, process.color, process.width, process.name);
                });
            }
            
            // ç»˜åˆ¶èƒ½é‡æµåŠ¨è¿‡ç¨‹
            if (currentMode === 'energy' || currentMode === 'compare') {
                elements.energyFlow.forEach(flow => {
                    let fromPos, toPos;
                    
                    // å¤„ç†èµ·å§‹ç‚¹
                    if (typeof flow.from === 'object') {
                        fromPos = flow.from;
                    } else {
                        fromPos = getElementPosition(flow.from);
                    }
                    
                    // å¤„ç†ç»ˆç‚¹
                    if (typeof flow.to === 'object') {
                        toPos = flow.to;
                    } else {
                        toPos = getElementPosition(flow.to);
                    }
                    
                    if (!fromPos || !toPos) return;
                    
                    // èƒ½é‡æµåŠ¨ä½¿ç”¨ä¸åŒçš„ç®­å¤´æ ·å¼
                    drawEnergyArrow(fromPos.x, fromPos.y, toPos.x, toPos.y, flow.color, flow.width, flow.name);
                });
            }
        }
        
        // ç»˜åˆ¶æ™®é€šç®­å¤´
        function drawArrow(fromX, fromY, toX, toY, color, width, label) {
            // è®¡ç®—è§’åº¦
            const angle = Math.atan2(toY - fromY, toX - fromX);
            const headLength = 15;
            const distance = Math.sqrt(Math.pow(toX - fromX, 2) + Math.pow(toY - fromY, 2));
            
            // è°ƒæ•´èµ·ç‚¹å’Œç»ˆç‚¹ï¼Œé¿å…ä¸åœ†åœˆé‡å 
            const fromElement = [...elements.reservoirs, ...elements.organisms].find(e => 
                Math.abs(e.x - fromX) < 5 && Math.abs(e.y - fromY) < 5);
            const toElement = [...elements.reservoirs, ...elements.organisms].find(e => 
                Math.abs(e.x - toX) < 5 && Math.abs(e.y - toY) < 5);
            
            let startX = fromX, startY = fromY;
            let endX = toX, endY = toY;
            
            if (fromElement) {
                const radius = fromElement.radius + 5;
                startX = fromX + Math.cos(angle) * radius;
                startY = fromY + Math.sin(angle) * radius;
            }
            
            if (toElement) {
                const radius = toElement.radius + 5;
                endX = toX - Math.cos(angle) * radius;
                endY = toY - Math.sin(angle) * radius;
            }
            
            // ç»˜åˆ¶ç®­å¤´çº¿
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(endX, endY);
            ctx.strokeStyle = color;
            ctx.lineWidth = width;
            ctx.stroke();
            
            // ç»˜åˆ¶ç®­å¤´å¤´éƒ¨
            ctx.beginPath();
            ctx.moveTo(endX, endY);
            ctx.lineTo(
                endX - headLength * Math.cos(angle - Math.PI / 7),
                endY - headLength * Math.sin(angle - Math.PI / 7)
            );
            ctx.lineTo(
                endX - headLength * Math.cos(angle + Math.PI / 7),
                endY - headLength * Math.sin(angle + Math.PI / 7)
            );
            ctx.closePath();
            ctx.fillStyle = color;
            ctx.fill();
            
            // ç»˜åˆ¶è¿‡ç¨‹æ ‡ç­¾
            if (label && distance > 80) {
                const midX = (startX + endX) / 2;
                const midY = (startY + endY) / 2;
                
                ctx.save();
                ctx.translate(midX, midY);
                ctx.rotate(angle);
                
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(label, 0, -10);
                
                ctx.restore();
            }
        }
        
        // ç»˜åˆ¶èƒ½é‡ç®­å¤´ï¼ˆæ¸å˜ã€å‘å…‰æ•ˆæœï¼‰
        function drawEnergyArrow(fromX, fromY, toX, toY, color, width, label) {
            const angle = Math.atan2(toY - fromY, toX - fromX);
            const headLength = 20;
            const distance = Math.sqrt(Math.pow(toX - fromX, 2) + Math.pow(toY - fromY, 2));
            
            // è°ƒæ•´èµ·ç‚¹å’Œç»ˆç‚¹
            const fromElement = [...elements.reservoirs, ...elements.organisms].find(e => 
                Math.abs(e.x - fromX) < 5 && Math.abs(e.y - fromY) < 5);
            const toElement = [...elements.reservoirs, ...elements.organisms].find(e => 
                Math.abs(e.x - toX) < 5 && Math.abs(e.y - toY) < 5);
            
            let startX = fromX, startY = fromY;
            let endX = toX, endY = toY;
            
            if (fromElement) {
                const radius = fromElement.radius + 5;
                startX = fromX + Math.cos(angle) * radius;
                startY = fromY + Math.sin(angle) * radius;
            }
            
            if (toElement) {
                const radius = toElement.radius + 5;
                endX = toX - Math.cos(angle) * radius;
                endY = toY - Math.sin(angle) * radius;
            }
            
            // åˆ›å»ºèƒ½é‡æµåŠ¨çš„æ¸å˜
            const gradient = ctx.createLinearGradient(startX, startY, endX, endY);
            gradient.addColorStop(0, color);
            gradient.addColorStop(1, '#f44336'); // èƒ½é‡é€æ¸è€—æ•£ä¸ºçƒ­èƒ½
            
            // ç»˜åˆ¶èƒ½é‡æµçº¿
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(endX, endY);
            ctx.strokeStyle = gradient;
            ctx.lineWidth = width;
            ctx.lineCap = 'round';
            ctx.stroke();
            
            // æ·»åŠ å‘å…‰æ•ˆæœ
            ctx.shadowColor = color;
            ctx.shadowBlur =
<!--æ£€æµ‹åˆ°ä»£ç æˆªæ–­ï¼Œè‡ªåŠ¨ç»­å†™ä¸­...-->
15;
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(endX, endY);
            ctx.stroke();
            ctx.shadowBlur = 0;
            
            // ç»˜åˆ¶ç®­å¤´å¤´éƒ¨
            ctx.beginPath();
            ctx.moveTo(endX, endY);
            ctx.lineTo(
                endX - headLength * Math.cos(angle - Math.PI / 7),
                endY - headLength * Math.sin(angle - Math.PI / 7)
            );
            ctx.lineTo(
                endX - headLength * Math.cos(angle + Math.PI / 7),
                endY - headLength * Math.sin(angle + Math.PI / 7)
            );
            ctx.closePath();
            ctx.fillStyle = gradient;
            ctx.fill();
            
            // ç»˜åˆ¶èƒ½é‡æ ‡ç­¾
            if (label && distance > 80) {
                const midX = (startX + endX) / 2;
                const midY = (startY + endY) / 2;
                
                ctx.save();
                ctx.translate(midX, midY);
                ctx.rotate(angle);
                
                ctx.fillStyle = '#ffeb3b';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(label, 0, -15);
                
                // ç»˜åˆ¶èƒ½é‡æŸå¤±ç™¾åˆ†æ¯”ï¼ˆä»…å¯¹èƒ½é‡æµåŠ¨ï¼‰
                if (label.includes('æ¶ˆè´¹è€…') || label.includes('åˆ†è§£')) {
                    const efficiency = label.includes('åˆçº§') ? '10%' : '1%';
                    ctx.font = '12px Arial';
                    ctx.fillText(`æ•ˆç‡: ${efficiency}`, 0, 5);
                }
                
                ctx.restore();
            }
        }
        
        // ç»˜åˆ¶ç²’å­
        function drawParticles() {
            // æ›´æ–°å¹¶ç»˜åˆ¶ç¢³ç²’å­
            if (currentMode === 'carbon' || currentMode === 'compare') {
                particles.carbon.forEach(particle => {
                    // æ›´æ–°ç²’å­ä½ç½®
                    particle.progress += 0.005 * animationSpeed;
                    if (particle.progress > 1) particle.progress = 0;
                    
                    // è®©ç²’å­æ²¿ç®€å•è·¯å¾„ç§»åŠ¨
                    particle.x = 550 + Math.cos(time * 0.5 + particle.progress * Math.PI * 2) * 400;
                    particle.y = 350 + Math.sin(time * 0.3 + particle.progress * Math.PI * 2) * 250;
                    
                    // ç»˜åˆ¶ç²’å­
                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                    ctx.fillStyle = particle.color;
                    ctx.fill();
                    
                    // æ·»åŠ è½»å¾®å‘å…‰æ•ˆæœ
                    ctx.shadowColor = particle.color;
                    ctx.shadowBlur = 8;
                    ctx.fill();
                    ctx.shadowBlur = 0;
                });
            }
            
            // æ›´æ–°å¹¶ç»˜åˆ¶æ°®ç²’å­
            if (currentMode === 'nitrogen' || currentMode === 'compare') {
                particles.nitrogen.forEach(particle => {
                    particle.progress += 0.004 * animationSpeed;
                    if (particle.progress > 1) particle.progress = 0;
                    
                    particle.x = 550 + Math.cos(time * 0.4 + particle.progress * Math.PI * 2) * 350;
                    particle.y = 400 + Math.sin(time * 0.5 + particle.progress * Math.PI * 2) * 200;
                    
                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                    ctx.fillStyle = particle.color;
                    ctx.fill();
                    
                    ctx.shadowColor = particle.color;
                    ctx.shadowBlur = 8;
                    ctx.fill();
                    ctx.shadowBlur = 0;
                });
            }
            
            // æ›´æ–°å¹¶ç»˜åˆ¶èƒ½é‡ç²’å­
            if (currentMode === 'energy' || currentMode === 'compare') {
                particles.energy.forEach(particle => {
                    particle.progress += 0.008 * animationSpeed;
                    if (particle.progress > 1) particle.progress = 0;
                    
                    // èƒ½é‡ç²’å­æ²¿èƒ½é‡æµåŠ¨è·¯å¾„ç§»åŠ¨
                    const pathProgress = particle.progress;
                    let x, y;
                    
                    if (pathProgress < 0.25) {
                        // ä»å¤ªé˜³åˆ°ç”Ÿäº§è€…
                        x = 100 + (300 - 100) * (pathProgress * 4);
                        y = 150 + (300 - 150) * (pathProgress * 4);
                    } else if (pathProgress < 0.5) {
                        // ä»ç”Ÿäº§è€…åˆ°æ¶ˆè´¹è€…
                        x = 300 + (400 - 300) * ((pathProgress - 0.25) * 4);
                        y = 300 + (350 - 300) * ((pathProgress - 0.25) * 4);
                    } else if (pathProgress < 0.75) {
                        // ä»æ¶ˆè´¹è€…åˆ°åˆ†è§£è€…
                        x = 400 + (550 - 400) * ((pathProgress - 0.5) * 4);
                        y = 350 + (600 - 350) * ((pathProgress - 0.5) * 4);
                    } else {
                        // ä»åˆ†è§£è€…æ•£å¤±åˆ°å¤§æ°”
                        x = 550 + (1000 - 550) * ((pathProgress - 0.75) * 4);
                        y = 600 + (100 - 600) * ((pathProgress - 0.75) * 4);
                    }
                    
                    particle.x = x;
                    particle.y = y;
                    
                    // éšç€èƒ½é‡ä¼ é€’ï¼Œç²’å­å˜å°å˜æš—
                    const sizeFactor = 1 - (pathProgress * 0.7);
                    const alpha = 1 - (pathProgress * 0.8);
                    
                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, particle.size * sizeFactor, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(255, 183, 77, ${alpha})`;
                    ctx.fill();
                    
                    if (particle.glow) {
                        ctx.shadowColor = '#ffeb3b';
                        ctx.shadowBlur = 15;
                        ctx.fill();
                        ctx.shadowBlur = 0;
                    }
                });
            }
        }
        
        // ç»˜åˆ¶äººç±»æ´»åŠ¨å½±å“
        function drawHumanImpact() {
            // ç»˜åˆ¶åŒ–çŸ³ç‡ƒæ–™ç‡ƒçƒ§æ•ˆæœ
            if (humanImpact.fuelBurning > 0.3 && (currentMode === 'carbon' || currentMode === 'compare')) {
                const intensity = humanImpact.fuelBurning;
                const fossil = elements.reservoirs.find(r => r.id === 'fossil');
                
                // ç»˜åˆ¶çƒŸé›¾
                for (let i = 0; i < 5 * intensity; i++) {
                    const smokeX = fossil.x + Math.cos(time * 2 + i) * 30;
                    const smokeY = fossil.y - 50 - (time * 20 + i * 10) % 100;
                    const smokeSize = 10 + Math.sin(time + i) * 5;
                    
                    ctx.beginPath();
                    ctx.arc(smokeX, smokeY, smokeSize, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(100, 100, 100, ${0.3 * intensity})`;
                    ctx.fill();
                }
                
                // ç»˜åˆ¶ç«ç„°
                if (intensity > 0.5) {
                    ctx.fillStyle = `rgba(255, 69, 0, ${0.6 * intensity})`;
                    ctx.beginPath();
                    ctx.moveTo(fossil.x - 20, fossil.y);
                    ctx.bezierCurveTo(
                        fossil.x - 15, fossil.y - 40,
                        fossil.x + 15, fossil.y - 40,
                        fossil.x + 20, fossil.y
                    );
                    ctx.bezierCurveTo(
                        fossil.x + 10, fossil.y - 20,
                        fossil.x - 10, fossil.y - 20,
                        fossil.x - 20, fossil.y
                    );
                    ctx.closePath();
                    ctx.fill();
                }
            }
            
            // ç»˜åˆ¶æ£®æ—ç ä¼æ•ˆæœ
            if (humanImpact.deforestation > 0.3 && (currentMode === 'carbon' || currentMode === 'compare')) {
                const forest = elements.reservoirs.find(r => r.id === 'forest');
                const stumpsCount = Math.floor(humanImpact.deforestation * 5);
                
                // ç»˜åˆ¶æ ‘æ¡©
                for (let i = 0; i < stumpsCount; i++) {
                    const stumpX = forest.x - 40 + (i % 3) * 40;
                    const stumpY = forest.y - 20 + Math.floor(i / 3) * 30;
                    
                    ctx.fillStyle = '#8d6e63';
                    ctx.fillRect(stumpX - 5, stumpY - 5, 10, 10);
                    
                    // å¹´è½®
                    ctx.strokeStyle = '#5d4037';
                    ctx.beginPath();
                    ctx.arc(stumpX, stumpY, 3, 0, Math.PI * 2);
                    ctx.stroke();
                }
            }
            
            // ç»˜åˆ¶åŒ–è‚¥ä½¿ç”¨æ•ˆæœï¼ˆæ°®æ±¡æŸ“ï¼‰
            if (humanImpact.fertilizerUse > 0.3 && (currentMode === 'nitrogen' || currentMode === 'compare')) {
                const soil = elements.reservoirs.find(r => r.id === 'soil');
                
                // ç»˜åˆ¶åŒ–è‚¥é¢—ç²’
                for (let i = 0; i < 10 * humanImpact.fertilizerUse; i++) {
                    const grainX = soil.x - 30 + Math.random() * 60;
                    const grainY = soil.y - 20 + Math.random() * 40;
                    const grainSize = 2 + Math.random() * 3;
                    
                    ctx.beginPath();
                    ctx.arc(grainX, grainY, grainSize, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(255, 235, 59, ${0.7 * humanImpact.fertilizerUse})`;
                    ctx.fill();
                }
                
                // ç»˜åˆ¶æ°´ä½“å¯Œè¥å…»åŒ–ï¼ˆå¦‚æœæµ·æ´‹å¯è§ï¼‰
                if (currentMode !== 'carbon') {
                    const ocean = elements.reservoirs.find(r => r.id === 'ocean');
                    ctx.fillStyle = `rgba(76, 175, 80, ${0.3 * humanImpact.fertilizerUse})`;
                    ctx.beginPath();
                    ctx.arc(ocean.x, ocean.y, ocean.radius * 0.9, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
        }
        
        // æ›´æ–°æ•°æ®å±•ç¤º
        function updateDataDisplay() {
            // æ ¹æ®äººç±»æ´»åŠ¨å½±å“æ›´æ–°æ•°æ®
            dataState.co2Concentration = 415 + humanImpact.fuelBurning * 100 + humanImpact.deforestation * 50;
            dataState.temperatureChange = 1.2 + (humanImpact.fuelBurning * 0.8) + (humanImpact.deforestation * 0.4);
            dataState.nitrogenFixed = 140 + humanImpact.fertilizerUse * 60;
            
            // èƒ½é‡æ•ˆç‡éšç€æ±¡æŸ“ç•¥å¾®é™ä½
            dataState.energyEfficiency = 10 - (humanImpact.fuelBurning * 2) - (humanImpact.fertilizerUse * 1);
            if (dataState.energyEfficiency < 5) dataState.energyEfficiency = 5;
            
            // æ›´æ–°DOMå…ƒç´ 
            document.getElementById('co2Value').textContent = Math.round(dataState.co2Concentration) + ' ppm';
            document.getElementById('tempValue').textContent = '+' + dataState.temperatureChange.toFixed(1) + 'Â°C';
            document.getElementById('nitrogenValue').textContent = Math.round(dataState.nitrogenFixed) + ' Tg/å¹´';
            document.getElementById('energyValue').textContent = dataState.energyEfficiency.toFixed(1) + '%';
            
            // æ›´æ–°æ»‘å—å€¼æ˜¾ç¤º
            document.getElementById('fuelValue').textContent = Math.round(humanImpact.fuelBurning * 100) + '%';
            document.getElementById('deforestValue').textContent = Math.round(humanImpact.deforestation * 100) + '%';
            document.getElementById('fertilizerValue').textContent = Math.round(humanImpact.fertilizerUse * 100) + '%';
        }
        
        // ä¸»ç»˜åˆ¶å‡½æ•°
        function draw() {
            // æ¸…é™¤ç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶èƒŒæ™¯
            drawBackground();
            
            // ç»˜åˆ¶ç”Ÿæ€ç³»ç»Ÿå…ƒç´ 
            drawReservoirs();
            drawOrganisms();
            drawProcesses();
            
            // ç»˜åˆ¶äººç±»æ´»åŠ¨å½±å“
            drawHumanImpact();
            
            // ç»˜åˆ¶ç²’å­
            drawParticles();
            
            // æ›´æ–°æ—¶é—´
            time += 0.05 * animationSpeed;
            
            // æ›´æ–°æ•°æ®å±•ç¤º
            updateDataDisplay();
            
            // ç»§ç»­åŠ¨ç”»å¾ªç¯
            if (isPlaying) {
                animationId = requestAnimationFrame(draw);
            }
        }
        
        // å¤„ç†ç”»å¸ƒç‚¹å‡»äº‹ä»¶
        function handleCanvasClick(event) {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†å‚¨åº“
            for (const reservoir of elements.reservoirs) {
                const distance = Math.sqrt(Math.pow(x - reservoir.x, 2) + Math.pow(y - reservoir.y, 2));
                if (distance <= reservoir.radius) {
                    showInfo(reservoir.name, getReservoirInfo(reservoir.id));
                    return;
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†ç”Ÿç‰©
            for (const organism of elements.organisms) {
                const distance = Math.sqrt(Math.pow(x - organism.x, 2) + Math.pow(y - organism.y, 2));
                if (distance <= organism.radius) {
                    showInfo(organism.name, getOrganismInfo(organism.id));
                    return;
                }
            }
            
            // å¦‚æœæ²¡æœ‰ç‚¹å‡»ä»»ä½•å…ƒç´ ï¼Œæ˜¾ç¤ºé»˜è®¤ä¿¡æ¯
            showDefaultInfo();
        }
        
        // è·å–å‚¨åº“ä¿¡æ¯
        function getReservoirInfo(id) {
            const info = {
                atmosphere: `å¤§æ°”æ˜¯ç¢³å¾ªç¯å’Œæ°®å¾ªç¯çš„å…³é”®å‚¨åº“ã€‚<br><br>
                           <span class="highlight">ç¢³å¾ªç¯</span>: å¤§æ°”ä¸­å«æœ‰äºŒæ°§åŒ–ç¢³(COâ‚‚)ï¼Œæ˜¯å…‰åˆä½œç”¨çš„åŸæ–™ï¼Œä¹Ÿæ˜¯å‘¼å¸ä½œç”¨å’Œç‡ƒçƒ§çš„äº§ç‰©ã€‚<br>
                           <span class="highlight">æ°®å¾ªç¯</span>: å¤§æ°”ä¸­78%æ˜¯æ°®æ°”(Nâ‚‚)ï¼Œä½†å¤§å¤šæ•°ç”Ÿç‰©æ— æ³•ç›´æ¥åˆ©ç”¨ã€‚<br><br>
                           å½“å‰COâ‚‚æµ“åº¦: <span class="highlight">${dataState.co2Concentration.toFixed(0)} ppm</span><br>
                           äººç±»æ´»åŠ¨ä½¿å¤§æ°”COâ‚‚æµ“åº¦æ¯”å·¥ä¸šé©å‘½å‰å¢åŠ äº†çº¦50%ã€‚`,
                
                forest: `æ£®æ—æ˜¯é‡è¦çš„ç¢³æ±‡å’Œç”Ÿç‰©å¤šæ ·æ€§å®åº“ã€‚<br><br>
                        <span class="highlight">ç¢³å‚¨å­˜</span>: æ£®æ—é€šè¿‡å…‰åˆä½œç”¨å¸æ”¶å¤§æ°”ä¸­çš„COâ‚‚ï¼Œå°†ç¢³å›ºå®šåœ¨ç”Ÿç‰©è´¨ä¸­ã€‚<br>
                        <span class="highlight">æ°®å¾ªç¯</span>: æ£®æ—å‚ä¸æ°®çš„å¸æ”¶å’Œè½¬åŒ–ï¼Œç»´æŒåœŸå£¤è‚¥åŠ›ã€‚<br><br>
                        å½“å‰æ£®æ—ç ä¼ç¨‹åº¦: <span class="highlight">${Math.round(humanImpact.deforestation * 100)}%</span><br>
                        æ£®æ—ç ä¼ä¼šé‡Šæ”¾å‚¨å­˜çš„ç¢³ï¼ŒåŠ å‰§æ°”å€™å˜åŒ–ã€‚`,
                
                ocean: `æµ·æ´‹æ˜¯åœ°çƒä¸Šæœ€å¤§çš„ç¢³æ±‡ï¼Œå¸æ”¶äº†çº¦30%äººç±»æ’æ”¾çš„COâ‚‚ã€‚<br><br>
                       <span class="highlight">ç¢³å¾ªç¯</span>: æµ·æ´‹é€šè¿‡ç‰©ç†æº¶è§£å’Œç”Ÿç‰©æ³µå¸æ”¶å¤§æ°”COâ‚‚ã€‚<br>
                       <span class="highlight">æ°®å¾ªç¯</span>: æµ·æ´‹ä¸­çš„è“è—»ç­‰ç”Ÿç‰©å¯ä»¥è¿›è¡Œå›ºæ°®ä½œç”¨ã€‚<br><br>
                       æµ·æ´‹é…¸åŒ–: å¸æ”¶è¿‡å¤šCOâ‚‚å¯¼è‡´æµ·æ°´pHå€¼ä¸‹é™ï¼Œå½±å“æµ·æ´‹ç”Ÿç‰©ã€‚`,
                
                soil: `åœŸå£¤æ˜¯ç‰©è´¨å¾ªç¯çš„é‡è¦æ¢çº½ã€‚<br><br>
                      <span class="highlight">ç¢³å¾ªç¯</span>: åœŸå£¤æœ‰æœºè´¨æ˜¯å·¨å¤§çš„ç¢³åº“ï¼Œåˆ†è§£è€…å°†æœ‰æœºç‰©åˆ†è§£ä¸ºCOâ‚‚ã€‚<br>
                      <span class="highlight">æ°®å¾ªç¯</span>: åœŸå£¤ä¸­è¿›è¡Œç€ç¡åŒ–ã€åç¡åŒ–ç­‰å…³é”®æ°®è½¬åŒ–è¿‡ç¨‹ã€‚<br><br>
                      åœŸå£¤å¥åº·ç›´æ¥å½±å“ç”Ÿæ€ç³»ç»Ÿçš„ç”Ÿäº§åŠ›å’Œç¨³å®šæ€§ã€‚`,
                
                fossil: `åŒ–çŸ³ç‡ƒæ–™æ˜¯å¤ä»£ç”Ÿç‰©ç»è¿‡æ•°ç™¾ä¸‡å¹´å½¢æˆçš„ç¢³å‚¨å­˜åº“ã€‚<br><br>
                        <span class="highlight">ç¢³å¾ªç¯</span>: ç‡ƒçƒ§åŒ–çŸ³ç‡ƒæ–™ä¼šå¿«é€Ÿé‡Šæ”¾å¤§é‡COâ‚‚åˆ°å¤§æ°”ä¸­ï¼Œæ‰“ç ´è‡ªç„¶ç¢³å¹³è¡¡ã€‚<br><br>
                        å½“å‰åŒ–çŸ³ç‡ƒæ–™ç‡ƒçƒ§å¼ºåº¦: <span class="highlight">${Math.round(humanImpact.fuelBurning * 100)}%</span><br>
                        è¿™æ˜¯å½“å‰å…¨çƒå˜æš–çš„ä¸»è¦åŸå› ä¹‹ä¸€ã€‚`
            };
            
            return info[id] || "ä¿¡æ¯æœªæ‰¾åˆ°ã€‚";
        }
        
        // è·å–ç”Ÿç‰©ä¿¡æ¯
        function getOrganismInfo(id) {
            const info = {
                producers: `ç”Ÿäº§è€…ï¼ˆä¸»è¦æ˜¯æ¤ç‰©å’Œè—»ç±»ï¼‰æ˜¯ç”Ÿæ€ç³»ç»Ÿçš„èƒ½é‡åŸºç¡€ã€‚<br><br>
                          <span class="highlight">ç¢³å¾ªç¯</span>: é€šè¿‡å…‰åˆä½œç”¨å°†å¤§æ°”COâ‚‚è½¬åŒ–ä¸ºæœ‰æœºç‰©ã€‚<br>
                          <span class="highlight">æ°®å¾ªç¯</span>: å¸æ”¶åœŸå£¤ä¸­çš„æ°®åŒ–åˆç‰©åˆæˆè›‹ç™½è´¨ç­‰æœ‰æœºç‰©ã€‚<br>
                          <span class="highlight">èƒ½é‡æµåŠ¨</span>: å°†å¤ªé˜³èƒ½è½¬åŒ–ä¸ºåŒ–å­¦èƒ½ï¼Œä¾›å…¶ä»–ç”Ÿç‰©åˆ©ç”¨ã€‚<br><br>
                          ç”Ÿäº§è€…å›ºå®šçš„èƒ½é‡åªæœ‰çº¦1%èƒ½è¢«åç»­è¥å…»çº§åˆ©ç”¨ã€‚`,
                
                consumers: `æ¶ˆè´¹è€…é€šè¿‡æ‘„é£Ÿå…¶ä»–ç”Ÿç‰©è·å–èƒ½é‡å’Œç‰©è´¨ã€‚<br><br>
                          <span class="highlight">ç¢³å¾ªç¯</span>: é€šè¿‡å‘¼å¸ä½œç”¨å°†æœ‰æœºç‰©åˆ†è§£ä¸ºCOâ‚‚é‡Šæ”¾å›å¤§æ°”ã€‚<br>
                          <span class="highlight">æ°®å¾ªç¯</span>: é€šè¿‡æ’æ³„å’Œæ­»äº¡å°†æ°®è¿”å›ç¯å¢ƒã€‚<br>
                          <span class="highlight">èƒ½é‡æµåŠ¨</span>: èƒ½é‡ä¼ é€’æ•ˆç‡é€šå¸¸åªæœ‰10%ï¼Œå…¶ä½™ä»¥çƒ­èƒ½æ•£å¤±ã€‚<br><br>
                          æ¶ˆè´¹è€…åœ¨ç‰©è´¨å¾ªç¯å’Œèƒ½é‡æµåŠ¨ä¸­èµ·å…³é”®ä¼ é€’ä½œç”¨ã€‚`,
                
                decomposers: `åˆ†è§£è€…ï¼ˆç»†èŒã€çœŸèŒç­‰ï¼‰æ˜¯ç‰©è´¨å¾ªç¯çš„"æ¸…é“å¤«"ã€‚<br><br>
                            <span class="highlight">ç¢³å¾ªç¯</span>: å°†åŠ¨æ¤ç‰©æ®‹ä½“åˆ†è§£ä¸ºCOâ‚‚å’Œæ— æœºç‰©ã€‚<br>
                            <span class="highlight">æ°®å¾ªç¯</span>: å°†æœ‰æœºæ°®è½¬åŒ–ä¸ºæ— æœºæ°®ï¼Œä¾›æ¤ç‰©é‡æ–°åˆ©ç”¨ã€‚<br><br>
                            æ²¡æœ‰åˆ†è§£è€…ï¼Œç”Ÿæ€ç³»ç»Ÿä¸­çš„ç‰©è´¨å¾ªç¯å°†å¾ˆå¿«åœæ­¢ã€‚`,
                
                nitrogenFixers: `å›ºæ°®ç”Ÿç‰©ï¼ˆå¦‚æ ¹ç˜¤èŒã€è“è—»ï¼‰æ˜¯æ°®å¾ªç¯çš„å…³é”®ã€‚<br><br>
                               <span class="highlight">æ°®å¾ªç¯</span>: å°†å¤§æ°”ä¸­æƒ°æ€§çš„Nâ‚‚è½¬åŒ–ä¸ºç”Ÿç‰©å¯åˆ©ç”¨çš„æ°¨(NHâ‚ƒ)ã€‚<br><br>
                               è‡ªç„¶å›ºæ°®é‡: <span class="highlight">çº¦140 Tg/å¹´</span><br>
                               å·¥ä¸šå›ºæ°®ï¼ˆåŒ–è‚¥ï¼‰å·²æ¥è¿‘ç”šè‡³è¶…è¿‡è‡ªç„¶å›ºæ°®é‡ï¼Œé€ æˆæ°®æ±¡æŸ“ã€‚`
            };
            
            return info[id] || "ä¿¡æ¯æœªæ‰¾åˆ°ã€‚";
        }
        
        // æ˜¾ç¤ºä¿¡æ¯
        function showInfo(title, content) {
            document.getElementById('infoTitle').textContent = title;
            document.getElementById('infoContent').innerHTML = content;
        }
        
        // æ˜¾ç¤ºé»˜è®¤ä¿¡æ¯
        function showDefaultInfo() {
            const modeInfo = {
                carbon: `å½“å‰æ¨¡å¼: <span class="highlight">ç¢³å¾ªç¯</span><br><br>
                        ç¢³å…ƒç´ åœ¨å¤§æ°”ã€ç”Ÿç‰©ã€æµ·æ´‹å’Œåœ°å£³ä¹‹é—´å¾ªç¯ã€‚<br>
                        å…³é”®è¿‡ç¨‹: å…‰åˆä½œç”¨ã€å‘¼å¸ä½œç”¨ã€åˆ†è§£ä½œç”¨ã€åŒ–çŸ³ç‡ƒæ–™ç‡ƒçƒ§ã€‚<br><br>
                        äººç±»æ´»åŠ¨ï¼ˆç‡ƒçƒ§åŒ–çŸ³ç‡ƒæ–™ã€æ¯æ—ï¼‰æ­£åŠ é€Ÿç¢³å¾ªç¯ï¼Œå¯¼è‡´å¤§æ°”COâ‚‚æµ“åº¦å‡é«˜å’Œå…¨çƒå˜æš–ã€‚`,
                
                nitrogen: `å½“å‰æ¨¡å¼: <span class="highlight">æ°®å¾ªç¯</span><br><br>
                          æ°®å…ƒç´ åœ¨å¤§æ°”ã€ç”Ÿç‰©å’ŒåœŸå£¤ä¹‹é—´è½¬åŒ–å¾ªç¯ã€‚<br>
                          å…³é”®è¿‡ç¨‹: å›ºæ°®ä½œç”¨ã€ç¡åŒ–ä½œç”¨ã€åç¡åŒ–ä½œç”¨ã€æ¤ç‰©å¸æ”¶ã€‚<br><br>
                          äººç±»æ´»åŠ¨ï¼ˆåŒ–è‚¥ä½¿ç”¨ã€åŒ–çŸ³ç‡ƒæ–™ç‡ƒçƒ§ï¼‰å¢åŠ äº†æ´»æ€§æ°®å«é‡ï¼Œå¯¼è‡´æ°´ä½“å¯Œè¥å…»åŒ–å’Œæ¸©å®¤æ°”ä½“æ’æ”¾ã€‚`,
                
                energy: `å½“å‰æ¨¡å¼: <span class="highlight">èƒ½é‡æµåŠ¨</span><br><br>
                        èƒ½é‡ä»å¤ªé˜³æµå‘ç”Ÿäº§è€…ï¼Œç„¶åé€šè¿‡é£Ÿç‰©é“¾ä¼ é€’ï¼Œæœ€ç»ˆä»¥çƒ­èƒ½å½¢å¼æ•£å¤±ã€‚<br>
                        å…³é”®ç‰¹å¾: å•å‘æµåŠ¨ã€é€çº§é€’å‡ï¼ˆé€šå¸¸åªæœ‰10%ä¼ é€’åˆ°ä¸‹ä¸€è¥å…»çº§ï¼‰ã€‚<br><br>
                        ä¸ç‰©è´¨å¾ªç¯ä¸åŒï¼Œèƒ½é‡ä¸èƒ½å¾ªç¯åˆ©ç”¨ï¼Œéœ€è¦å¤ªé˜³æŒç»­è¾“å…¥ã€‚`,
                
                compare: `å½“å‰æ¨¡å¼: <span class="highlight">å¯¹æ¯”è§†å›¾</span><br><br>
                         åŒæ—¶å±•ç¤ºç‰©è´¨å¾ªç¯ä¸èƒ½é‡æµåŠ¨ï¼Œç†è§£ä¸¤è€…çš„æœ¬è´¨å·®å¼‚:<br>
                         <span class="highlight">ç‰©è´¨å¾ªç¯</span>: å…ƒç´ ï¼ˆC, Nï¼‰åœ¨ä¸åŒå‚¨åº“é—´å¾€å¤å¾ªç¯ã€‚<br>
                         <span class="highlight">èƒ½é‡æµåŠ¨</span>: èƒ½é‡ä»å¤ªé˜³å•å‘æµåŠ¨ï¼Œæœ€ç»ˆä»¥çƒ­èƒ½æ•£å¤±ã€‚<br><br>
                         ç”Ÿæ€ç³»ç»Ÿä¾é è¿™ä¸¤å¤§è¿‡ç¨‹ç»´æŒåŠŸèƒ½å’Œç¨³å®šã€‚`
            };
            
            document.getElementById('infoTitle').textContent = 'ç”Ÿæ€ç³»ç»ŸåŠ¨æ€';
            document.getElementById('infoContent').innerHTML = modeInfo[currentMode] || "è¯·é€‰æ‹©ä¸€ç§æ¨¡å¼å¼€å§‹æ¢ç´¢ã€‚";
        }
        
        // åˆ‡æ¢æ¨¡å¼
        function switchMode(mode) {
            currentMode = mode;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.mode === mode) {
                    btn.classList.add('active');
                }
            });
            
            // é‡æ–°åˆå§‹åŒ–ç²’å­
            initParticles();
            
            // æ˜¾ç¤ºæ¨¡å¼ä¿¡æ¯
            showDefaultInfo();
            
            // å¦‚æœåŠ¨ç”»æš‚åœï¼Œé‡ç»˜ä¸€å¸§
            if (!isPlaying) {
                draw();
            }
        }
        
        // æ’­æ”¾/æš‚åœåŠ¨ç”»
        function togglePlay() {
            isPlaying = !isPlaying;
            const playBtn = document.getElementById('playBtn');
            
            if (isPlaying) {
                playBtn.textContent = 'â¸ æš‚åœ';
                draw(); // é‡æ–°å¼€å§‹åŠ¨ç”»å¾ªç¯
            } else {
                playBtn.textContent = 'â–¶ æ’­æ”¾';
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }
            }
        }
        
        // é‡ç½®åŠ¨ç”»
        function resetAnimation() {
            time = 0;
            humanImpact.fuelBurning = 0.5;
            humanImpact.deforestation = 0.3;
            humanImpact.fertilizerUse = 0.4;
            
            // é‡ç½®æ»‘å—
            document.getElementById('fuelSlider').value = 50;
            document.getElementById('deforestSlider').value = 30;
            document.getElementById('fertilizerSlider').value = 40;
            
            // æ›´æ–°æ»‘å—æ˜¾ç¤º
            document.getElementById('fuelValue').textContent = '50%';
            document.getElementById('deforestValue').textContent = '30%';
            document.getElementById('fertilizerValue').textContent = '40%';
            
            // é‡æ–°åˆå§‹åŒ–ç²’å­
            initParticles();
            
            // æ˜¾ç¤ºé»˜è®¤ä¿¡æ¯
            showDefaultInfo();
            
            // å¦‚æœåŠ¨ç”»æš‚åœï¼Œé‡ç»˜ä¸€å¸§
            if (!isPlaying) {
                draw();
            }
        }
        
        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initEventListeners() {
            // æ¨¡å¼åˆ‡æ¢æŒ‰é’®
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    switchMode(btn.dataset.mode);
                });
            });
            
            // æ’­æ”¾/æš‚åœæŒ‰é’®
            document.getElementById('playBtn').addEventListener('click', togglePlay);
            
            // é‡ç½®æŒ‰é’®
            document.getElementById('resetBtn').addEventListener('click', resetAnimation);
            
            // é€Ÿåº¦æ»‘å—
            document.getElementById('speedSlider').addEventListener('input', function() {
                animationSpeed = parseFloat(this.value);
                document.getElementById('speedValue').textContent = animationSpeed.toFixed(1) + 'x';
            });
            
            // äººç±»å½±å“æ»‘å—
            document.getElementById('fuelSlider').addEventListener('input', function() {
                humanImpact.fuelBurning = this.value / 100;
                document.getElementById('fuelValue').textContent = this.value + '%';
            });
            
            document.getElementById('deforestSlider').addEventListener('input', function() {
                humanImpact.deforestation = this.value / 100;
                document.getElementById('deforestValue').textContent = this.value + '%';
            });
            
            document.getElementById('fertilizerSlider').addEventListener('input', function() {
                humanImpact.fertilizerUse = this.value / 100;
                document.getElementById('fertilizerValue').textContent = this.value + '%';
            });
            
            // ç”»å¸ƒç‚¹å‡»äº‹ä»¶
            canvas.addEventListener('click', handleCanvasClick);
            
            // çª—å£å¤§å°è°ƒæ•´
            window.addEventListener('resize', function() {
                // å¦‚æœåŠ¨ç”»æš‚åœï¼Œé‡ç»˜ä¸€å¸§ä»¥é€‚åº”æ–°å°ºå¯¸
                if (!isPlaying) {
                    draw();
                }
            });
        }
        
        // åˆå§‹åŒ–å‡½æ•°
        function init() {
            // åˆå§‹åŒ–ç²’å­ç³»ç»Ÿ
            initParticles();
            
            // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
            initEventListeners();
            
            // æ˜¾ç¤ºé»˜è®¤ä¿¡æ¯
            showDefaultInfo();
            
            // å¼€å§‹åŠ¨ç”»å¾ªç¯
            draw();
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>