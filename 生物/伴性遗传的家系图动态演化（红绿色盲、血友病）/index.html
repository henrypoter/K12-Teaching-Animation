<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼´æ€§é—ä¼ å®¶ç³»å›¾åŠ¨æ€æ¼”åŒ– | çº¢ç»¿è‰²ç›²ä¸è¡€å‹ç—…</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #6A5ACD;
        }

        .header h1 {
            color: #6A5ACD;
            margin-bottom: 10px;
            font-size: 2.2rem;
        }

        .header p {
            color: #666;
            max-width: 800px;
            margin: 0 auto;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }

        .main-content {
            flex: 3;
            min-width: 300px;
        }

        .sidebar {
            flex: 1;
            min-width: 280px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid #e9ecef;
        }

        .canvas-container {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid #e9ecef;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        #pedigreeCanvas {
            display: block;
            width: 100%;
            height: 500px;
            background-color: #f8f9fa;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid #e9ecef;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button {
            padding: 10px 18px;
            background-color: #6A5ACD;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        button:hover {
            background-color: #5a4abc;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(106, 90, 205, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background-color: #8A2BE2;
        }

        button.secondary:hover {
            background-color: #7a1bd2;
        }

        select, input[type="range"] {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 14px;
        }

        .checkbox-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .info-panel {
            margin-top: 20px;
            padding: 15px;
            background: #E6F3FF;
            border-radius: 8px;
            border-left: 4px solid #6A5ACD;
        }

        .info-panel h3 {
            color: #6A5ACD;
            margin-bottom: 10px;
        }

        .legend {
            margin-top: 20px;
            padding: 15px;
            background: #F0E6FF;
            border-radius: 8px;
        }

        .legend h3 {
            color: #8A2BE2;
            margin-bottom: 10px;
        }

        .legend-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .legend-symbol {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .tooltip {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #6A5ACD;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            pointer-events: none;
            z-index: 1000;
            max-width: 300px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .tooltip h4 {
            color: #6A5ACD;
            margin-bottom: 8px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .tooltip p {
            margin-bottom: 5px;
            font-size: 14px;
        }

        .stats {
            background: #FFF9C4;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #FFBF00;
        }

        .stats h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .stat-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #FFBF00;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #8A2BE2;
        }

        .highlight {
            color: #FFBF00;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .control-group {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ä¼´æ€§é—ä¼ å®¶ç³»å›¾åŠ¨æ€æ¼”åŒ–</h1>
        <p>æ¢ç´¢XæŸ“è‰²ä½“éšæ€§é—ä¼ è§„å¾‹ï¼šçº¢ç»¿è‰²ç›²ä¸è¡€å‹ç—…çš„é—ä¼ æ¨¡å¼å¯¹æ¯”ä¸å¯è§†åŒ–</p>
    </div>

    <div class="controls">
        <div class="control-group">
            <button id="playBtn" title="æ’­æ”¾åŠ¨ç”»">
                <span>â–¶</span> æ’­æ”¾
            </button>
            <button id="pauseBtn" title="æš‚åœåŠ¨ç”»">
                <span>â¸</span> æš‚åœ
            </button>
            <button id="stepBtn" title="ä¸‹ä¸€æ­¥">
                <span>â­</span> æ­¥è¿›
            </button>
            <button id="resetBtn" title="é‡ç½®åŠ¨ç”»">
                <span>â†º</span> é‡ç½®
            </button>
        </div>

        <div class="control-group">
            <label for="speedSlider">é€Ÿåº¦:</label>
            <input type="range" id="speedSlider" min="1" max="10" value="5">
        </div>

        <div class="control-group">
            <label for="diseaseSelect">æ¡ˆä¾‹é€‰æ‹©:</label>
            <select id="diseaseSelect">
                <option value="colorBlindness">çº¢ç»¿è‰²ç›²ç»å…¸æ¡ˆä¾‹</option>
                <option value="hemophilia">è¡€å‹ç—…çš‡å®¤æ¡ˆä¾‹</option>
                <option value="custom">è‡ªå®šä¹‰æ¡ˆä¾‹</option>
            </select>
        </div>

        <div class="checkbox-group">
            <div class="checkbox-item">
                <input type="checkbox" id="showGenotype" checked>
                <label for="showGenotype">æ˜¾ç¤ºåŸºå› å‹</label>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="showPhenotype" checked>
                <label for="showPhenotype">æ˜¾ç¤ºè¡¨ç°å‹</label>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="showProbability">
                <label for="showProbability">æ˜¾ç¤ºæ¦‚ç‡è®¡ç®—</label>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="main-content">
            <div class="canvas-container">
                <canvas id="pedigreeCanvas"></canvas>
                <div id="tooltip" class="tooltip"></div>
            </div>

            <div class="info-panel">
                <h3>å½“å‰çŠ¶æ€è¯´æ˜</h3>
                <p id="currentInfo">æ­£åœ¨æ¼”ç¤ºçº¢ç»¿è‰²ç›²çš„XæŸ“è‰²ä½“éšæ€§é—ä¼ æ¨¡å¼ã€‚ç”·æ€§æ‚£è€…ï¼ˆXáµƒYï¼‰çš„è‡´ç—…åŸºå› æ¥è‡ªæ¯äº²ï¼ˆæºå¸¦è€…Xá´¬Xáµƒï¼‰ã€‚</p>
            </div>
        </div>

        <div class="sidebar">
            <div class="legend">
                <h3>å›¾ä¾‹è¯´æ˜</h3>
                <div class="legend-items">
                    <div class="legend-item">
                        <div class="legend-symbol" style="background-color: #E6F3FF; border-color: #6A5ACD;">â–¡</div>
                        <span>æ­£å¸¸ç”·æ€§</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-symbol" style="background-color: #E6F3FF; border-color: #6A5ACD;">â—‹</div>
                        <span>æ­£å¸¸å¥³æ€§</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-symbol" style="background-color: #F0E6FF; border-color: #8A2BE2;">â—‹â€¢</div>
                        <span>å¥³æ€§æºå¸¦è€…</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-symbol" style="background-color: #8A2BE2; border-color: #5a1a9e;">â–¡</div>
                        <span>ç”·æ€§æ‚£è€…</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-symbol" style="background-color: #8A2BE2; border-color: #5a1a9e;">â—‹</div>
                        <span>å¥³æ€§æ‚£è€…</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-symbol" style="border-color: #FFBF00; background: none;">â†’</div>
                        <span>åŸºå› ä¼ é€’è·¯å¾„</span>
                    </div>
                </div>
            </div>

            <div class="stats">
                <h3>æ¨¡æ‹Ÿç»Ÿè®¡</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalCount">0</div>
                        <div>æ€»äººæ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="malePatients">0</div>
                        <div>ç”·æ€§æ‚£è€…</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="femalePatients">0</div>
                        <div>å¥³æ€§æ‚£è€…</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="carriers">0</div>
                        <div>æºå¸¦è€…</div>
                    </div>
                </div>
            </div>

            <button id="simulateBtn" class="secondary" style="margin-top: 20px; width: 100%;">
                <span>ğŸ§ª</span> è¿›å…¥æ¨¡æ‹Ÿå®éªŒå®¤
            </button>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        const canvas = document.getElementById('pedigreeCanvas');
        const ctx = canvas.getContext('2d');
        const tooltip = document.getElementById('tooltip');
        const currentInfo = document.getElementById('currentInfo');
        
        // è®¾ç½®Canvaså°ºå¯¸
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }
        
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        
        // é—ä¼ ç³»ç»Ÿ
        class Individual {
            constructor(id, generation, position, gender, genotype, phenotype, parents = []) {
                this.id = id;
                this.generation = generation;
                this.position = position; // {x, y}
                this.gender = gender; // 'male' or 'female'
                this.genotype = genotype; // ä¾‹å¦‚: 'X^A Y', 'X^A X^a'
                this.phenotype = phenotype; // 'normal', 'carrier', 'affected'
                this.parents = parents;
                this.children = [];
                this.spouse = null;
                this.radius = 25;
                this.hovered = false;
                this.selected = false;
            }
            
            draw() {
                // ç»˜åˆ¶ä¸ªä½“
                ctx.save();
                
                // è®¾ç½®é¢œè‰²
                let fillColor, borderColor;
                switch(this.phenotype) {
                    case 'normal':
                        fillColor = this.gender === 'male' ? '#E6F3FF' : '#E6F3FF';
                        borderColor = '#6A5ACD';
                        break;
                    case 'carrier':
                        fillColor = '#F0E6FF';
                        borderColor = '#8A2BE2';
                        break;
                    case 'affected':
                        fillColor = '#8A2BE2';
                        borderColor = '#5a1a9e';
                        break;
                }
                
                // ç»˜åˆ¶å½¢çŠ¶
                ctx.beginPath();
                if (this.gender === 'male') {
                    // æ–¹å½¢
                    ctx.rect(this.position.x - this.radius, this.position.y - this.radius, 
                            this.radius * 2, this.radius * 2);
                } else {
                    // åœ†å½¢
                    ctx.arc(this.position.x, this.position.y, this.radius, 0, Math.PI * 2);
                }
                
                ctx.fillStyle = fillColor;
                ctx.fill();
                ctx.lineWidth = this.selected ? 4 : 2;
                ctx.strokeStyle = borderColor;
                ctx.stroke();
                
                // å¦‚æœæ˜¯æºå¸¦è€…ï¼Œåœ¨ä¸­é—´ç”»ä¸€ä¸ªç‚¹
                if (this.phenotype === 'carrier' && this.gender === 'female') {
                    ctx.beginPath();
                    ctx.arc(this.position.x, this.position.y, 6, 0, Math.PI * 2);
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fill();
                    ctx.strokeStyle = '#8A2BE2';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                }
                
                // å¦‚æœæ˜¯æ‚£è€…ï¼Œæ·»åŠ åå­—æ ‡è®°
                if (this.phenotype === 'affected') {
                    ctx.beginPath();
                    ctx.moveTo(this.position.x - 10, this.position.y);
                    ctx.lineTo(this.position.x + 10, this.position.y);
                    ctx.moveTo(this.position.x, this.position.y - 10);
                    ctx.lineTo(this.position.x, this.position.y + 10);
                    ctx.strokeStyle = '#FFFFFF';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
                
                // ç»˜åˆ¶IDå’ŒåŸºå› å‹
                ctx.fillStyle = '#333333';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                
                // æ˜¾ç¤ºID
                ctx.fillText(`I${this.id}`, this.position.x, this.position.y - this.radius - 10);
                
                // æ˜¾ç¤ºåŸºå› å‹ï¼ˆå¦‚æœå¼€å¯ï¼‰
                if (document.getElementById('showGenotype').checked) {
                    ctx.font = '12px Arial';
                    let genotypeText = this.genotype;
                    if (this.gender === 'male') {
                        genotypeText = genotypeText.replace('X^A', 'Xá´¬').replace('X^a', 'Xáµƒ');
                    } else {
                        genotypeText = genotypeText.replace('X^A', 'Xá´¬').replace('X^a', 'Xáµƒ');
                    }
                    ctx.fillText(genotypeText, this.position.x, this.position.y + this.radius + 15);
                }
                
                // æ˜¾ç¤ºè¡¨ç°å‹ï¼ˆå¦‚æœå¼€å¯ï¼‰
                if (document.getElementById('showPhenotype').checked) {
                    ctx.font = '12px Arial';
                    let phenotypeText = '';
                    switch(this.phenotype) {
                        case 'normal': phenotypeText = 'æ­£å¸¸'; break;
                        case 'carrier': phenotypeText = 'æºå¸¦è€…'; break;
                        case 'affected': 
                            phenotypeText = document.getElementById('diseaseSelect').value === 'colorBlindness' 
                                ? 'è‰²ç›²' : 'è¡€å‹ç—…';
                            break;
                    }
                    ctx.fillText(phenotypeText, this.position.x, this.position.y + this.radius + 30);
                }
                
                // æ‚¬åœæ•ˆæœ
                if (this.hovered) {
                    ctx.beginPath();
                    ctx.arc(this.position.x, this.position.y, this.radius + 5, 0, Math.PI * 2);
                    ctx.strokeStyle = '#FFBF00';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
                
                ctx.restore();
            }
            
            isPointInside(x, y) {
                const dx = x - this.position.x;
                const dy = y - this.position.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                return distance <= this.radius;
            }
            
            getInfo() {
                let diseaseName = document.getElementById('diseaseSelect').value === 'colorBlindness' 
                    ? 'çº¢ç»¿è‰²ç›²' : 'è¡€å‹ç—…';
                
                let phenotypeDesc = '';
                switch(this.phenotype) {
                    case 'normal':
                        phenotypeDesc = 'æ­£å¸¸ä¸ªä½“';
                        break;
                    case 'carrier':
                        phenotypeDesc = `å¥³æ€§æºå¸¦è€…ï¼ˆä¸è¡¨ç°${diseaseName}ç—‡çŠ¶ï¼‰`;
                        break;
                    case 'affected':
                        phenotypeDesc = `${diseaseName}æ‚£è€…`;
                        break;
                }
                
                let info = `<h4>ä¸ªä½“ I${this.id}</h4>
                           <p><strong>æ€§åˆ«:</strong> ${this.gender === 'male' ? 'ç”·æ€§' : 'å¥³æ€§'}</p>
                           <p><strong>åŸºå› å‹:</strong> ${this.genotype}</p>
                           <p><strong>è¡¨ç°å‹:</strong> ${phenotypeDesc}</p>`;
                
                if (this.parents.length > 0) {
                    info += `<p><strong>çˆ¶æ¯:</strong> I${this.parents[0].id}, I${this.parents[1].id}</p>`;
                }
                
                if (this.children.length > 0) {
                    info += `<p><strong>å­å¥³:</strong> ${this.children.map(c => 'I' + c.id).join(', ')}</p>`;
                }
                
                return info;
            }
        }
        
        class PedigreeSystem {
            constructor() {
                this.individuals = [];
                this.currentGeneration = 0;
                this.animationStep = 0;
                this.isAnimating = false;
                this.animationSpeed = 5;
                this.currentDisease = 'colorBlindness';
                this.highlightedPath = null;
                this.nextId = 1;
                
                // åˆå§‹åŒ–å®¶ç³»å›¾
                this.initializePedigree();
            }
            
            initializePedigree() {
                this.individuals = [];
                this.nextId = 1;
                this.animationStep = 0;
                
                // åˆ›å»ºç¬¬ä¸€ä»£ï¼ˆæ ¹æ®é€‰æ‹©çš„ç–¾ç—…ï¼‰
                const disease = document.getElementById('diseaseSelect').value;
                this.currentDisease = disease;
                
                if (disease === 'colorBlindness') {
                    // çº¢ç»¿è‰²ç›²æ¡ˆä¾‹ï¼šæ­£å¸¸ç”·æ€§ + æºå¸¦è€…å¥³æ€§
                    const father = new Individual(this.nextId++, 1, 
                        {x: canvas.width * 0.3, y: 100}, 'male', 'X^A Y', 'normal');
                    const mother = new Individual(this.nextId++, 1, 
                        {x: canvas.width * 0.7, y: 100}, 'female', 'X^A X^a', 'carrier');
                    
                    father.spouse = mother;
                    mother.spouse = father;
                    
                    this.individuals.push(father, mother);
                    currentInfo.textContent = "ç¬¬ä¸€ä»£ï¼šæ­£å¸¸ç”·æ€§ï¼ˆXá´¬Yï¼‰ä¸å¥³æ€§æºå¸¦è€…ï¼ˆXá´¬Xáµƒï¼‰å©šé…ã€‚å¥³æ€§æºå¸¦è€…ä¸è¡¨ç°çº¢ç»¿è‰²ç›²ç—‡çŠ¶ã€‚";
                    
                } else if (disease === 'hemophilia') {
                    // è¡€å‹ç—…æ¡ˆä¾‹ï¼šæ­£å¸¸ç”·æ€§ + æºå¸¦è€…å¥³æ€§ï¼ˆæ¨¡æ‹Ÿæ¬§æ´²çš‡å®¤ï¼‰
                    const father = new Individual(this.nextId++, 1, 
                        {x: canvas.width * 0.3, y: 100}, 'male', 'X^A Y', 'normal');
                    const mother = new Individual(this.nextId++, 1, 
                        {x: canvas.width * 0.7, y: 100}, 'female', 'X^A X^a', 'carrier');
                    
                    father.spouse = mother;
                    mother.spouse = father;
                    
                    this.individuals.push(father, mother);
                    currentInfo.textContent = "ç¬¬ä¸€ä»£ï¼šæ­£å¸¸ç”·æ€§ï¼ˆXá´¬Yï¼‰ä¸å¥³æ€§æºå¸¦è€…ï¼ˆXá´¬Xáµƒï¼‰å©šé…ã€‚æ¨¡æ‹Ÿæ¬§æ´²çš‡å®¤è¡€å‹ç—…é—ä¼ ã€‚";
                    
                } else {
                    // è‡ªå®šä¹‰æ¡ˆä¾‹
                    const father = new Individual(this.nextId++, 1, 
                        {x: canvas.width * 0.3, y: 100}, 'male', 'X^A Y', 'normal');
                    const mother = new Individual(this.nextId++, 1, 
                        {x: canvas.width * 0.7, y: 100}, 'female', 'X^A X^A', 'normal');
                    
                    father.spouse = mother;
                    mother.spouse = father;
                    
                    this.individuals.push(father, mother);
                    currentInfo.textContent = "è‡ªå®šä¹‰æ¡ˆä¾‹ï¼šæ­£å¸¸ç”·æ€§ï¼ˆXá´¬Yï¼‰ä¸æ­£å¸¸å¥³æ€§ï¼ˆXá´¬Xá´¬ï¼‰å©šé…ã€‚ç‚¹å‡»'æ¨¡æ‹Ÿå®éªŒå®¤'è¿›è¡Œè‡ªå®šä¹‰è®¾ç½®ã€‚";
                }
                
                this.updateStats();
            }
            
            addGeneration() {
                if (this.animationStep === 0) {
                    // ç¬¬ä¸€æ­¥ï¼šæ˜¾ç¤ºç¬¬ä¸€ä»£
                    this.animationStep = 1;
                    currentInfo.textContent = "è§‚å¯Ÿç¬¬ä¸€ä»£çˆ¶æ¯ã€‚ç”·æ€§ä¸ºæ­£å¸¸ï¼ˆXá´¬Yï¼‰ï¼Œå¥³æ€§ä¸ºæºå¸¦è€…ï¼ˆXá´¬Xáµƒï¼‰ã€‚";
                    
                } else if (this.animationStep === 1) {
                    // ç¬¬äºŒæ­¥ï¼šåˆ›å»ºç¬¬äºŒä»£å­å¥³
                    const parents = this.individuals.filter(ind => ind.generation === 1);
                    if (parents.length === 2) {
                        const [father, mother] = parents;
                        
                        // è®¡ç®—å¯èƒ½çš„å­å¥³åŸºå› å‹
                        const possibleGenotypes = this.calculateOffspring(father.genotype, mother.genotype);
                        
                        // åˆ›å»º4ä¸ªå­å¥³ï¼ˆå±•ç¤ºæ‰€æœ‰å¯èƒ½æ€§ï¼‰
                        const startX = canvas.width * 0.2;
                        const spacing = canvas.width * 0.15;
                        
                        possibleGenotypes.forEach((genotype, index) => {
                            const gender = genotype.includes('Y') ? 'male' : 'female';
                            const phenotype = this.determinePhenotype(genotype, gender);
                            
                            const child = new Individual(
                                this.nextId++,
                                2,
                                {x: startX + spacing * index, y: 250},
                                gender,
                                genotype,
                                phenotype,
                                [father, mother]
                            );
                            
                            this.individuals.push(child);
                            father.children.push(child);
                            mother.children.push(child);
                        });
                        
                        this.animationStep = 2;
                        currentInfo.textContent = "ç¬¬äºŒä»£ï¼šå­å¥³åŸºå› å‹åˆ†æã€‚æ³¨æ„ç”·æ€§æ‚£è€…ï¼ˆXáµƒYï¼‰çš„è‡´ç—…åŸºå› æ¥è‡ªæ¯äº²ã€‚";
                        this.highlightedPath = {from: mother.id, to: this.individuals.find(ind => 
                            ind.genotype === 'X^a Y' && ind.generation === 2).id};
                        
                    }
                    
                } else if (this.animationStep === 2) {
                    // ç¬¬ä¸‰æ­¥ï¼šé€‰æ‹©ä¸€å¯¹å©šé…å¹¶åˆ›å»ºç¬¬ä¸‰ä»£
                    const secondGen = this.individuals.filter(ind => ind.generation === 2);
                    if (secondGen.length >= 2) {
                        // é€‰æ‹©æ­£å¸¸å¥³æ€§å’Œç”·æ€§æ‚£è€…å©šé…ï¼ˆå¸¸è§æƒ…å†µï¼‰
                        const normalFemale = secondGen.find(ind => 
                            ind.gender === 'female' && ind.phenotype === 'normal');
                        const affectedMale = secondGen.find(ind => 
                            ind.gender === 'male' && ind.phenotype === 'affected');
                        
                        if (normalFemale && affectedMale) {
                            normalFemale.spouse = affectedMale;
                            affectedMale.spouse = normalFemale;
                            
                            // åˆ›å»ºç¬¬ä¸‰ä»£å­å¥³
                            const possibleGenotypes = this.calculateOffspring(affectedMale.genotype, normalFemale.genotype);
                            
                            const startX = canvas.width * 0.3;
                            const spacing = canvas.width * 0.2;
                            
                            possibleGenotypes.forEach((genotype, index) => {
                                const gender = genotype.includes('Y') ? 'male' : 'female';
                                const phenotype = this.determinePhenotype(genotype, gender);
                                
                                const child = new Individual(
                                    this.nextId++,
                                    3,
                                    {x: startX + spacing * index, y: 400},
                                    gender,
                                    genotype,
                                    phenotype,
                                    [affectedMale, normalFemale]
                                );
                                
                                this.individuals.push(child);
                                affectedMale.children.push(child);
                                normalFemale.children.push(child);
                            });
                            
                            this.animationStep = 3;
                            currentInfo.textContent = "ç¬¬ä¸‰ä»£ï¼šç”·æ€§æ‚£è€…ä¸æ­£å¸¸å¥³æ€§å©šé…ã€‚æ‰€æœ‰å¥³å„¿éƒ½æ˜¯æºå¸¦è€…ï¼Œæ‰€æœ‰å„¿å­éƒ½æ­£å¸¸ã€‚è¿™å°±æ˜¯'äº¤å‰é—ä¼ 'ã€‚";
                            this.highlightedPath = {from: affectedMale.id, to: this.individuals.find(ind => 
                                ind.generation === 3 && ind.gender === 'female').id};
                        }
                    }
                }
                
                this.updateStats();
            }
            
            calculateOffspring(fatherGenotype, motherGenotype) {
                // ç®€åŒ–è®¡ç®—ï¼šè¿”å›æ‰€æœ‰å¯èƒ½çš„å­å¥³åŸºå› å‹
                if (fatherGenotype === 'X^A Y' && motherGenotype === 'X^A X^a') {
                    return ['X^A X^A', 'X^A X^a', 'X^A Y', 'X^a Y'];
                } else if (fatherGenotype === 'X^a Y' && motherGenotype === 'X^A X^A') {
                    return ['X^A X^a', 'X^A Y'];
                }
                return [];
            }
            
            determinePhenotype(genotype, gender) {
                if (gender === 'male') {
                    return genotype === 'X^a Y' ? 'affected' : 'normal';
                } else {
                    if (genotype === 'X^a X^a') return 'affected';
                    if (genotype === 'X^A X^a') return 'carrier';
                    return 'normal';
                }
            }
            
            draw() {
                // æ¸…ç©ºç”»å¸ƒ
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // ç»˜åˆ¶ç½‘æ ¼èƒŒæ™¯
                this.drawGrid();
                
                // ç»˜åˆ¶è¿æ¥çº¿
                this.drawConnections();
                
                // ç»˜åˆ¶é«˜äº®è·¯å¾„
                if (this.highlightedPath) {
                    this.drawHighlightedPath();
                }
                
                // ç»˜åˆ¶æ‰€æœ‰ä¸ªä½“
                this.individuals.forEach(individual => individual.draw());
                
                // ç»˜åˆ¶æ¦‚ç‡è®¡ç®—ï¼ˆå¦‚æœå¼€å¯ï¼‰
                if (document.getElementById('showProbability').checked && this.animationStep >= 1) {
                    this.drawProbabilityCalculations();
                }
            }
            
            drawGrid() {
                ctx.strokeStyle = '#E9ECEF';
                ctx.lineWidth = 1;
                
                // æ°´å¹³çº¿
                for (let y = 50; y < canvas.height; y += 50) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvas.width, y);
                    ctx.stroke();
                }
                
                // å‚ç›´çº¿
                for (let x = 50; x < canvas.width; x += 50) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvas.height);
                    ctx.stroke();
                }
            }
            
            drawConnections() {
                ctx.strokeStyle = '#333333';
                ctx.lineWidth = 1;
                
                // ç»˜åˆ¶é…å¶è¿æ¥çº¿
                this.individuals.forEach(individual => {
                    if (individual.spouse && individual.id < individual.spouse.id) {
                        ctx.beginPath();
                        ctx.moveTo(individual.position.x, individual.position.y);
                        ctx.lineTo(individual.spouse.position.x, individual.spouse.position.y);
                        ctx.stroke();
                        
                        // åœ¨ä¸­é—´ç”»ä¸€ä¸ªå°åœ†è¡¨ç¤ºå©šå§»
                        const midX = (individual.position.x + individual.spouse.position.x) / 2;
                        const midY = (individual.position.y + individual.spouse.position.y) / 2;
                        ctx.beginPath();
                        ctx.arc(midX, midY, 4, 0, Math.PI * 2);
                        ctx.fillStyle = '#333333';
                        ctx.fill();
                    }
                });
                
                // ç»˜åˆ¶äº²å­è¿æ¥çº¿
                this.individuals.forEach(individual => {
                    if (individual.children.length > 0) {
                        // æ‰¾åˆ°é…å¶ï¼ˆå¦‚æœæœ‰ï¼‰
                        const spouse = individual.spouse;
                        let parentY = individual.position.y;
                        let parentX = individual.position.x;
                        
                        if (spouse) {
                            parentY = Math.max(individual.position.y, spouse.position.y);
                            parentX = (individual.position.x + spouse.position.x) / 2;
                        }
                        
                        // ç»˜åˆ¶åˆ°å­å¥³çš„è¿çº¿
                        const childrenCount = individual.children.length;
                        const startX = individual.children[0].position.x;
                        const endX = individual.children[childrenCount - 1].position.x;
                        
                        // æ°´å¹³çº¿ä»çˆ¶æ¯åˆ°å­å¥³ä¸Šæ–¹
                        ctx.beginPath();
                        ctx.moveTo(parentX, parentY + 25);
                        ctx.lineTo(parentX, parentY + 50);
                        ctx.stroke();
                        
                        // æ°´å¹³çº¿è¿æ¥æ‰€æœ‰å­å¥³
                        ctx.beginPath();
                        ctx.moveTo(startX, parentY + 50);
                        ctx.lineTo(endX, parentY + 50);
                        ctx.stroke();
                        
                        // å‚ç›´çº¿åˆ°æ¯ä¸ªå­å¥³
                        individual.children.forEach(child => {
                            ctx.beginPath();
                            ctx.moveTo(child.position.x, parentY + 50);
                            ctx.lineTo(child.position.x, child.position.y - 25);
                            ctx.stroke();
                        });
                    }
                });
            }
            
            drawHighlightedPath() {
                const fromInd = this.individuals.find(ind => ind.id === this.highlightedPath.from);
                const toInd = this.individuals.find(ind => ind.id === this.highlightedPath.to);
                
                if (fromInd && toInd) {
                    ctx.strokeStyle = '#FFBF00';
                    ctx.lineWidth = 3;
                    ctx.setLineDash([5, 5]);
                    
                    // ç»˜åˆ¶ç®­å¤´
                    this.drawArrow(fromInd.position.x, fromInd.position.y, 
                                 toInd.position.x, toInd.position.y);
                    
                    ctx.setLineDash([]);
                    
                    // ç»˜åˆ¶å…‰ç‚¹åŠ¨ç”»
                    const progress = (Date.now() % 2000) / 2000;
                    const pointX = fromInd.position.x + (toInd.position.x - fromInd.position.x) * progress;
                    const pointY = fromInd.position.y + (toInd.position.y - fromInd.position.y) * progress;
                    
                    ctx.beginPath();
                    ctx.arc(pointX, pointY, 8, 0, Math.PI * 2);
                    ctx.fillStyle = '#FFBF00';
                    ctx.fill();
                    ctx.strokeStyle = '#FFFFFF';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            }
            
            drawArrow(fromX, fromY, toX, toY) {
                const headlen = 15;
                const dx = toX - fromX;
                const dy = toY - fromY;
                const angle = Math.atan2(dy, dx);
                
                ctx.beginPath();
                ctx.moveTo(fromX, fromY);
                ctx.lineTo(toX, toY);
                ctx.stroke();
                
                // ç»˜åˆ¶ç®­å¤´å¤´éƒ¨
                ctx.beginPath();
                ctx.moveTo(toX, toY);
                ctx.lineTo(toX - headlen * Math.cos(angle - Math.PI / 6), 
                          toY - headlen * Math.sin(angle - Math.PI / 6));
                ctx.lineTo(toX - headlen * Math.cos(angle + Math.PI / 6), 
                          toY - headlen * Math.sin(angle + Math.PI / 6));
                ctx.closePath();
                ctx.fillStyle = '#FFBF00';
                ctx.fill();
            }
            
            drawProbabilityCalculations() {
                ctx.fillStyle = '#333333';
                ctx.font = '14px Arial';
                ctx.textAlign = 'left';
                
                let text = '';
                let yPos = canvas.height - 100;
                
                if (this.animationStep === 1) {
                    text = "æ¦‚ç‡è®¡ç®—ï¼š\n";
                    text += "å¥³æ€§æºå¸¦è€…(Xá´¬Xáµƒ) Ã— æ­£å¸¸ç”·æ€§(Xá´¬Y)\n";
                    text += "â†’ å„¿å­ï¼š50%æ­£å¸¸(Xá´¬Y)ï¼Œ50%æ‚£è€…(XáµƒY)\n";
                    text += "â†’ å¥³å„¿ï¼š50%æ­£å¸¸(Xá´¬Xá´¬)ï¼Œ50%æºå¸¦è€…(Xá´¬Xáµƒ)";
                } else if (this.animationStep === 2) {
                    text = "æ¦‚ç‡è®¡ç®—ï¼š\n";
                    text += "ç”·æ€§æ‚£è€…(XáµƒY) Ã— æ­£å¸¸å¥³æ€§(Xá´¬Xá´¬)\n";
                    text += "â†’ å„¿å­ï¼š100%æ­£å¸¸(Xá´¬Y)\n";
                    text += "â†’ å¥³å„¿ï¼š100%æºå¸¦è€…(Xá´¬Xáµƒ)";
                }
                
                // ç»˜åˆ¶èƒŒæ™¯æ¡†
                const lines = text.split('\n');
                const maxWidth = Math.max(...lines.map(line => ctx.measureText(line).width));
                
                ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                ctx.fillRect(20, yPos - 30, maxWidth + 40, lines.length * 20 + 20);
                ctx.strokeStyle = '#6A5ACD';
                ctx.lineWidth = 2;
                ctx.strokeRect(20, yPos - 30, maxWidth + 40, lines.length * 20 + 20);
                
                // ç»˜åˆ¶æ–‡å­—
                ctx.fillStyle = '#333333';
                lines.forEach((line, index) => {
                    ctx.fillText(line, 40, yPos + index * 20);
                });
            }
            
            updateStats() {
                const total = this.individuals.length;
                const malePatients = this.individuals.filter(ind => 
                    ind.gender === 'male' && ind.phenotype === 'affected').length;
                const femalePatients = this.individuals.filter(ind => 
                    ind.gender === 'female' && ind.phenotype === 'affected').length;
                const carriers = this.individuals.filter(ind => 
                    ind.phenotype === 'carrier').length;
                
                document.getElementById('totalCount').textContent = total;
                document.getElementById('malePatients').textContent = malePatients;
                document.getElementById('femalePatients').textContent = femalePatients;
                document.getElementById('carriers').
<!--æ£€æµ‹åˆ°ä»£ç æˆªæ–­ï¼Œè‡ªåŠ¨ç»­å†™ä¸­...-->
textContent = carriers;
            }
            
            handleClick(x, y) {
                // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†ä¸ªä½“
                for (let i = this.individuals.length - 1; i >= 0; i--) {
                    const individual = this.individuals[i];
                    if (individual.isPointInside(x, y)) {
                        // æ˜¾ç¤ºå·¥å…·æç¤º
                        tooltip.innerHTML = individual.getInfo();
                        tooltip.style.left = (x + 15) + 'px';
                        tooltip.style.top = (y + 15) + 'px';
                        tooltip.style.opacity = '1';
                        
                        // é«˜äº®ç›¸å…³ä¸ªä½“
                        this.individuals.forEach(ind => ind.selected = false);
                        individual.selected = true;
                        
                        // é«˜äº®é—ä¼ è·¯å¾„
                        if (individual.parents.length > 0) {
                            this.highlightedPath = {
                                from: individual.parents[0].id,
                                to: individual.id
                            };
                        }
                        
                        return;
                    }
                }
                
                // ç‚¹å‡»ç©ºç™½å¤„éšè—å·¥å…·æç¤º
                tooltip.style.opacity = '0';
                this.individuals.forEach(ind => ind.selected = false);
            }
            
            handleHover(x, y) {
                let hoveredAny = false;
                
                this.individuals.forEach(individual => {
                    individual.hovered = individual.isPointInside(x, y);
                    if (individual.hovered) hoveredAny = true;
                });
                
                // æ›´æ–°é¼ æ ‡æŒ‡é’ˆ
                canvas.style.cursor = hoveredAny ? 'pointer' : 'default';
            }
            
            animate() {
                if (this.isAnimating && this.animationStep < 3) {
                    this.addGeneration();
                }
                this.draw();
                
                if (this.isAnimating) {
                    setTimeout(() => {
                        requestAnimationFrame(() => this.animate());
                    }, 2000 / this.animationSpeed);
                }
            }
            
            startAnimation() {
                if (!this.isAnimating) {
                    this.isAnimating = true;
                    this.animate();
                }
            }
            
            stopAnimation() {
                this.isAnimating = false;
            }
            
            reset() {
                this.stopAnimation();
                this.initializePedigree();
                this.draw();
                tooltip.style.opacity = '0';
            }
        }

        // åˆå§‹åŒ–ç³»ç»Ÿ
        const pedigreeSystem = new PedigreeSystem();
        pedigreeSystem.draw();

        // äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('playBtn').addEventListener('click', () => {
            pedigreeSystem.startAnimation();
            currentInfo.textContent = "åŠ¨ç”»æ’­æ”¾ä¸­...è§‚å¯Ÿé—ä¼ åŸºå› çš„ä¼ é€’è·¯å¾„ã€‚";
        });

        document.getElementById('pauseBtn').addEventListener('click', () => {
            pedigreeSystem.stopAnimation();
            currentInfo.textContent = "åŠ¨ç”»å·²æš‚åœã€‚ç‚¹å‡»ä¸ªä½“æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ï¼Œæˆ–ç‚¹å‡»'æ­¥è¿›'ç»§ç»­ã€‚";
        });

        document.getElementById('stepBtn').addEventListener('click', () => {
            pedigreeSystem.stopAnimation();
            pedigreeSystem.addGeneration();
            pedigreeSystem.draw();
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            pedigreeSystem.reset();
        });

        document.getElementById('speedSlider').addEventListener('input', (e) => {
            pedigreeSystem.animationSpeed = parseInt(e.target.value);
        });

        document.getElementById('diseaseSelect').addEventListener('change', () => {
            pedigreeSystem.reset();
        });

        document.getElementById('showGenotype').addEventListener('change', () => {
            pedigreeSystem.draw();
        });

        document.getElementById('showPhenotype').addEventListener('change', () => {
            pedigreeSystem.draw();
        });

        document.getElementById('showProbability').addEventListener('change', () => {
            pedigreeSystem.draw();
        });

        document.getElementById('simulateBtn').addEventListener('click', () => {
            alert("æ¨¡æ‹Ÿå®éªŒå®¤åŠŸèƒ½ï¼š\n\n1. è‡ªå®šä¹‰çˆ¶æ¯åŸºå› å‹\n2. æ¨¡æ‹Ÿå¤šä»£é—ä¼ \n3. ç»Ÿè®¡é—ä¼ è§„å¾‹\n\nï¼ˆæ­¤ä¸ºæ‰©å±•åŠŸèƒ½æ¼”ç¤ºï¼Œå®Œæ•´å®ç°éœ€è¦æ›´å¤šä»£ç ï¼‰");
            
            // ç®€å•æ¼”ç¤ºï¼šéšæœºç”Ÿæˆä¸€ä¸ªå¤§å®¶ç³»
            pedigreeSystem.reset();
            
            // æ·»åŠ æ›´å¤šéšæœºä¸ªä½“
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    pedigreeSystem.addGeneration();
                    pedigreeSystem.draw();
                }, i * 500);
            }
            
            currentInfo.textContent = "æ¨¡æ‹Ÿå®éªŒå®¤ï¼šéšæœºç”Ÿæˆå¤šä»£å®¶ç³»å›¾ï¼Œè§‚å¯Ÿé—ä¼ è§„å¾‹ã€‚æ³¨æ„ç”·æ€§æ‚£è€…æ¯”ä¾‹æ˜¾è‘—é«˜äºå¥³æ€§ã€‚";
        });

        // Canvas äº¤äº’
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            pedigreeSystem.handleClick(x, y);
        });

        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            pedigreeSystem.handleHover(x, y);
            
            // ç§»åŠ¨å·¥å…·æç¤º
            if (tooltip.style.opacity === '1') {
                tooltip.style.left = (x + 15) + 'px';
                tooltip.style.top = (y + 15) + 'px';
            }
        });

        canvas.addEventListener('mouseleave', () => {
            pedigreeSystem.individuals.forEach(ind => ind.hovered = false);
            canvas.style.cursor = 'default';
            tooltip.style.opacity = '0';
        });

        // åˆå§‹æç¤º
        setTimeout(() => {
            currentInfo.textContent = "ç‚¹å‡»'æ’­æ”¾'å¼€å§‹åŠ¨ç”»æ¼”ç¤ºï¼Œæˆ–ç‚¹å‡»'æ­¥è¿›'æ‰‹åŠ¨æ§åˆ¶ã€‚å°†é¼ æ ‡æ‚¬åœåœ¨å®¶ç³»æˆå‘˜ä¸ŠæŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ã€‚";
        }, 1000);
    </script>
</body>
</html>