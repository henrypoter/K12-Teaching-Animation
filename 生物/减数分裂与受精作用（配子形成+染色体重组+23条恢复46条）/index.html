<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡æ•°åˆ†è£‚ä¸å—ç²¾ä½œç”¨æ•™å­¦åŠ¨ç”»</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            background-color: #f0f5ff;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #2c5aa0;
        }

        h1 {
            color: #2c5aa0;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .module-tabs {
            display: flex;
            background: #e6f0ff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 6px rgba(0,0,0,0.08);
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: transparent;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #2c5aa0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab:hover {
            background: rgba(44, 90, 160, 0.1);
        }

        .tab.active {
            background: #2c5aa0;
            color: white;
        }

        .animation-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .canvas-wrapper {
            position: relative;
            width: 100%;
            height: 500px;
            background: #f8fbff;
            border-radius: 8px;
            border: 1px solid #d0e0ff;
            margin-bottom: 20px;
            overflow: hidden;
        }

        #animationCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .chromosome-counter {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 20px;
            font-weight: bold;
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
            border: 2px solid #2c5aa0;
            z-index: 10;
        }

        .counter-number {
            color: #2c5aa0;
            font-size: 1.8em;
            margin: 0 5px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8fbff;
            border-radius: 8px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 18px;
            background: #2c5aa0;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button:hover {
            background: #5a8cd0;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background: #a02c6b;
        }

        button.secondary:hover {
            background: #d05a94;
        }

        button.small {
            padding: 8px 14px;
            font-size: 14px;
        }

        .stage-indicator {
            display: flex;
            align-items: center;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #d0e0ff;
            min-width: 200px;
        }

        .stage-name {
            font-weight: bold;
            color: #2c5aa0;
            margin-right: 10px;
        }

        .stage-progress {
            flex: 1;
            height: 8px;
            background: #e6f0ff;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #2c5aa0, #5a8cd0);
            width: 0%;
            transition: width 0.5s ease;
        }

        .info-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            border-left: 5px solid #4CAF50;
            box-shadow: 0 3px 8px rgba(0,0,0,0.08);
            margin-top: 20px;
        }

        .info-title {
            color: #2c5aa0;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .info-content {
            color: #444;
            line-height: 1.7;
        }

        .highlight {
            color: #2c5aa0;
            font-weight: bold;
        }

        .interactive-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
            padding: 20px;
            background: #f8fbff;
            border-radius: 8px;
            border: 1px dashed #5a8cd0;
        }

        .panel-title {
            width: 100%;
            color: #2c5aa0;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-label {
            font-weight: 500;
        }

        .quiz-popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 100;
            display: none;
            width: 90%;
            max-width: 500px;
        }

        .quiz-question {
            margin-bottom: 20px;
            font-size: 1.1em;
            color: #333;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .quiz-option {
            padding: 12px;
            background: #f0f5ff;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quiz-option:hover {
            background: #e6f0ff;
        }

        .quiz-option.correct {
            background: #d4edda;
            border-left: 4px solid #4CAF50;
        }

        .quiz-option.incorrect {
            background: #f8d7da;
            border-left: 4px solid #f44336;
        }

        .close-quiz {
            background: #2c5aa0;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            float: right;
        }

        .chromosome-legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .legend-text {
            font-size: 14px;
        }

        footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #d0e0ff;
            color: #666;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            
            .stage-indicator {
                min-width: 100%;
            }
            
            .chromosome-legend {
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>å‡æ•°åˆ†è£‚ä¸å—ç²¾ä½œç”¨æ•™å­¦åŠ¨ç”»</h1>
        <p class="subtitle">é…å­å½¢æˆ + æŸ“è‰²ä½“é‡ç»„ + 23æ¡æ¢å¤46æ¡çš„ç”Ÿå‘½å¾ªç¯</p>
    </header>

    <div class="main-container">
        <div class="module-tabs">
            <button class="tab active" data-module="overview">ç”Ÿå‘½å¾ªç¯æ¦‚è§ˆ</button>
            <button class="tab" data-module="meiosis">å‡æ•°åˆ†è£‚è¯¦è§£</button>
            <button class="tab" data-module="fertilization">å—ç²¾ä½œç”¨</button>
        </div>

        <div class="animation-container">
            <div class="canvas-wrapper">
                <canvas id="animationCanvas" width="1000" height="500"></canvas>
                <div class="chromosome-counter">
                    æŸ“è‰²ä½“æ•°ç›®: <span class="counter-number">46</span> æ¡
                </div>
            </div>

            <div class="controls">
                <div class="control-group">
                    <button id="playBtn">
                        <span>â–¶</span> æ’­æ”¾
                    </button>
                    <button id="pauseBtn">
                        <span>â¸</span> æš‚åœ
                    </button>
                    <button id="resetBtn">
                        <span>â†º</span> é‡ç½®
                    </button>
                </div>

                <div class="control-group">
                    <button id="prevBtn" class="small">
                        <span>â†</span> ä¸Šä¸€æ­¥
                    </button>
                    <button id="nextBtn" class="small">
                        ä¸‹ä¸€æ­¥ <span>â†’</span>
                    </button>
                </div>

                <div class="stage-indicator">
                    <div class="stage-name">é—´æœŸ</div>
                    <div class="stage-progress">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                </div>

                <div class="control-group">
                    <button id="crossoverBtn" class="secondary small">
                        <span>ğŸ”„</span> æ‰‹åŠ¨äº¤å‰äº’æ¢
                    </button>
                    <button id="generateGameteBtn" class="secondary small">
                        <span>ğŸ²</span> éšæœºç”Ÿæˆé…å­
                    </button>
                </div>
            </div>

            <div class="interactive-panel">
                <div class="panel-title">è§†è§‰è¾…åŠ©é€‰é¡¹</div>
                <div class="toggle-switch">
                    <input type="checkbox" id="spindleToggle" checked>
                    <label for="spindleToggle" class="toggle-label">æ˜¾ç¤ºçººé”¤ä½“</label>
                </div>
                <div class="toggle-switch">
                    <input type="checkbox" id="geneToggle">
                    <label for="geneToggle" class="toggle-label">æ˜¾ç¤ºåŸºå› ä½ç‚¹</label>
                </div>
                <div class="toggle-switch">
                    <input type="checkbox" id="detailedViewToggle" checked>
                    <label for="detailedViewToggle" class="toggle-label">è¯¦ç»†è§†å›¾ (Xå½¢æŸ“è‰²ä½“)</label>
                </div>
            </div>

            <div class="chromosome-legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #2c5aa0;"></div>
                    <div class="legend-text">çˆ¶æºæŸ“è‰²ä½“</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #a02c6b;"></div>
                    <div class="legend-text">æ¯æºæŸ“è‰²ä½“</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(45deg, #2c5aa0 50%, #a02c6b 50%);"></div>
                    <div class="legend-text">é‡ç»„æŸ“è‰²ä½“ (äº¤å‰äº’æ¢å)</div>
                </div>
            </div>

            <div class="info-panel">
                <div class="info-title" id="infoTitle">å‡æ•°åˆ†è£‚æ¦‚è¿°</div>
                <div class="info-content" id="infoContent">
                    å‡æ•°åˆ†è£‚æ˜¯äº§ç”Ÿé…å­ï¼ˆç²¾å­å’Œåµç»†èƒï¼‰çš„ç‰¹æ®Šç»†èƒåˆ†è£‚æ–¹å¼ã€‚ä¸€ä¸ªäºŒå€ä½“ç»†èƒç»è¿‡ä¸€æ¬¡DNAå¤åˆ¶å’Œä¸¤æ¬¡è¿ç»­åˆ†è£‚ï¼Œäº§ç”Ÿå››ä¸ªå•å€ä½“ç»†èƒã€‚æŸ“è‰²ä½“æ•°ç›®ä»<span class="highlight">46æ¡ï¼ˆäºŒå€ä½“ï¼‰</span>å‡å°‘åˆ°<span class="highlight">23æ¡ï¼ˆå•å€ä½“ï¼‰</span>ã€‚
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-popup" id="quizPopup">
        <div class="quiz-question" id="quizQuestion">åŒæºæŸ“è‰²ä½“åˆ†ç¦»å‘ç”Ÿåœ¨å“ªä¸€æ¬¡åˆ†è£‚ï¼Ÿ</div>
        <div class="quiz-options" id="quizOptions">
            <div class="quiz-option" data-correct="true">å‡æ•°åˆ†è£‚I</div>
            <div class="quiz-option" data-correct="false">å‡æ•°åˆ†è£‚II</div>
            <div class="quiz-option" data-correct="false">æœ‰ä¸åˆ†è£‚</div>
            <div class="quiz-option" data-correct="false">ä¸¤æ¬¡åˆ†è£‚éƒ½ä¼šå‘ç”Ÿ</div>
        </div>
        <button class="close-quiz" id="closeQuiz">ç»§ç»­å­¦ä¹ </button>
    </div>

    <footer>
        <p>æ•™å­¦åŠ¨ç”»è®¾è®¡ | å‡æ•°åˆ†è£‚ä¸å—ç²¾ä½œç”¨ | æŸ“è‰²ä½“æ•°ç›®å˜åŒ–: 46 â†’ 23 â†’ 46</p>
        <p>æç¤ºï¼šç‚¹å‡»æŸ“è‰²ä½“å¯æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ï¼Œä½¿ç”¨æ§åˆ¶æŒ‰é’®è°ƒèŠ‚å­¦ä¹ è¿›åº¦</p>
    </footer>

    <script>
        // å…¨å±€å˜é‡å’Œé…ç½®
        const canvas = document.getElementById('animationCanvas');
        const ctx = canvas.getContext('2d');
        const counterElement = document.querySelector('.counter-number');
        const infoTitle = document.getElementById('infoTitle');
        const infoContent = document.getElementById('infoContent');
        const progressBar = document.getElementById('progressBar');
        const stageName = document.querySelector('.stage-name');
        const quizPopup = document.getElementById('quizPopup');
        const quizQuestion = document.getElementById('quizQuestion');
        const quizOptions = document.getElementById('quizOptions');
        
        // æ¨¡å—çŠ¶æ€
        let currentModule = 'overview'; // overview, meiosis, fertilization
        let currentStage = 0;
        let isPlaying = false;
        let animationId = null;
        let lastTime = 0;
        
        // å‡æ•°åˆ†è£‚é˜¶æ®µå®šä¹‰
        const meiosisStages = [
            { name: "é—´æœŸ", duration: 3, info: "DNAå¤åˆ¶ï¼ŒæŸ“è‰²ä½“å¤åˆ¶ï¼Œæ¯æ¡æŸ“è‰²ä½“ç”±ä¸¤ä¸ªå§å¦¹æŸ“è‰²å•ä½“ç»„æˆã€‚" },
            { name: "å‰æœŸ I", duration: 4, info: "åŒæºæŸ“è‰²ä½“é…å¯¹ï¼ˆè”ä¼šï¼‰ï¼Œéå§å¦¹æŸ“è‰²å•ä½“é—´å¯èƒ½å‘ç”Ÿäº¤å‰äº’æ¢ã€‚" },
            { name: "ä¸­æœŸ I", duration: 3, info: "åŒæºæŸ“è‰²ä½“æ’åˆ—åœ¨ç»†èƒä¸­å¤®çš„èµ¤é“æ¿ä¸Šï¼Œçººé”¤ä½“å½¢æˆã€‚" },
            { name: "åæœŸ I", duration: 3, info: "åŒæºæŸ“è‰²ä½“åˆ†ç¦»ï¼Œåˆ†åˆ«ç§»å‘ç»†èƒä¸¤æã€‚æŸ“è‰²ä½“æ•°ç›®å¼€å§‹å‡åŠã€‚" },
            { name: "æœ«æœŸ I", duration: 2, info: "ç»†èƒä¸€åˆ†ä¸ºäºŒï¼Œå½¢æˆä¸¤ä¸ªæ¬¡çº§æ€§æ¯ç»†èƒï¼Œæ¯ä¸ªç»†èƒå«æœ‰å•å€ä½“æ•°ç›®çš„æŸ“è‰²ä½“ã€‚" },
            { name: "å‰æœŸ II", duration: 2, info: "ä¸¤ä¸ªæ¬¡çº§æ€§æ¯ç»†èƒå‡†å¤‡ç¬¬äºŒæ¬¡åˆ†è£‚ï¼ŒæŸ“è‰²ä½“ä¸å†å¤åˆ¶ã€‚" },
            { name: "ä¸­æœŸ II", duration: 2, info: "æŸ“è‰²ä½“æ’åˆ—åœ¨æ¯ä¸ªç»†èƒçš„èµ¤é“æ¿ä¸Šï¼Œç€ä¸ç²’åˆ†è£‚å‡†å¤‡ã€‚" },
            { name: "åæœŸ II", duration: 2, info: "å§å¦¹æŸ“è‰²å•ä½“åˆ†ç¦»ï¼Œæˆä¸ºç‹¬ç«‹çš„æŸ“è‰²ä½“ï¼Œç§»å‘ç»†èƒä¸¤æã€‚" },
            { name: "æœ«æœŸ II", duration: 2, info: "ç»†èƒåˆ†è£‚å®Œæˆï¼Œå½¢æˆå››ä¸ªå•å€ä½“é…å­ï¼Œæ¯ä¸ªé…å­å«æœ‰23æ¡æŸ“è‰²ä½“ã€‚" }
        ];
        
        const overviewStages = [
            { name: "ä½“ç»†èƒ", duration: 2, info: "äºŒå€ä½“ä½“ç»†èƒï¼Œå«æœ‰46æ¡æŸ“è‰²ä½“ï¼ˆ23å¯¹åŒæºæŸ“è‰²ä½“ï¼‰ã€‚" },
            { name: "å‡æ•°åˆ†è£‚", duration: 5, info: "ç»è¿‡å‡æ•°åˆ†è£‚Iå’ŒIIï¼Œäº§ç”Ÿå››ä¸ªå•å€ä½“é…å­ï¼Œæ¯ä¸ªå«æœ‰23æ¡æŸ“è‰²ä½“ã€‚" },
            { name: "é…å­", duration: 2, info: "ç²¾å­å’Œåµç»†èƒï¼Œå„å«æœ‰23æ¡æŸ“è‰²ä½“ï¼Œé—ä¼ ç‰©è´¨é€šè¿‡äº¤å‰äº’æ¢å’Œè‡ªç”±ç»„åˆå®ç°é‡ç»„ã€‚" },
            { name: "å—ç²¾ä½œç”¨", duration: 3, info: "ç²¾å­å’Œåµç»†èƒç»“åˆï¼ŒæŸ“è‰²ä½“æ•°ç›®æ¢å¤ä¸º46æ¡ï¼Œå½¢æˆå—ç²¾åµã€‚" },
            { name: "æ–°ä¸ªä½“", duration: 2, info: "å—ç²¾åµç»è¿‡æœ‰ä¸åˆ†è£‚å’Œåˆ†åŒ–ï¼Œå‘è‚²ä¸ºæ–°ä¸ªä½“ï¼Œç»´æŒç‰©ç§æŸ“è‰²ä½“æ•°ç›®çš„ç¨³å®šã€‚" }
        ];
        
        const fertilizationStages = [
            { name: "é…å­ç›¸é‡", duration: 2, info: "ç²¾å­å’Œåµç»†èƒç›¸äº’è¯†åˆ«å¹¶é è¿‘ã€‚" },
            { name: "ç²¾åµç»“åˆ", duration: 3, info: "ç²¾å­è¿›å…¥åµç»†èƒï¼Œä¸¤ä¸ªç»†èƒæ ¸é€æ¸é è¿‘ã€‚" },
            { name: "æ ¸è†œæ¶ˆå¤±", duration: 2, info: "ç²¾å­å’Œåµç»†èƒçš„æ ¸è†œæ¶ˆå¤±ï¼ŒæŸ“è‰²ä½“é‡Šæ”¾ã€‚" },
            { name: "æŸ“è‰²ä½“è”åˆ", duration: 3, info: "çˆ¶æºå’Œæ¯æºæŸ“è‰²ä½“åœ¨å—ç²¾åµä¸­é…å¯¹ï¼Œæ¢å¤äºŒå€ä½“çŠ¶æ€ã€‚" },
            { name: "å—ç²¾åµå½¢æˆ", duration: 2, info: "å½¢æˆå«æœ‰46æ¡æŸ“è‰²ä½“çš„å—ç²¾åµï¼Œæ–°ç”Ÿå‘½å¼€å§‹ã€‚" }
        ];
        
        let stages = overviewStages;
        let stageProgress = 0;
        let stageStartTime = 0;
        
        // æŸ“è‰²ä½“æ•°æ®
        let chromosomes = [];
        let gametes = [];
        let selectedChromosome = null;
        
        // äº¤äº’çŠ¶æ€
        let showSpindle = true;
        let showGenes = false;
        let detailedView = true;
        
        // åˆå§‹åŒ–æŸ“è‰²ä½“
        function initChromosomes() {
            chromosomes = [];
            gametes = [];
            
            // åˆ›å»º23å¯¹åŒæºæŸ“è‰²ä½“ï¼ˆä½“ç»†èƒï¼‰
            for (let i = 0; i < 23; i++) {
                // çˆ¶æºæŸ“è‰²ä½“
                chromosomes.push({
                    id: `p${i}`,
                    type: 'paternal',
                    pairId: i,
                    x: 300 + Math.random() * 400,
                    y: 200 + Math.random() * 100,
                    width: 30,
                    height: 60,
                    replicated: true,
                    chromatids: 2,
                    color: '#2c5aa0',
                    targetX: 0,
                    targetY: 0,
                    moving: false,
                    inGamete: false,
                    crossoverPoints: []
                });
                
                // æ¯æºæŸ“è‰²ä½“
                chromosomes.push({
                    id: `m${i}`,
                    type: 'maternal',
                    pairId: i,
                    x: 300 + Math.random() * 400,
                    y: 200 + Math.random() * 100,
                    width: 30,
                    height: 60,
                    replicated: true,
                    chromatids: 2,
                    color: '#a02c6b',
                    targetX: 0,
                    targetY: 0,
                    moving: false,
                    inGamete: false,
                    crossoverPoints: []
                });
            }
            
            updateCounter(46);
        }
        
        // æ›´æ–°æŸ“è‰²ä½“è®¡æ•°å™¨
        function updateCounter(count) {
            counterElement.textContent = count;
            
            // æ·»åŠ åŠ¨ç”»æ•ˆæœ
            counterElement.style.transform = 'scale(1.2)';
            setTimeout(() => {
                counterElement.style.transform = 'scale(1)';
            }, 300);
        }
        
        // æ›´æ–°ä¿¡æ¯é¢æ¿
        function updateInfoPanel() {
            const stage = stages[currentStage];
            infoTitle.textContent = stage.name;
            infoContent.innerHTML = stage.info;
            
            // æ ¹æ®é˜¶æ®µæ·»åŠ ç‰¹å®šä¿¡æ¯
            if (currentModule === 'meiosis') {
                if (currentStage === 1) { // å‰æœŸI
                    infoContent.innerHTML += " <span class='highlight'>ç‚¹å‡»'æ‰‹åŠ¨äº¤å‰äº’æ¢'æŒ‰é’®ä½“éªŒé‡ç»„è¿‡ç¨‹ã€‚</span>";
                } else if (currentStage === 8) { // æœ«æœŸII
                    infoContent.innerHTML += " <span class='highlight'>ç‚¹å‡»'éšæœºç”Ÿæˆé…å­'æŒ‰é’®è§‚å¯Ÿé—ä¼ å¤šæ ·æ€§ã€‚</span>";
                }
            }
            
            // æ›´æ–°è¿›åº¦æ¡
            progressBar.style.width = `${(currentStage / (stages.length - 1)) * 100}%`;
            stageName.textContent = stage.name;
        }
        
        // ç»˜åˆ¶æŸ“è‰²ä½“
        function drawChromosome(chromo) {
            ctx.save();
            
            if (chromo.inGamete && currentModule === 'fertilization') {
                // åœ¨å—ç²¾ä½œç”¨ä¸­ï¼Œé…å­ä¸­çš„æŸ“è‰²ä½“è¾ƒå°
                ctx.translate(chromo.x, chromo.y);
                ctx.scale(0.7, 0.7);
            } else {
                ctx.translate(chromo.x, chromo.y);
            }
            
            // ç»˜åˆ¶æŸ“è‰²ä½“ä¸»ä½“
            if (detailedView && chromo.replicated) {
                // è¯¦ç»†è§†å›¾ï¼šXå½¢æŸ“è‰²ä½“ï¼ˆä¸¤ä¸ªæŸ“è‰²å•ä½“ï¼‰
                ctx.fillStyle = chromo.color;
                
                // ç»˜åˆ¶ä¸¤ä¸ªæŸ“è‰²å•ä½“
                ctx.save();
                ctx.rotate(Math.PI / 12); // è½»å¾®æ—‹è½¬
                ctx.fillRect(-chromo.width/2, -chromo.height/2, chromo.width, chromo.height);
                ctx.restore();
                
                ctx.save();
                ctx.rotate(-Math.PI / 12);
                ctx.fillRect(-chromo.width/2, -chromo.height/2, chromo.width, chromo.height);
                ctx.restore();
                
                // ç»˜åˆ¶ç€ä¸ç²’
                ctx.fillStyle = '#333';
                ctx.fillRect(-5, -5, 10, 10);
                
                // å¦‚æœæ˜¾ç¤ºåŸºå› ä½ç‚¹
                if (showGenes) {
                    ctx.fillStyle = '#FF9800';
                    for (let i = 0; i < 3; i++) {
                        const yPos = -chromo.height/2 + 20 + i * 20;
                        ctx.beginPath();
                        ctx.arc(0, yPos, 3, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }
                
                // ç»˜åˆ¶äº¤å‰äº’æ¢ç‚¹
                if (chromo.crossoverPoints.length > 0) {
                    ctx.fillStyle = '#FF9800';
                    chromo.crossoverPoints.forEach(point => {
                        ctx.beginPath();
                        ctx.arc(0, point, 5, 0, Math.PI * 2);
                        ctx.fill();
                    });
                }
                
            } else {
                // ç®€åŒ–è§†å›¾ï¼šå•è‰²æ¡çŠ¶
                ctx.fillStyle = chromo.color;
                ctx.fillRect(-chromo.width/2, -chromo.height/2, chromo.width, chromo.height);
                
                // ç»˜åˆ¶ç€ä¸ç²’
                ctx.fillStyle = '#333';
                ctx.fillRect(-4, -4, 8, 8);
            }
            
            // å¦‚æœè¢«é€‰ä¸­ï¼Œç»˜åˆ¶é«˜äº®è¾¹æ¡†
            if (selectedChromosome && selectedChromosome.id === chromo.id) {
                ctx.strokeStyle = '#FFEB3B';
                ctx.lineWidth = 3;
                ctx.strokeRect(-chromo.width/2 - 5, -chromo.height/2 - 5, chromo.width + 10, chromo.height + 10);
            }
            
            ctx.restore();
        }
        
        // ç»˜åˆ¶ç»†èƒ
        function drawCell() {
            // ç»˜åˆ¶ç»†èƒè†œ
            ctx.strokeStyle = '#999';
            ctx.lineWidth = 2;
            ctx.setLineDash([]);
            
            if (currentModule === 'overview' || currentModule === 'meiosis') {
                if (currentStage >= 4 && currentStage <= 8 && currentModule === 'meiosis') {
                    // å‡æ•°åˆ†è£‚åæœŸï¼šç»˜åˆ¶ä¸¤ä¸ªç»†èƒ
                    ctx.beginPath();
                    ctx.arc(250, 250, 120, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    ctx.beginPath();
                    ctx.arc(750, 250, 120, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    if (currentStage >= 6) {
                        // å‡æ•°åˆ†è£‚IIï¼šç»˜åˆ¶å››ä¸ªç»†èƒ
                        ctx.beginPath();
                        ctx.arc(200, 200, 80, 0, Math.PI * 2);
                        ctx.stroke();
                        
                        ctx.beginPath();
                        ctx.arc(300, 300, 80, 0, Math.PI * 2);
                        ctx.stroke();
                        
                        ctx.beginPath();
                        ctx.arc(700, 200, 80, 0, Math.PI * 2);
                        ctx.stroke();
                        
                        ctx.beginPath();
                        ctx.arc(800, 300, 80, 0, Math.PI * 2);
                        ctx.stroke();
                    }
                } else {
                    // å•ä¸ªç»†èƒ
                    ctx.beginPath();
                    ctx.arc(500, 250, 180, 0, Math.PI * 2);
                    ctx.stroke();
                }
            } else if (currentModule === 'fertilization') {
                // å—ç²¾ä½œç”¨ï¼šç»˜åˆ¶ä¸¤ä¸ªé…å­ç»†èƒ
                ctx.beginPath();
                ctx.arc(350, 250, 80, 0, Math.PI * 2);
                ctx.stroke();
                ctx.fillStyle = 'rgba(90, 140, 208, 0.1)';
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(650, 250, 80, 0, Math.PI * 2);
                ctx.stroke();
                ctx.fillStyle = 'rgba(208, 90, 148, 0.1)';
                ctx.fill();
                
                if (currentStage >= 3) {
                    // ç»˜åˆ¶èåˆåçš„å—ç²¾åµ
                    ctx.beginPath();
                    ctx.arc(500, 250, 120, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.fillStyle = 'rgba(76, 175, 80, 0.1)';
                    ctx.fill();
                }
            }
            
            // ç»˜åˆ¶çººé”¤ä½“
            if (showSpindle && (currentModule === 'meiosis' || currentModule === 'overview')) {
                if (currentStage === 2 || currentStage === 3 || currentStage === 6 || currentStage === 7) {
                    ctx.strokeStyle = '#CCCCCC';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    
                    const centerX = currentStage >= 4 && currentStage <= 8 ? (currentStage >= 6 ? [200, 300, 700, 800] : [250, 750]) : [500];
                    
                    if (Array.isArray(centerX)) {
                        centerX.forEach(x => {
                            const y = x === 200 || x === 700 ? 200 : 300;
                            ctx.beginPath();
                            ctx.moveTo(x, y - 100);
                            ctx.lineTo(x, y + 100);
                            ctx.stroke();
                            
                            ctx.beginPath();
                            ctx.moveTo(x - 80, y - 60);
                            ctx.lineTo(x + 80, y - 60);
                            ctx.stroke();
                            
                            ctx.beginPath();
                            ctx.moveTo(x - 80, y + 60);
                            ctx.lineTo(x + 80, y + 60);
                            ctx.stroke();
                        });
                    } else {
                        ctx.beginPath();
                        ctx.moveTo(centerX, 100);
                        ctx.lineTo(centerX, 400);
                        ctx.stroke();
                        
                        ctx.beginPath();
                        ctx.moveTo(centerX - 150, 150);
                        ctx.lineTo(centerX + 150, 150);
                        ctx.stroke();
                        
                        ctx.beginPath();
                        ctx.moveTo(centerX - 150, 350);
                        ctx.lineTo(centerX + 150, 350);
                        ctx.stroke();
                    }
                    ctx.setLineDash([]);
                }
            }
        }
        
        // ç»˜åˆ¶é…å­
        function drawGametes() {
            if (gametes.length === 0) return;
            
            ctx.fillStyle = 'rgba(44, 90, 160, 0.8)';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            
            gametes.forEach((gamete, index) => {
                const x = 150 + index * 200;
                const y = 400;
                
                // ç»˜åˆ¶é…å­ç»†èƒ
                ctx.beginPath();
                ctx.arc(x, y, 40, 0, Math.PI * 2);
                ctx.stroke();
                
                // ç»˜åˆ¶é…å­ä¸­çš„æŸ“è‰²ä½“
                gamete.chromosomes.forEach((chromo, i) => {
                    ctx.save();
                    ctx.translate(x - 20 + (i % 3) * 20, y - 10 + Math.floor(i / 3) * 20);
                    
                    ctx.fillStyle = chromo.type === 'paternal' ? '#2c5aa0' : '#a02c6b';
                    ctx.fillRect(-5, -8, 10, 16);
                    
                    ctx.restore();
                });
                
                // æ˜¾ç¤ºé…å­ç¼–å·
                ctx.fillText(`é…å­ ${index + 1}`, x, y + 60);
                ctx.fillText(`${gamete.chromosomes.length}æ¡æŸ“è‰²ä½“`, x, y + 80);
            });
        }
        
        // æ›´æ–°æŸ“è‰²ä½“ä½ç½®ï¼ˆåŠ¨ç”»ï¼‰
        function updateChromosomes(deltaTime) {
            if (!isPlaying) return;
            
            stageProgress += deltaTime / 1000; // è½¬æ¢ä¸ºç§’
            
            const stage = stages[currentStage];
            const progress = Math.min(stageProgress / stage.duration, 1);
            
            // æ ¹æ®å½“å‰æ¨¡å—å’Œé˜¶æ®µæ›´æ–°æŸ“è‰²ä½“ä½ç½®
            switch(currentModule) {
                case 'overview':
                    updateOverviewPositions(progress);
                    break;
                case 'meiosis':
                    updateMeiosisPositions(progress);
                    break;
                case 'fertilization':
                    updateFertilizationPositions(progress);
                    break;
            }
            
            // å¦‚æœå½“å‰é˜¶æ®µå®Œæˆï¼Œè¿›å…¥ä¸‹ä¸€é˜¶æ®µ
            if (progress >= 1) {
                nextStage();
            }
        }
        
        // æ›´æ–°æ¦‚è§ˆæ¨¡å—çš„æŸ“è‰²ä½“ä½ç½®
        function updateOverviewPositions(progress) {
            switch(currentStage) {
                case 0: // ä½“ç»†èƒ
                    chromosomes.forEach((chromo, i) => {
                        const angle = (i / chromosomes.length) * Math.PI * 2;
                        const radius = 120;
                        chromo.x = 500 + Math.cos(angle) * radius;
                        chromo.y = 250 + Math.sin(angle) * radius;
                    });
                    break;
                    
                case 1: // å‡æ•°åˆ†è£‚
                    if (progress < 0.5) {
                        // å‡æ•°åˆ†è£‚Iï¼šåŒæºæŸ“è‰²ä½“åˆ†ç¦»
                        chromosomes.forEach((chromo, i) => {
                            const targetX = chromo.type === 'paternal' ? 300 : 700;
                            const targetY = 250 + (i % 10) * 20 - 100;
                            chromo.x += (targetX - chromo.x) * 0.05;
                            chromo.y += (targetY - chromo.y) * 0.05;
                        });
                        
                        if (progress > 0.3 && progress < 0.4) {
                            updateCounter(23);
                        }
                    } else {
                        // å‡æ•°åˆ†è£‚IIï¼šå§å¦¹æŸ“è‰²å•ä½“åˆ†ç¦»
                        chromosomes.forEach((chromo, i) => {
                            const baseX = chromo.type === 'paternal' ? 300 : 700;
                            const quadrant = Math.floor(i / 6) % 4;
                            let targetX, targetY;
                            
                            switch(quadrant) {
                                case 0: targetX = baseX - 50; targetY = 200; break;
                                case 1: targetX = baseX + 50; targetY = 200; break;
                                case 2: targetX = baseX - 50; targetY = 300; break;
                                case 3: targetX = baseX + 50; targetY = 300; break;
                            }
                            
                            chromo.x += (targetX - chromo.x) * 0.05;
                            chromo.y += (targetY - chromo.y) * 0.05;
                        });
                    }
                    break;
                    
                case 2: // é…å­
                    // é…å­ä¸­çš„æŸ“è‰²ä½“èšé›†
                    chromosomes.forEach((chromo, i) => {
                        const gameteIndex = Math.floor(i / 23);
                        const x = 150 + gameteIndex * 200;
                        const y = 400;
                        
                        chromo.x += (x - chromo.x) * 0.05;
                        chromo.y += (y - chromo.y) * 0.05;
                        chromo.inGamete = true;
                    });
                    break;
                    
                case 3: // å—ç²¾ä½œç”¨
                    // é…å­å‘ä¸­å¿ƒç§»åŠ¨
                    chromosomes.forEach((chromo, i) => {
                        const isPaternal = chromo.type === 'paternal';
                        const targetX = isPaternal ? 400 : 600;
                        const targetY = 250;
                        
                        chromo.x += (targetX - chromo.x) * 0.05;
                        chromo.y += (targetY - chromo.y) * 0.05;
                    });
                    break;
                    
                case 4: // æ–°ä¸ªä½“
                    // æŸ“è‰²ä½“åˆ†æ•£åœ¨å—ç²¾åµä¸­
                    chromosomes.forEach((chromo, i) => {
                        const angle = (i / chromosomes.length) * Math.PI * 2;
                        const radius = 80;
                        chromo.x = 500 + Math.cos(angle) * radius;
                        chromo.y = 250 + Math.sin(angle) * radius;
                        chromo.inGamete = false;
                    });
                    updateCounter(46);
                    break;
            }
        }
        
        // æ›´æ–°å‡æ•°åˆ†è£‚æ¨¡å—çš„æŸ“è‰²ä½“ä½ç½®
        function updateMeiosisPositions(progress) {
            // æ ¹æ®å‡æ•°åˆ†è£‚é˜¶æ®µæ›´æ–°ä½ç½®
            // è¿™é‡Œç®€åŒ–å®ç°ï¼Œå®é™…åº”æ ¹æ®æ¯ä¸ªé˜¶æ®µçš„å…·ä½“ç”Ÿç‰©å­¦è¿‡ç¨‹
            chromosomes.forEach((chromo, i) => {
                let targetX, targetY;
                
                switch(currentStage) {
                    case 0: // é—´æœŸ
                        targetX = 500 + (i % 10) * 30 - 150;
                        targetY = 250 + Math.floor(i / 10) * 30 - 75;
                        break;
                        
                    case 1: // å‰æœŸI - åŒæºæŸ“è‰²ä½“é…å¯¹
                        const pairX = 500 + (chromo.pairId % 8) * 40 - 160;
                        const pairY = 250 + Math.floor(chromo.pairId / 8) * 40 - 80;
                        targetX = pairX + (chromo.type === 'paternal' ? -15 : 15);
                        targetY = pairY;
                        break;
                        
                    case 2: // ä¸­æœŸI - æ’åˆ—åœ¨èµ¤é“æ¿
                        targetX = 500;
                        targetY = 250 + chromo.pairId * 8 - 92;
                        break;
                        
                    case 3: // åæœŸI - åŒæºæŸ“è‰²ä½“åˆ†ç¦»
                        targetX = chromo.type === 'paternal' ?
<!--æ£€æµ‹åˆ°ä»£ç æˆªæ–­ï¼Œè‡ªåŠ¨ç»­å†™ä¸­...-->
350 : 650;
                        targetY = 250 + (chromo.pairId % 12) * 15 - 90;
                        break;
                        
                    case 4: // æœ«æœŸI - å½¢æˆä¸¤ä¸ªç»†èƒ
                        targetX = chromo.type === 'paternal' ? 250 : 750;
                        targetY = 250 + (chromo.pairId % 12) * 15 - 90;
                        break;
                        
                    case 5: // å‰æœŸII
                        targetX = chromo.type === 'paternal' ? 250 : 750;
                        targetY = 250 + (chromo.pairId % 12) * 15 - 90;
                        break;
                        
                    case 6: // ä¸­æœŸII
                        const cellOffset = chromo.type === 'paternal' ? 0 : 500;
                        const cellIndex = chromo.pairId % 2;
                        targetX = cellOffset + (cellIndex === 0 ? 200 : 300);
                        targetY = cellIndex === 0 ? 200 : 300;
                        break;
                        
                    case 7: // åæœŸII - å§å¦¹æŸ“è‰²å•ä½“åˆ†ç¦»
                        const baseCell = chromo.type === 'paternal' ? 0 : 500;
                        const chromoIndex = chromo.pairId % 4;
                        switch(chromoIndex) {
                            case 0: targetX = baseCell + 180; targetY = 180; break;
                            case 1: targetX = baseCell + 220; targetY = 180; break;
                            case 2: targetX = baseCell + 180; targetY = 320; break;
                            case 3: targetX = baseCell + 220; targetY = 320; break;
                        }
                        break;
                        
                    case 8: // æœ«æœŸII - å››ä¸ªé…å­
                        const gameteGroup = chromo.type === 'paternal' ? 0 : 2;
                        const gametePos = chromo.pairId % 4;
                        switch(gameteGroup + (gametePos % 2)) {
                            case 0: targetX = 200; targetY = 200; break;
                            case 1: targetX = 300; targetY = 300; break;
                            case 2: targetX = 700; targetY = 200; break;
                            case 3: targetX = 800; targetY = 300; break;
                        }
                        chromo.inGamete = true;
                        break;
                }
                
                if (targetX !== undefined && targetY !== undefined) {
                    chromo.x += (targetX - chromo.x) * 0.05;
                    chromo.y += (targetY - chromo.y) * 0.05;
                }
            });
            
            // æ›´æ–°æŸ“è‰²ä½“è®¡æ•°å™¨
            if (currentStage === 3 && progress > 0.5) {
                updateCounter(23); // åæœŸIæŸ“è‰²ä½“æ•°ç›®å‡åŠ
            }
        }
        
        // æ›´æ–°å—ç²¾ä½œç”¨æ¨¡å—çš„æŸ“è‰²ä½“ä½ç½®
        function updateFertilizationPositions(progress) {
            switch(currentStage) {
                case 0: // é…å­ç›¸é‡
                    chromosomes.forEach((chromo, i) => {
                        const isPaternal = chromo.type === 'paternal';
                        const baseX = isPaternal ? 350 : 650;
                        const baseY = 250;
                        const angle = (i / 23) * Math.PI * 2;
                        const radius = 50;
                        
                        chromo.x = baseX + Math.cos(angle) * radius;
                        chromo.y = baseY + Math.sin(angle) * radius;
                        chromo.inGamete = true;
                    });
                    updateCounter(23);
                    break;
                    
                case 1: // ç²¾åµç»“åˆ
                    chromosomes.forEach((chromo, i) => {
                        const isPaternal = chromo.type === 'paternal';
                        const targetX = isPaternal ? 450 : 550;
                        const targetY = 250;
                        
                        chromo.x += (targetX - chromo.x) * 0.05;
                        chromo.y += (targetY - chromo.y) * 0.05;
                    });
                    break;
                    
                case 2: // æ ¸è†œæ¶ˆå¤±
                    chromosomes.forEach((chromo, i) => {
                        const angle = (i / chromosomes.length) * Math.PI * 2;
                        const radius = 80;
                        chromo.x = 500 + Math.cos(angle) * radius;
                        chromo.y = 250 + Math.sin(angle) * radius;
                    });
                    break;
                    
                case 3: // æŸ“è‰²ä½“è”åˆ
                    chromosomes.forEach((chromo, i) => {
                        // åŒæºæŸ“è‰²ä½“é…å¯¹
                        const pairId = chromo.pairId;
                        const isPaternal = chromo.type === 'paternal';
                        const pairX = 500 + (pairId % 8) * 30 - 120;
                        const pairY = 250 + Math.floor(pairId / 8) * 30 - 60;
                        
                        const targetX = pairX + (isPaternal ? -12 : 12);
                        const targetY = pairY;
                        
                        chromo.x += (targetX - chromo.x) * 0.05;
                        chromo.y += (targetY - chromo.y) * 0.05;
                        chromo.inGamete = false;
                    });
                    break;
                    
                case 4: // å—ç²¾åµå½¢æˆ
                    chromosomes.forEach((chromo, i) => {
                        const angle = (i / chromosomes.length) * Math.PI * 2;
                        const radius = 60;
                        const targetX = 500 + Math.cos(angle) * radius;
                        const targetY = 250 + Math.sin(angle) * radius;
                        
                        chromo.x += (targetX - chromo.x) * 0.05;
                        chromo.y += (targetY - chromo.y) * 0.05;
                    });
                    updateCounter(46);
                    break;
            }
        }
        
        // ä¸»åŠ¨ç”»å¾ªç¯
        function animate(timestamp) {
            if (!lastTime) lastTime = timestamp;
            const deltaTime = timestamp - lastTime;
            lastTime = timestamp;
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // æ›´æ–°å’Œç»˜åˆ¶
            updateChromosomes(deltaTime);
            drawCell();
            
            // ç»˜åˆ¶æŸ“è‰²ä½“
            chromosomes.forEach(chromo => {
                if (!chromo.inGamete || currentModule === 'fertilization') {
                    drawChromosome(chromo);
                }
            });
            
            // ç»˜åˆ¶é…å­ï¼ˆå¦‚æœéœ€è¦ï¼‰
            if (currentModule === 'overview' && currentStage === 2) {
                drawGametes();
            }
            
            // ç»§ç»­åŠ¨ç”»å¾ªç¯
            if (isPlaying || animationId) {
                animationId = requestAnimationFrame(animate);
            }
        }
        
        // åˆ‡æ¢åˆ°ä¸‹ä¸€é˜¶æ®µ
        function nextStage() {
            if (currentStage < stages.length - 1) {
                currentStage++;
                stageProgress = 0;
                updateInfoPanel();
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦å¼¹å‡ºæµ‹éªŒ
                if (currentModule === 'meiosis' && currentStage === 3) {
                    setTimeout(() => showQuiz("åŒæºæŸ“è‰²ä½“åˆ†ç¦»å‘ç”Ÿåœ¨å“ªä¸€æ¬¡åˆ†è£‚ï¼Ÿ", [
                        "å‡æ•°åˆ†è£‚I",
                        "å‡æ•°åˆ†è£‚II", 
                        "æœ‰ä¸åˆ†è£‚",
                        "ä¸¤æ¬¡åˆ†è£‚éƒ½ä¼šå‘ç”Ÿ"
                    ], 0), 500);
                }
            } else if (isPlaying) {
                // å¦‚æœæ˜¯è‡ªåŠ¨æ’­æ”¾ï¼Œå¾ªç¯å›åˆ°ç¬¬ä¸€é˜¶æ®µ
                currentStage = 0;
                stageProgress = 0;
                updateInfoPanel();
            }
        }
        
        // åˆ‡æ¢åˆ°ä¸Šä¸€é˜¶æ®µ
        function prevStage() {
            if (currentStage > 0) {
                currentStage--;
                stageProgress = 0;
                updateInfoPanel();
            }
        }
        
        // åˆ‡æ¢æ¨¡å—
        function switchModule(moduleName) {
            currentModule = moduleName;
            currentStage = 0;
            stageProgress = 0;
            
            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.module === moduleName);
            });
            
            // è®¾ç½®å¯¹åº”çš„é˜¶æ®µæ•°æ®
            switch(moduleName) {
                case 'overview':
                    stages = overviewStages;
                    initChromosomes();
                    break;
                case 'meiosis':
                    stages = meiosisStages;
                    initChromosomes();
                    break;
                case 'fertilization':
                    stages = fertilizationStages;
                    initChromosomes();
                    break;
            }
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('crossoverBtn').style.display = 
                moduleName === 'meiosis' ? 'flex' : 'none';
            document.getElementById('generateGameteBtn').style.display = 
                moduleName === 'meiosis' ? 'flex' : 'none';
            
            updateInfoPanel();
            
            // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œé‡æ–°å¼€å§‹åŠ¨ç”»
            if (isPlaying) {
                playAnimation();
            }
        }
        
        // æ’­æ”¾åŠ¨ç”»
        function playAnimation() {
            if (!isPlaying) {
                isPlaying = true;
                document.getElementById('playBtn').innerHTML = '<span>â–¶</span> æ’­æ”¾ä¸­...';
                if (!animationId) {
                    lastTime = 0;
                    animationId = requestAnimationFrame(animate);
                }
            }
        }
        
        // æš‚åœåŠ¨ç”»
        function pauseAnimation() {
            isPlaying = false;
            document.getElementById('playBtn').innerHTML = '<span>â–¶</span> æ’­æ”¾';
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
        }
        
        // é‡ç½®åŠ¨ç”»
        function resetAnimation() {
            currentStage = 0;
            stageProgress = 0;
            initChromosomes();
            updateInfoPanel();
            
            if (isPlaying) {
                pauseAnimation();
                playAnimation();
            }
        }
        
        // æ‰§è¡Œäº¤å‰äº’æ¢
        function performCrossover() {
            if (currentModule !== 'meiosis' || currentStage !== 1) {
                alert("è¯·åœ¨å‡æ•°åˆ†è£‚çš„'å‰æœŸ I'é˜¶æ®µè¿›è¡Œäº¤å‰äº’æ¢æ“ä½œã€‚");
                return;
            }
            
            // éšæœºé€‰æ‹©ä¸€å¯¹åŒæºæŸ“è‰²ä½“è¿›è¡Œäº¤å‰äº’æ¢
            const pairId = Math.floor(Math.random() * 23);
            const paternal = chromosomes.find(c => c.type === 'paternal' && c.pairId === pairId);
            const maternal = chromosomes.find(c => c.type === 'maternal' && c.pairId === pairId);
            
            if (paternal && maternal) {
                // æ·»åŠ äº¤å‰äº’æ¢ç‚¹
                paternal.crossoverPoints.push(20);
                maternal.crossoverPoints.push(-20);
                
                // æ”¹å˜é¢œè‰²è¡¨ç¤ºé‡ç»„
                paternal.color = '#5a8cd0';
                maternal.color = '#d05a94';
                
                // æ˜¾ç¤ºä¿¡æ¯
                infoContent.innerHTML = `ç¬¬${pairId + 1}å¯¹åŒæºæŸ“è‰²ä½“å‘ç”Ÿäº†äº¤å‰äº’æ¢ï¼éå§å¦¹æŸ“è‰²å•ä½“é—´äº¤æ¢äº†ç‰‡æ®µï¼Œå¢åŠ äº†é—ä¼ å¤šæ ·æ€§ã€‚`;
                
                // æ·»åŠ è§†è§‰æ•ˆæœ
                setTimeout(() => {
                    paternal.color = 'linear-gradient(45deg, #2c5aa0 50%, #a02c6b 50%)';
                    maternal.color = 'linear-gradient(45deg, #a02c6b 50%, #2c5aa0 50%)';
                }, 500);
            }
        }
        
        // éšæœºç”Ÿæˆé…å­
        function generateRandomGamete() {
            if (currentModule !== 'meiosis' || currentStage < 8) {
                alert("è¯·åœ¨å‡æ•°åˆ†è£‚å®Œæˆåç”Ÿæˆé…å­ã€‚");
                return;
            }
            
            // åˆ›å»ºä¸€ä¸ªéšæœºé…å­
            const gamete = {
                id: gametes.length + 1,
                chromosomes: []
            };
            
            // ä»æ¯å¯¹åŒæºæŸ“è‰²ä½“ä¸­éšæœºé€‰æ‹©ä¸€ä¸ª
            for (let i = 0; i < 23; i++) {
                const isPaternal = Math.random() > 0.5;
                const original = chromosomes.find(c => c.pairId === i && c.type === (isPaternal ? 'paternal' : 'maternal'));
                
                if (original) {
                    gamete.chromosomes.push({
                        ...original,
                        id: `g${gametes.length}_${i}`,
                        x: 150 + gametes.length * 200,
                        y: 400
                    });
                }
            }
            
            gametes.push(gamete);
            
            // é™åˆ¶æœ€å¤šæ˜¾ç¤º4ä¸ªé…å­
            if (gametes.length > 4) {
                gametes.shift();
            }
            
            // æ˜¾ç¤ºä¿¡æ¯
            infoContent.innerHTML = `ç”Ÿæˆäº†æ–°çš„é…å­ï¼ç”±äºéåŒæºæŸ“è‰²ä½“çš„è‡ªç”±ç»„åˆï¼Œæ¯ä¸ªé…å­çš„æŸ“è‰²ä½“ç»„æˆéƒ½ä¸åŒã€‚è¿™å¢åŠ äº†é—ä¼ å¤šæ ·æ€§ã€‚<br>å·²ç”Ÿæˆ ${gametes.length} ä¸ªé…å­ç¤ºä¾‹ã€‚`;
        }
        
        // æ˜¾ç¤ºæµ‹éªŒ
        function showQuiz(question, options, correctIndex) {
            quizQuestion.textContent = question;
            quizOptions.innerHTML = '';
            
            options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'quiz-option';
                optionElement.textContent = option;
                optionElement.dataset.correct = index === correctIndex;
                
                optionElement.addEventListener('click', function() {
                    const isCorrect = this.dataset.correct === 'true';
                    
                    // æ˜¾ç¤ºæ­£ç¡®/é”™è¯¯åé¦ˆ
                    document.querySelectorAll('.quiz-option').forEach(opt => {
                        opt.classList.remove('correct', 'incorrect');
                        if (opt.dataset.correct === 'true') {
                            opt.classList.add('correct');
                        } else if (opt === this && !isCorrect) {
                            opt.classList.add('incorrect');
                        }
                    });
                    
                    if (isCorrect) {
                        this.classList.add('correct');
                        infoContent.innerHTML = "<span style='color:#4CAF50;'>âœ“ å›ç­”æ­£ç¡®ï¼</span> åŒæºæŸ“è‰²ä½“åˆ†ç¦»å‘ç”Ÿåœ¨å‡æ•°åˆ†è£‚Iï¼Œè¿™æ˜¯æŸ“è‰²ä½“æ•°ç›®å‡åŠçš„å…³é”®æ­¥éª¤ã€‚";
                    }
                });
                
                quizOptions.appendChild(optionElement);
            });
            
            quizPopup.style.display = 'block';
        }
        
        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initEventListeners() {
            // æ¨¡å—æ ‡ç­¾åˆ‡æ¢
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    switchModule(tab.dataset.module);
                });
            });
            
            // æ§åˆ¶æŒ‰é’®
            document.getElementById('playBtn').addEventListener('click', playAnimation);
            document.getElementById('pauseBtn').addEventListener('click', pauseAnimation);
            document.getElementById('resetBtn').addEventListener('click', resetAnimation);
            document.getElementById('prevBtn').addEventListener('click', prevStage);
            document.getElementById('nextBtn').addEventListener('click', nextStage);
            
            // äº¤äº’æŒ‰é’®
            document.getElementById('crossoverBtn').addEventListener('click', performCrossover);
            document.getElementById('generateGameteBtn').addEventListener('click', generateRandomGamete);
            
            // è§†è§‰è¾…åŠ©å¼€å…³
            document.getElementById('spindleToggle').addEventListener('change', function() {
                showSpindle = this.checked;
            });
            
            document.getElementById('geneToggle').addEventListener('change', function() {
                showGenes = this.checked;
            });
            
            document.getElementById('detailedViewToggle').addEventListener('change', function() {
                detailedView = this.checked;
            });
            
            // æµ‹éªŒå…³é—­æŒ‰é’®
            document.getElementById('closeQuiz').addEventListener('click', function() {
                quizPopup.style.display = 'none';
            });
            
            // ç‚¹å‡»æŸ“è‰²ä½“é€‰æ‹©
            canvas.addEventListener('click', function(event) {
                const rect = canvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;
                
                // æŸ¥æ‰¾ç‚¹å‡»çš„æŸ“è‰²ä½“
                for (const chromo of chromosomes) {
                    const dx = x - chromo.x;
                    const dy = y - chromo.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < 40) {
                        selectedChromosome = chromo;
                        
                        // æ˜¾ç¤ºæŸ“è‰²ä½“ä¿¡æ¯
                        const typeText = chromo.type === 'paternal' ? 'çˆ¶æº' : 'æ¯æº';
                        infoTitle.textContent = `æŸ“è‰²ä½“ä¿¡æ¯ (${typeText})`;
                        infoContent.innerHTML = `
                            <strong>æŸ“è‰²ä½“å¯¹:</strong> ç¬¬${chromo.pairId + 1}å¯¹<br>
                            <strong>æ¥æº:</strong> ${typeText}æŸ“è‰²ä½“<br>
                            <strong>çŠ¶æ€:</strong> ${chromo.replicated ? 'å·²å¤åˆ¶ï¼ˆä¸¤ä¸ªæŸ“è‰²å•ä½“ï¼‰' : 'æœªå¤åˆ¶'}<br>
                            <strong>ä½ç½®:</strong> ç»†èƒ${chromo.inGamete ? 'é…å­ä¸­' : 'æ ¸å†…'}<br>
                            ${chromo.crossoverPoints.length > 0 ? '<strong>ç‰¹å¾:</strong> å·²å‘ç”Ÿäº¤å‰äº’æ¢' : ''}
                        `;
                        return;
                    }
                }
                
                // å¦‚æœç‚¹å‡»ç©ºç™½å¤„ï¼Œå–æ¶ˆé€‰æ‹©
                selectedChromosome = null;
            });
            
            // é”®ç›˜æ§åˆ¶
            document.addEventListener('keydown', function(event) {
                switch(event.key) {
                    case ' ':
                        event.preventDefault();
                        if (isPlaying) pauseAnimation();
                        else playAnimation();
                        break;
                    case 'ArrowLeft':
                        event.preventDefault();
                        prevStage();
                        break;
                    case 'ArrowRight':
                        event.preventDefault();
                        nextStage();
                        break;
                    case 'r':
                    case 'R':
                        resetAnimation();
                        break;
                }
            });
        }
        
        // åˆå§‹åŒ–å‡½æ•°
        function init() {
            initChromosomes();
            initEventListeners();
            updateInfoPanel();
            
            // å¼€å§‹åŠ¨ç”»
            playAnimation();
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>