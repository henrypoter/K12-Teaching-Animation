<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­å¿ƒæ³•åˆ™ï¼šä»DNAåˆ°è›‹ç™½è´¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.92);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 100, 0.1);
            padding: 25px;
            overflow: hidden;
        }
        
        header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eaeef5;
        }
        
        h1 {
            color: #2c3e50;
            font-size: 2.4rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #3498db, #2c3e50);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 1.2rem;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .animation-section {
            background-color: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #eaeef5;
        }
        
        .canvas-container {
            position: relative;
            width: 100%;
            height: 500px;
            background-color: #f8fafc;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #dce4ef;
        }
        
        #animationCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .controls-section {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-items: center;
            padding: 20px;
            background-color: #f8fafc;
            border-radius: 12px;
        }
        
        .scene-nav {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background-color: #2ecc71;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
        }
        
        .btn-scene {
            background-color: #9b59b6;
            color: white;
        }
        
        .btn-scene:hover {
            background-color: #8e44ad;
            transform: translateY(-2px);
        }
        
        .btn-scene.active {
            background-color: #732d91;
            box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.2);
        }
        
        .btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        .info-panel {
            background-color: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #eaeef5;
        }
        
        h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.6rem;
            border-left: 5px solid #3498db;
            padding-left: 12px;
        }
        
        .info-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .info-box {
            background-color: #f8fafc;
            padding: 18px;
            border-radius: 10px;
            border-left: 4px solid;
        }
        
        .info-box h3 {
            margin-bottom: 10px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-box.transcription {
            border-left-color: #e74c3c;
        }
        
        .info-box.splicing {
            border-left-color: #9b59b6;
        }
        
        .info-box.translation {
            border-left-color: #2ecc71;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eaeef5;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .legend-label {
            font-size: 0.9rem;
        }
        
        .game-mode {
            background-color: #fff9e6;
            border: 2px dashed #f1c40f;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }
        
        .game-mode h3 {
            color: #d35400;
            margin-bottom: 10px;
        }
        
        .status-bar {
            position: absolute;
            top: 15px;
            left: 15px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            z-index: 10;
            border: 1px solid #eaeef5;
        }
        
        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            pointer-events: none;
            z-index: 100;
            max-width: 250px;
            display: none;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .canvas-container {
                height: 400px;
            }
            
            .controls-section {
                flex-direction: column;
            }
            
            .btn {
                padding: 10px 18px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ä¸­å¿ƒæ³•åˆ™ï¼šä»DNAåˆ°è›‹ç™½è´¨</h1>
            <p class="subtitle">æ¢ç´¢é—ä¼ ä¿¡æ¯å¦‚ä½•ä»DNAè½¬å½•ä¸ºmRNAï¼Œç»è¿‡å‰ªæ¥åç¿»è¯‘æˆè›‹ç™½è´¨çš„å®Œæ•´è¿‡ç¨‹</p>
        </header>
        
        <div class="main-content">
            <div class="animation-section">
                <div class="canvas-container">
                    <div class="status-bar" id="statusBar">åœºæ™¯ï¼šè½¬å½•ä¸å‰ªæ¥</div>
                    <canvas id="animationCanvas"></canvas>
                    <div class="tooltip" id="tooltip"></div>
                </div>
            </div>
            
            <div class="controls-section">
                <div class="scene-nav">
                    <button class="btn btn-scene active" id="scene1Btn">1. è½¬å½•ä¸å‰ªæ¥</button>
                    <button class="btn btn-scene" id="scene2Btn">2. mRNAè¿è¾“</button>
                    <button class="btn btn-scene" id="scene3Btn">3. ç¿»è¯‘åˆæˆ</button>
                </div>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" id="playBtn">æ’­æ”¾</button>
                    <button class="btn btn-primary" id="pauseBtn">æš‚åœ</button>
                    <button class="btn btn-primary" id="stepBtn">ä¸‹ä¸€æ­¥</button>
                    <button class="btn btn-primary" id="resetBtn">é‡ç½®</button>
                </div>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" id="toggleLabelsBtn">æ˜¾ç¤ºæ ‡ç­¾</button>
                    <button class="btn btn-secondary" id="highlightBtn">é«˜äº®é…å¯¹</button>
                    <button class="btn btn-secondary" id="gameModeBtn">æ‹–æ‹½åŒ¹é…æ¸¸æˆ</button>
                </div>
            </div>
            
            <div class="info-panel">
                <h2>è¿‡ç¨‹è¯¦è§£</h2>
                <div class="info-content">
                    <div class="info-box transcription">
                        <h3>ğŸ“ è½¬å½•</h3>
                        <p>åœ¨ç»†èƒæ ¸å†…ï¼ŒRNAèšåˆé…¶ä»¥DNAçš„ä¸€æ¡é“¾ä¸ºæ¨¡æ¿ï¼ŒæŒ‰ç…§ç¢±åŸºäº’è¡¥é…å¯¹åŸåˆ™ï¼ˆA-Uï¼ŒT-Aï¼ŒC-Gï¼ŒG-Cï¼‰åˆæˆpre-mRNAåˆ†å­ã€‚</p>
                    </div>
                    <div class="info-box splicing">
                        <h3>âœ‚ï¸ RNAå‰ªæ¥</h3>
                        <p>pre-mRNAä¸­çš„å†…å«å­ï¼ˆéç¼–ç åŒºï¼‰è¢«å‰ªæ¥ä½“è¯†åˆ«å¹¶åˆ‡é™¤ï¼Œå¤–æ˜¾å­ï¼ˆç¼–ç åŒºï¼‰è¿æ¥åœ¨ä¸€èµ·å½¢æˆæˆç†Ÿçš„mRNAã€‚</p>
                    </div>
                    <div class="info-box translation">
                        <h3>ğŸ§¬ ç¿»è¯‘</h3>
                        <p>mRNAè¿›å…¥ç»†èƒè´¨ï¼Œæ ¸ç³–ä½“è¯»å–å…¶å¯†ç å­åºåˆ—ï¼ŒtRNAæºå¸¦ç›¸åº”çš„æ°¨åŸºé…¸ï¼Œé€šè¿‡åå¯†ç å­ä¸å¯†ç å­é…å¯¹ï¼Œåˆæˆå¤šè‚½é“¾ã€‚</p>
                    </div>
                </div>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #2c3e50;"></div>
                        <span class="legend-label">DNA</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e74c3c;"></div>
                        <span class="legend-label">mRNA</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #9b59b6;"></div>
                        <span class="legend-label">tRNA</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #2ecc71;"></div>
                        <span class="legend-label">æ°¨åŸºé…¸/è›‹ç™½è´¨</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f1c40f;"></div>
                        <span class="legend-label">æ ¸ç³–ä½“</span>
                    </div>
                </div>
                
                <div class="game-mode" id="gameModePanel" style="display: none;">
                    <h3>ğŸ§ª æ‹–æ‹½åŒ¹é…æ¸¸æˆ</h3>
                    <p>å°†æ­£ç¡®çš„tRNAæ‹–æ‹½åˆ°æ ¸ç³–ä½“çš„Aä½ç‚¹ä¸Šï¼ŒåŒ¹é…mRNAä¸Šçš„å¯†ç å­ï¼</p>
                    <div id="gameInfo">
                        <p>å½“å‰å¯†ç å­: <span id="currentCodon">AUG</span></p>
                        <p>å¾—åˆ†: <span id="gameScore">0</span> / <span id="gameTotal">0</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è·å–Canvaså’Œä¸Šä¸‹æ–‡
        const canvas = document.getElementById('animationCanvas');
        const ctx = canvas.getContext('2d');
        const tooltip = document.getElementById('tooltip');
        const statusBar = document.getElementById('statusBar');
        
        // è®¾ç½®Canvaså°ºå¯¸
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }
        
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        
        // åŠ¨ç”»çŠ¶æ€
        let currentScene = 1; // 1: è½¬å½•ä¸å‰ªæ¥, 2: mRNAè¿è¾“, 3: ç¿»è¯‘åˆæˆ
        let isPlaying = false;
        let animationFrameId = null;
        let showLabels = true;
        let highlightPairing = true;
        let gameMode = false;
        let gameScore = 0;
        let gameTotal = 0;
        
        // é¢œè‰²å®šä¹‰
        const colors = {
            dna: '#2c3e50',
            dnaStrand2: '#3498db',
            mrna: '#e74c3c',
            preMrnaIntron: '#e67e22',
            trna: '#9b59b6',
            aminoAcid: '#2ecc71',
            ribosome: '#f1c40f',
            nucleus: 'rgba(52, 152, 219, 0.1)',
            cytoplasm: 'rgba(46, 204, 113, 0.05)',
            text: '#2c3e50',
            highlight: '#f1c40f'
        };
        
        // ç¢±åŸºå®šä¹‰
        const dnaBases = ['A', 'T', 'C', 'G'];
        const rnaBases = ['A', 'U', 'C', 'G'];
        const aminoAcids = ['Met', 'Leu', 'Ser', 'Arg', 'Gly', 'Pro', 'Val', 'Thr', 'Ala'];
        
        // åœºæ™¯1: è½¬å½•ä¸å‰ªæ¥
        const scene1 = {
            dnaX: 100,
            dnaY: 250,
            dnaLength: 400,
            transcriptionProgress: 0,
            rnaPolymeraseX: 100,
            preMrna: [],
            spliced: false,
            splicingProgress: 0,
            introns: [
                {start: 3, end: 5, removed: false},
                {start: 8, end: 10, removed: false}
            ]
        };
        
        // åœºæ™¯2: mRNAè¿è¾“
        const scene2 = {
            mrnaX: 150,
            mrnaY: 250,
            nucleusX: 100,
            nucleusY: 200,
            nucleusRadius: 120,
            nuclearPoreX: 220,
            nuclearPoreY: 200,
            transportProgress: 0,
            ribosomeX: 500,
            ribosomeY: 250,
            assemblyProgress: 0
        };
        
        // åœºæ™¯3: ç¿»è¯‘åˆæˆ
        const scene3 = {
            mrnaX: 200,
            mrnaY: 300,
            mrnaSequence: ['AUG', 'CUU', 'UCU', 'AGA', 'GGA', 'CCA', 'GUA', 'ACC', 'GCA', 'UAA'],
            currentCodonIndex: 0,
            ribosomeX: 300,
            ribosomeY: 300,
            trnas: [],
            peptideChain: [],
            translationProgress: 0,
            draggingTrna: null,
            dragOffsetX: 0,
            dragOffsetY: 0
        };
        
        // åˆå§‹åŒ–tRNA
        function initTranslationScene() {
            scene3.trnas = [];
            scene3.peptideChain = [];
            scene3.currentCodonIndex = 0;
            
            // åˆ›å»ºä¸€äº›æ¸¸ç¦»çš„tRNA
            for (let i = 0; i < 5; i++) {
                scene3.trnas.push({
                    x: 100 + Math.random() * 150,
                    y: 100 + Math.random() * 150,
                    anticodon: getRandomAnticodon(),
                    aminoAcid: aminoAcids[Math.floor(Math.random() * aminoAcids.length)],
                    state: 'free', // free, inA, inP, inE
                    inRibosome: false
                });
            }
            
            // ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªæ­£ç¡®çš„tRNA
            const correctAnticodon = getComplementaryCodon(scene3.mrnaSequence[0]);
            scene3.trnas[0].anticodon = correctAnticodon;
            scene3.trnas[0].aminoAcid = 'Met'; // AUGå¯¹åº”ç”²ç¡«æ°¨é…¸
        }
        
        // è·å–éšæœºåå¯†ç å­
        function getRandomAnticodon() {
            const bases = ['A', 'U', 'C', 'G'];
            let codon = '';
            for (let i = 0; i < 3; i++) {
                codon += bases[Math.floor(Math.random() * bases.length)];
            }
            return codon;
        }
        
        // è·å–äº’è¡¥å¯†ç å­
        function getComplementaryCodon(codon) {
            const complement = {
                'A': 'U',
                'U': 'A',
                'C': 'G',
                'G': 'C'
            };
            
            let result = '';
            for (let i = 0; i < codon.length; i++) {
                result += complement[codon[i]] || ' ';
            }
            return result;
        }
        
        // ç»˜åˆ¶DNAåŒèºæ—‹
        function drawDNA(x, y, length, progress = 1) {
            const segmentCount = 20;
            const segmentLength = length / segmentCount;
            
            // ç»˜åˆ¶DNAéª¨æ¶
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x + length * progress, y);
            ctx.strokeStyle = colors.dna;
            ctx.lineWidth = 3;
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(x, y + 20);
            ctx.lineTo(x + length * progress, y + 20);
            ctx.strokeStyle = colors.dnaStrand2;
            ctx.lineWidth = 3;
            ctx.stroke();
            
            // ç»˜åˆ¶ç¢±åŸºå¯¹
            const visibleSegments = Math.floor(segmentCount * progress);
            for (let i = 0; i < visibleSegments; i++) {
                const segX = x + i * segmentLength + segmentLength / 2;
                
                // ç¢±åŸºå¯¹è¿çº¿
                ctx.beginPath();
                ctx.moveTo(segX, y);
                ctx.lineTo(segX, y + 20);
                ctx.strokeStyle = i % 2 === 0 ? '#e74c3c' : '#2ecc71';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // ç¢±åŸºæ ‡ç­¾
                if (showLabels && i % 3 === 0) {
                    ctx.fillStyle = colors.text;
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(dnaBases[i % 4], segX - 5, y - 5);
                    ctx.fillText(dnaBases[(i + 1) % 4], segX + 5, y + 25);
                }
            }
            
            // DNAæ ‡ç­¾
            if (showLabels) {
                ctx.fillStyle = colors.text;
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('DNA', x + length / 2, y - 30);
            }
        }
        
        // ç»˜åˆ¶RNAèšåˆé…¶
        function drawRNAPolymerase(x, y) {
            ctx.fillStyle = '#8e44ad';
            ctx.beginPath();
            ctx.ellipse(x, y, 20, 15, 0, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = '#732d91';
            ctx.beginPath();
            ctx.ellipse(x, y, 12, 10, 0, 0, Math.PI * 2);
            ctx.fill();
            
            if (showLabels) {
                ctx.fillStyle = colors.text;
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('RNAèšåˆé…¶', x, y - 25);
            }
        }
        
        // ç»˜åˆ¶pre-mRNA/mRNA
        function drawRNA(x, y, sequence, isMature = false, introns = []) {
            const baseSpacing = 15;
            const totalWidth = sequence.length * baseSpacing;
            
            // ç»˜åˆ¶RNAéª¨æ¶
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x + totalWidth, y);
            ctx.strokeStyle = colors.mrna;
            ctx.lineWidth = 3;
            ctx.stroke();
            
            // ç»˜åˆ¶ç¢±åŸº
            for (let i = 0; i < sequence.length; i++) {
                const baseX = x + i * baseSpacing;
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºå†…å«å­
                let isIntron = false;
                for (const intron of introns) {
                    if (i >= intron.start && i <= intron.end && !intron.removed) {
                        isIntron = true;
                        break;
                    }
                }
                
                // ç»˜åˆ¶ç¢±åŸº
                ctx.beginPath();
                ctx.moveTo(baseX, y);
                ctx.lineTo(baseX, y + (i % 2 === 0 ? 15 : -15));
                ctx.strokeStyle = isIntron ? colors.preMrnaIntron : colors.mrna;
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // ç¢±åŸºæ ‡ç­¾
                if (showLabels && i % 3 === 0) {
                    ctx.fillStyle = isIntron ? colors.preMrnaIntron : colors.text;
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(sequence[i], baseX, y + (i % 2 === 0 ? 25 : -25));
                }
            }
            
            // RNAæ ‡ç­¾
            if (showLabels) {
                ctx.fillStyle = colors.text;
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(isMature ? 'mRNA' : 'pre-mRNA', x + totalWidth / 2, y - 40);
            }
            
            return totalWidth;
        }
        
        // ç»˜åˆ¶å‰ªæ¥è¿‡ç¨‹
        function drawSplicing(x, y, progress, introns) {
            const radius = 30;
            const angle = Math.PI * 2 * progress;
            
            // ç»˜åˆ¶å‰ªæ¥ä½“
            ctx.strokeStyle = '#f39c12';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, angle);
            ctx.stroke();
            
            // ç»˜åˆ¶è¢«åˆ‡é™¤çš„å†…å«å­
            for (let i = 0; i < introns.length; i++) {
                if (introns[i].removed) {
                    const intronX = x + 100 + i * 60;
                    const intronY = y + 50;
                    
                    // ç»˜åˆ¶å†…å«å­ç¯
                    ctx.strokeStyle = colors.preMrnaIntron;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(intronX, intronY, 20, 0, Math.PI * 2 * (1 - progress));
                    ctx.stroke();
                    
                    // ç»˜åˆ¶é™è§£æ•ˆæœ
                    if (progress > 0.5) {
                        ctx.globalAlpha = 1 - (progress - 0.5) * 2;
                        ctx.fillStyle = colors.preMrnaIntron;
                        ctx.beginPath();
                        ctx.arc(intronX, intronY, 15, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.globalAlpha = 1;
                    }
                }
            }
            
            if (showLabels && progress > 0) {
                ctx.fillStyle = colors.text;
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('å‰ªæ¥ä½“', x, y - radius - 10);
            }
        }
        
        // ç»˜åˆ¶ç»†èƒæ ¸
        function drawNucleus(x, y, radius) {
            // ç»†èƒæ ¸è†œ
            ctx.strokeStyle = colors.dna;
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.stroke();
            
            // ç»†èƒæ ¸å†…éƒ¨
            ctx.fillStyle = colors.nucleus;
            ctx.beginPath();
            ctx.arc(x, y, radius - 2, 0, Math.PI * 2);
            ctx.fill();
            
            // æ ¸å­”
            ctx.fillStyle = colors.ribosome;
            ctx.beginPath();
            ctx.arc(x + radius * 0.7, y, 8, 0, Math.PI * 2);
            ctx.fill();
            
            if (showLabels) {
                ctx.fillStyle = colors.text;
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ç»†èƒæ ¸', x, y - radius - 20);
            }
        }
        
        // ç»˜åˆ¶æ ¸ç³–ä½“
        function drawRibosome(x, y, size = 1) {
            const width = 60 * size;
            const height = 40 * size;
            
            // å¤§äºšåŸº
            ctx.fillStyle = colors.ribosome;
            ctx.beginPath();
            ctx.ellipse(x, y, width / 2, height / 2, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // å°äºšåŸº
            ctx.fillStyle = '#e67e22';
            ctx.beginPath();
            ctx.ellipse(x, y - height * 0.3, width * 0.6, height * 0.5, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Aã€Pã€Eä½ç‚¹æ ‡è®°
            if (showLabels) {
                ctx.fillStyle = colors.text;
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('A', x - width * 0.3, y + height * 0.2);
                ctx.fillText('P', x, y + height * 0.2);
                ctx.fillText('E', x + width * 0.3, y + height * 0.2);
            }
            
            // æ ¸ç³–ä½“æ ‡ç­¾
            if (showLabels) {
                ctx.fillStyle = colors.text;
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('æ ¸ç³–ä½“', x, y - height - 10);
            }
        }
        
        // ç»˜åˆ¶tRNA
        function drawTRNA(x, y, anticodon, aminoAcid, isDragging = false) {
            const size = isDragging ? 1.2 : 1;
            
            // tRNAä¸»ä½“ï¼ˆä¸‰å¶è‰å½¢çŠ¶ç®€åŒ–ç‰ˆï¼‰
            ctx.fillStyle = colors.trna;
            ctx.beginPath();
            
            // ä¸»ä½“
            ctx.ellipse(x, y, 20 * size, 15 * size, 0, 0, Math.PI * 2);
            
            // åå¯†ç å­è‡‚
            ctx.moveTo(x, y + 15 * size);
            ctx.lineTo(x, y + 35 * size);
            
            // æ°¨åŸºé…¸è‡‚
            ctx.moveTo(x, y - 15 * size);
            ctx.lineTo(x, y - 35 * size);
            
            ctx.fill();
            ctx.strokeStyle = '#8e44ad';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // åå¯†ç å­
            ctx.fillStyle = colors.text;
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(anticodon, x, y + 50 * size);
            
            // æ°¨åŸºé…¸
            ctx.fillStyle = colors.aminoAcid;
            ctx.beginPath();
            ctx.arc(x, y - 45 * size, 10 * size, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = 'white';
            ctx.font = '9px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(aminoAcid.substring(0, 3), x, y - 43 * size);
            
            // tRNAæ ‡ç­¾
            if (showLabels && !isDragging) {
                ctx.fillStyle = colors.text;
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('tRNA', x, y - 65 * size);
            }
            
            return {
                x: x - 20 * size,
                y: y - 55 * size,
                width: 40 * size,
                height: 100 * size
            };
        }
        
        // ç»˜åˆ¶è‚½é“¾
        function drawPeptideChain(x, y, chain) {
            if (chain.length === 0) return;
            
            const spacing = 25;
            
            for (let i = 0; i < chain.length; i++) {
                const aminoX = x + i * spacing;
                
                // æ°¨åŸºé…¸
                ctx.fillStyle = colors.aminoAcid;
                ctx.beginPath();
                ctx.arc(aminoX, y, 10, 0, Math.PI * 2);
                ctx.fill();
                
                // æ°¨åŸºé…¸æ ‡ç­¾
                if (showLabels) {
                    ctx.fillStyle = 'white';
                    ctx.font = '10px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(chain[i], aminoX, y + 3);
                }
                
                // è‚½é”®ï¼ˆé™¤äº†ç¬¬ä¸€ä¸ªæ°¨åŸºé…¸ï¼‰
                if (i > 0) {
                    ctx.strokeStyle = colors.text;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(aminoX - spacing + 10, y);
                    ctx.lineTo(aminoX - 10, y);
                    ctx.stroke();
                    
                    if (showLabels && i === 1) {
                        ctx.fillStyle = colors.text;
                        ctx.font = '10px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText('è‚½é”®', aminoX - spacing / 2, y - 15);
                    }
                }
            }
            
            // è‚½é“¾æ ‡ç­¾
            if (showLabels && chain.length > 1) {
                ctx.fillStyle = colors.text;
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ç”Ÿé•¿ä¸­çš„è‚½é“¾', x + (chain.length * spacing) / 2, y - 30);
            }
        }
        
        // ç»˜åˆ¶åœºæ™¯1ï¼šè½¬å½•ä¸å‰ªæ¥
        function drawScene1() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶æ ‡é¢˜
            ctx.fillStyle = colors.text;
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('è½¬å½•ä¸å‰ªæ¥ï¼ˆç»†èƒæ ¸å†…ï¼‰', canvas.width / 2, 40);
            
            // ç»˜åˆ¶DNA
            drawDNA(scene1.dnaX, scene1.dnaY, scene1.dnaLength, 1);
            
            // ç»˜åˆ¶RNAèšåˆé…¶
            drawRNAPolymerase(scene1.rnaPolymeraseX, scene1.dnaY);
            
            // æ›´æ–°è½¬å½•è¿›åº¦
            if (isPlaying && currentScene === 1) {
                scene1.transcriptionProgress += 0.01;
                scene1.rnaPolymeraseX = scene1.dnaX + scene1.dnaLength * scene1.transcriptionProgress;
                
                // ç”Ÿæˆpre-mRNAåºåˆ—
                if (scene1.preMrna.length < 15 && Math.random() > 0.7) {
                    scene1.preMrna.push(rnaBases[scene1.preMrna.length % 4]);
                }
                
                // è½¬å½•å®Œæˆï¼Œå¼€å§‹å‰ªæ¥
                if (scene1.transcriptionProgress >= 1 && !scene1.spliced) {
                    scene1.splicingProgress += 0.01;
                    
                    // å‰ªæ¥å®Œæˆ
                    if (scene1.splicingProgress >= 1) {
                        scene1.spliced = true;
                        for (const intron of scene1.introns) {
                            intron.removed = true;
                        }
                    }
                }
            }
            
            // ç»˜åˆ¶pre-mRNA
            if (scene1.preMrna.length > 0) {
                const rnaX = scene1.dnaX + 50;
                const rnaY = scene1.dnaY - 80;
                drawRNA(rnaX, rnaY, scene1.preMrna, false, scene1.introns);
                
                // ç»˜åˆ¶å‰ªæ¥è¿‡ç¨‹
                if (scene1.transcriptionProgress >= 1 && scene1.splicingProgress > 0) {
                    drawSplicing(rnaX + 200, rnaY, scene1.splicingProgress, scene1.introns);
                }
            }
            
            // ç»˜åˆ¶è¯´æ˜
            if (showLabels) {
                ctx.fillStyle = colors.text;
                ctx.font = '14px Arial';
                ctx.textAlign = 'left';
                ctx.fillText('â€¢ RNAèšåˆé…¶æ²¿DNAç§»åŠ¨ï¼Œåˆæˆpre-mRNA', 50, 450);
                ctx.fillText('â€¢ pre-mRNAåŒ…å«å¤–æ˜¾å­ï¼ˆçº¢è‰²ï¼‰å’Œå†…å«å­ï¼ˆæ©™è‰²ï¼‰', 50, 470);
                
                if (scene1.spliced) {
                    ctx.fillStyle = '#27ae60';
                    ctx.fillText('âœ“ å‰ªæ¥å®Œæˆï¼šå†…å«å­è¢«åˆ‡é™¤ï¼Œå¤–æ˜¾å­è¿æ¥å½¢æˆæˆç†ŸmRNA', 50, 490);
                }
            }
        }
        
        // ç»˜åˆ¶åœºæ™¯2ï¼šmRNAè¿è¾“
        function drawScene2() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶æ ‡é¢˜
            ctx.fillStyle = colors.text;
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('mRNAè¿è¾“ä¸æ ¸ç³–ä½“ç»„è£…', canvas.width / 2, 40);
            
            // ç»˜åˆ¶ç»†èƒæ ¸
            drawNucleus(scene2.nucleusX, scene2.nucleusY, scene2.nucleusRadius);
            
            // ç»˜åˆ¶ç»†èƒè´¨èƒŒæ™¯
            ctx.fillStyle = colors.cytoplasm;
            ctx.fillRect(scene2.nucleusX + scene2.nucleusRadius + 10, 0, 
                        canvas.width - (scene2.nucleusX + scene2.nucleusRadius + 10), canvas.height);
            
            // æ›´æ–°è¿è¾“è¿›åº¦
            if (isPlaying && currentScene === 2) {
                scene2.transportProgress += 0.01;
                scene2.mrnaX = scene2.nuclearPoreX + (scene2.ribosomeX - scene2.nuclearPoreX) * scene2.transportProgress;
                scene2.mrnaY = scene2.nuclearPoreY + (scene2.ribosomeY - scene2.nuclearPoreY) * scene2.transportProgress;
                
                // è¿è¾“å®Œæˆï¼Œå¼€å§‹ç»„è£…æ ¸ç³–ä½“
                if (scene2.transportProgress >= 1) {
                    scene2.assemblyProgress += 0.01;
                }
            }
            
            // ç»˜åˆ¶mRNA
            const mrnaSequence = ['A', 'U', 'G', 'C', 'U', 'U', 'U', 'C', 'U', 'A', 'G', 'A'];
            drawRNA(sc
<!--æ£€æµ‹åˆ°ä»£ç æˆªæ–­ï¼Œè‡ªåŠ¨ç»­å†™ä¸­...-->
scene2.mrnaX, scene2.mrnaY, mrnaSequence, true);
            
            // ç»˜åˆ¶æ ¸ç³–ä½“
            const ribosomeSize = 0.5 + scene2.assemblyProgress * 0.5;
            drawRibosome(scene2.ribosomeX, scene2.ribosomeY, ribosomeSize);
            
            // ç»˜åˆ¶è¯´æ˜
            if (showLabels) {
                ctx.fillStyle = colors.text;
                ctx.font = '14px Arial';
                ctx.textAlign = 'left';
                ctx.fillText('â€¢ æˆç†ŸmRNAé€šè¿‡æ ¸å­”ç¦»å¼€ç»†èƒæ ¸', 50, 450);
                ctx.fillText('â€¢ mRNAè¿›å…¥ç»†èƒè´¨å¹¶ä¸æ ¸ç³–ä½“å°äºšåŸºç»“åˆ', 50, 470);
                
                if (scene2.assemblyProgress >= 1) {
                    ctx.fillStyle = '#27ae60';
                    ctx.fillText('âœ“ æ ¸ç³–ä½“ç»„è£…å®Œæˆï¼Œå‡†å¤‡å¼€å§‹ç¿»è¯‘', 50, 490);
                }
            }
        }
        
        // ç»˜åˆ¶åœºæ™¯3ï¼šç¿»è¯‘åˆæˆ
        function drawScene3() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶æ ‡é¢˜
            ctx.fillStyle = colors.text;
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('ç¿»è¯‘ä¸è‚½é“¾åˆæˆ', canvas.width / 2, 40);
            
            // ç»˜åˆ¶mRNA
            const codonSpacing = 40;
            const mrnaLength = scene3.mrnaSequence.length * codonSpacing;
            
            // mRNAéª¨æ¶
            ctx.beginPath();
            ctx.moveTo(scene3.mrnaX, scene3.mrnaY);
            ctx.lineTo(scene3.mrnaX + mrnaLength, scene3.mrnaY);
            ctx.strokeStyle = colors.mrna;
            ctx.lineWidth = 3;
            ctx.stroke();
            
            // ç»˜åˆ¶å¯†ç å­
            for (let i = 0; i < scene3.mrnaSequence.length; i++) {
                const codonX = scene3.mrnaX + i * codonSpacing + codonSpacing / 2;
                
                // ç»˜åˆ¶å¯†ç å­æ¡†
                ctx.fillStyle = i === scene3.currentCodonIndex && highlightPairing ? colors.highlight : 'rgba(231, 76, 60, 0.1)';
                ctx.fillRect(codonX - 25, scene3.mrnaY - 20, 50, 40);
                
                // ç»˜åˆ¶å¯†ç å­æ–‡æœ¬
                ctx.fillStyle = colors.text;
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(scene3.mrnaSequence[i], codonX, scene3.mrnaY + 5);
                
                // å¯†ç å­ç¼–å·
                if (showLabels) {
                    ctx.fillStyle = colors.text;
                    ctx.font = '10px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(`C${i+1}`, codonX, scene3.mrnaY - 25);
                }
            }
            
            // ç»˜åˆ¶æ ¸ç³–ä½“
            drawRibosome(scene3.ribosomeX, scene3.ribosomeY);
            
            // é«˜äº®å½“å‰å¯†ç å­å¯¹åº”çš„æ ¸ç³–ä½“ä½ç‚¹
            if (highlightPairing && scene3.currentCodonIndex < scene3.mrnaSequence.length) {
                const codonX = scene3.mrnaX + scene3.currentCodonIndex * codonSpacing + codonSpacing / 2;
                
                // ç»˜åˆ¶è¿æ¥çº¿
                ctx.strokeStyle = colors.highlight;
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(codonX, scene3.mrnaY + 20);
                ctx.lineTo(scene3.ribosomeX - 20, scene3.ribosomeY + 10);
                ctx.stroke();
                ctx.setLineDash([]);
            }
            
            // ç»˜åˆ¶tRNA
            for (let i = 0; i < scene3.trnas.length; i++) {
                const trna = scene3.trnas[i];
                const isDragging = (scene3.draggingTrna === trna);
                
                // å¦‚æœtRNAåœ¨æ ¸ç³–ä½“ä¸­ï¼Œè°ƒæ•´ä½ç½®
                let drawX = trna.x;
                let drawY = trna.y;
                
                if (trna.state === 'inA') {
                    drawX = scene3.ribosomeX - 20;
                    drawY = scene3.ribosomeY + 30;
                } else if (trna.state === 'inP') {
                    drawX = scene3.ribosomeX;
                    drawY = scene3.ribosomeY + 30;
                } else if (trna.state === 'inE') {
                    drawX = scene3.ribosomeX + 20;
                    drawY = scene3.ribosomeY + 30;
                }
                
                // ç»˜åˆ¶tRNA
                const bounds = drawTRNA(drawX, drawY, trna.anticodon, trna.aminoAcid, isDragging);
                
                // ä¿å­˜è¾¹ç•Œä¿¡æ¯ç”¨äºç‚¹å‡»æ£€æµ‹
                trna.bounds = bounds;
                
                // å¦‚æœtRNAåœ¨Aä½ç‚¹ä¸”å¯†ç å­åŒ¹é…ï¼Œé«˜äº®æ˜¾ç¤º
                if (trna.state === 'inA' && highlightPairing) {
                    const currentCodon = scene3.mrnaSequence[scene3.currentCodonIndex];
                    const complementaryCodon = getComplementaryCodon(currentCodon);
                    
                    if (trna.anticodon === complementaryCodon) {
                        ctx.strokeStyle = colors.highlight;
                        ctx.lineWidth = 3;
                        ctx.beginPath();
                        ctx.arc(drawX, drawY, 25, 0, Math.PI * 2);
                        ctx.stroke();
                    }
                }
            }
            
            // ç»˜åˆ¶è‚½é“¾
            if (scene3.peptideChain.length > 0) {
                const peptideX = scene3.ribosomeX;
                const peptideY = scene3.ribosomeY - 50;
                drawPeptideChain(peptideX, peptideY, scene3.peptideChain);
            }
            
            // æ›´æ–°ç¿»è¯‘è¿›åº¦
            if (isPlaying && currentScene === 3 && !gameMode) {
                scene3.translationProgress += 0.005;
                
                // è‡ªåŠ¨è¿›è¡Œç¿»è¯‘æ­¥éª¤
                if (scene3.translationProgress >= 1 && scene3.currentCodonIndex < scene3.mrnaSequence.length) {
                    performTranslationStep();
                    scene3.translationProgress = 0;
                }
            }
            
            // ç»˜åˆ¶è¯´æ˜
            if (showLabels) {
                ctx.fillStyle = colors.text;
                ctx.font = '14px Arial';
                ctx.textAlign = 'left';
                ctx.fillText('â€¢ tRNAé€šè¿‡åå¯†ç å­ä¸mRNAå¯†ç å­é…å¯¹', 50, 450);
                ctx.fillText('â€¢ æ ¸ç³–ä½“å‚¬åŒ–è‚½é”®å½¢æˆï¼Œå»¶ä¼¸è‚½é“¾', 50, 470);
                ctx.fillText('â€¢ ç¿»è¯‘ä»èµ·å§‹å¯†ç å­AUGå¼€å§‹ï¼Œåˆ°ç»ˆæ­¢å¯†ç å­ç»“æŸ', 50, 490);
            }
            
            // æ¸¸æˆæ¨¡å¼ä¿¡æ¯
            if (gameMode) {
                ctx.fillStyle = '#d35400';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('æ¸¸æˆæ¨¡å¼ï¼šæ‹–æ‹½æ­£ç¡®çš„tRNAåˆ°æ ¸ç³–ä½“Aä½ç‚¹', canvas.width / 2, 100);
                
                // æ˜¾ç¤ºå½“å‰å¯†ç å­
                const currentCodon = scene3.mrnaSequence[scene3.currentCodonIndex];
                ctx.fillStyle = colors.text;
                ctx.font = '18px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`å½“å‰å¯†ç å­: ${currentCodon}`, canvas.width / 2, 130);
                
                // æ˜¾ç¤ºäº’è¡¥å¯†ç å­æç¤º
                const complementaryCodon = getComplementaryCodon(currentCodon);
                ctx.fillStyle = '#27ae60';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`éœ€è¦åå¯†ç å­: ${complementaryCodon}`, canvas.width / 2, 155);
            }
        }
        
        // æ‰§è¡Œç¿»è¯‘æ­¥éª¤
        function performTranslationStep() {
            if (scene3.currentCodonIndex >= scene3.mrnaSequence.length) return;
            
            const currentCodon = scene3.mrnaSequence[scene3.currentCodonIndex];
            const complementaryCodon = getComplementaryCodon(currentCodon);
            
            // æŸ¥æ‰¾åŒ¹é…çš„tRNA
            let matchedTrna = null;
            for (const trna of scene3.trnas) {
                if (trna.state === 'free' && trna.anticodon === complementaryCodon) {
                    matchedTrna = trna;
                    break;
                }
            }
            
            if (matchedTrna) {
                // ç§»åŠ¨tRNAåˆ°Aä½ç‚¹
                matchedTrna.state = 'inA';
                matchedTrna.x = scene3.ribosomeX - 20;
                matchedTrna.y = scene3.ribosomeY + 30;
                
                // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªå¯†ç å­ï¼Œç›´æ¥æ·»åŠ åˆ°Pä½ç‚¹
                if (scene3.currentCodonIndex === 0) {
                    matchedTrna.state = 'inP';
                    matchedTrna.x = scene3.ribosomeX;
                    scene3.peptideChain.push(matchedTrna.aminoAcid);
                } else if (scene3.currentCodonIndex > 0) {
                    // å°†Pä½ç‚¹çš„tRNAæ°¨åŸºé…¸æ·»åŠ åˆ°è‚½é“¾
                    for (const trna of scene3.trnas) {
                        if (trna.state === 'inP') {
                            scene3.peptideChain.push(trna.aminoAcid);
                            trna.state = 'inE'; // ç§»åŠ¨åˆ°Eä½ç‚¹
                            break;
                        }
                    }
                    
                    // Aä½ç‚¹tRNAç§»åŠ¨åˆ°Pä½ç‚¹
                    setTimeout(() => {
                        matchedTrna.state = 'inP';
                        matchedTrna.x = scene3.ribosomeX;
                    }, 500);
                }
                
                // æ¸…é™¤Eä½ç‚¹çš„tRNA
                setTimeout(() => {
                    for (const trna of scene3.trnas) {
                        if (trna.state === 'inE') {
                            trna.state = 'free';
                            trna.x = 100 + Math.random() * 150;
                            trna.y = 100 + Math.random() * 150;
                        }
                    }
                }, 1000);
                
                scene3.currentCodonIndex++;
                
                // åˆ°è¾¾ç»ˆæ­¢å¯†ç å­
                if (scene3.currentCodonIndex >= scene3.mrnaSequence.length) {
                    setTimeout(() => {
                        // é‡Šæ”¾æœ€åçš„tRNA
                        for (const trna of scene3.trnas) {
                            if (trna.state === 'inP') {
                                trna.state = 'free';
                                trna.x = 100 + Math.random() * 150;
                                trna.y = 100 + Math.random() * 150;
                            }
                        }
                    }, 500);
                }
            }
        }
        
        // æ¸¸æˆæ¨¡å¼ï¼šæ£€æŸ¥tRNAæ˜¯å¦æ­£ç¡®
        function checkGameAnswer(trna) {
            const currentCodon = scene3.mrnaSequence[scene3.currentCodonIndex];
            const complementaryCodon = getComplementaryCodon(currentCodon);
            
            if (trna.anticodon === complementaryCodon) {
                // æ­£ç¡®ç­”æ¡ˆ
                gameScore++;
                document.getElementById('gameScore').textContent = gameScore;
                
                // æ‰§è¡Œç¿»è¯‘æ­¥éª¤
                trna.state = 'inA';
                trna.x = scene3.ribosomeX - 20;
                trna.y = scene3.ribosomeY + 30;
                
                setTimeout(() => {
                    performTranslationStep();
                    
                    // æ›´æ–°æ¸¸æˆä¿¡æ¯
                    if (scene3.currentCodonIndex < scene3.mrnaSequence.length) {
                        document.getElementById('currentCodon').textContent = 
                            scene3.mrnaSequence[scene3.currentCodonIndex];
                    } else {
                        document.getElementById('currentCodon').textContent = "å®Œæˆ!";
                    }
                }, 500);
                
                return true;
            } else {
                // é”™è¯¯ç­”æ¡ˆ
                return false;
            }
        }
        
        // ä¸»ç»˜åˆ¶å‡½æ•°
        function draw() {
            switch (currentScene) {
                case 1:
                    drawScene1();
                    break;
                case 2:
                    drawScene2();
                    break;
                case 3:
                    drawScene3();
                    break;
            }
            
            if (isPlaying) {
                animationFrameId = requestAnimationFrame(draw);
            }
        }
        
        // åˆ‡æ¢åœºæ™¯
        function switchScene(sceneNumber) {
            currentScene = sceneNumber;
            isPlaying = false;
            
            // æ›´æ–°åœºæ™¯æŒ‰é’®çŠ¶æ€
            document.getElementById('scene1Btn').classList.toggle('active', sceneNumber === 1);
            document.getElementById('scene2Btn').classList.toggle('active', sceneNumber === 2);
            document.getElementById('scene3Btn').classList.toggle('active', sceneNumber === 3);
            
            // æ›´æ–°çŠ¶æ€æ 
            const sceneNames = ['', 'è½¬å½•ä¸å‰ªæ¥', 'mRNAè¿è¾“', 'ç¿»è¯‘åˆæˆ'];
            statusBar.textContent = `åœºæ™¯ï¼š${sceneNames[sceneNumber]}`;
            
            // é‡ç½®åœºæ™¯çŠ¶æ€
            if (sceneNumber === 1) {
                scene1.transcriptionProgress = 0;
                scene1.rnaPolymeraseX = 100;
                scene1.preMrna = [];
                scene1.spliced = false;
                scene1.splicingProgress = 0;
                for (const intron of scene1.introns) {
                    intron.removed = false;
                }
            } else if (sceneNumber === 2) {
                scene2.transportProgress = 0;
                scene2.assemblyProgress = 0;
                scene2.mrnaX = 150;
                scene2.mrnaY = 250;
            } else if (sceneNumber === 3) {
                initTranslationScene();
                scene3.translationProgress = 0;
            }
            
            // åœæ­¢ä¹‹å‰çš„åŠ¨ç”»
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            
            // å¼€å§‹ç»˜åˆ¶
            draw();
        }
        
        // äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('playBtn').addEventListener('click', () => {
            isPlaying = true;
            if (!animationFrameId) {
                animationFrameId = requestAnimationFrame(draw);
            }
        });
        
        document.getElementById('pauseBtn').addEventListener('click', () => {
            isPlaying = false;
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
        });
        
        document.getElementById('stepBtn').addEventListener('click', () => {
            isPlaying = false;
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            
            // æ‰§è¡Œå•æ­¥æ“ä½œ
            if (currentScene === 1) {
                if (scene1.transcriptionProgress < 1) {
                    scene1.transcriptionProgress += 0.1;
                    scene1.rnaPolymeraseX = scene1.dnaX + scene1.dnaLength * scene1.transcriptionProgress;
                    
                    if (scene1.preMrna.length < 15) {
                        scene1.preMrna.push(rnaBases[scene1.preMrna.length % 4]);
                    }
                } else if (!scene1.spliced && scene1.splicingProgress < 1) {
                    scene1.splicingProgress += 0.2;
                    if (scene1.splicingProgress >= 1) {
                        scene1.spliced = true;
                        for (const intron of scene1.introns) {
                            intron.removed = true;
                        }
                    }
                }
            } else if (currentScene === 2) {
                if (scene2.transportProgress < 1) {
                    scene2.transportProgress += 0.2;
                    scene2.mrnaX = scene2.nuclearPoreX + (scene2.ribosomeX - scene2.nuclearPoreX) * scene2.transportProgress;
                    scene2.mrnaY = scene2.nuclearPoreY + (scene2.ribosomeY - scene2.nuclearPoreY) * scene2.transportProgress;
                } else if (scene2.assemblyProgress < 1) {
                    scene2.assemblyProgress += 0.2;
                }
            } else if (currentScene === 3 && !gameMode) {
                performTranslationStep();
            }
            
            draw();
        });
        
        document.getElementById('resetBtn').addEventListener('click', () => {
            isPlaying = false;
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            
            switchScene(currentScene);
        });
        
        document.getElementById('scene1Btn').addEventListener('click', () => switchScene(1));
        document.getElementById('scene2Btn').addEventListener('click', () => switchScene(2));
        document.getElementById('scene3Btn').addEventListener('click', () => switchScene(3));
        
        document.getElementById('toggleLabelsBtn').addEventListener('click', function() {
            showLabels = !showLabels;
            this.textContent = showLabels ? 'éšè—æ ‡ç­¾' : 'æ˜¾ç¤ºæ ‡ç­¾';
            draw();
        });
        
        document.getElementById('highlightBtn').addEventListener('click', function() {
            highlightPairing = !highlightPairing;
            this.textContent = highlightPairing ? 'å–æ¶ˆé«˜äº®' : 'é«˜äº®é…å¯¹';
            draw();
        });
        
        document.getElementById('gameModeBtn').addEventListener('click', function() {
            gameMode = !gameMode;
            this.textContent = gameMode ? 'é€€å‡ºæ¸¸æˆ' : 'æ‹–æ‹½åŒ¹é…æ¸¸æˆ';
            document.getElementById('gameModePanel').style.display = gameMode ? 'block' : 'none';
            
            if (gameMode) {
                // åˆå§‹åŒ–æ¸¸æˆ
                gameScore = 0;
                gameTotal = scene3.mrnaSequence.length;
                document.getElementById('gameScore').textContent = gameScore;
                document.getElementById('gameTotal').textContent = gameTotal;
                document.getElementById('currentCodon').textContent = scene3.mrnaSequence[scene3.currentCodonIndex];
                
                // é‡ç½®ç¿»è¯‘çŠ¶æ€
                scene3.currentCodonIndex = 0;
                scene3.peptideChain = [];
                initTranslationScene();
            } else {
                // é€€å‡ºæ¸¸æˆæ¨¡å¼
                switchScene(3);
            }
            
            draw();
        });
        
        // é¼ æ ‡äº‹ä»¶å¤„ç†
        let mouseX = 0, mouseY = 0;
        
        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            mouseX = e.clientX - rect.left;
            mouseY = e.clientY - rect.top;
            
            // æ›´æ–°å·¥å…·æç¤º
            if (currentScene === 3) {
                let tooltipText = '';
                
                // æ£€æŸ¥æ˜¯å¦æ‚¬åœåœ¨tRNAä¸Š
                for (const trna of scene3.trnas) {
                    if (trna.bounds && 
                        mouseX >= trna.bounds.x && mouseX <= trna.bounds.x + trna.bounds.width &&
                        mouseY >= trna.bounds.y && mouseY <= trna.bounds.y + trna.bounds.height) {
                        
                        tooltipText = `tRNA\nåå¯†ç å­: ${trna.anticodon}\næºå¸¦æ°¨åŸºé…¸: ${trna.aminoAcid}`;
                        break;
                    }
                }
                
                // æ£€æŸ¥æ˜¯å¦æ‚¬åœåœ¨å¯†ç å­ä¸Š
                if (!tooltipText && currentScene === 3) {
                    const codonSpacing = 40;
                    for (let i = 0; i < scene3.mrnaSequence.length; i++) {
                        const codonX = scene3.mrnaX + i * codonSpacing + codonSpacing / 2;
                        if (Math.abs(mouseX - codonX) < 25 && Math.abs(mouseY - scene3.mrnaY) < 25) {
                            tooltipText = `å¯†ç å­: ${scene3.mrnaSequence[i]}\nä½ç½®: ${i+1}`;
                            break;
                        }
                    }
                }
                
                if (tooltipText) {
                    tooltip.style.display = 'block';
                    tooltip.style.left = (e.clientX + 10) + 'px';
                    tooltip.style.top = (e.clientY + 10) + 'px';
                    tooltip.textContent = tooltipText;
                } else {
                    tooltip.style.display = 'none';
                }
            }
            
            // æ‹–æ‹½tRNA
            if (scene3.draggingTrna) {
                scene3.draggingTrna.x = mouseX - scene3.dragOffsetX;
                scene3.draggingTrna.y = mouseY - scene3.dragOffsetY;
                draw();
            }
        });
        
        canvas.addEventListener('mousedown', (e) => {
            if (currentScene === 3 && gameMode) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†tRNA
                for (const trna of scene3.trnas) {
                    if (trna.bounds && 
                        x >= trna.bounds.x && x <= trna.bounds.x + trna.bounds.width &&
                        y >= trna.bounds.y && y <= trna.bounds.y + trna.bounds.height &&
                        trna.state === 'free') {
                        
                        scene3.draggingTrna = trna;
                        scene3.dragOffsetX = x - trna.x;
                        scene3.dragOffsetY = y - trna.y;
                        break;
                    }
                }
            }
        });
        
        canvas.addEventListener('mouseup', (e) => {
            if (scene3.draggingTrna) {
                // æ£€æŸ¥æ˜¯å¦æ‹–æ‹½åˆ°äº†æ ¸ç³–ä½“Aä½ç‚¹
                const aSiteX = scene3.ribosomeX - 20;
                const aSiteY = scene3.ribosomeY + 30;
                const distance = Math.sqrt(
                    Math.pow(scene3.draggingTrna.x - aSiteX, 2) + 
                    Math.pow(scene3.draggingTrna.y - aSiteY, 2)
                );
                
                if (distance < 40) {
                    // åœ¨Aä½ç‚¹é™„è¿‘ï¼Œæ£€æŸ¥ç­”æ¡ˆ
                    const isCorrect = checkGameAnswer(scene3.draggingTrna);
                    
                    if (isCorrect) {
                        scene3.draggingTrna.x = aSiteX;
                        scene3.draggingTrna.y = aSiteY;
                    } else {
                        // é”™è¯¯ç­”æ¡ˆï¼Œè¿”å›åŸä½ç½®
                        scene3.draggingTrna.x = 100 + Math.random() * 150;
                        scene3.draggingTrna.y = 100 + Math.random() * 150;
                    }
                } else {
                    // ä¸åœ¨Aä½ç‚¹ï¼Œè¿”å›åŸä½ç½®
                    scene3.draggingTrna.x = 100 + Math.random() * 150;
                    scene3.draggingTrna.y = 100 + Math.random() * 150;
                }
                
                scene3.draggingTrna = null;
                draw();
            }
        });
        
        canvas.addEventListener('mouseleave', () => {
            tooltip.style.display = 'none';
            
            if (scene3.draggingTrna) {
                scene3.draggingTrna.x = 100 + Math.random() * 150;
                scene3.draggingTrna.y = 100 + Math.random() * 150;
                scene3.draggingTrna = null;
                draw();
            }
        });
        
        // åˆå§‹åŒ–
        switchScene(1);
        draw();
    </script>
</body>
</html>