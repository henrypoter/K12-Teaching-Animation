<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡æ•°åˆ†è£‚å…¨è¿‡ç¨‹æ•™å­¦åŠ¨ç”»</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(to right, #2E5A88, #4A6FA5);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }

        h1 {
            font-size: 2.2em;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
            font-weight: 300;
        }

        .main-content {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
            gap: 20px;
        }

        .animation-section {
            flex: 1;
            min-width: 300px;
            background: #FAF8F0;
            border-radius: 15px;
            padding: 15px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
        }

        .canvas-container {
            position: relative;
            width: 100%;
            height: 500px;
            background-color: #FAF8F0;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #E0E0E0;
        }

        #meiosisCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .controls-section {
            flex: 1;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .control-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        h2 {
            color: #2E5A88;
            font-size: 1.4em;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #E8E8E8;
        }

        .stage-nav {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .stage-btn {
            background: #f0f4f8;
            border: 2px solid #d0d8e4;
            border-radius: 8px;
            padding: 10px 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85em;
            text-align: center;
            color: #555;
        }

        .stage-btn:hover {
            background: #e1e8f0;
            transform: translateY(-2px);
        }

        .stage-btn.active {
            background: #4A6FA5;
            color: white;
            border-color: #2E5A88;
            font-weight: 600;
        }

        .player-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }

        .ctrl-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #4A6FA5;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            flex: 1;
        }

        .ctrl-btn:hover {
            background: #2E5A88;
            transform: translateY(-2px);
        }

        .ctrl-btn:active {
            transform: translateY(0);
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        #speedSlider {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            background: #e0e0e0;
            border-radius: 4px;
            outline: none;
        }

        #speedSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4A6FA5;
            cursor: pointer;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .color-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .info-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            flex: 1;
        }

        .stage-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #4A6FA5;
        }

        .stage-title {
            font-size: 1.2em;
            color: #2E5A88;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .stage-desc {
            line-height: 1.6;
            color: #555;
        }

        .highlight {
            background-color: rgba(255, 215, 0, 0.2);
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: 600;
        }

        .interactive-hint {
            background: #fff8e1;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #FFD700;
            font-size: 0.9em;
            color: #666;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
            border-top: 1px solid #eee;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .stage-nav {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .canvas-container {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>å‡æ•°åˆ†è£‚å…¨è¿‡ç¨‹æ•™å­¦åŠ¨ç”»</h1>
            <p class="subtitle">æ¢ç´¢æŸ“è‰²ä½“å¤åˆ¶ã€è”ä¼šã€å››åˆ†ä½“å½¢æˆä¸åŒæºæŸ“è‰²ä½“åˆ†ç¦»çš„å¥¥ç§˜</p>
        </header>
        
        <div class="main-content">
            <section class="animation-section">
                <h2>å‡æ•°åˆ†è£‚è¿‡ç¨‹</h2>
                <div class="canvas-container">
                    <canvas id="meiosisCanvas"></canvas>
                </div>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #2E5A88;"></div>
                        <span>çˆ¶æœ¬æ¥æºæŸ“è‰²ä½“</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #A63D40;"></div>
                        <span>æ¯æœ¬æ¥æºæŸ“è‰²ä½“</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box" style="background-color: rgba(46, 90, 136, 0.5);"></div>
                        <span>å§å¦¹æŸ“è‰²å•ä½“</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #D4C1E0; border: 1px solid #999;"></div>
                        <span>çººé”¤ä¸</span>
                    </div>
                </div>
                
                <div class="interactive-hint">
                    ğŸ’¡ äº¤äº’æç¤ºï¼šç‚¹å‡»ç”»å¸ƒä¸­çš„æŸ“è‰²ä½“å¯ä»¥æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ã€‚å°è¯•ç‚¹å‡»"å››åˆ†ä½“"ç»“æ„ï¼
                </div>
            </section>
            
            <section class="controls-section">
                <div class="control-panel">
                    <h2>åŠ¨ç”»æ§åˆ¶</h2>
                    
                    <div class="stage-nav">
                        <button class="stage-btn" data-stage="0">é—´æœŸ</button>
                        <button class="stage-btn" data-stage="1">å‰æœŸ I</button>
                        <button class="stage-btn" data-stage="2">ä¸­æœŸ I</button>
                        <button class="stage-btn" data-stage="3">åæœŸ I</button>
                        <button class="stage-btn" data-stage="4">æœ«æœŸ I</button>
                        <button class="stage-btn" data-stage="5">å‰æœŸ II</button>
                        <button class="stage-btn" data-stage="6">ä¸­æœŸ II</button>
                        <button class="stage-btn" data-stage="7">åæœŸ II</button>
                        <button class="stage-btn" data-stage="8">æœ«æœŸ II</button>
                    </div>
                    
                    <div class="player-controls">
                        <button id="prevBtn" class="ctrl-btn">â—€ ä¸Šä¸€é˜¶æ®µ</button>
                        <button id="playPauseBtn" class="ctrl-btn">â–¶ æ’­æ”¾</button>
                        <button id="nextBtn" class="ctrl-btn">ä¸‹ä¸€é˜¶æ®µ â–¶</button>
                    </div>
                    
                    <button id="resetBtn" class="ctrl-btn" style="background: #666;">é‡ç½®åŠ¨ç”»</button>
                    
                    <div class="speed-control">
                        <span>é€Ÿåº¦:</span>
                        <input type="range" id="speedSlider" min="0.5" max="3" step="0.1" value="1">
                        <span id="speedValue">1.0x</span>
                    </div>
                </div>
                
                <div class="info-panel">
                    <h2>é˜¶æ®µä¿¡æ¯</h2>
                    <div class="stage-info">
                        <div class="stage-title" id="currentStageTitle">é—´æœŸ</div>
                        <div class="stage-desc" id="currentStageDesc">
                            æŸ“è‰²ä½“å¤åˆ¶ï¼Œç»†èƒå‡†å¤‡è¿›è¡Œå‡æ•°åˆ†è£‚ã€‚æ¯ä¸ªæŸ“è‰²ä½“å¤åˆ¶å½¢æˆä¸¤ä¸ªå§å¦¹æŸ“è‰²å•ä½“ï¼Œç”±ç€ä¸ç²’è¿æ¥ã€‚
                        </div>
                    </div>
                    
                    <div class="stage-info">
                        <div class="stage-title">å…³é”®æ¦‚å¿µ</div>
                        <div class="stage-desc">
                            <p><span class="highlight">è”ä¼š</span>: åŒæºæŸ“è‰²ä½“é…å¯¹çš„è¿‡ç¨‹ï¼Œå‘ç”Ÿåœ¨å‰æœŸIã€‚</p>
                            <p><span class="highlight">å››åˆ†ä½“</span>: ä¸€å¯¹åŒæºæŸ“è‰²ä½“å¤åˆ¶åå½¢æˆçš„4æ¡æŸ“è‰²å•ä½“ç»“æ„ã€‚</p>
                            <p><span class="highlight">åŒæºæŸ“è‰²ä½“åˆ†ç¦»</span>: å‡æ•°åˆ†è£‚IåæœŸï¼ŒåŒæºæŸ“è‰²ä½“åˆ†åˆ«ç§»å‘ç»†èƒä¸¤æã€‚</p>
                            <p><span class="highlight">æŸ“è‰²ä½“å‡åŠ</span>: å‘ç”Ÿåœ¨å‡æ•°åˆ†è£‚Iç»“æŸæ—¶ï¼Œä»2nå˜ä¸ºnã€‚</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
        
        <div class="footer">
            <p>æ•™å­¦åŠ¨ç”»è®¾è®¡ | å‡æ•°åˆ†è£‚å…¨è¿‡ç¨‹ | é€‚ç”¨äºé«˜ä¸­åŠå¤§å­¦ç”Ÿç‰©å­¦å­¦ä¹ </p>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        const canvas = document.getElementById('meiosisCanvas');
        const ctx = canvas.getContext('2d');
        const stageButtons = document.querySelectorAll('.stage-btn');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const resetBtn = document.getElementById('resetBtn');
        const speedSlider = document.getElementById('speedSlider');
        const speedValue = document.getElementById('speedValue');
        const currentStageTitle = document.getElementById('currentStageTitle');
        const currentStageDesc = document.getElementById('currentStageDesc');
        
        // ç”»å¸ƒå°ºå¯¸
        let canvasWidth, canvasHeight;
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvasWidth = canvas.width = container.clientWidth;
            canvasHeight = canvas.height = container.clientHeight;
        }
        
        // åŠ¨ç”»çŠ¶æ€
        let currentStage = 0;
        let isPlaying = false;
        let animationSpeed = 1.0;
        let animationProgress = 0;
        let lastTime = 0;
        let selectedChromosome = null;
        
        // å‡æ•°åˆ†è£‚é˜¶æ®µä¿¡æ¯
        const stages = [
            {
                name: "é—´æœŸ",
                description: "æŸ“è‰²ä½“å¤åˆ¶ï¼Œç»†èƒå‡†å¤‡è¿›è¡Œå‡æ•°åˆ†è£‚ã€‚æ¯ä¸ªæŸ“è‰²ä½“å¤åˆ¶å½¢æˆä¸¤ä¸ªå§å¦¹æŸ“è‰²å•ä½“ï¼Œç”±ç€ä¸ç²’è¿æ¥ã€‚",
                duration: 2
            },
            {
                name: "å‰æœŸ I",
                description: "æŸ“è‰²ä½“å‡ç¼©ï¼ŒåŒæºæŸ“è‰²ä½“é…å¯¹ï¼ˆè”ä¼šï¼‰ï¼Œå½¢æˆå››åˆ†ä½“ã€‚éå§å¦¹æŸ“è‰²å•ä½“é—´å¯èƒ½å‘ç”Ÿäº¤å‰äº’æ¢ã€‚",
                duration: 3
            },
            {
                name: "ä¸­æœŸ I",
                description: "å››åˆ†ä½“æ’åˆ—åœ¨ç»†èƒä¸­å¤®çš„èµ¤é“æ¿ä¸Šã€‚çººé”¤ä¸é™„ç€åœ¨æŸ“è‰²ä½“çš„ç€ä¸ç²’ä¸Šã€‚",
                duration: 2
            },
            {
                name: "åæœŸ I",
                description: "åŒæºæŸ“è‰²ä½“åˆ†ç¦»ï¼Œåˆ†åˆ«ç§»å‘ç»†èƒä¸¤æã€‚è¿™æ˜¯æŸ“è‰²ä½“æ•°ç›®å‡åŠçš„å…³é”®æ­¥éª¤ã€‚",
                duration: 2
            },
            {
                name: "æœ«æœŸ I",
                description: "æŸ“è‰²ä½“åˆ°è¾¾ä¸¤æï¼Œç»†èƒå¼€å§‹åˆ†è£‚ï¼Œå½¢æˆä¸¤ä¸ªå­ç»†èƒï¼Œæ¯ä¸ªå­ç»†èƒå«æœ‰å•å€ä½“æŸ“è‰²ä½“ç»„ã€‚",
                duration: 2
            },
            {
                name: "å‰æœŸ II",
                description: "ä¸¤ä¸ªå­ç»†èƒä¸­çš„æŸ“è‰²ä½“å†æ¬¡å‡ç¼©ï¼Œçººé”¤ä½“é‡æ–°å½¢æˆã€‚",
                duration: 1.5
            },
            {
                name: "ä¸­æœŸ II",
                description: "æŸ“è‰²ä½“æ’åˆ—åœ¨ç»†èƒä¸­å¤®çš„èµ¤é“æ¿ä¸Šï¼Œç€ä¸ç²’åˆ†è£‚å‡†å¤‡ã€‚",
                duration: 1.5
            },
            {
                name: "åæœŸ II",
                description: "å§å¦¹æŸ“è‰²å•ä½“åˆ†ç¦»ï¼Œåˆ†åˆ«ç§»å‘ç»†èƒä¸¤æã€‚",
                duration: 2
            },
            {
                name: "æœ«æœŸ II",
                description: "æŸ“è‰²ä½“åˆ°è¾¾ä¸¤æï¼Œç»†èƒåˆ†è£‚å®Œæˆï¼Œå½¢æˆå››ä¸ªå•å€ä½“é…å­ã€‚",
                duration: 2
            }
        ];
        
        // æŸ“è‰²ä½“æ•°æ®
        const chromosomes = [
            { id: 1, length: 80, centromerePos: 0.3, paternal: true, x: 0, y: 0, angle: 0, replicated: false },
            { id: 2, length: 70, centromerePos: 0.5, paternal: false, x: 0, y: 0, angle: 0, replicated: false },
            { id: 3, length: 90, centromerePos: 0.4, paternal: true, x: 0, y: 0, angle: 0, replicated: false },
            { id: 4, length: 60, centromerePos: 0.6, paternal: false, x: 0, y: 0, angle: 0, replicated: false }
        ];
        
        // ç»†èƒæ•°æ®
        const cell = {
            x: 0,
            y: 0,
            radius: 0,
            nuclearMembrane: true,
            spindlePoles: [{x: 0, y: 0}, {x: 0, y: 0}],
            spindleFibers: []
        };
        
        // åˆå§‹åŒ–
        function init() {
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // è®¾ç½®åˆå§‹ä½ç½®
            updateCellDimensions();
            arrangeChromosomes();
            
            // äº‹ä»¶ç›‘å¬
            playPauseBtn.addEventListener('click', togglePlayPause);
            prevBtn.addEventListener('click', prevStage);
            nextBtn.addEventListener('click', nextStage);
            resetBtn.addEventListener('click', resetAnimation);
            speedSlider.addEventListener('input', updateSpeed);
            
            stageButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const stage = parseInt(btn.dataset.stage);
                    goToStage(stage);
                });
            });
            
            canvas.addEventListener('click', handleCanvasClick);
            
            // åˆå§‹ç»˜åˆ¶
            draw();
            updateStageInfo();
            updateStageButtons();
            
            // å¼€å§‹åŠ¨ç”»å¾ªç¯
            requestAnimationFrame(animate);
        }
        
        // æ›´æ–°ç»†èƒå°ºå¯¸
        function updateCellDimensions() {
            cell.x = canvasWidth / 2;
            cell.y = canvasHeight / 2;
            cell.radius = Math.min(canvasWidth, canvasHeight) * 0.4;
        }
        
        // æ’åˆ—æŸ“è‰²ä½“
        function arrangeChromosomes() {
            const angleStep = (Math.PI * 2) / chromosomes.length;
            
            chromosomes.forEach((chr, index) => {
                const angle = angleStep * index;
                const distance = cell.radius * 0.6;
                
                chr.x = cell.x + Math.cos(angle) * distance;
                chr.y = cell.y + Math.sin(angle) * distance;
                chr.angle = angle;
            });
        }
        
        // åŠ¨ç”»å¾ªç¯
        function animate(timestamp) {
            if (!lastTime) lastTime = timestamp;
            const deltaTime = (timestamp - lastTime) / 1000;
            lastTime = timestamp;
            
            if (isPlaying) {
                animationProgress += deltaTime * animationSpeed;
                
                const stageDuration = stages[currentStage].duration;
                if (animationProgress >= stageDuration) {
                    animationProgress = 0;
                    if (currentStage < stages.length - 1) {
                        currentStage++;
                        updateStageInfo();
                        updateStageButtons();
                    } else {
                        isPlaying = false;
                        playPauseBtn.textContent = 'â–¶ æ’­æ”¾';
                    }
                }
            }
            
            draw();
            requestAnimationFrame(animate);
        }
        
        // ç»˜åˆ¶å‡½æ•°
        function draw() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);
            
            // ç»˜åˆ¶ç»†èƒè´¨
            ctx.fillStyle = '#FAF8F0';
            ctx.beginPath();
            ctx.arc(cell.x, cell.y, cell.radius, 0, Math.PI * 2);
            ctx.fill();
            
            // ç»˜åˆ¶ç»†èƒè†œ
            ctx.strokeStyle = '#F5F5F5';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(cell.x, cell.y, cell.radius, 0, Math.PI * 2);
            ctx.stroke();
            
            // ç»˜åˆ¶æ ¸è†œï¼ˆå‰æœŸIä¹‹å‰ï¼‰
            if (cell.nuclearMembrane && currentStage < 1) {
                ctx.strokeStyle = '#F5F5F5';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.arc(cell.x, cell.y, cell.radius * 0.8, 0, Math.PI * 2);
                ctx.stroke();
                ctx.setLineDash([]);
            }
            
            // æ›´æ–°çººé”¤ä½“
            updateSpindle();
            
            // ç»˜åˆ¶çººé”¤ä½“
            drawSpindle();
            
            // ç»˜åˆ¶æŸ“è‰²ä½“
            drawChromosomes();
            
            // ç»˜åˆ¶è¢«é€‰ä¸­çš„æŸ“è‰²ä½“é«˜äº®
            if (selectedChromosome) {
                drawSelectedChromosome();
            }
        }
        
        // æ›´æ–°çººé”¤ä½“
        function updateSpindle() {
            // çººé”¤ä½“æç‚¹ä½ç½®
            const poleDistance = cell.radius * 0.8;
            
            if (currentStage >= 2 && currentStage <= 3) { // ä¸­æœŸIå’ŒåæœŸI
                cell.spindlePoles[0].x = cell.x - poleDistance;
                cell.spindlePoles[0].y = cell.y;
                cell.spindlePoles[1].x = cell.x + poleDistance;
                cell.spindlePoles[1].y = cell.y;
            } else if (currentStage >= 6 && currentStage <= 7) { // ä¸­æœŸIIå’ŒåæœŸII
                // å‡æ•°åˆ†è£‚IIæœ‰ä¸¤ä¸ªç»†èƒ
                const cell1X = cell.x - cell.radius * 0.5;
                const cell2X = cell.x + cell.radius * 0.5;
                
                cell.spindlePoles[0].x = cell1X - poleDistance * 0.6;
                cell.spindlePoles[0].y = cell.y;
                cell.spindlePoles[1].x = cell1X + poleDistance * 0.6;
                cell.spindlePoles[1].y = cell.y;
            } else {
                cell.spindlePoles[0].x = cell.x - poleDistance;
                cell.spindlePoles[0].y = cell.y;
                cell.spindlePoles[1].x = cell.x + poleDistance;
                cell.spindlePoles[1].y = cell.y;
            }
            
            // æ›´æ–°çººé”¤ä¸
            cell.spindleFibers = [];
            
            if (currentStage >= 2) { // ä¸­æœŸIåŠä»¥å
                chromosomes.forEach(chr => {
                    if (currentStage >= 4 && currentStage <= 8) {
                        // å‡æ•°åˆ†è£‚IIï¼ŒæŸ“è‰²ä½“åœ¨ä¸åŒç»†èƒä¸­
                        return;
                    }
                    
                    const progress = animationProgress / stages[currentStage].duration;
                    
                    if (currentStage === 2) { // ä¸­æœŸI
                        // æŸ“è‰²ä½“åœ¨èµ¤é“æ¿
                        const targetX = cell.x;
                        const targetY = cell.y - cell.radius * 0.3 + chr.id * 20;
                        
                        chr.x += (targetX - chr.x) * 0.1;
                        chr.y += (targetY - chr.y) * 0.1;
                        
                        // è¿æ¥åˆ°ä¸¤æ
                        cell.spindleFibers.push({
                            from: cell.spindlePoles[0],
                            to: {x: chr.x - 10, y: chr.y}
                        });
                        cell.spindleFibers.push({
                            from: cell.spindlePoles[1],
                            to: {x: chr.x + 10, y: chr.y}
                        });
                    } else if (currentStage === 3) { // åæœŸI
                        // åŒæºæŸ“è‰²ä½“åˆ†ç¦»
                        const targetPole = chr.paternal ? 0 : 1;
                        const targetX = cell.spindlePoles[targetPole].x;
                        const targetY = cell.spindlePoles[targetPole].y + (chr.id % 2) * 40 - 20;
                        
                        chr.x += (targetX - chr.x) * 0.05 * progress;
                        chr.y += (targetY - chr.y) * 0.05 * progress;
                        
                        // è¿æ¥åˆ°å¯¹åº”çš„æ
                        cell.spindleFibers.push({
                            from: cell.spindlePoles[targetPole],
                            to: {x: chr.x, y: chr.y}
                        });
                    }
                });
            }
        }
        
        // ç»˜åˆ¶çººé”¤ä½“
        function drawSpindle() {
            if (currentStage < 2) return; // å‰æœŸIä¹‹å‰ä¸æ˜¾ç¤ºçººé”¤ä½“
            
            // ç»˜åˆ¶ä¸­å¿ƒä½“
            ctx.fillStyle = '#666666';
            cell.spindlePoles.forEach(pole => {
                ctx.beginPath();
                ctx.arc(pole.x, pole.y, 8, 0, Math.PI * 2);
                ctx.fill();
                
                // ä¸­å¿ƒä½“å‘¨å›´çš„å¾®ç®¡ç»„ç»‡ä¸­å¿ƒ
                ctx.strokeStyle = '#666666';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.arc(pole.x, pole.y, 15, 0, Math.PI * 2);
                ctx.stroke();
            });
            
            // ç»˜åˆ¶çººé”¤ä¸
            ctx.strokeStyle = '#D4C1E0';
            ctx.lineWidth = 2;
            ctx.setLineDash([2, 2]);
            
            cell.spindleFibers.forEach(fiber => {
                ctx.beginPath();
                ctx.moveTo(fiber.from.x, fiber.from.y);
                ctx.lineTo(fiber.to.x, fiber.to.y);
                ctx.stroke();
            });
            
            ctx.setLineDash([]);
        }
        
        // ç»˜åˆ¶æŸ“è‰²ä½“
        function drawChromosomes() {
            chromosomes.forEach(chr => {
                // æ ¹æ®é˜¶æ®µæ›´æ–°æŸ“è‰²ä½“çŠ¶æ€
                updateChromosomeState(chr);
                
                // ç»˜åˆ¶æŸ“è‰²ä½“
                drawChromosome(chr);
            });
            
            // å¦‚æœæ˜¯å‰æœŸIï¼Œç»˜åˆ¶è”ä¼šå¤åˆä½“å’Œå››åˆ†ä½“
            if (currentStage === 1) {
                drawSynapsis();
            }
        }
        
        // æ›´æ–°æŸ“è‰²ä½“çŠ¶æ€
        function updateChromosomeState(chr) {
            // æŸ“è‰²ä½“å¤åˆ¶ï¼ˆé—´æœŸï¼‰
            if (currentStage >= 0 && !chr.replicated) {
                chr.replicated = true;
            }
            
            // æŸ“è‰²ä½“å‡ç¼©ï¼ˆå‰æœŸIï¼‰
            if (currentStage >= 1) {
                // æŸ“è‰²ä½“å˜å¾—æ›´ç²—æ›´çŸ­
                chr.displayLength = chr.length * 0.7;
            } else {
                chr.displayLength = chr.length;
            }
        }
        
        // ç»˜åˆ¶å•ä¸ªæŸ“è‰²ä½“
        function drawChromosome(chr) {
            const length = chr.displayLength || chr.length;
            const centromerePos = chr.centromerePos;
            
            // æŸ“è‰²ä½“é¢œè‰²
            const mainColor = chr.paternal ? '#2E5A88' : '#A63D40';
            const sisterColor = chr.paternal ? 'rgba(46, 90, 136, 0.5)' : 'rgba(166, 61, 64, 0.5)';
            
            // è®¡ç®—æŸ“è‰²ä½“ç«¯ç‚¹
            const endX1 = chr.x + Math.cos(chr.angle) * length * centromerePos;
            const endY1 = chr.y + Math.sin(chr.angle) * length * centromerePos;
            const endX2 = chr.x - Math.cos(chr.angle) * length * (1 - centromerePos);
            const endY2 = chr.y - Math.sin(chr.angle) * length * (1 - centromerePos);
            
            // ç»˜åˆ¶å§å¦¹æŸ“è‰²å•ä½“ï¼ˆå¦‚æœå·²å¤åˆ¶ï¼‰
            if (chr.replicated && currentStage >= 0) {
                const offset = 5;
                const offsetX = Math.cos(chr.angle + Math.PI/2) * offset;
                const offsetY = Math.sin(chr.angle + Math.PI/2) * offset;
                
                // ç¬¬ä¸€æ¡å§å¦¹æŸ“è‰²å•ä½“
                ctx.strokeStyle = sisterColor;
                ctx.lineWidth = 6;
                ctx.beginPath();
                ctx.moveTo(endX1 + offsetX, endY1 + offsetY);
                ctx.lineTo(endX2 + offsetX, endY2 + offsetY);
                ctx.stroke();
                
                // ç¬¬äºŒæ¡å§å¦¹æŸ“è‰²å•ä½“
                ctx.strokeStyle = mainColor;
                ctx.lineWidth = 6;
                ctx.beginPath();
                ctx.moveTo(endX1 - offsetX, endY1 - offsetY);
                ctx.lineTo(endX2 - offsetX, endY2 - offsetY);
                ctx.stroke();
                
                // ç»˜åˆ¶ç€ä¸ç²’
                ctx.fillStyle = '#333';
                ctx.beginPath();
                ctx.arc(chr.x, chr.y, 4, 0, Math.PI * 2);
                ctx.fill();
                
                // å­˜å‚¨æŸ“è‰²ä½“è¾¹ç•Œç”¨äºç‚¹å‡»æ£€æµ‹
                chr.bounds = {
                    x: Math.min(endX1, endX2) - 10,
                    y: Math.min(endY1, endY2) - 10,
                    width: Math.abs(endX1 - endX2) + 20,
                    height: Math.abs(endY1 - endY2) + 20
                };
            } else {
                // æœªå¤åˆ¶çš„æŸ“è‰²ä½“
                ctx.strokeStyle = mainColor;
                ctx.lineWidth = 8;
                ctx.beginPath();
                ctx.moveTo(endX1, endY1);
                ctx.lineTo(endX2, endY2);
                ctx.stroke();
                
                // ç»˜åˆ¶ç€ä¸ç²’
                ctx.fillStyle = '#333';
                ctx.beginPath();
                ctx.arc(chr.x, chr.y, 4, 0, Math.PI * 2);
                ctx.fill();
                
                // å­˜å‚¨æŸ“è‰²ä½“è¾¹ç•Œ
                chr.bounds = {
                    x: Math.min(endX1, endX2) - 10,
                    y: Math.min(endY1, endY2) - 10,
                    width: Math.abs(endX1 - endX2) + 20,
                    height: Math.abs(endY1 - endY2) + 20
                };
            }
            
            // å¦‚æœæ˜¯è¢«é€‰ä¸­çš„æŸ“è‰²ä½“ï¼Œç»˜åˆ¶é«˜äº®
            if (selectedChromosome === chr.id) {
                ctx.strokeStyle = '#FFD700';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(chr.x, chr.y, length/2 + 15, 0, Math.PI * 2);
                ctx.stroke();
            }
        }
        
        // ç»˜åˆ¶è”ä¼šå’Œå››åˆ†ä½“
        function drawSynapsis() {
            // å°†æŸ“è‰²ä½“æŒ‰åŒæºé…å¯¹åˆ†ç»„
            const pairedChromosomes = [
                [chromosomes[0], chromosomes[1]], // ç¬¬ä¸€å¯¹åŒæºæŸ“è‰²ä½“
                [chromosomes[2], chromosomes[3]]  // ç¬¬äºŒå¯¹åŒæºæŸ“è‰²ä½“
            ];
            
            pairedChromosomes.forEach(pair => {
                const chr1 = pair[0];
                const chr2 = pair[1];
                
                // è®¡ç®—é…å¯¹ä½ç½®
                const pairX = (chr1.x + chr2.x) / 2;
                const pairY = (chr1.y + chr2.y) / 2;
                
                // ç»˜åˆ¶è”ä¼šå¤åˆä½“ï¼ˆè¿æ¥ä¸¤æ¡åŒæºæŸ“è‰²ä½“ï¼‰
                ctx.strokeStyle = '#888';
                ctx.lineWidth = 2;
                ctx.setLineDash([3, 3]);
                ctx.beginPath();
                ctx.moveTo(chr1.x, chr1.y);
                ctx.lineTo(chr2.x, chr2.y);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // ç»˜åˆ¶å››åˆ†ä½“æ ‡ç­¾ï¼ˆä»…åœ¨ç¬¬ä¸€å¯¹æŸ“è‰²ä½“ä¸Šï¼‰
                if (pair === pairedChromosomes[0]) {
                    ctx.fillStyle = '#2E5A88';
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('å››åˆ†ä½“', pairX, pairY - 30);
                    
                    // ç»˜åˆ¶äº¤å‰äº’æ¢ç¤ºæ„å›¾
                    ctx.strokeStyle = '#FF6B6B';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(pairX - 20, pairY - 10);
                    ctx.lineTo(pairX + 20, pairY + 10);
                    ctx.stroke();
                    
                    ctx.beginPath();
                    ctx.moveTo(pairX + 20, pairY - 10);
                    ctx.lineTo(pairX - 20, pairY + 10);
                    ctx.stroke();
                }
            });
        }
        
        // ç»˜åˆ¶è¢«é€‰ä¸­çš„æŸ“è‰²ä½“è¯¦ç»†ä¿¡æ¯
        function drawSelectedChromosome() {
            const chr = chromosomes.find(c => c.id === selectedChromosome);
            if (!chr) return;
            
            // ç»˜åˆ¶ä¿¡æ¯æ¡†
            const infoX = chr.x + 100;
            const infoY = chr.y - 50;
            const infoWidth = 200;
            const infoHeight = 120;
            
            // èƒŒæ™¯
            ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
            ctx.strokeStyle = '#4A6FA5';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.roundRect(infoX, infoY, infoWidth, infoHeight, 10);
            ctx.fill();
            ctx.stroke();
            
            // æ–‡æœ¬
            ctx.fillStyle = '#333';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(`æŸ“è‰²ä½“ ${chr.id}`, infoX + 10, infoY + 25);
            
            ctx.font = '14px Arial';
            ctx.fillText(`æ¥æº: ${chr.paternal ? 'çˆ¶æœ¬' : 'æ¯æœ¬'}`, infoX + 10, infoY + 50);
            ctx.fillText(`é•¿åº¦: ${chr.length}`, infoX + 10, infoY + 70);
            ctx.fillText(`ç€ä¸ç²’ä½ç½®: ${chr.centromerePos}`, infoX + 10, infoY + 90);
            ctx.fillText(`çŠ¶æ€: ${chr.replicated ? 'å·²å¤åˆ¶' : 'æœªå¤åˆ¶'}`, infoX + 10, infoY + 110);
            
            // è¿æ¥çº¿
            ctx.strokeStyle = '#4A6FA5';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(chr.x, chr.y);
            ctx.lineTo(infoX, infoY + infoHeight/2);
            ctx.stroke();
            ctx.setLineDash([]);
        }
        
        // å¤„ç†ç”»å¸ƒç‚¹å‡»
        function handleCanvasClick(event) {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†æŸ“è‰²ä½“
            for (const chr of chromosomes) {
                if (chr.bounds && 
                    x >= chr.bounds.x && x <= chr.bounds.x + chr.bounds.width &&
                    y >= chr.bounds.y && y <= chr.bounds.y + chr.bounds.height) {
                    
                    if (selectedChromosome === chr.id) {
                        selectedChromosome = null; // å–æ¶ˆé€‰æ‹©
                    } else {
                        selectedChromosome = chr.id; // é€‰æ‹©æŸ“è‰²ä½“
                        
                        // å¦‚æœæ˜¯å‰æœŸIä¸”ç‚¹å‡»äº†ç¬¬ä¸€å¯¹åŒæºæŸ“è‰²ä½“ï¼Œæ˜¾ç¤ºå››åˆ†ä½“ä¿¡æ¯
                        if (currentStage === 1 && chr.id <= 2) {
                            setTimeout(() => {
                                alert('å››åˆ†ä½“ï¼šä¸€å¯¹åŒæºæŸ“è‰²ä½“å¤åˆ¶åå½¢æˆçš„4æ¡æŸ“è‰²å•ä½“ç»“æ„ã€‚\n\nåœ¨å››åˆ†ä½“æ—¶æœŸï¼Œéå§å¦¹æŸ“è‰²å•ä½“ä¹‹é—´å¯èƒ½å‘ç”Ÿäº¤å‰äº’æ¢ï¼Œè¿™æ˜¯é—ä¼ å˜å¼‚çš„é‡è¦æ¥æºã€‚');
                            }, 100);
                        }
                    }
                    return;
                }
            }
            
            // ç‚¹å‡»å…¶ä»–åŒºåŸŸå–æ¶ˆé€‰æ‹©
            selectedChromosome = null;
        }
        
        // åŠ¨ç”»æ§åˆ¶å‡½æ•°
        function togglePlayPause() {
            isPlaying = !isPlaying;
            playPauseBtn.textContent = isPlaying ? 'â¸ æš‚åœ' : 'â–¶ æ’­æ”¾';
        }
        
        function prevStage() {
            if (currentStage > 0) {
                currentStage--;
                animationProgress = 0;
                updateStageInfo();
                updateStageButtons();
            }
        }
        
        function nextStage() {
            if (currentStage < stages.length - 1) {
                currentStage++;
                animationProgress = 0;
                updateStageInfo();
                updateStageButtons();
            }
        }
        
        function goToStage(stage) {
            currentStage = stage;
            animationProgress = 0;
            updateStageInfo();
            updateStageButtons();
            
            // æ ¹æ®é˜¶æ®µæ›´æ–°ç»†èƒçŠ¶æ€
            if (currentStage >= 1) {
                cell.nuclearMembrane = false; // å‰æœŸIæ ¸è†œæ¶ˆå¤±
            } else {
                cell.nuclearMembrane = true;
            }
            
            // é‡ç½®æŸ“è‰²ä½“ä½ç½®
            if (currentStage === 0) {
                arrangeChromosomes();
            }
        }
        
        function resetAnimation() {
            currentStage = 0;
            animationProgress = 0;
            isPlaying = false;
            playPauseBtn.textContent = 'â–¶ æ’­æ”¾';
            selectedChromosome = null;
            
            // é‡ç½®æŸ“è‰²ä½“çŠ¶æ€
            chromosomes.forEach(chr => {
                chr.replicated = false;
            });
            
            cell.nuclearMembrane = true;
            arrangeChromosomes();
            
            updateStageInfo();
            updateStageButtons();
        }
        
        function updateSpeed() {
            animationSpeed = parseFloat(speedSlider.value);
            speedValue.textContent = animationSpeed.toFixed(1) + 'x
<!--æ£€æµ‹åˆ°ä»£ç æˆªæ–­ï¼Œè‡ªåŠ¨ç»­å†™ä¸­...-->
        }
        
        function updateStageInfo() {
            const stage = stages[currentStage];
            currentStageTitle.textContent = stage.name;
            currentStageDesc.textContent = stage.description;
        }
        
        function updateStageButtons() {
            stageButtons.forEach((btn, index) => {
                if (index === currentStage) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
        
        // åˆå§‹åŒ–å¹¶å¼€å§‹
        init();
        
        // æ·»åŠ åœ†è§’çŸ©å½¢ç»˜åˆ¶æ–¹æ³•ï¼ˆå…¼å®¹æ€§ï¼‰
        if (!CanvasRenderingContext2D.prototype.roundRect) {
            CanvasRenderingContext2D.prototype.roundRect = function(x, y, width, height, radius) {
                if (width < 2 * radius) radius = width / 2;
                if (height < 2 * radius) radius = height / 2;
                this.beginPath();
                this.moveTo(x + radius, y);
                this.arcTo(x + width, y, x + width, y + height, radius);
                this.arcTo(x + width, y + height, x, y + height, radius);
                this.arcTo(x, y + height, x, y, radius);
                this.arcTo(x, y, x + width, y, radius);
                this.closePath();
                return this;
            }
        }
    </script>
</body>
</html>