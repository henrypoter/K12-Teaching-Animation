<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸºå› å·¥ç¨‹å››å¤§æ­¥éª¤ï¼šå‰ªã€è¿ã€è½¬ã€æ£€ - 3Däº¤äº’æ•™å­¦åŠ¨ç”»</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1A237E 0%, #2C3E50 100%);
            color: #f0f0f0;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(74, 144, 226, 0.3);
        }

        h1 {
            color: #4A90E2;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            color: #50C878;
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .animation-section {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(74, 144, 226, 0.2);
        }

        .canvas-container {
            position: relative;
            width: 100%;
            height: 500px;
            background: rgba(10, 15, 30, 0.7);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        #dnaCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #4A90E2 0%, #2A6FC9 100%);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.15);
            color: #f0f0f0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-success {
            background: linear-gradient(135deg, #50C878 0%, #2E8B57 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #FFA726 0%, #F57C00 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #FF5252 0%, #D32F2F 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            position: relative;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
            z-index: 2;
        }

        .step-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            border: 3px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.5);
        }

        .step.active .step-circle {
            background: #4A90E2;
            border-color: #4A90E2;
            color: white;
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(74, 144, 226, 0.7);
        }

        .step.completed .step-circle {
            background: #50C878;
            border-color: #50C878;
            color: white;
        }

        .step-label {
            font-size: 0.9rem;
            text-align: center;
            font-weight: 500;
        }

        .step-line {
            position: absolute;
            top: 25px;
            left: 10%;
            right: 10%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            z-index: 1;
        }

        .info-panel {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #4A90E2;
        }

        .info-title {
            color: #4A90E2;
            font-size: 1.3rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-content {
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.9);
        }

        .toolbox {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        .tool {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: grab;
            transition: all 0.2s ease;
            border: 2px dashed transparent;
            text-align: center;
            min-width: 120px;
        }

        .tool:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .tool.active {
            border-color: #4A90E2;
            background: rgba(74, 144, 226, 0.2);
        }

        .tool-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .tool-name {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .quiz-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            border: 1px solid rgba(80, 200, 120, 0.3);
        }

        .quiz-question {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #50C878;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .quiz-option {
            padding: 15px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quiz-option:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .quiz-option.correct {
            background: rgba(80, 200, 120, 0.3);
            border-left: 4px solid #50C878;
        }

        .quiz-option.incorrect {
            background: rgba(255, 82, 82, 0.3);
            border-left: 4px solid #FF5252;
        }

        .hidden {
            display: none !important;
        }

        .hint {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            max-width: 250px;
            z-index: 100;
            pointer-events: none;
            border: 1px solid #4A90E2;
        }

        .completion-message {
            text-align: center;
            padding: 30px;
            background: rgba(80, 200, 120, 0.1);
            border-radius: 15px;
            margin-top: 30px;
            border: 2px solid #50C878;
        }

        .completion-title {
            color: #50C878;
            font-size: 1.8rem;
            margin-bottom: 15px;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .step-indicator {
                flex-wrap: wrap;
                gap: 20px;
            }
            
            .step {
                flex: 0 0 calc(50% - 20px);
            }
            
            .canvas-container {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>åŸºå› å·¥ç¨‹å››å¤§æ­¥éª¤</h1>
            <p class="subtitle">å‰ªã€è¿ã€è½¬ã€æ£€ - ä¸‰ç»´äº¤äº’å¼æ•™å­¦åŠ¨ç”»</p>
        </header>
        
        <main class="main-content">
            <section class="animation-section">
                <div class="step-indicator">
                    <div class="step-line"></div>
                    <div class="step active" data-step="1">
                        <div class="step-circle">1</div>
                        <div class="step-label">å‰ª - åˆ‡å‰²DNA</div>
                    </div>
                    <div class="step" data-step="2">
                        <div class="step-circle">2</div>
                        <div class="step-label">è¿ - è¿æ¥åŸºå› </div>
                    </div>
                    <div class="step" data-step="3">
                        <div class="step-circle">3</div>
                        <div class="step-label">è½¬ - è½¬å…¥ç»†èƒ</div>
                    </div>
                    <div class="step" data-step="4">
                        <div class="step-circle">4</div>
                        <div class="step-label">æ£€ - æ£€æµ‹è¡¨è¾¾</div>
                    </div>
                </div>
                
                <div class="canvas-container">
                    <canvas id="dnaCanvas"></canvas>
                    <div id="hint" class="hint hidden"></div>
                </div>
                
                <div class="toolbox" id="toolbox">
                    <div class="tool" data-tool="restriction-enzyme" id="tool-restriction">
                        <div class="tool-icon">âœ‚ï¸</div>
                        <div class="tool-name">é™åˆ¶æ€§å†…åˆ‡é…¶</div>
                    </div>
                    <div class="tool" data-tool="dna-fragment" id="tool-dna">
                        <div class="tool-icon">ğŸ§¬</div>
                        <div class="tool-name">ç›®æ ‡åŸºå› ç‰‡æ®µ</div>
                    </div>
                    <div class="tool" data-tool="ligase" id="tool-ligase">
                        <div class="tool-icon">ğŸ”—</div>
                        <div class="tool-name">DNAè¿æ¥é…¶</div>
                    </div>
                    <div class="tool" data-tool="plasmid" id="tool-plasmid">
                        <div class="tool-icon">â­•</div>
                        <div class="tool-name">è´¨ç²’è½½ä½“</div>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn btn-secondary" id="prevBtn">
                        <span>â—€</span> ä¸Šä¸€æ­¥
                    </button>
                    <button class="btn btn-primary" id="playBtn">
                        <span>â–¶</span> æ’­æ”¾åŠ¨ç”»
                    </button>
                    <button class="btn btn-secondary" id="nextBtn">
                        ä¸‹ä¸€æ­¥ <span>â–¶</span>
                    </button>
                    <button class="btn btn-secondary" id="resetBtn">
                        <span>â†º</span> é‡ç½®
                    </button>
                    <button class="btn btn-success" id="testBtn">
                        <span>ğŸ”¬</span> å¼€å§‹æ£€æµ‹
                    </button>
                </div>
                
                <div class="info-panel">
                    <div class="info-title">
                        <span id="stepIcon">âœ‚ï¸</span>
                        <span id="stepTitle">æ­¥éª¤ä¸€ï¼šå‰ªåˆ‡DNA</span>
                    </div>
                    <div class="info-content" id="stepDescription">
                        ä½¿ç”¨é™åˆ¶æ€§å†…åˆ‡é…¶åœ¨ç‰¹å®šè¯†åˆ«åºåˆ—å¤„åˆ‡å‰²DNAåˆ†å­ï¼Œäº§ç”Ÿé»æ€§æœ«ç«¯ã€‚è¯·ä»å·¦ä¾§å·¥å…·ç®±ä¸­é€‰æ‹©"é™åˆ¶æ€§å†…åˆ‡é…¶"ï¼Œç„¶åæ‹–æ‹½åˆ°DNAé“¾ä¸Šè¿›è¡Œåˆ‡å‰²ã€‚
                    </div>
                </div>
            </section>
            
            <section class="quiz-section hidden" id="quizSection">
                <h2 class="info-title">çŸ¥è¯†æŒ‘æˆ˜</h2>
                <p class="quiz-question" id="quizQuestion">åŸºå› å·¥ç¨‹ä¸­ï¼Œç”¨æ¥åˆ‡å‰²DNAäº§ç”Ÿé»æ€§æœ«ç«¯çš„å·¥å…·æ˜¯ä»€ä¹ˆï¼Ÿ</p>
                <div class="quiz-options" id="quizOptions">
                    <div class="quiz-option" data-answer="A">A. DNAè¿æ¥é…¶</div>
                    <div class="quiz-option" data-answer="B">B. é™åˆ¶æ€§å†…åˆ‡é…¶</div>
                    <div class="quiz-option" data-answer="C">C. RNAèšåˆé…¶</div>
                    <div class="quiz-option" data-answer="D">D. è§£æ—‹é…¶</div>
                </div>
            </section>
            
            <div class="completion-message hidden" id="completionMessage">
                <h2 class="completion-title">ğŸ‰ æ­å–œï¼</h2>
                <p>æ‚¨å·²ç»æˆåŠŸå®Œæˆäº†åŸºå› å·¥ç¨‹å››å¤§æ­¥éª¤çš„å­¦ä¹ ï¼</p>
                <p>é€šè¿‡è¿™ä¸ªäº¤äº’å¼åŠ¨ç”»ï¼Œæ‚¨å·²ç»æŒæ¡äº†ï¼š</p>
                <ul style="text-align: left; margin: 15px 0; padding-left: 20px;">
                    <li>ä½¿ç”¨é™åˆ¶æ€§å†…åˆ‡é…¶åˆ‡å‰²DNA</li>
                    <li>ä½¿ç”¨DNAè¿æ¥é…¶è¿æ¥åŸºå› ç‰‡æ®µä¸è´¨ç²’</li>
                    <li>å°†é‡ç»„è´¨ç²’è½¬å…¥ç»†èŒç»†èƒ</li>
                    <li>æ£€æµ‹åŸºå› æ˜¯å¦æˆåŠŸè¡¨è¾¾</li>
                </ul>
                <p>ç‚¹å‡»"é‡ç½®"æŒ‰é’®å¯ä»¥é‡æ–°å¼€å§‹å­¦ä¹ ã€‚</p>
            </div>
        </main>
        
        <footer>
            <p>åŸºå› å·¥ç¨‹æ•™å­¦åŠ¨ç”» | è®¾è®¡ï¼šæ•™è‚²æŠ€æœ¯ä¸“å®¶ | æœ¬åŠ¨ç”»ä¸ºæ•™å­¦æ¼”ç¤ºç”¨é€”</p>
            <p>æ³¨æ„ï¼šæœ¬åŠ¨ç”»å¯¹åˆ†å­è¿‡ç¨‹è¿›è¡Œäº†ç®€åŒ–ä¸å¯è§†åŒ–å¤„ç†ï¼Œä¾¿äºç†è§£æ ¸å¿ƒæ¦‚å¿µ</p>
        </footer>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentStep = 1;
        let animationPlaying = false;
        let canvas, ctx;
        let animationId;
        let hintElement;
        
        // é¢œè‰²å®šä¹‰
        const colors = {
            dnaBackbone: '#CCCCCC',
            dnaBaseA: '#FFA726', // æ©™è‰²
            dnaBaseT: '#42A5F5', // è“è‰²
            dnaBaseG: '#66BB6A', // ç»¿è‰²
            dnaBaseC: '#EF5350', // çº¢è‰²
            restrictionEnzyme: '#FF5252', // çº¢è‰²
            ligase: '#FFD95C', // é»„è‰²
            plasmid: '#AB47BC', // ç´«è‰²
            bacteria: '#E8F5E9', // æµ…ç»¿è‰²
            success: '#00E676', // ç»¿è‰²
            failure: '#FF5252', // çº¢è‰²
            highlight: '#FFFFFF' // ç™½è‰²
        };
        
        // åŠ¨ç”»çŠ¶æ€
        const state = {
            dnaCut: false,
            geneConnected: false,
            transformed: false,
            tested: false,
            selectedTool: null,
            dragging: false,
            dragObject: null,
            dragOffset: {x: 0, y: 0},
            bacteria: [],
            showAntibiotic: false,
            showUV: false
        };
        
        // åˆå§‹åŒ–ç»†èŒ
        function initBacteria() {
            state.bacteria = [];
            for (let i = 0; i < 20; i++) {
                state.bacteria.push({
                    x: 100 + (i % 5) * 120,
                    y: 150 + Math.floor(i / 5) * 80,
                    radius: 20,
                    transformed: i < 5, // å‰5ä¸ªæ˜¯æˆåŠŸè½¬åŒ–çš„
                    glowing: false,
                    alive: true
                });
            }
        }
        
        // åˆå§‹åŒ–Canvas
        function initCanvas() {
            canvas = document.getElementById('dnaCanvas');
            ctx = canvas.getContext('2d');
            hintElement = document.getElementById('hint');
            
            // è®¾ç½®Canvaså°ºå¯¸
            function resizeCanvas() {
                const container = canvas.parentElement;
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
                draw();
            }
            
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
            
            // äº‹ä»¶ç›‘å¬
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('click', handleCanvasClick);
            
            // å·¥å…·ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.tool').forEach(tool => {
                tool.addEventListener('click', () => {
                    if (tool.classList.contains('active')) {
                        tool.classList.remove('active');
                        state.selectedTool = null;
                    } else {
                        document.querySelectorAll('.tool').forEach(t => t.classList.remove('active'));
                        tool.classList.add('active');
                        state.selectedTool = tool.dataset.tool;
                        showHint(`å·²é€‰æ‹©ï¼š${tool.querySelector('.tool-name').textContent}`);
                    }
                });
            });
            
            // æ§åˆ¶æŒ‰é’®äº‹ä»¶
            document.getElementById('prevBtn').addEventListener('click', prevStep);
            document.getElementById('nextBtn').addEventListener('click', nextStep);
            document.getElementById('playBtn').addEventListener('click', toggleAnimation);
            document.getElementById('resetBtn').addEventListener('click', resetAnimation);
            document.getElementById('testBtn').addEventListener('click', startTest);
            
            // åˆå§‹åŒ–ç»†èŒ
            initBacteria();
        }
        
        // ç»˜åˆ¶å‡½æ•°
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // æ ¹æ®å½“å‰æ­¥éª¤ç»˜åˆ¶ä¸åŒå†…å®¹
            switch(currentStep) {
                case 1:
                    drawStep1();
                    break;
                case 2:
                    drawStep2();
                    break;
                case 3:
                    drawStep3();
                    break;
                case 4:
                    drawStep4();
                    break;
            }
            
            // ç»˜åˆ¶æ‹–æ‹½å¯¹è±¡
            if (state.dragging && state.dragObject) {
                drawDragObject();
            }
        }
        
        // æ­¥éª¤1ï¼šå‰ªåˆ‡DNA
        function drawStep1() {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            // ç»˜åˆ¶DNAé“¾
            drawDNA(centerX - 200, centerY, 400, 30, false);
            
            // ç»˜åˆ¶é™åˆ¶é…¶ï¼ˆå¦‚æœåœ¨å·¥å…·ç®±ä¸­ï¼‰
            if (!state.dnaCut) {
                drawRestrictionEnzyme(centerX + 150, centerY - 100);
                
                // ç»˜åˆ¶æç¤º
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ç‚¹å‡»å¹¶æ‹–æ‹½é™åˆ¶é…¶åˆ°DNAé“¾ä¸Šè¿›è¡Œåˆ‡å‰²', centerX, centerY + 100);
            } else {
                // ç»˜åˆ¶åˆ‡å‰²åçš„DNA
                drawCutDNA(centerX, centerY);
                
                ctx.fillStyle = colors.success;
                ctx.font = 'bold 18px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('âœ“ DNAå·²æˆåŠŸåˆ‡å‰²ï¼', centerX, centerY + 100);
            }
        }
        
        // æ­¥éª¤2ï¼šè¿æ¥åŸºå› 
        function drawStep2() {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            // ç»˜åˆ¶è´¨ç²’
            drawPlasmid(centerX, centerY - 50, 80);
            
            // ç»˜åˆ¶ç›®æ ‡åŸºå› ç‰‡æ®µ
            if (!state.geneConnected) {
                drawDNAFragment(centerX - 200, centerY + 100, 150, 20);
                
                // ç»˜åˆ¶DNAè¿æ¥é…¶
                drawLigase(centerX + 150, centerY + 100);
                
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('æ‹–æ‹½åŸºå› ç‰‡æ®µåˆ°è´¨ç²’åˆ‡å£å¤„ï¼Œç„¶åä½¿ç”¨è¿æ¥é…¶', centerX, centerY + 180);
            } else {
                // ç»˜åˆ¶é‡ç»„è´¨ç²’
                drawRecombinantPlasmid(centerX, centerY);
                
                ctx.fillStyle = colors.success;
                ctx.font = 'bold 18px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('âœ“ é‡ç»„è´¨ç²’æ„å»ºæˆåŠŸï¼', centerX, centerY + 150);
            }
        }
        
        // æ­¥éª¤3ï¼šè½¬å…¥ç»†èƒ
        function drawStep3() {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            // ç»˜åˆ¶ç»†èŒç»†èƒ
            drawBacteriaCell(centerX, centerY, 60);
            
            // ç»˜åˆ¶è´¨ç²’
            if (!state.transformed) {
                const angle = Date.now() / 1000;
                const plasmidX = centerX + Math.cos(angle) * 150;
                const plasmidY = centerY + Math.sin(angle) * 150;
                
                drawPlasmid(plasmidX, plasmidY, 40);
                
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ç‚¹å‡»"æ’­æ”¾åŠ¨ç”»"è§‚çœ‹è´¨ç²’è½¬å…¥ç»†èŒçš„è¿‡ç¨‹', centerX, centerY + 150);
            } else {
                // ç»˜åˆ¶è´¨ç²’åœ¨ç»†èŒå†…
                drawPlasmidInCell(centerX, centerY);
                
                ctx.fillStyle = colors.success;
                ctx.font = 'bold 18px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('âœ“ è´¨ç²’æˆåŠŸè½¬å…¥ç»†èŒç»†èƒï¼', centerX, centerY + 150);
            }
        }
        
        // æ­¥éª¤4ï¼šæ£€æµ‹è¡¨è¾¾
        function drawStep4() {
            const centerX = canvas.width / 2;
            
            // ç»˜åˆ¶æ ‡é¢˜
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('ç»†èŒåŸ¹å…»çš¿', centerX, 50);
            
            // ç»˜åˆ¶åŸ¹å…»çš¿
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(centerX, 250, 200, 0, Math.PI * 2);
            ctx.stroke();
            
            // ç»˜åˆ¶ç»†èŒèŒè½
            state.bacteria.forEach(bacteria => {
                drawBacteriaColony(bacteria);
            });
            
            // ç»˜åˆ¶æŠ—ç”Ÿç´ æ•ˆæœ
            if (state.showAntibiotic) {
                ctx.fillStyle = 'rgba(255, 82, 82, 0.3)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = colors.failure;
                ctx.font = 'bold 18px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('æŠ—ç”Ÿç´ æ€æ­»äº†æœªæˆåŠŸè½¬åŒ–çš„ç»†èŒ', centerX, 450);
            }
            
            // ç»˜åˆ¶UVæ•ˆæœ
            if (state.showUV) {
                // UVå…‰æ•ˆæœ
                const gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
                gradient.addColorStop(0, 'rgba(128, 0, 255, 0.1)');
                gradient.addColorStop(0.5, 'rgba(128, 0, 255, 0.3)');
                gradient.addColorStop(1, 'rgba(128, 0, 255, 0.1)');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = colors.success;
                ctx.font = 'bold 18px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('UVç…§å°„ä¸‹ï¼ŒæˆåŠŸè¡¨è¾¾è§å…‰è›‹ç™½çš„èŒè½å‘å‡ºç»¿è‰²è§å…‰', centerX, 450);
            }
            
            if (!state.tested) {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ç‚¹å‡»"å¼€å§‹æ£€æµ‹"æŒ‰é’®è¿›è¡ŒåŸºå› è¡¨è¾¾æ£€æµ‹', centerX, 480);
            }
        }
        
        // ç»˜åˆ¶DNAé“¾
        function drawDNA(x, y, length, basePairs, isCircular = false) {
            const segmentLength = length / basePairs;
            
            // ç»˜åˆ¶ä¸»é“¾
            ctx.strokeStyle = colors.dnaBackbone;
            ctx.lineWidth = 3;
            
            if (isCircular) {
                ctx.beginPath();
                ctx.arc(x, y, length / (2 * Math.PI), 0, Math.PI * 2);
                ctx.stroke();
            } else {
                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.lineTo(x + length, y);
                ctx.stroke();
            }
            
            // ç»˜åˆ¶ç¢±åŸºå¯¹
            for (let i = 0; i < basePairs; i++) {
                const baseX = x + i * segmentLength + segmentLength / 2;
                
                // äº¤æ›¿ç»˜åˆ¶ä¸åŒé¢œè‰²çš„ç¢±åŸºå¯¹
                let color1, color2;
                if (i % 4 === 0) {
                    color1 = colors.dnaBaseA;
                    color2 = colors.dnaBaseT;
                } else if (i % 4 === 1) {
                    color1 = colors.dnaBaseT;
                    color2 = colors.dnaBaseA;
                } else if (i % 4 === 2) {
                    color1 = colors.dnaBaseG;
                    color2 = colors.dnaBaseC;
                } else {
                    color1 = colors.dnaBaseC;
                    color2 = colors.dnaBaseG;
                }
                
                // ç»˜åˆ¶ç¢±åŸºå¯¹è¿çº¿
                ctx.strokeStyle = color1;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(baseX, y - 15);
                ctx.lineTo(baseX, y + 15);
                ctx.stroke();
                
                // ç»˜åˆ¶ç¢±åŸºç‚¹
                ctx.fillStyle = color1;
                ctx.beginPath();
                ctx.arc(baseX, y - 15, 3, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = color2;
                ctx.beginPath();
                ctx.arc(baseX, y + 15, 3, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        
        // ç»˜åˆ¶åˆ‡å‰²åçš„DNA
        function drawCutDNA(x, y) {
            // å·¦åŠéƒ¨åˆ†DNA
            drawDNA(x - 150, y, 150, 15);
            
            // å³åŠéƒ¨åˆ†DNA
            drawDNA(x + 50, y, 150, 15);
            
            // ç»˜åˆ¶åˆ‡å‰²ç‚¹ï¼ˆé»æ€§æœ«ç«¯ï¼‰
            ctx.strokeStyle = colors.highlight;
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            
            // å·¦ç«¯é»æ€§æœ«ç«¯
            ctx.beginPath();
            ctx.moveTo(x - 5, y - 10);
            ctx.lineTo(x - 15, y - 10);
            ctx.moveTo(x - 5, y + 10);
            ctx.lineTo(x - 15, y + 10);
            ctx.stroke();
            
            // å³ç«¯é»æ€§æœ«ç«¯
            ctx.beginPath();
            ctx.moveTo(x + 5, y - 10);
            ctx.lineTo(x + 15, y - 10);
            ctx.moveTo(x + 5, y + 10);
            ctx.lineTo(x + 15, y + 10);
            ctx.stroke();
            
            ctx.setLineDash([]);
        }
        
        // ç»˜åˆ¶é™åˆ¶é…¶
        function drawRestrictionEnzyme(x, y) {
            // é…¶çš„ä¸»ä½“
            ctx.fillStyle = colors.restrictionEnzyme;
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x - 20, y - 30);
            ctx.lineTo(x + 20, y - 30);
            ctx.closePath();
            ctx.fill();
            
            // å‰ªåˆ€å½¢çŠ¶
            ctx.strokeStyle = colors.highlight;
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(x - 15, y - 20);
            ctx.lineTo(x - 5, y - 10);
            ctx.moveTo(x + 15, y - 20);
            ctx.lineTo(x + 5, y - 10);
            ctx.stroke();
            
            // æ ‡ç­¾
            ctx.fillStyle = 'white';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('é™åˆ¶é…¶', x, y - 40);
        }
        
        // ç»˜åˆ¶DNAç‰‡æ®µ
        function drawDNAFragment(x, y, length, basePairs) {
            drawDNA(x, y, length, basePairs);
            
            // é«˜äº®æ˜¾ç¤º
            ctx.strokeStyle = colors.highlight;
            ctx.lineWidth = 2;
            ctx.strokeRect(x - 10, y - 25, length + 20, 50);
        }
        
        // ç»˜åˆ¶DNAè¿æ¥é…¶
        function drawLigase(x, y) {
            // é…¶çš„ä¸»ä½“
            ctx.fillStyle = colors.ligase;
            ctx.beginPath();
            ctx.arc(x, y, 25, 0, Math.PI * 2);
            ctx.fill();
            
            // è¿æ¥ç¬¦å·
            ctx.strokeStyle = colors.highlight;
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(x - 15, y);
            ctx.lineTo(x - 5, y);
            ctx.moveTo(x + 5, y);
            ctx.lineTo(x + 15, y);
            ctx.moveTo(x - 5, y - 5);
            ctx.lineTo(x - 5, y + 5);
            ctx.moveTo(x + 5, y - 5);
            ctx.lineTo(x + 5, y + 5);
            ctx.stroke();
            
            // æ ‡ç­¾
            ctx.fillStyle = 'white';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('è¿æ¥é…¶', x, y - 35);
        }
        
        // ç»˜åˆ¶è´¨ç²’
        function drawPlasmid(x, y, radius) {
            // ç¯å½¢DNA
            ctx.strokeStyle = colors.plasmid;
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.stroke();
            
            // ç»˜åˆ¶ä¸€äº›ç¢±åŸºå¯¹
            const baseCount = 12;
            for (let i = 0; i < baseCount; i++) {
                const angle = (i / baseCount) * Math.PI * 2;
                const baseX = x + Math.cos(angle) * radius;
                const baseY = y + Math.sin(angle) * radius;
                
                ctx.fillStyle = i % 2 === 0 ? colors.dnaBaseA : colors.dnaBaseG;
                ctx.beginPath();
                ctx.arc(baseX, baseY, 3, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // å¦‚æœæ˜¯åˆ‡å‰²åçš„è´¨ç²’ï¼Œæ˜¾ç¤ºåˆ‡å£
            if (currentStep === 2 && !state.geneConnected) {
                ctx.strokeStyle = colors.restrictionEnzyme;
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(x + radius, y, 5, 0, Math.PI * 2);
                ctx.stroke();
            }
        }
        
        // ç»˜åˆ¶é‡ç»„è´¨ç²’
        function drawRecombinantPlasmid(x, y) {
            const radius = 100;
            
            // ç»˜åˆ¶è´¨ç²’ç¯
            ctx.strokeStyle = colors.plasmid;
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.stroke();
            
            // ç»˜åˆ¶æ’å…¥çš„åŸºå› ç‰‡æ®µï¼ˆä¸åŒé¢œè‰²ï¼‰
            ctx.strokeStyle = colors.dnaBaseA;
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.arc(x, y, radius, -Math.PI/4, Math.PI/4);
            ctx.stroke();
            
            // é«˜äº®æ˜¾ç¤ºæ’å…¥ç‚¹
            ctx.fillStyle = colors.success;
            ctx.beginPath();
            ctx.arc(x + radius * Math.cos(Math.PI/4), y + radius * Math.sin(Math.PI/4), 8, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.beginPath();
            ctx.arc(x + radius * Math.cos(-Math.PI/4), y + radius * Math.sin(-Math.PI/4), 8, 0, Math.PI * 2);
            ctx.fill();
            
            // æ ‡ç­¾
            ctx.fillStyle = 'white';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('é‡ç»„è´¨ç²’', x, y - radius - 20);
        }
        
        // ç»˜åˆ¶ç»†èŒç»†èƒ
        function drawBacteriaCell(x, y, radius) {
            // ç»†èƒè†œ
            ctx.strokeStyle = colors.bacteria;
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.ellipse(x, y, radius * 1.5, radius, 
<!--æ£€æµ‹åˆ°ä»£ç æˆªæ–­ï¼Œè‡ªåŠ¨ç»­å†™ä¸­...-->
0, Math.PI * 2);
            ctx.stroke();
            
            // ç»†èƒè´¨
            ctx.fillStyle = colors.bacteria + '40';
            ctx.beginPath();
            ctx.ellipse(x, y, radius * 1.5, radius, 0, Math.PI * 2);
            ctx.fill();
            
            // ç»†èƒå†…éƒ¨ç»“æ„
            ctx.fillStyle = colors.dnaBaseG + '80';
            ctx.beginPath();
            ctx.arc(x - radius/2, y, 8, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.beginPath();
            ctx.arc(x + radius/2, y - 10, 6, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.beginPath();
            ctx.arc(x + radius/3, y + 15, 5, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // ç»˜åˆ¶è´¨ç²’åœ¨ç»†èƒå†…
        function drawPlasmidInCell(x, y) {
            // å…ˆç»˜åˆ¶ç»†èŒç»†èƒ
            drawBacteriaCell(x, y, 60);
            
            // åœ¨ç»†èƒå†…ç»˜åˆ¶è´¨ç²’
            const angle = Date.now() / 1000;
            const plasmidX = x + Math.cos(angle) * 20;
            const plasmidY = y + Math.sin(angle) * 15;
            
            drawPlasmid(plasmidX, plasmidY, 25);
            
            // æ·»åŠ é«˜äº®æ•ˆæœ
            ctx.strokeStyle = colors.success;
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.ellipse(x, y, 90, 60, 0, Math.PI * 2);
            ctx.stroke();
            ctx.setLineDash([]);
        }
        
        // ç»˜åˆ¶ç»†èŒèŒè½
        function drawBacteriaColony(bacteria) {
            if (!bacteria.alive) {
                // æ­»äº¡çš„ç»†èŒ
                ctx.fillStyle = colors.failure + '40';
                ctx.beginPath();
                ctx.arc(bacteria.x, bacteria.y, bacteria.radius, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.strokeStyle = colors.failure;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(bacteria.x - bacteria.radius/2, bacteria.y - bacteria.radius/2);
                ctx.lineTo(bacteria.x + bacteria.radius/2, bacteria.y + bacteria.radius/2);
                ctx.moveTo(bacteria.x + bacteria.radius/2, bacteria.y - bacteria.radius/2);
                ctx.lineTo(bacteria.x - bacteria.radius/2, bacteria.y + bacteria.radius/2);
                ctx.stroke();
                return;
            }
            
            // æ­£å¸¸ç»†èŒ
            ctx.fillStyle = bacteria.transformed ? colors.bacteria : '#CCCCCC';
            ctx.beginPath();
            ctx.arc(bacteria.x, bacteria.y, bacteria.radius, 0, Math.PI * 2);
            ctx.fill();
            
            // æˆåŠŸè½¬åŒ–çš„ç»†èŒæœ‰ç‰¹æ®Šæ ‡è®°
            if (bacteria.transformed) {
                ctx.strokeStyle = colors.plasmid;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(bacteria.x, bacteria.y, bacteria.radius - 3, 0, Math.PI * 2);
                ctx.stroke();
                
                // å¦‚æœæ­£åœ¨å‘å…‰ï¼ˆUVç…§å°„ä¸‹ï¼‰
                if (bacteria.glowing) {
                    // å‘å…‰æ•ˆæœ
                    const gradient = ctx.createRadialGradient(
                        bacteria.x, bacteria.y, 0,
                        bacteria.x, bacteria.y, bacteria.radius * 2
                    );
                    gradient.addColorStop(0, colors.success + '80');
                    gradient.addColorStop(1, colors.success + '0');
                    
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(bacteria.x, bacteria.y, bacteria.radius * 2, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // ç»†èŒæœ¬èº«æ›´äº®
                    ctx.fillStyle = colors.success;
                    ctx.beginPath();
                    ctx.arc(bacteria.x, bacteria.y, bacteria.radius, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
        }
        
        // ç»˜åˆ¶æ‹–æ‹½å¯¹è±¡
        function drawDragObject() {
            if (!state.dragObject) return;
            
            const {type, x, y} = state.dragObject;
            
            switch(type) {
                case 'restriction-enzyme':
                    drawRestrictionEnzyme(x, y);
                    break;
                case 'dna-fragment':
                    drawDNAFragment(x - 75, y, 150, 20);
                    break;
                case 'ligase':
                    drawLigase(x, y);
                    break;
                case 'plasmid':
                    drawPlasmid(x, y, 40);
                    break;
            }
        }
        
        // é¼ æ ‡äº‹ä»¶å¤„ç†
        function handleMouseDown(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†å¯æ‹–æ‹½å¯¹è±¡
            if (currentStep === 1 && !state.dnaCut) {
                // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†é™åˆ¶é…¶
                const enzymeX = canvas.width / 2 + 150;
                const enzymeY = canvas.height / 2 - 100;
                const distance = Math.sqrt((x - enzymeX) ** 2 + (y - enzymeY) ** 2);
                
                if (distance < 40 && state.selectedTool === 'restriction-enzyme') {
                    state.dragging = true;
                    state.dragObject = {
                        type: 'restriction-enzyme',
                        x: x,
                        y: y
                    };
                    state.dragOffset = {x: enzymeX - x, y: enzymeY - y};
                }
            }
            
            if (currentStep === 2 && !state.geneConnected) {
                // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†DNAç‰‡æ®µ
                const fragmentX = canvas.width / 2 - 200;
                const fragmentY = canvas.height / 2 + 100;
                const distance = Math.sqrt((x - fragmentX) ** 2 + (y - fragmentY) ** 2);
                
                if (distance < 100 && state.selectedTool === 'dna-fragment') {
                    state.dragging = true;
                    state.dragObject = {
                        type: 'dna-fragment',
                        x: x,
                        y: y
                    };
                    state.dragOffset = {x: fragmentX - x, y: fragmentY - y};
                }
                
                // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†è¿æ¥é…¶
                const ligaseX = canvas.width / 2 + 150;
                const ligaseY = canvas.height / 2 + 100;
                const ligaseDistance = Math.sqrt((x - ligaseX) ** 2 + (y - ligaseY) ** 2);
                
                if (ligaseDistance < 40 && state.selectedTool === 'ligase') {
                    state.dragging = true;
                    state.dragObject = {
                        type: 'ligase',
                        x: x,
                        y: y
                    };
                    state.dragOffset = {x: ligaseX - x, y: ligaseY - y};
                }
            }
        }
        
        function handleMouseMove(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // æ›´æ–°æ‹–æ‹½å¯¹è±¡ä½ç½®
            if (state.dragging && state.dragObject) {
                state.dragObject.x = x + state.dragOffset.x;
                state.dragObject.y = y + state.dragOffset.y;
                draw();
            }
            
            // æ˜¾ç¤ºæç¤º
            showHintAtPosition(x, y);
        }
        
        function handleMouseUp(e) {
            if (!state.dragging || !state.dragObject) {
                state.dragging = false;
                return;
            }
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // æ£€æŸ¥æ˜¯å¦æ”¾ç½®åˆ°æ­£ç¡®ä½ç½®
            if (currentStep === 1 && state.dragObject.type === 'restriction-enzyme') {
                const dnaX = canvas.width / 2;
                const dnaY = canvas.height / 2;
                
                // æ£€æŸ¥æ˜¯å¦é è¿‘DNAé“¾
                if (Math.abs(y - dnaY) < 50 && x > dnaX - 250 && x < dnaX + 250) {
                    // æˆåŠŸåˆ‡å‰²DNA
                    state.dnaCut = true;
                    showHint('âœ“ DNAåˆ‡å‰²æˆåŠŸï¼äº§ç”Ÿäº†é»æ€§æœ«ç«¯ã€‚');
                    
                    // æ›´æ–°æ­¥éª¤ä¿¡æ¯
                    updateStepInfo();
                    
                    // æ’­æ”¾æˆåŠŸéŸ³æ•ˆï¼ˆæ¨¡æ‹Ÿï¼‰
                    playSuccessSound();
                }
            }
            
            if (currentStep === 2) {
                const plasmidX = canvas.width / 2;
                const plasmidY = canvas.height / 2 - 50;
                
                if (state.dragObject.type === 'dna-fragment') {
                    // æ£€æŸ¥æ˜¯å¦é è¿‘è´¨ç²’åˆ‡å£
                    const distance = Math.sqrt((x - (plasmidX + 80)) ** 2 + (y - plasmidY) ** 2);
                    
                    if (distance < 30) {
                        showHint('åŸºå› ç‰‡æ®µå·²æ”¾ç½®åˆ°è´¨ç²’åˆ‡å£å¤„ã€‚ç°åœ¨è¯·ä½¿ç”¨DNAè¿æ¥é…¶è¿›è¡Œè¿æ¥ã€‚');
                    }
                }
                
                if (state.dragObject.type === 'ligase') {
                    // æ£€æŸ¥æ˜¯å¦é è¿‘è´¨ç²’
                    const distance = Math.sqrt((x - plasmidX) ** 2 + (y - plasmidY) ** 2);
                    
                    if (distance < 100) {
                        // æˆåŠŸè¿æ¥
                        state.geneConnected = true;
                        showHint('âœ“ DNAè¿æ¥æˆåŠŸï¼é‡ç»„è´¨ç²’æ„å»ºå®Œæˆã€‚');
                        
                        // æ›´æ–°æ­¥éª¤ä¿¡æ¯
                        updateStepInfo();
                        
                        // æ’­æ”¾æˆåŠŸéŸ³æ•ˆï¼ˆæ¨¡æ‹Ÿï¼‰
                        playSuccessSound();
                    }
                }
            }
            
            state.dragging = false;
            state.dragObject = null;
            draw();
        }
        
        function handleCanvasClick(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // æ­¥éª¤3ï¼šç‚¹å‡»æ’­æ”¾è½¬åŒ–åŠ¨ç”»
            if (currentStep === 3 && !state.transformed) {
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const distance = Math.sqrt((x - centerX) ** 2 + (y - centerY) ** 2);
                
                if (distance < 100) {
                    playTransformationAnimation();
                }
            }
        }
        
        // æ’­æ”¾è½¬åŒ–åŠ¨ç”»
        function playTransformationAnimation() {
            if (animationPlaying) return;
            
            animationPlaying = true;
            document.getElementById('playBtn').disabled = true;
            
            let startTime = Date.now();
            const duration = 2000; // 2ç§’åŠ¨ç”»
            
            function animate() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                draw();
                
                // ç»˜åˆ¶åŠ¨ç”»ä¸­çš„è´¨ç²’
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                
                // è®¡ç®—è´¨ç²’ä½ç½®ï¼ˆä»å¤–éƒ¨é£å…¥ç»†èƒï¼‰
                const startX = centerX + 150;
                const startY = centerY + 150;
                const endX = centerX;
                const endY = centerY;
                
                const plasmidX = startX + (endX - startX) * progress;
                const plasmidY = startY + (endY - startY) * progress;
                const plasmidSize = 40 * (1 - progress * 0.5);
                
                // ç»˜åˆ¶è´¨ç²’
                drawPlasmid(plasmidX, plasmidY, plasmidSize);
                
                // ç»˜åˆ¶è¿åŠ¨è½¨è¿¹
                ctx.strokeStyle = colors.highlight + '80';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(startX, startY);
                ctx.lineTo(plasmidX, plasmidY);
                ctx.stroke();
                ctx.setLineDash([]);
                
                if (progress < 1) {
                    animationId = requestAnimationFrame(animate);
                } else {
                    // åŠ¨ç”»å®Œæˆ
                    state.transformed = true;
                    animationPlaying = false;
                    document.getElementById('playBtn').disabled = false;
                    
                    // æ›´æ–°æ­¥éª¤ä¿¡æ¯
                    updateStepInfo();
                    
                    // æ’­æ”¾æˆåŠŸéŸ³æ•ˆï¼ˆæ¨¡æ‹Ÿï¼‰
                    playSuccessSound();
                    
                    draw();
                }
            }
            
            animate();
        }
        
        // å¼€å§‹æ£€æµ‹
        function startTest() {
            if (currentStep !== 4) return;
            
            // ç¬¬ä¸€æ­¥ï¼šæ·»åŠ æŠ—ç”Ÿç´ 
            state.showAntibiotic = true;
            draw();
            
            // æ€æ­»æœªè½¬åŒ–çš„ç»†èŒ
            setTimeout(() => {
                state.bacteria.forEach(bacteria => {
                    if (!bacteria.transformed) {
                        bacteria.alive = false;
                    }
                });
                draw();
                
                // ç¬¬äºŒæ­¥ï¼šUVç…§å°„
                setTimeout(() => {
                    state.showAntibiotic = false;
                    state.showUV = true;
                    
                    // è®©è½¬åŒ–çš„ç»†èŒå‘å…‰
                    state.bacteria.forEach(bacteria => {
                        if (bacteria.transformed && bacteria.alive) {
                            bacteria.glowing = true;
                        }
                    });
                    draw();
                    
                    // å®Œæˆæ£€æµ‹
                    setTimeout(() => {
                        state.tested = true;
                        showHint('âœ“ æ£€æµ‹å®Œæˆï¼æˆåŠŸç­›é€‰å‡ºè¡¨è¾¾ç›®æ ‡åŸºå› çš„ç»†èŒã€‚');
                        
                        // æ˜¾ç¤ºå®Œæˆæ¶ˆæ¯
                        document.getElementById('completionMessage').classList.remove('hidden');
                        
                        // æ˜¾ç¤ºæµ‹éªŒ
                        document.getElementById('quizSection').classList.remove('hidden');
                        
                        // æ’­æ”¾æˆåŠŸéŸ³æ•ˆï¼ˆæ¨¡æ‹Ÿï¼‰
                        playSuccessSound();
                    }, 2000);
                }, 2000);
            }, 2000);
        }
        
        // æ˜¾ç¤ºæç¤º
        function showHint(message) {
            hintElement.textContent = message;
            hintElement.classList.remove('hidden');
            
            // å±…ä¸­æ˜¾ç¤º
            hintElement.style.left = '50%';
            hintElement.style.top = '20px';
            hintElement.style.transform = 'translateX(-50%)';
            
            // 3ç§’åéšè—
            setTimeout(() => {
                hintElement.classList.add('hidden');
            }, 3000);
        }
        
        // åœ¨æŒ‡å®šä½ç½®æ˜¾ç¤ºæç¤º
        function showHintAtPosition(x, y) {
            // æ ¹æ®ä½ç½®æ˜¾ç¤ºä¸åŒçš„æç¤º
            if (currentStep === 1 && !state.dnaCut) {
                const dnaY = canvas.height / 2;
                if (Math.abs(y - dnaY) < 30) {
                    hintElement.textContent = 'å°†é™åˆ¶é…¶æ‹–æ‹½åˆ°è¿™é‡Œåˆ‡å‰²DNA';
                    hintElement.style.left = x + 'px';
                    hintElement.style.top = (y - 40) + 'px';
                    hintElement.classList.remove('hidden');
                    return;
                }
            }
            
            // é»˜è®¤éšè—æç¤º
            hintElement.classList.add('hidden');
        }
        
        // æ’­æ”¾æˆåŠŸéŸ³æ•ˆï¼ˆæ¨¡æ‹Ÿï¼‰
        function playSuccessSound() {
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šæ’­æ”¾éŸ³é¢‘æ–‡ä»¶
            // ç°åœ¨ä½¿ç”¨æ§åˆ¶å°æ—¥å¿—æ¨¡æ‹Ÿ
            console.log('æ’­æ”¾æˆåŠŸéŸ³æ•ˆ');
        }
        
        // æ›´æ–°æ­¥éª¤ä¿¡æ¯
        function updateStepInfo() {
            const stepTitles = [
                'æ­¥éª¤ä¸€ï¼šå‰ªåˆ‡DNA',
                'æ­¥éª¤äºŒï¼šè¿æ¥åŸºå› ',
                'æ­¥éª¤ä¸‰ï¼šè½¬å…¥ç»†èƒ',
                'æ­¥éª¤å››ï¼šæ£€æµ‹è¡¨è¾¾'
            ];
            
            const stepIcons = ['âœ‚ï¸', 'ğŸ”—', 'ğŸ¦ ', 'ğŸ”¬'];
            
            const stepDescriptions = [
                'ä½¿ç”¨é™åˆ¶æ€§å†…åˆ‡é…¶åœ¨ç‰¹å®šè¯†åˆ«åºåˆ—å¤„åˆ‡å‰²DNAåˆ†å­ï¼Œäº§ç”Ÿé»æ€§æœ«ç«¯ã€‚',
                'ä½¿ç”¨DNAè¿æ¥é…¶å°†ç›®æ ‡åŸºå› ç‰‡æ®µä¸è´¨ç²’è½½ä½“çš„é»æ€§æœ«ç«¯è¿æ¥ï¼Œå½¢æˆé‡ç»„DNAåˆ†å­ã€‚',
                'é€šè¿‡è½¬åŒ–æ³•å°†é‡ç»„è´¨ç²’å¯¼å…¥ç»†èŒå—ä½“ç»†èƒä¸­ã€‚',
                'é€šè¿‡æŠ—ç”Ÿç´ ç­›é€‰å’Œè§å…‰è›‹ç™½è¡¨è¾¾æ£€æµ‹ï¼Œç¡®è®¤æˆåŠŸè½¬å…¥å¹¶è¡¨è¾¾ç›®æ ‡åŸºå› çš„ç»†èƒã€‚'
            ];
            
            document.getElementById('stepTitle').textContent = stepTitles[currentStep - 1];
            document.getElementById('stepIcon').textContent = stepIcons[currentStep - 1];
            document.getElementById('stepDescription').textContent = stepDescriptions[currentStep - 1];
        }
        
        // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
        function updateStepIndicator() {
            document.querySelectorAll('.step').forEach((step, index) => {
                step.classList.remove('active', 'completed');
                
                const stepNum = index + 1;
                if (stepNum === currentStep) {
                    step.classList.add('active');
                } else if (stepNum < currentStep) {
                    step.classList.add('completed');
                }
            });
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('prevBtn').disabled = currentStep === 1;
            document.getElementById('nextBtn').disabled = currentStep === 4;
            document.getElementById('testBtn').classList.toggle('hidden', currentStep !== 4);
            
            // æ›´æ–°å·¥å…·ç®±æ˜¾ç¤º
            document.getElementById('toolbox').classList.toggle('hidden', currentStep > 2);
            
            // æ›´æ–°æ­¥éª¤ä¿¡æ¯
            updateStepInfo();
            
            // é‡ç»˜Canvas
            draw();
        }
        
        // ä¸‹ä¸€æ­¥
        function nextStep() {
            if (currentStep < 4) {
                currentStep++;
                updateStepIndicator();
            }
        }
        
        // ä¸Šä¸€æ­¥
        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepIndicator();
            }
        }
        
        // åˆ‡æ¢åŠ¨ç”»æ’­æ”¾
        function toggleAnimation() {
            if (currentStep === 3 && !state.transformed) {
                playTransformationAnimation();
            } else {
                // æ’­æ”¾å½“å‰æ­¥éª¤çš„è¯´æ˜åŠ¨ç”»
                animationPlaying = !animationPlaying;
                
                if (animationPlaying) {
                    document.getElementById('playBtn').innerHTML = '<span>â¸</span> æš‚åœåŠ¨ç”»';
                    // è¿™é‡Œå¯ä»¥æ·»åŠ æ­¥éª¤è¯´æ˜åŠ¨ç”»
                } else {
                    document.getElementById('playBtn').innerHTML = '<span>â–¶</span> æ’­æ”¾åŠ¨ç”»';
                    if (animationId) {
                        cancelAnimationFrame(animationId);
                    }
                }
            }
        }
        
        // é‡ç½®åŠ¨ç”»
        function resetAnimation() {
            currentStep = 1;
            state.dnaCut = false;
            state.geneConnected = false;
            state.transformed = false;
            state.tested = false;
            state.selectedTool = null;
            state.dragging = false;
            state.dragObject = null;
            state.showAntibiotic = false;
            state.showUV = false;
            
            // é‡ç½®ç»†èŒ
            initBacteria();
            
            // é‡ç½®UI
            document.querySelectorAll('.tool').forEach(tool => tool.classList.remove('active'));
            document.getElementById('completionMessage').classList.add('hidden');
            document.getElementById('quizSection').classList.add('hidden');
            
            // åœæ­¢åŠ¨ç”»
            animationPlaying = false;
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            
            document.getElementById('playBtn').innerHTML = '<span>â–¶</span> æ’­æ”¾åŠ¨ç”»';
            document.getElementById('playBtn').disabled = false;
            
            updateStepIndicator();
        }
        
        // åˆå§‹åŒ–æµ‹éªŒ
        function initQuiz() {
            const quizOptions = document.querySelectorAll('.quiz-option');
            quizOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const answer = this.dataset.answer;
                    
                    // ç§»é™¤æ‰€æœ‰çŠ¶æ€
                    quizOptions.forEach(opt => {
                        opt.classList.remove('correct', 'incorrect');
                    });
                    
                    // æ£€æŸ¥ç­”æ¡ˆï¼ˆBæ˜¯æ­£ç¡®ç­”æ¡ˆï¼‰
                    if (answer === 'B') {
                        this.classList.add('correct');
                        showHint('âœ“ å›ç­”æ­£ç¡®ï¼é™åˆ¶æ€§å†…åˆ‡é…¶æ˜¯åŸºå› å·¥ç¨‹çš„"åˆ†å­å‰ªåˆ€"ã€‚');
                    } else {
                        this.classList.add('incorrect');
                        showHint('âœ— å›ç­”é”™è¯¯ã€‚é™åˆ¶æ€§å†…åˆ‡é…¶æ‰æ˜¯ç”¨æ¥åˆ‡å‰²DNAçš„å·¥å…·ã€‚');
                        
                        // æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
                        document.querySelector('.quiz-option[data-answer="B"]').classList.add('correct');
                    }
                });
            });
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', () => {
            initCanvas();
            initQuiz();
            updateStepIndicator();
        });
    </script>
</body>
</html>