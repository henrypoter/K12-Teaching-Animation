<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®è§‚ä¸–ç•Œæ¢ç´¢ï¼šæ˜¾å¾®é•œä¸‹çš„ç»†èƒè§‚å¯Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
            max-width: 800px;
        }

        h1 {
            color: #4fc3f7;
            margin-bottom: 10px;
            font-size: 2.2rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .subtitle {
            color: #b0bec5;
            font-size: 1.1rem;
            line-height: 1.5;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            max-width: 1200px;
            width: 100%;
            justify-content: center;
        }

        .main-panel {
            flex: 1;
            min-width: 300px;
            max-width: 700px;
            background: rgba(30, 30, 46, 0.8);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(76, 175, 80, 0.1);
        }

        .control-panel {
            flex: 0 0 300px;
            background: rgba(30, 30, 46, 0.8);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(33, 150, 243, 0.1);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel-title {
            color: #4fc3f7;
            font-size: 1.4rem;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid rgba(79, 195, 247, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel-title i {
            font-size: 1.2rem;
        }

        .microscope-view {
            position: relative;
            width: 100%;
            height: 400px;
            background-color: #0a0a15;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 2px solid #333;
            box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.8);
        }

        #microscopeCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .sample-selector {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 20px;
        }

        .sample-btn {
            flex: 1;
            padding: 12px 5px;
            background: rgba(40, 40, 60, 0.8);
            border: 2px solid #444;
            border-radius: 8px;
            color: #ccc;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .sample-btn:hover {
            background: rgba(60, 60, 90, 0.9);
            transform: translateY(-2px);
        }

        .sample-btn.active {
            background: rgba(33, 150, 243, 0.25);
            border-color: #2196f3;
            color: #90caf9;
            box-shadow: 0 0 15px rgba(33, 150, 243, 0.3);
        }

        .control-section {
            background: rgba(40, 40, 60, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .section-title {
            color: #81c784;
            font-size: 1.1rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .focus-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }

        .focus-knob {
            position: relative;
            width: 70px;
            height: 70px;
            cursor: pointer;
        }

        .knob-label {
            text-align: center;
            font-size: 0.9rem;
            color: #aaa;
            margin-top: 5px;
        }

        .enhancement-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .enhance-btn {
            padding: 12px 10px;
            background: rgba(50, 50, 70, 0.8);
            border: 1px solid #555;
            border-radius: 8px;
            color: #ddd;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .enhance-btn:hover {
            background: rgba(70, 70, 100, 0.9);
            transform: translateY(-2px);
        }

        .enhance-btn.active {
            background: rgba(76, 175, 80, 0.25);
            border-color: #4caf50;
            color: #a5d6a7;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }

        .comparison-panel {
            margin-top: 10px;
            background: rgba(40, 40, 60, 0.5);
            border-radius: 10px;
            padding: 15px;
        }

        .comparison-btn {
            width: 100%;
            padding: 14px;
            background: rgba(103, 58, 183, 0.7);
            border: none;
            border-radius: 8px;
            color: #e1bee7;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .comparison-btn:hover {
            background: rgba(123, 78, 203, 0.9);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(103, 58, 183, 0.4);
        }

        .comparison-view {
            display: none;
            margin-top: 20px;
            background: rgba(20, 20, 35, 0.9);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #673ab7;
        }

        .comparison-view.active {
            display: block;
        }

        .comparison-title {
            color: #ba68c8;
            font-size: 1.2rem;
            margin-bottom: 15px;
            text-align: center;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .comparison-cell {
            background: rgba(30, 30, 45, 0.8);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }

        .comparison-canvas {
            width: 100%;
            height: 120px;
            background: #0a0a15;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .cell-name {
            color: #4fc3f7;
            font-weight: 600;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .comparison-table th {
            background: rgba(103, 58, 183, 0.3);
            color: #d1c4e9;
            padding: 10px;
            text-align: left;
        }

        .comparison-table td {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .comparison-table tr:last-child td {
            border-bottom: none;
        }

        .hint {
            color: #ffb74d;
            font-size: 0.9rem;
            margin-top: 20px;
            padding: 12px;
            background: rgba(255, 183, 77, 0.1);
            border-radius: 8px;
            border-left: 4px solid #ffb74d;
            line-height: 1.5;
        }

        .footer {
            margin-top: 30px;
            text-align: center;
            color: #78909c;
            font-size: 0.9rem;
            max-width: 800px;
            padding: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .control-panel {
                width: 100%;
            }
            
            .comparison-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ”¬ å¾®è§‚ä¸–ç•Œæ¢ç´¢ï¼šæ˜¾å¾®é•œä¸‹çš„ç»†èƒ</h1>
        <p class="subtitle">æ¨¡æ‹ŸçœŸå®æ˜¾å¾®é•œè§‚å¯Ÿä½“éªŒï¼Œæ¢ç´¢äººå£è…”ä¸Šçš®ç»†èƒã€è‰å±¥è™«å’Œæ´‹è‘±è¡¨çš®ç»†èƒçš„å¾®è§‚ç»“æ„ã€‚ä½“éªŒä»æ¨¡ç³Šåˆ°æ¸…æ™°ï¼Œä»ç°æš—åˆ°æŸ“è‰²çš„å®Œæ•´è§‚å¯Ÿè¿‡ç¨‹ã€‚</p>
    </div>

    <div class="container">
        <div class="main-panel">
            <div class="panel-title">
                <span>ğŸ”­ æ˜¾å¾®é•œè§†é‡</span>
            </div>
            
            <div class="microscope-view">
                <canvas id="microscopeCanvas"></canvas>
            </div>
            
            <div class="sample-selector">
                <button class="sample-btn active" data-sample="cheek">ğŸ§¬ äººå£è…”ä¸Šçš®ç»†èƒ</button>
                <button class="sample-btn" data-sample="paramecium">ğŸ¦  è‰å±¥è™«</button>
                <button class="sample-btn" data-sample="onion">ğŸ§… æ´‹è‘±è¡¨çš®ç»†èƒ</button>
            </div>
            
            <div class="hint">
                ğŸ’¡ æç¤ºï¼šå…ˆä½¿ç”¨è°ƒç„¦æ—‹é’®ä½¿å›¾åƒå˜æ¸…æ™°ï¼Œç„¶åå°è¯•ä½¿ç”¨æŸ“è‰²ã€ç¨³å®šè§†é‡ç­‰å¢å¼ºåŠŸèƒ½æ¥è§‚å¯Ÿç»†èƒç»†èŠ‚ç»“æ„ã€‚
            </div>
        </div>
        
        <div class="control-panel">
            <div class="panel-title">
                <span>âš™ï¸ æ˜¾å¾®é•œæ§åˆ¶</span>
            </div>
            
            <div class="control-section">
                <div class="section-title">
                    <span>ğŸ›ï¸ è°ƒç„¦æ§åˆ¶</span>
                </div>
                <div class="focus-controls">
                    <div>
                        <div class="focus-knob" id="coarseKnob">
                            <svg width="70" height="70" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="45" fill="#333" stroke="#555" stroke-width="3"/>
                                <circle cx="50" cy="50" r="35" fill="#444" stroke="#666" stroke-width="2"/>
                                <line x1="50" y1="10" x2="50" y2="30" stroke="#4fc3f7" stroke-width="4"/>
                                <circle cx="50" cy="50" r="5" fill="#4fc3f7"/>
                                <text x="50" y="85" text-anchor="middle" fill="#aaa" font-size="12">ç²—å‡†ç„¦</text>
                            </svg>
                        </div>
                    </div>
                    
                    <div>
                        <div class="focus-knob" id="fineKnob">
                            <svg width="70" height="70" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="45" fill="#333" stroke="#555" stroke-width="3"/>
                                <circle cx="50" cy="50" r="35" fill="#444" stroke="#666" stroke-width="2"/>
                                <line x1="50" y1="15" x2="50" y2="35" stroke="#81c784" stroke-width="3"/>
                                <circle cx="50" cy="50" r="5" fill="#81c784"/>
                                <text x="50" y="85" text-anchor="middle" fill="#aaa" font-size="12">ç»†å‡†ç„¦</text>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="control-section">
                <div class="section-title">
                    <span>âœ¨ è§†é‡å¢å¼ºåŠŸèƒ½</span>
                </div>
                <div class="enhancement-controls">
                    <button class="enhance-btn" id="stainBtn">
                        <span>ğŸ¨ æŸ“è‰²</span>
                    </button>
                    <button class="enhance-btn" id="stabilizeBtn">
                        <span>ğŸ“· ç¨³å®šè§†é‡</span>
                    </button>
                    <button class="enhance-btn" id="brightnessBtn">
                        <span>ğŸ’¡ å¢å¼ºäº®åº¦</span>
                    </button>
                    <button class="enhance-btn" id="labelsBtn">
                        <span>ğŸ·ï¸ æ˜¾ç¤ºæ ‡æ³¨</span>
                    </button>
                </div>
            </div>
            
            <div class="control-section">
                <div class="section-title">
                    <span>ğŸ”„ é‡ç½®ä¸å¯¹æ¯”</span>
                </div>
                <button class="enhance-btn" id="resetBtn" style="grid-column: span 2;">
                    <span>ğŸ”„ é‡ç½®å½“å‰æ ·æœ¬</span>
                </button>
            </div>
            
            <div class="comparison-panel">
                <button class="comparison-btn" id="compareBtn">
                    <span>ğŸ” å¹¶æ’å¯¹æ¯”ä¸‰ç§ç»†èƒ</span>
                </button>
                
                <div class="comparison-view" id="comparisonView">
                    <div class="comparison-title">ä¸‰ç§ç»†èƒç»“æ„å¯¹æ¯”</div>
                    
                    <div class="comparison-grid">
                        <div class="comparison-cell">
                            <canvas class="comparison-canvas" id="compareCheek"></canvas>
                            <div class="cell-name">äººå£è…”ä¸Šçš®ç»†èƒ</div>
                        </div>
                        <div class="comparison-cell">
                            <canvas class="comparison-canvas" id="compareParamecium"></canvas>
                            <div class="cell-name">è‰å±¥è™«</div>
                        </div>
                        <div class="comparison-cell">
                            <canvas class="comparison-canvas" id="compareOnion"></canvas>
                            <div class="cell-name">æ´‹è‘±è¡¨çš®ç»†èƒ</div>
                        </div>
                    </div>
                    
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>ç»“æ„ç‰¹å¾</th>
                                <th>äººå£è…”ä¸Šçš®ç»†èƒ</th>
                                <th>è‰å±¥è™«</th>
                                <th>æ´‹è‘±è¡¨çš®ç»†èƒ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>ç»†èƒå£</td>
                                <td>âŒ æ— </td>
                                <td>âŒ æ— </td>
                                <td>âœ… æœ‰</td>
                            </tr>
                            <tr>
                                <td>ç»†èƒè†œ</td>
                                <td>âœ… æœ‰</td>
                                <td>âœ… æœ‰</td>
                                <td>âœ… æœ‰</td>
                            </tr>
                            <tr>
                                <td>ç»†èƒæ ¸</td>
                                <td>âœ… æœ‰</td>
                                <td>âœ… æœ‰ï¼ˆå¤§æ ¸+å°æ ¸ï¼‰</td>
                                <td>âœ… æœ‰</td>
                            </tr>
                            <tr>
                                <td>ç»†èƒè´¨</td>
                                <td>âœ… æœ‰</td>
                                <td>âœ… æœ‰</td>
                                <td>âœ… æœ‰</td>
                            </tr>
                            <tr>
                                <td>å¶ç»¿ä½“</td>
                                <td>âŒ æ— </td>
                                <td>âŒ æ— </td>
                                <td>âŒ æ— ï¼ˆè¡¨çš®ç»†èƒï¼‰</td>
                            </tr>
                            <tr>
                                <td>æ¶²æ³¡</td>
                                <td>âŒ æ— </td>
                                <td>âœ… æœ‰ï¼ˆé£Ÿç‰©æ³¡ã€ä¼¸ç¼©æ³¡ï¼‰</td>
                                <td>âœ… æœ‰ï¼ˆä¸­å¤®å¤§æ¶²æ³¡ï¼‰</td>
                            </tr>
                            <tr>
                                <td>è¿åŠ¨ç»“æ„</td>
                                <td>âŒ æ— </td>
                                <td>âœ… çº¤æ¯›</td>
                                <td>âŒ æ— </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <p>æ•™å­¦åŠ¨ç”»è®¾è®¡è¯´æ˜ï¼šæœ¬åŠ¨ç”»æ¨¡æ‹ŸçœŸå®æ˜¾å¾®é•œè§‚å¯Ÿä½“éªŒï¼Œåˆå§‹çŠ¶æ€ä¸ºç°æš—ã€æ¨¡ç³Šã€æŠ–åŠ¨çš„è§†é‡ï¼Œé€šè¿‡è°ƒç„¦å’Œå¢å¼ºåŠŸèƒ½å¯é€æ­¥è·å¾—æ¸…æ™°ã€ç¨³å®šã€æŸ“è‰²çš„é«˜æ¸…å›¾åƒï¼Œä¾¿äºå­¦ä¹ ä¸‰ç§å…¸å‹ç»†èƒçš„å¾®è§‚ç»“æ„ã€‚</p>
        <p>Â© å¾®è§‚ä¸–ç•Œæ¢ç´¢ - æ•™è‚²æŠ€æœ¯äº¤äº’åŠ¨ç”»</p>
    </div>

    <script>
        // ä¸»Canvaså’Œä¸Šä¸‹æ–‡
        const canvas = document.getElementById('microscopeCanvas');
        const ctx = canvas.getContext('2d');
        
        // å¯¹æ¯”è§†å›¾Canvas
        const compareCanvases = {
            cheek: document.getElementById('compareCheek'),
            paramecium: document.getElementById('compareParamecium'),
            onion: document.getElementById('compareOnion')
        };
        
        // è®¾ç½®Canvaså°ºå¯¸
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            
            // åŒæ—¶è®¾ç½®å¯¹æ¯”Canvasçš„å°ºå¯¸
            Object.values(compareCanvases).forEach(compareCanvas => {
                compareCanvas.width = compareCanvas.clientWidth;
                compareCanvas.height = compareCanvas.clientHeight;
            });
        }
        
        // åˆå§‹çŠ¶æ€
        let currentSample = 'cheek'; // cheek, paramecium, onion
        let focusLevel = 0; // 0-100, 0è¡¨ç¤ºå®Œå…¨å¤±ç„¦
        let isStained = false;
        let isStabilized = false;
        let isBright = false;
        let showLabels = false;
        
        // æŠ–åŠ¨å‚æ•°
        let shakeX = 0;
        let shakeY = 0;
        let shakeTime = 0;
        
        // åŠ¨ç”»å¸§ID
        let animationId = null;
        
        // æ ·æœ¬æ•°æ®
        const samples = {
            cheek: {
                name: 'äººå£è…”ä¸Šçš®ç»†èƒ',
                color: '#e8f4f8',
                nucleusColor: '#8a2be2',
                stainedColor: '#f0e6d2',
                stainedNucleusColor: '#6a0dad',
                cellCount: 8,
                label: 'åŠ¨ç‰©ç»†èƒï¼ˆæ— ç»†èƒå£ï¼‰'
            },
            paramecium: {
                name: 'è‰å±¥è™«',
                color: '#d4e6d4',
                nucleusColor: '#8b0000',
                stainedColor: '#c8e6c9',
                stainedNucleusColor: '#a52a2a',
                cellCount: 1,
                label: 'å•ç»†èƒç”Ÿç‰©'
            },
            onion: {
                name: 'æ´‹è‘±è¡¨çš®ç»†èƒ',
                color: '#f0f8e8',
                nucleusColor: '#4b0082',
                cellWallColor: '#32cd32',
                stainedColor: '#f5f5dc',
                stainedNucleusColor: '#800080',
                stainedCellWallColor: '#228b22',
                cellCount: 12,
                label: 'æ¤ç‰©ç»†èƒï¼ˆæœ‰ç»†èƒå£ï¼‰'
            }
        };
        
        // åˆå§‹åŒ–
        function init() {
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // æ ·æœ¬é€‰æ‹©æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.sample-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.sample-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentSample = this.dataset.sample;
                    
                    // é‡ç½®å¢å¼ºçŠ¶æ€
                    resetEnhancements();
                    
                    // æ›´æ–°å¯¹æ¯”è§†å›¾
                    updateComparisonView();
                });
            });
            
            // è°ƒç„¦æ—‹é’®äº‹ä»¶
            document.getElementById('coarseKnob').addEventListener('mousedown', startKnobDrag);
            document.getElementById('fineKnob').addEventListener('mousedown', startKnobDrag);
            
            // å¢å¼ºæŒ‰é’®äº‹ä»¶
            document.getElementById('stainBtn').addEventListener('click', function() {
                isStained = !isStained;
                this.classList.toggle('active', isStained);
                this.innerHTML = isStained ? '<span>ğŸ¨ å–æ¶ˆæŸ“è‰²</span>' : '<span>ğŸ¨ æŸ“è‰²</span>';
            });
            
            document.getElementById('stabilizeBtn').addEventListener('click', function() {
                isStabilized = !isStabilized;
                this.classList.toggle('active', isStabilized);
                this.innerHTML = isStabilized ? '<span>ğŸ“· å–æ¶ˆç¨³å®š</span>' : '<span>ğŸ“· ç¨³å®šè§†é‡</span>';
            });
            
            document.getElementById('brightnessBtn').addEventListener('click', function() {
                isBright = !isBright;
                this.classList.toggle('active', isBright);
                this.innerHTML = isBright ? '<span>ğŸ’¡ é™ä½äº®åº¦</span>' : '<span>ğŸ’¡ å¢å¼ºäº®åº¦</span>';
            });
            
            document.getElementById('labelsBtn').addEventListener('click', function() {
                showLabels = !showLabels;
                this.classList.toggle('active', showLabels);
                this.innerHTML = showLabels ? '<span>ğŸ·ï¸ éšè—æ ‡æ³¨</span>' : '<span>ğŸ·ï¸ æ˜¾ç¤ºæ ‡æ³¨</span>';
            });
            
            document.getElementById('resetBtn').addEventListener('click', resetEnhancements);
            
            // å¯¹æ¯”æŒ‰é’®äº‹ä»¶
            document.getElementById('compareBtn').addEventListener('click', function() {
                const comparisonView = document.getElementById('comparisonView');
                comparisonView.classList.toggle('active');
                this.innerHTML = comparisonView.classList.contains('active') 
                    ? '<span>ğŸ” éšè—å¯¹æ¯”è§†å›¾</span>' 
                    : '<span>ğŸ” å¹¶æ’å¯¹æ¯”ä¸‰ç§ç»†èƒ</span>';
                
                if (comparisonView.classList.contains('active')) {
                    updateComparisonView();
                }
            });
            
            // å¼€å§‹åŠ¨ç”»å¾ªç¯
            animate();
        }
        
        // é‡ç½®å¢å¼ºåŠŸèƒ½
        function resetEnhancements() {
            focusLevel = 0;
            isStained = false;
            isStabilized = false;
            isBright = false;
            showLabels = false;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('stainBtn').classList.remove('active');
            document.getElementById('stainBtn').innerHTML = '<span>ğŸ¨ æŸ“è‰²</span>';
            document.getElementById('stabilizeBtn').classList.remove('active');
            document.getElementById('stabilizeBtn').innerHTML = '<span>ğŸ“· ç¨³å®šè§†é‡</span>';
            document.getElementById('brightnessBtn').classList.remove('active');
            document.getElementById('brightnessBtn').innerHTML = '<span>ğŸ’¡ å¢å¼ºäº®åº¦</span>';
            document.getElementById('labelsBtn').classList.remove('active');
            document.getElementById('labelsBtn').innerHTML = '<span>ğŸ·ï¸ æ˜¾ç¤ºæ ‡æ³¨</span>';
        }
        
        // æ—‹é’®æ‹–åŠ¨æ§åˆ¶
        function startKnobDrag(e) {
            e.preventDefault();
            const knob = e.currentTarget;
            const isCoarse = knob.id === 'coarseKnob';
            let startY = e.clientY || e.touches[0].clientY;
            let startFocus = focusLevel;
            
            function onMouseMove(moveEvent) {
                const currentY = moveEvent.clientY || moveEvent.touches[0].clientY;
                const deltaY = startY - currentY;
                const change = isCoarse ? deltaY * 0.5 : deltaY * 0.2;
                
                focusLevel = Math.max(0, Math.min(100, startFocus + change));
                
                // æ—‹è½¬æ—‹é’®è§†è§‰æ•ˆæœ
                const knobSvg = knob.querySelector('svg');
                const rotation = (focusLevel / 100) * 360;
                knobSvg.style.transform = `rotate(${rotation}deg)`;
            }
            
            function onMouseUp() {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                document.removeEventListener('touchmove', onMouseMove);
                document.removeEventListener('touchend', onMouseUp);
            }
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
            document.addEventListener('touchmove', onMouseMove);
            document.addEventListener('touchend', onMouseUp);
        }
        
        // ç»˜åˆ¶ä¸»æ˜¾å¾®é•œè§†é‡
        function drawMicroscopeView() {
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width, height) * 0.45;
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, width, height);
            
            // ç»˜åˆ¶åœ†å½¢è§†é‡ï¼ˆæ¨¡æ‹Ÿæ˜¾å¾®é•œåœ†å½¢è§†é‡ï¼‰
            ctx.save();
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
            ctx.clip();
            
            // æ ¹æ®äº®åº¦è®¾ç½®èƒŒæ™¯
            let bgColor = isBright ? '#3a3a3a' : '#1a1a1a';
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, width, height);
            
            // æ·»åŠ å™ªç‚¹æ•ˆæœï¼ˆæ¨¡æ‹ŸçœŸå®æ˜¾å¾®é•œï¼‰
            if (!isBright) {
                addNoiseEffect();
            }
            
            // åº”ç”¨æŠ–åŠ¨æ•ˆæœï¼ˆå¦‚æœæœªç¨³å®šï¼‰
            if (!isStabilized) {
                shakeTime += 0.05;
                shakeX = Math.sin(shakeTime * 1.3) * (3 - focusLevel / 50);
                shakeY = Math.cos(shakeTime * 0.9) * (3 - focusLevel / 50);
                ctx.translate(shakeX, shakeY);
            }
            
            // æ ¹æ®å¯¹ç„¦çº§åˆ«åº”ç”¨æ¨¡ç³Šæ•ˆæœ
            const blurAmount = 10 - (focusLevel / 100) * 9.5;
            ctx.filter = `blur(${blurAmount}px)`;
            
            // ç»˜åˆ¶æ ·æœ¬
            drawSample();
            
            // æ¢å¤ä¸Šä¸‹æ–‡çŠ¶æ€
            ctx.restore();
            
            // ç»˜åˆ¶åœ†å½¢è¾¹æ¡†
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
            ctx.strokeStyle = '#555';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            // ç»˜åˆ¶æ ‡æ³¨ï¼ˆå¦‚æœå¯ç”¨ï¼‰
            if (showLabels && focusLevel > 30) {
                drawLabels();
            }
        }
        
        // æ·»åŠ å™ªç‚¹æ•ˆæœ
        function addNoiseEffect() {
            const width = canvas.width;
            const height = canvas.height;
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;
            
            // æ·»åŠ éšæœºå™ªç‚¹
            for (let i = 0; i < data.length; i += 4) {
                if (Math.random() > 0.95) {
                    const noise = Math.random() * 50;
                    data[i] += noise;     // R
                    data[i + 1] += noise; // G
                    data[i + 2] += noise; // B
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
        }
        
        // ç»˜åˆ¶å½“å‰æ ·æœ¬
        function drawSample() {
            const width = canvas.width;
            const height = canvas.height;
            const sample = samples[currentSample];
            
            // æ ¹æ®å¯¹ç„¦çº§åˆ«è°ƒæ•´é€æ˜åº¦
            const alpha = focusLevel / 100;
            
            // æ ¹æ®æ ·æœ¬ç±»å‹ç»˜åˆ¶ä¸åŒçš„ç»†èƒ
            if (currentSample === 'cheek') {
                drawCheekCells(alpha);
            } else if (currentSample === 'paramecium') {
                drawParamecium(alpha);
            } else if (currentSample === 'onion') {
                drawOnionCells(alpha);
            }
        }
        
        // ç»˜åˆ¶å£è…”ä¸Šçš®ç»†èƒ
        function drawCheekCells(alpha) {
            const width = canvas.width;
            const height = canvas.height;
            const sample = samples.cheek;
            const cellCount = sample.cellCount;
            
            // ç»†èƒé¢œè‰²ï¼ˆæ ¹æ®æŸ“è‰²çŠ¶æ€ï¼‰
            const cellColor = isStained ? sample.stainedColor : sample.color;
            const nucleusColor = isStained ? sample.stainedNucleusColor : sample.nucleusColor;
            
            for (let i = 0; i < cellCount; i++) {
                // éšæœºä½ç½®ï¼ˆä½†ä¿æŒåœ¨è§†é‡å†…ï¼‰
                const x = width * 0.2 + Math.random() * width * 0.6;
                const y = height * 0.2 + Math.random() * height * 0.6;
                const size = 20 + Math.random() * 30;
                
                // ç»˜åˆ¶ç»†èƒè´¨ï¼ˆä¸è§„åˆ™å½¢çŠ¶æ¨¡æ‹Ÿä¸Šçš®ç»†èƒï¼‰
                ctx.beginPath();
                ctx.ellipse(x, y, size, size * 0.7, 0, 0, Math.PI * 2);
                ctx.fillStyle = cellColor;
                ctx.globalAlpha = alpha * 0.8;
                ctx.fill();
                
                // ç»˜åˆ¶ç»†èƒæ ¸
                ctx.beginPath();
                ctx.arc(x, y, size * 0.3, 0, Math.PI * 2);
                ctx.fillStyle = nucleusColor;
                ctx.globalAlpha = alpha;
                ctx.fill();
                
                // ç»˜åˆ¶ç»†èƒè†œï¼ˆè½®å»“ï¼‰
                ctx.beginPath();
                ctx.ellipse(x, y, size, size * 0.7, 0, 0, Math.PI * 2);
                ctx.strokeStyle = isStained ? '#666' : '#888';
                ctx.lineWidth = 1;
                ctx.globalAlpha = alpha * 0.7;
                ctx.stroke();
            }
            
            ctx.globalAlpha = 1;
        }
        
        // ç»˜åˆ¶è‰å±¥è™«
        function drawParamecium(alpha) {
            const width = canvas.width;
            const height = canvas.height;
            const sample = samples.paramecium;
            
            // ç»†èƒé¢œè‰²ï¼ˆæ ¹æ®æŸ“è‰²çŠ¶æ€ï¼‰
            const cellColor = isStained ? sample.stainedColor : sample.color;
            const nucleusColor = isStained ? sample.stainedNucleusColor : sample.nucleusColor;
            
            // è‰å±¥è™«ä½ç½®ï¼ˆå±…ä¸­ï¼‰
            const x = width / 2;
            const y = height / 2;
            const length = 80;
            const widthSize = 30;
            
            // ç»˜åˆ¶è‰å±¥è™«èº«ä½“ï¼ˆé‹åº•å½¢çŠ¶ï¼‰
            ctx.beginPath();
            ctx.ellipse(x, y, length, widthSize, 0, 0, Math.PI * 2);
            ctx.fillStyle = cellColor;
            ctx.globalAlpha = alpha * 0.8;
            ctx.fill();
            
            // ç»˜åˆ¶ç»†èƒæ ¸ï¼ˆå¤§æ ¸å’Œå°æ ¸ï¼‰
            ctx.beginPath();
            ctx.ellipse(x - 10, y, 15, 10, 0, 0, Math.PI * 2); // å¤§æ ¸
            ctx.fillStyle = nucleusColor;
            ctx.globalAlpha = alpha;
            ctx.fill();
            
            ctx.beginPath();
            ctx.arc(x + 20, y - 5, 4, 0, Math.PI * 2); // å°æ ¸
            ctx.fillStyle = '#000';
            ctx.globalAlpha = alpha;
            ctx.fill();
            
            // ç»˜åˆ¶çº¤æ¯›ï¼ˆå¦‚æœå¯¹ç„¦è¶³å¤Ÿæ¸…æ™°ï¼‰
            if (focusLevel > 50) {
                ctx.strokeStyle = isStained ? '#aaa' : '#ccc';
                ctx.lineWidth = 0.5;
                ctx.globalAlpha = alpha * 0.7;
                
                for (let i = 0; i < 30; i++) {
                    const angle = (i / 30) * Math.PI * 2;
                    const ciliaX = x + Math.cos(angle) * (length - 5);
                    const ciliaY = y + Math.sin(angle) * (widthSize - 5);
                    
                    ctx.beginPath();
                    ctx.moveTo(ciliaX, ciliaY);
                    ctx.lineTo(
                        ciliaX + Math.cos(angle) * 10,
                        ciliaY + Math.sin(angle) * 10
                    );
                    ctx.stroke();
                }
            }
            
            // ç»˜åˆ¶é£Ÿç‰©æ³¡ï¼ˆå¦‚æœæŸ“è‰²ï¼‰
            if (isStained && focusLevel > 40) {
                ctx.fillStyle = '#8bc34a';
                ctx.globalAlpha = alpha * 0.6;
                
                // å‡ ä¸ªé£Ÿç‰©æ³¡
                ctx.beginPath();
                ctx.arc(x - 30, y + 10, 8, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(x + 10, y - 15, 6, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // ç»˜åˆ¶ç»†èƒè†œè½®å»“
            ctx.beginPath();
            ctx.ellipse(x, y, length, widthSize, 0, 0, Math.PI * 2);
            ctx.strokeStyle = isStained ? '#666' : '#888';
            ctx.lineWidth = 1;
            ctx.globalAlpha = alpha * 0.7;
            ctx.stroke();
            
            ctx.globalAlpha = 1;
        }
        
        // ç»˜åˆ¶æ´‹è‘±è¡¨çš®ç»†èƒ
        function drawOnionCells(alpha) {
            const width = canvas.width;
            const height = canvas.height;
            const sample = samples.onion;
            const cellCount = sample.cellCount;
            
            // ç»†èƒé¢œè‰²ï¼ˆæ ¹æ®æŸ“è‰²çŠ¶æ€ï¼‰
            const cellColor = isStained ? sample.stainedColor : sample.color;
            const nucleusColor = isStained ? sample.stainedNucleusColor : sample.nucleusColor;
            const cellWallColor = isStained ? sample.stainedCellWallColor : sample.cellWallColor;
            
            // ç»˜åˆ¶ç½‘æ ¼çŠ¶æ’åˆ—çš„ç»†èƒ
            const cols = 4;
            const rows = 3;
            const cellWidth = width * 0.8 / cols;
            const cellHeight = height * 0.8 / rows;
            const startX = width * 0.1;
            const startY = height * 0.1;
            
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    const x = startX + col * cellWidth + cellWidth / 2;
                    const y = startY + row * cellHeight + cellHeight / 2;
                    
                    // ç»˜åˆ¶ç»†èƒå£ï¼ˆçŸ©å½¢ï¼‰
                    ctx.fillStyle = cellWallColor;
                    ctx.globalAlpha = alpha * 0.3;
                    ctx.fillRect(x - cellWidth / 2, y - cellHeight / 2, cell
<!--æ£€æµ‹åˆ°ä»£ç æˆªæ–­ï¼Œè‡ªåŠ¨ç»­å†™ä¸­...-->
Width / 2, cellHeight / 2);
                    
                    // ç»˜åˆ¶ç»†èƒå£è¾¹æ¡†
                    ctx.strokeStyle = cellWallColor;
                    ctx.lineWidth = 2;
                    ctx.globalAlpha = alpha * 0.8;
                    ctx.strokeRect(x - cellWidth / 2, y - cellHeight / 2, cellWidth, cellHeight);
                    
                    // ç»˜åˆ¶ç»†èƒè´¨ï¼ˆå¡«å……å¤§éƒ¨åˆ†ç»†èƒï¼‰
                    ctx.fillStyle = cellColor;
                    ctx.globalAlpha = alpha * 0.5;
                    ctx.fillRect(
                        x - cellWidth / 2 + 5, 
                        y - cellHeight / 2 + 5, 
                        cellWidth - 10, 
                        cellHeight - 10
                    );
                    
                    // ç»˜åˆ¶ç»†èƒæ ¸ï¼ˆé è¿‘ç»†èƒå£ï¼‰
                    const nucleusX = x - cellWidth / 4;
                    const nucleusY = y;
                    const nucleusSize = Math.min(cellWidth, cellHeight) * 0.2;
                    
                    ctx.beginPath();
                    ctx.arc(nucleusX, nucleusY, nucleusSize, 0, Math.PI * 2);
                    ctx.fillStyle = nucleusColor;
                    ctx.globalAlpha = alpha;
                    ctx.fill();
                    
                    // ç»˜åˆ¶æ¶²æ³¡ï¼ˆä¸­å¤®å¤§æ¶²æ³¡ï¼‰
                    ctx.fillStyle = isStained ? '#e8f4f8' : '#f0f8ff';
                    ctx.globalAlpha = alpha * 0.4;
                    ctx.fillRect(
                        x + cellWidth / 6, 
                        y - cellHeight / 3, 
                        cellWidth / 3, 
                        cellHeight * 0.6
                    );
                }
            }
            
            ctx.globalAlpha = 1;
        }
        
        // ç»˜åˆ¶æ ‡æ³¨
        function drawLabels() {
            const width = canvas.width;
            const height = canvas.height;
            const sample = samples[currentSample];
            
            ctx.font = '14px Arial, sans-serif';
            ctx.fillStyle = '#ffffff';
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 3;
            ctx.textAlign = 'center';
            ctx.globalAlpha = 0.9;
            
            if (currentSample === 'cheek') {
                // å£è…”ä¸Šçš®ç»†èƒæ ‡æ³¨
                ctx.fillText('ç»†èƒè†œ', width * 0.5, height * 0.3);
                ctx.fillText('ç»†èƒè´¨', width * 0.5, height * 0.5);
                ctx.fillText('ç»†èƒæ ¸', width * 0.5, height * 0.7);
                
                // ç»˜åˆ¶å¼•çº¿
                drawLabelLine(width * 0.5, height * 0.25, width * 0.3, height * 0.35);
                drawLabelLine(width * 0.5, height * 0.45, width * 0.7, height * 0.55);
                drawLabelLine(width * 0.5, height * 0.65, width * 0.4, height * 0.75);
                
            } else if (currentSample === 'paramecium') {
                // è‰å±¥è™«æ ‡æ³¨
                ctx.fillText('çº¤æ¯›', width * 0.3, height * 0.2);
                ctx.fillText('ç»†èƒè†œ', width * 0.7, height * 0.3);
                ctx.fillText('å¤§æ ¸', width * 0.4, height * 0.5);
                ctx.fillText('å°æ ¸', width * 0.6, height * 0.4);
                ctx.fillText('é£Ÿç‰©æ³¡', width * 0.3, height * 0.7);
                
                // ç»˜åˆ¶å¼•çº¿
                drawLabelLine(width * 0.25, height * 0.15, width * 0.2, height * 0.25);
                drawLabelLine(width * 0.75, height * 0.25, width * 0.8, height * 0.35);
                drawLabelLine(width * 0.35, height * 0.45, width * 0.45, height * 0.55);
                drawLabelLine(width * 0.65, height * 0.35, width * 0.7, height * 0.45);
                drawLabelLine(width * 0.25, height * 0.65, width * 0.2, height * 0.75);
                
            } else if (currentSample === 'onion') {
                // æ´‹è‘±è¡¨çš®ç»†èƒæ ‡æ³¨
                ctx.fillText('ç»†èƒå£', width * 0.3, height * 0.2);
                ctx.fillText('ç»†èƒè†œ', width * 0.7, height * 0.3);
                ctx.fillText('ç»†èƒæ ¸', width * 0.4, height * 0.5);
                ctx.fillText('æ¶²æ³¡', width * 0.7, height * 0.7);
                ctx.fillText('ç»†èƒè´¨', width * 0.5, height * 0.6);
                
                // ç»˜åˆ¶å¼•çº¿
                drawLabelLine(width * 0.25, height * 0.15, width * 0.15, height * 0.25);
                drawLabelLine(width * 0.75, height * 0.25, width * 0.85, height * 0.35);
                drawLabelLine(width * 0.35, height * 0.45, width * 0.25, height * 0.55);
                drawLabelLine(width * 0.75, height * 0.65, width * 0.85, height * 0.75);
                drawLabelLine(width * 0.55, height * 0.55, width * 0.65, height * 0.65);
            }
            
            ctx.globalAlpha = 1;
        }
        
        // ç»˜åˆ¶æ ‡æ³¨å¼•çº¿
        function drawLabelLine(textX, textY, targetX, targetY) {
            ctx.beginPath();
            ctx.moveTo(textX, textY);
            ctx.lineTo(targetX, targetY);
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 3]);
            ctx.stroke();
            ctx.setLineDash([]);
        }
        
        // æ›´æ–°å¯¹æ¯”è§†å›¾
        function updateComparisonView() {
            // ä¿å­˜å½“å‰çŠ¶æ€
            const originalSample = currentSample;
            const originalFocus = focusLevel;
            const originalStained = isStained;
            const originalStabilized = isStabilized;
            const originalBright = isBright;
            const originalLabels = showLabels;
            
            // ç»˜åˆ¶å£è…”ä¸Šçš®ç»†èƒå¯¹æ¯”å›¾
            currentSample = 'cheek';
            focusLevel = 100;
            isStained = true;
            isStabilized = true;
            isBright = true;
            showLabels = false;
            
            const cheekCtx = compareCanvases.cheek.getContext('2d');
            cheekCtx.clearRect(0, 0, compareCanvases.cheek.width, compareCanvases.cheek.height);
            drawComparisonCell(cheekCtx, 'cheek');
            
            // ç»˜åˆ¶è‰å±¥è™«å¯¹æ¯”å›¾
            currentSample = 'paramecium';
            const parameciumCtx = compareCanvases.paramecium.getContext('2d');
            parameciumCtx.clearRect(0, 0, compareCanvases.paramecium.width, compareCanvases.paramecium.height);
            drawComparisonCell(parameciumCtx, 'paramecium');
            
            // ç»˜åˆ¶æ´‹è‘±è¡¨çš®ç»†èƒå¯¹æ¯”å›¾
            currentSample = 'onion';
            const onionCtx = compareCanvases.onion.getContext('2d');
            onionCtx.clearRect(0, 0, compareCanvases.onion.width, compareCanvases.onion.height);
            drawComparisonCell(onionCtx, 'onion');
            
            // æ¢å¤åŸå§‹çŠ¶æ€
            currentSample = originalSample;
            focusLevel = originalFocus;
            isStained = originalStained;
            isStabilized = originalStabilized;
            isBright = originalBright;
            showLabels = originalLabels;
        }
        
        // ç»˜åˆ¶å¯¹æ¯”è§†å›¾ä¸­çš„ç»†èƒ
        function drawComparisonCell(ctx, sampleType) {
            const width = ctx.canvas.width;
            const height = ctx.canvas.height;
            
            // è®¾ç½®èƒŒæ™¯
            ctx.fillStyle = '#2a2a3a';
            ctx.fillRect(0, 0, width, height);
            
            // æ ¹æ®æ ·æœ¬ç±»å‹ç»˜åˆ¶
            if (sampleType === 'cheek') {
                // ç»˜åˆ¶å£è…”ä¸Šçš®ç»†èƒ
                ctx.fillStyle = samples.cheek.stainedColor;
                ctx.fillRect(width * 0.2, height * 0.2, width * 0.6, height * 0.4);
                
                ctx.fillStyle = samples.cheek.stainedNucleusColor;
                ctx.beginPath();
                ctx.arc(width * 0.5, height * 0.4, width * 0.1, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.strokeStyle = '#666';
                ctx.lineWidth = 1;
                ctx.strokeRect(width * 0.2, height * 0.2, width * 0.6, height * 0.4);
                
            } else if (sampleType === 'paramecium') {
                // ç»˜åˆ¶è‰å±¥è™«
                ctx.fillStyle = samples.paramecium.stainedColor;
                ctx.beginPath();
                ctx.ellipse(width * 0.5, height * 0.5, width * 0.3, height * 0.2, 0, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = samples.paramecium.stainedNucleusColor;
                ctx.beginPath();
                ctx.ellipse(width * 0.4, height * 0.5, width * 0.08, height * 0.05, 0, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(width * 0.6, height * 0.45, width * 0.02, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#8bc34a';
                ctx.beginPath();
                ctx.arc(width * 0.3, height * 0.6, width * 0.05, 0, Math.PI * 2);
                ctx.fill();
                
            } else if (sampleType === 'onion') {
                // ç»˜åˆ¶æ´‹è‘±è¡¨çš®ç»†èƒ
                ctx.fillStyle = samples.onion.stainedCellWallColor;
                ctx.lineWidth = 2;
                ctx.strokeRect(width * 0.2, height * 0.2, width * 0.6, height * 0.6);
                
                ctx.fillStyle = samples.onion.stainedColor;
                ctx.fillRect(width * 0.25, height * 0.25, width * 0.5, height * 0.5);
                
                ctx.fillStyle = samples.onion.stainedNucleusColor;
                ctx.beginPath();
                ctx.arc(width * 0.3, height * 0.5, width * 0.08, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#e8f4f8';
                ctx.fillRect(width * 0.5, height * 0.3, width * 0.2, height * 0.4);
            }
        }
        
        // åŠ¨ç”»å¾ªç¯
        function animate() {
            drawMicroscopeView();
            animationId = requestAnimationFrame(animate);
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', init);
        
        // æ¸…ç†åŠ¨ç”»å¸§
        window.addEventListener('beforeunload', () => {
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        });
    </script>
</body>
</html>